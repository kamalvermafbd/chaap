
<!DOCTYPE html>
<html lang="en">
  
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chaap Express</title>
<script src="https://cdn.tailwindcss.com"></script>

  <!-- Real Manifest File -->
  <link rel="manifest" href="/manifest.json">

  <!-- Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" sizes="192x192" href="/icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="/icons/icon-512.png">

  <meta name="theme-color" content="#ff6f00" />
  <style>
    /* Fade-in effect for menu items */
.fadeIn {
  animation: fadeIn 0.6s ease forwards;
  opacity: 0;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Slide-in animation for category titles */
.slideIn {
  animation: slideIn 0.7s ease forwards;
  opacity: 0;
}
@keyframes slideIn {
  from { transform: translateX(-30px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Ripple animation for buttons */
button {
  position: relative;
  overflow: hidden;
}
button::after {
  content: "";
  position: absolute;
  background: rgba(255,255,255,0.4);
  width: 0;
  height: 0;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  opacity: 0;
}
button:active::after {
  width: 200px;
  height: 200px;
  top: 50%;
  left: 50%;
  opacity: 1;
  transition: 0.4s ease;
}

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: #fffdf7;
      color: #333;
    }
    header {
      text-align: center;
      background: #ff6347;
      color: white;
      padding: 20px;
    }
    .menu-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      padding: 20px;
    }
    .menu-item {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 10px;
    }
      .menu-item h4, 
      .menu-item p,
      .menu-item img {
     text-align: left !important;
    }
    /* FIX SINGLE ITEM PRICE ALIGNMENT */
.menu-item .variant-row {
  text-align: left !important;
}

.menu-item .variant-row .unit,
.menu-item .variant-row .price {
  text-align: left !important;
}

    /* Keep button fixed at bottom */
.menu-item {
  display: flex;
  flex-direction: column;
  min-height: 350px;   /* adjust as needed */
}

.menu-item button {
  margin-top: auto;
  display: inline-block;   /* full width nahi lega */
  width: auto;             /* text ke hisaab se size */
  padding: 6px 14px;       /* perfect compact size */
  font-size: 14px;
  align-self: center;      /* center me aayega */
}

.variant-box {
  margin-bottom: 10px;
}

/* FIX: Ensure price never gets cut */
.variant-row {
  overflow: visible !important;
}

/* FIX: Give space on right side so ₹ price doesn't clip */
.variant-box {
  padding-right: 14px !important;
}

/* FIX: prevent label flex from shrinking price */
.price {
  flex-shrink: 0 !important;
  margin-left: auto !important;
}
/* Move price slightly inward */
.price {
  margin-right: 8px !important;
}

/* Keep Multi-variant in single line ALWAYS */
.variant-row {
  white-space: nowrap !important;
}

/* Left side ko shrink hone se rokna */
.left-side {
  flex-shrink: 0 !important;
}

/* Unit text 1st column me rahe, wrap na ho */
.unit {
  white-space: nowrap !important;
}

/* Price right me fix ho jaye, wrap na ho */
.price {
  white-space: nowrap !important;
}

    .menu-item img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 8px;
    }
    .cart {
      padding: 20px;
      background: #fff8f0;
      border-top: 2px solid #ff6347;
    }
    cart-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      margin: 2px 0;
      border-bottom: 1px solid #eee;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border-bottom: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th:nth-child(2), td:nth-child(2) {
      width: 60px;
    }
    button {
      background: #ff6347;
      color: white;
      border: none;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #e7533d; }
    checkout-btn {
      width: auto;
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
    }
    #checkoutForm button[type="button"] {
      margin-top: 25px;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
    }
    input, textarea, select {
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    #address, #orderType, #customerName, #email {
      display: none;
    }
#menu p {
  color: #000;
  font-weight: 600;
}
body {
  background: linear-gradient(135deg, #fff9f2, #ffe6d5);
  background-attachment: fixed;
}
    
.variant-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 6px;
  margin-bottom: 6px;
  cursor: pointer;
  width: 100%;  
  
}
    
.left-side {
  display: flex !important;
  align-items: center !important;
  gap: 10px !important;
}

.left-side {
  display: flex;
  align-items: center;
  gap: 8px;
}
.price {
  font-weight: 600;
}


.variant-row .left-side {
  display: flex;
  align-items: center;
  gap: 10px;
}

.variant-row input[type="radio"] {
  transform: scale(1.3);
}

.variant-box {
  border: 1px solid #ddd;
  padding: 8px;
  border-radius: 8px;
  margin-top: 10px;
  background: #fafafa;
  width: 100%;
  box-sizing: border-box;
  box-sizing: border-box;    /* ← JO MOST IMPORTANT FIX HAI */
  overflow: hidden;          /* ← extra expansion stop */
}

/* Center only the title and description */
.menu-item h4,
.menu-item p {
  text-align: center !important;
}
.variant-row { white-space: normal; }

@media (min-width:520px) {
  .variant-row { white-space: nowrap; }
}
/* Visual-only "disabled" look so clicks still work */
.disabled-btn {
  background: #ccc !important;
  opacity: 0.6;
  cursor: not-allowed;
  pointer-events: auto !important; /* ensure clicks are still delivered */
}
    .final-price {
  font-size: 16px;
  font-weight: 700;
}
.mrp {
  text-decoration: line-through;
  color: #777;
  margin-left: 6px;
  font-size: 13px;
}


/* Profile Page Input Styling */
#profilePage input {
  width: 280px !important;       /* Fixed compact width */
  max-width: 90% !important;     /* Responsive */
  font-size: 14px !important;    /* Smaller text */
  height: 32px !important;       /* Compact height */
  padding: 4px 10px !important;  /* Balanced padding */
  border: 1px solid #bbb;
  border-radius: 6px;
  margin-bottom: 10px;
  box-sizing: border-box;
}
#profilePage input[readonly] {
  background: #f5f5f5;
  color: #555;
}
#pageWrapper {
  position: relative;
}


#editBtn, #saveBtn, #cancelBtn {
  font-size: 14px !important;
  padding: 6px 12px !important;
}

/* PREMIUM LEFT SIDEBAR */
#leftNav {
  position: fixed;
  left: 0;
  width: 220px;
  top: 180px;    /* header ?? ???? */
  bottom: 0;
  background: #2A0A4A;  /* elegant royal blue */
  color: white;
  padding: 20px 15px;
  border-right: 1px solid rgba(255,255,255,0.15);
  box-shadow: 2px 0 12px rgba(0,0,0,0.12);
  border-top-right-radius: 12px;
   transform: translateX(-100%);
  transition: transform 0.3s ease;

}

/* Menu UL */
#leftNav ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

/* Items */
#leftNav li {
  padding: 12px 10px;
  margin-bottom: 6px;
  cursor: pointer;
  color: white;
  font-size: 16px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: 0.2s;  
}

/* Hover effect */
#leftNav li:hover {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(4px);
}

/* Active menu */
#leftNav li.active {
  background: white;
  color: #1e3a8a;
  font-weight: 600;
}

/* Premium badge for numbers */
.nav-badge {
  background: white;
  color: #1e3a8a;
  padding: 2px 7px;
  border-radius: 6px;
  font-weight: bold;
}
/* Premium Navigation Icons */
.nav-icon {
  font-size: 22px;       /* Bigger size */
  color: #ffd166;        /* Soft gold/yellow – looks premium on blue */
  font-weight: bold;
}
#profileOverlay { 
   display: none; 
   position: fixed; 
   inset: 0;
   background: rgba(0,0,0,0.45);
   z-index: 9999;
   color: white;
   font-size: 22px;
   align-items: center;
   justify-content: center;
}
#profileOverlay.active {
   display: flex;
}

/* soft noise overlay */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
  opacity: 0.15;
  pointer-events: none;
}
/* Sidebar hidden by default (slide-left) */

/* When sidebar is active */
#leftNav.active {
  transform: translateX(0);
}


    
  </style>
</head>
<body>
<div id="cartOverlay" class="fixed inset-0 bg-black bg-opacity-45 z-50 text-white text-xl font-medium flex items-center justify-center hidden">
  Updating your cart…
</div>


  <button onclick="openLogin()" 
        style="position:absolute; right:100px; top:60px; z-index:9999;
               background:#444;color:white;padding:8px 14px;border:none;
               border-radius:6px;cursor:pointer;">
  Login
</button>
<button id="logoutBtn"
        onclick="logoutUser()" 
        style="position:absolute; right:58px; top:60px; z-index:9999;
               background:#444;color:white;padding:8px 14px;border:none;
               border-radius:6px;cursor:pointer; display:none;">
  Logout
</button>

<button onclick="openSignup()" 
        style="position:absolute; right:12px; top:60px; z-index:9999;
               background:#444;color:white;padding:8px 14px;border:none;
               border-radius:6px;cursor:pointer;">
  Signup
</button>
<div  id="signupLabelBox" 
style="
  position:absolute;
  right:12px;
  top:100px;
  width:180px;
  text-align:right;
  font-size:13px;
  color:#FFFFFF; 
  font-weight:500;
  font-family:Poppins, sans-serif;
  line-height:16px;
">
  
  <span style="color:#FFFFFF; font-weight:600; text-decoration:none; cursor:pointer;"
        onclick="openSignup()">
  Are you not registered? <br> Just Sign Up
  </span>
</div>

 <!-- HAMBURGER BUTTON (appears only after login) -->
<button id="hamburgerBtn"
        onclick="toggleSidebar()"
        style="position:fixed; top:15px; left:15px; font-size:26px;
               background:#7A0010; color:#FFD166; border:none;
               padding:8px 12px; border-radius:8px; cursor:pointer;
               box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:9999; display:none;">
  <svg id="hamburgerIcon" viewBox="0 0 24 24" width="24" height="24" fill="#FFD166">
    <rect y="4" width="24" height="3"></rect>
    <rect y="10" width="24" height="3"></rect>
    <rect y="16" width="24" height="3"></rect>
  </svg>
</button>

<button id="installBtn" 
        style="
          display:none;
          position:fixed;
          bottom:20px;
          right:20px;
          background:#ff6347;
          color:white;
          padding:10px 16px;
          border-radius:8px;
          font-size:16px;
          border:none;
          box-shadow:0 4px 10px rgba(0,0,0,0.2);
          z-index:99999;
        ">
  Install App
</button>

  <header>
    <div id="userInfoBox" 
     style="background:#ff6347; color:white; padding:6px 12px;
            border-radius:6px; display:none; font-size:14px;
            margin-top:10px; display:inline-block;">

  Logged in: <span id="loggedEmail"></span><br>
 
</div>
    <div id="restaurantInfo">
      <h1 id="restaurantName">Loading...</h1>
      <p id="restaurantAddress"></p>
    </div>
    <p>Delicious meals delivered fast!</p>
    
  </header>

<!-- LEFT NAVIGATION PANEL -->
<!-- LEFT NAVIGATION PANEL -->
<div id="leftNav"
     style="
       position:fixed;
       left:0;
       top:90px;
       bottom:0;
       width:180px;
       background:#1976d2;
       color:white;
       border-right:1px solid #e6e6e6;
       box-shadow: 2px 0 4px rgba(0,0,0,0.06); /* soft professional shadow */
       padding:20px;
       z-index:999;
       overflow-y:auto;
       display:block; /* default hidden */
       
     ">
  <ul id="premiumMenu">
  <li onclick="openMenuPageProperly(this)">

  <span class="nav-icon">
  <svg viewBox="0 0 24 24" width="32" height="32">
    <path d="M6 7V6a6 6 0 0 1 12 0v1h2a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1h2Zm2 0h8V6a4 4 0 0 0-8 0v1Z" 
          fill="#FFD166"></path>
  </svg>
</span>

  Continue Shopping
</li>

      <li onclick="activateMenu(this); showPage('profilePage'); loadUserProfile();">
    <span class="nav-badge">1</span>
    My Profile
  </li>

  <li onclick="activateMenu(this); showPage('ordersPage'); loadUserOrders();">

    <span class="nav-badge">2</span>
    My Orders
  </li>

 <li onclick="activateMenu(this); showPage('offersPage'); loadOffers();">
    <span class="nav-badge">3</span>
    Offers
  </li>

</ul>

</div>

<!-- RIGHT SIDE MAIN CONTENT -->
<!-- MAIN CONTENT AREA -->
<div id="mainContent" 
     style="margin-left:0px; padding:20px; transition:0.2s ease;">

    <!--  MENU WRAPPER (default visible) -->
    <div id="menuWrapper">

        <!-- FILTER AREA -->
        <div id="filterWrapper" style="text-align:center; margin-bottom:15px;">
 <!-- Category Filter -->
        <select id="categoryFilter" onchange="filterMenu()"
            style="width:45%;max-width:200px;padding:10px;font-size:16px;
                   border-radius:6px;border:1px solid #ccc;background:white;">
            <option value="">All Categories</option>
        </select>

        <!-- Search -->
        <input type="text" id="menuSearch"
               placeholder="Search food item..."
               oninput="filterMenu()"
               style="width:45%;max-width:200px;padding:10px;font-size:16px;
                      border-radius:6px;border:1px solid #ccc;margin-left:10px;">

        <!-- Clear -->
        <button onclick="clearFilters()"
            style="padding:10px 15px;margin-left:10px;background:#777;color:white;
                   border:none;border-radius:6px;cursor:pointer;">
            Clear
        </button>



            <!-- Your existing category filter + search + clear button will be here -->
        </div>

        <!-- OTHER PAGES WRAPPER (default hidden) -->


        <!-- MENU LIST -->
        <div id="menu" class="menu-container">
            <p>Loading menu...</p>
        </div>

             <div class="cart">
    <h3 class="text-xl font-semibold mb-3 text-gray-800">Your Cart</h3>
        <!-- CART -->
        <div id="cartWrapper" class="p-4 bg-white shadow rounded-md">
<div id="cartItems" class="space-y-3"></div>

            <!-- Your current cart HTML goes here -->


    <table id="cartTable" class="hidden">

  <thead>
    <tr class="bg-gray-100 border-b">
      <th class="px-4 py-2 text-left">Item</th>
      <th class="px-4 py-2 text-left">Qty</th>
      <th class="px-4 py-2 text-left">Rate (MRP)</th>
      <th class="px-4 py-2 text-left">Disc %</th>
      <th class="px-4 py-2 text-left">Disc Amt</th>
      <th class="px-4 py-2 text-left">Net Amt</th>
      <th class="px-4 py-2 text-left">Total</th>
      <th class="px-4 py-2 text-left">Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  
<p id="cartBaseTotal" class="text-right font-semibold mt-2 mb-4">
  Total: ₹<span id="cartTotal">0.00</span>
</p>

<!-- Tax Summary Comes Here -->
<div id="taxSummary" class="text-right font-semibold mt-2"></div>

<button onclick="openCheckout()" class="w-full bg-orange-500 text-white py-3 rounded-lg mt-4 hover:bg-orange-600">
  Checkout
</button>

  </div>
        </div>
    </div>

  <div id="pageWrapper" style="display:none; padding:10px;">

    <!-- PROFILE PAGE -->
    <div id="profilePage" style="display:none;">
        <h2>My Profile</h2>
        
        <div id="profileLoading" style="display:none; color:red;">Loading...</div>
        <input id="pName" placeholder="Full Name" readonly><br>
        <input id="pMobile" placeholder="Mobile" disabled><br>
        <input id="pEmail" placeholder="Email" readonly><br>
        <input id="pAddress" placeholder="Address" readonly><br>
        <input id="ppin" placeholder="Pincode" readonly><br>
        <input id="pCity" placeholder="City" readonly><br>
        <input id="pState" placeholder="State" readonly><br>

        <button id="editBtn" onclick="enableProfileEdit()">Edit</button>
        <button id="saveBtn" onclick="saveProfile()" style="display:none;">Save Changes</button>
        <button id="cancelBtn" onclick="cancelProfileEdit()" style="display:none;">Cancel</button>

        <div id="profileOverlay"
             style="
               position:fixed;
               inset:0;
               background:rgba(0,0,0,0.45);
               z-index:9999;
               color:white;
               font-size:22px;
               align-items:center;
               justify-content:center;
             ">
          Saving your profile…
        </div>
    </div>

    <!-- ORDERS PAGE -->
    <div id="ordersPage" style="display:none;">
        <h2>My Orders</h2>
        <p>No order history available.</p>
    </div>

    <!-- OFFERS PAGE -->
    <div id="offersPage" style="display:none;">
        <h2>Offers</h2>
        <p>No offers available currently.</p>
    </div>

</div>

  <div id="checkoutModal" class="modal">
    <div class="modal-content">
      <h3>Checkout</h3>
      <form id="checkoutForm" onsubmit="event.preventDefault(); placeOrder();">
        <input type="tel" id="mobile" pattern="^[0-9]{10}$" placeholder="Enter 10-digit Mobile" required oninput="checkCustomerByMobile()">
        <p id="infoMsg" style="color:green;font-size:14px;display:none;margin-top:4px;"></p>

        <select id="orderType" onchange="toggleAddressField()" required>
          <option value="">Select Order Type</option>
          <option value="Dine In">Dine In</option>
          <option value="Take Away">Take Away</option>
          <option value="Home Delivery">Home Delivery</option>
        </select>

        <input type="text" id="customerName" placeholder="Name" required>
        <input type="email" id="email" placeholder="Email" required>
        <textarea id="address" placeholder="Address"></textarea>

        <select id="paymentMethod" required>
          <option value="">Select Payment</option>
          <option value="Cash on Delivery">Cash on Delivery</option>
          <option value="Online">Online</option>
        </select>

        <button type="submit" class="checkout-btn">Place Order</button>
        <button type="button" onclick="closeCheckout()">Cancel</button>
      </form>
    </div>
  </div>

  <script>
    let restaurantTax = {
  taxType: "",
  servicePercent: 0,
  cgstPercent: 0,
  sgstPercent: 0,
  igstPercent: 0
};
let cart = [];   // start empty

 // --- CART SAVE LOCK SYSTEM (Fix race condition) ---
let cartSaveLock = false;
let cartSaveQueued = false;
// ---- ADD-TO-CART CLICK LOCK ----
let addClickLock = false;
// --- Debounce variables (qty/update/delete) ---
let qtyDebounce = null;
let deleteDebounce = null;

    function levenshtein(a, b) {
  a = a || ""; b = b || "";
  const m = a.length, n = b.length;
  if (m === 0) return n;
  if (n === 0) return m;
  const dp = Array.from({length: m+1}, () => new Array(n+1).fill(0));
  for (let i=0;i<=m;i++) dp[i][0] = i;
  for (let j=0;j<=n;j++) dp[0][j] = j;
  for (let i=1;i<=m;i++) {
    for (let j=1;j<=n;j++) {
      const cost = a[i-1] === b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(dp[i-1][j] + 1, dp[i][j-1] + 1, dp[i-1][j-1] + cost);
    }
  }
  return dp[m][n];
}

// Normalize text for comparison
function normalizeText(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, "")   // remove punctuation
    .replace(/\s+/g, " ")         // collapse spaces
    .trim();
}

// Map several synonyms / common variants to canonical form
const CANONICAL_MAP = {
  "starter": "Starters",
  "starters": "Starters",
  "startrer": "Starters",
  "snack": "Snacks",
  "snacks": "Snacks",
  "drink": "Drink",
  "drinks": "Drinks",
  "mocktail": "Mocktail",
  "mocktails": "Mocktails",
  "cocktail": "Cocktail",
  "cocktails": "Cocktails",
  "main course": "Main Course",
  "main": "Main Course",
  "maincourse": "Main Course",
  "sweets": "Sweets",
  "sweet": "Sweet",
  "dessert": "Dessert",
  "desserts": "Desserts"
};

// Return canonical name for a category string using map + fuzzy fallback
function canonicalCategory(raw, priorityListLower) {
  const norm = normalizeText(raw);
  if (!norm) return ""; // blank

  // direct map
  if (CANONICAL_MAP[norm]) return CANONICAL_MAP[norm];

  // singular/plural quick fix: strip trailing 's'
  if (norm.endsWith("s") && CANONICAL_MAP[norm.slice(0,-1)]) {
    return CANONICAL_MAP[norm.slice(0,-1)];
  }

  // fuzzy match against priority list and canonical map keys
  let best = {score: Infinity, key: null, target: null};

  // check known canonical keys (map keys)
  for (const key of Object.keys(CANONICAL_MAP)) {
    const d = levenshtein(norm, key);
    if (d < best.score) { best = {score: d, key, target: CANONICAL_MAP[key]}; }
  }

  // check priority list labels (lowercase versions)
  for (const label of priorityListLower) {
    const d = levenshtein(norm, label);
    if (d < best.score) { best = {score: d, key: label, target: label.split(" ").map(w=>w[0].toUpperCase()+w.slice(1)).join(" ")}; }
  }

  // if very close (threshold), accept fuzzy match
  if (best.score <= Math.max(1, Math.floor(Math.min(norm.length, (best.key||"").length) * 0.35))) {
    // return capitalized target (if target from priorityListLower, it might be lowercase)
    const t = best.target || best.key;
    // ensure Title Case
    return String(t).split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
  }

  // fallback: title-case the original normalized string
  return norm.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
}

// NEW populateCategoryDropdown — shows canonical categories (no duplicates from typos)

function populateCategoryDropdown(items) {
  const dropdown = document.getElementById("categoryFilter");
  dropdown.innerHTML = `<option value="">All Categories</option>`;

  // priority list (same as renderMenu)
  const categoryPriority = [
    "starters","snacks","drinks","mocktails","cocktails","main course","sweets","desserts"
  ];
  const priorityLower = categoryPriority.slice();

  // Build set of canonical categories
  const canonicalSet = new Set();
  items.forEach(i => {
    const can = canonicalCategory(i.category, priorityLower);
    if (can) canonicalSet.add(can);
  });

  // Sort canonical list using priority (known ones first in defined order, others alphabetic)
  const list = Array.from(canonicalSet);
  list.sort((a,b) => {
    const A = a.toLowerCase(), B = b.toLowerCase();
    const ai = priorityLower.indexOf(A);
    const bi = priorityLower.indexOf(B);
    if (ai !== -1 && bi !== -1) return ai - bi;
    if (ai !== -1) return -1;
    if (bi !== -1) return 1;
    return A.localeCompare(B);
  });

  list.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    dropdown.appendChild(opt);
  });
}

    

    let menuItems = [];
 
const API_BASE = "https://script.google.com/macros/s/AKfycbweWixBaVjgouORVVEQ2A39i7sLpphBxCh6WuXPmUtW_E6RmPDPu-S6jE6Xa6EVuYsNyw/exec";

function apiGet(api, params = {}) {
  const url = new URL(API_BASE);
  url.searchParams.set("api", api);

  Object.keys(params).forEach(k => 
    url.searchParams.set(k, params[k])
  );

  return fetch(url.toString(), {
    method: "GET",
    headers: { "Accept": "application/json" }
  }).then(res => res.json());
}
apiGet("getMenu")
  .then(res => {
    // ⭐ Add image field to each menu item
    res.menu = (res.menu || []).map(row => ({
      ...row,
      image: row["Image Url"] || row.image || row.Image || row.img || ""
   // auto-detect column
    }));
   window.menuItems = res.menu;
    renderMenu(res.menu);
  })
  .catch(err => console.error("Menu load error:", err));

// LOAD cat_allocation sheet
apiGet("getCatAllocations")
  .then(res => {
    window.cat_allocations = res.cat_allocations || [];
    console.log("Cat Allocations Loaded:", window.cat_allocations);
  })
  .catch(err => console.error("cat allocation load error:", err));

    apiGet("getRestaurantInfo")
  .then(res => {
    document.getElementById("restaurantName").innerHTML = "&#127860; " + res.name;
    document.getElementById("restaurantAddress").innerText = res.address;
 // NEW (store tax settings globally)
    restaurantTax.taxType        = res.taxType || "";
    restaurantTax.servicePercent = (res.servicePercent && res.servicePercent !== "NIL") ? Number(res.servicePercent) : 0;

    restaurantTax.cgstPercent    = Number(res.cgstPercent) || 0;
    restaurantTax.sgstPercent    = Number(res.sgstPercent) || 0;
    restaurantTax.igstPercent    = Number(res.igstPercent) || 0;

    console.log("Restaurant Tax Settings Loaded:", restaurantTax);
  
    })
  .catch(err => {
    console.error("Restaurant info load error:", err);
  });
function slugify(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/\s+/g, "-")
    .replace(/[^a-z0-9\-_]/g, "");
}


function renderMenu(items) {
  menuItems = items;

  // Auto-fill category dropdown (canonical)
  populateCategoryDropdown(items);

  const menuDiv = document.getElementById('menu');
  menuDiv.innerHTML = '';
let renderIndex = 0;
  // priority brain
  const categoryPriority = [
    "starters",
    "snacks",
    "drinks",
    "mocktails",
    "cocktails",
    "main course",
    "sweets",
    "desserts"
  ];

  // Build map: original raw category -> canonical
  const rawToCanonical = {};
  items.forEach(it => {
    const raw = (it.category || "").toString();
    rawToCanonical[raw] = canonicalCategory(raw, categoryPriority);
  });

  // Extract unique canonical categories (preserve order)
  let categoryOrder = [...new Set(
    Object.values(rawToCanonical).filter(c => c && c !== "")
  )];

  // Sort categoryOrder using priority (canonical lowercases)
  categoryOrder.sort((a,b) => {
    const A = a.toLowerCase(), B = b.toLowerCase();
    const ai = categoryPriority.indexOf(A);
    const bi = categoryPriority.indexOf(B);
    if (ai !== -1 && bi !== -1) return ai - bi;
    if (ai !== -1) return -1;
    if (bi !== -1) return 1;
    return A.localeCompare(B);
  });

  // ====== CHEF SPECIAL SECTION ======
  const chefSpecialItems = items.filter(i => {
    const val = (i.hotselling || i.Hotselling || "").toString().trim().toUpperCase();
    return val === "TRUE";
  });

  if (chefSpecialItems.length > 0) {
    const heading = document.createElement("h2");
    heading.classList.add("slideIn");
    heading.innerHTML = "Chef Special";
    heading.style.margin = "10px 0 5px";
    heading.style.padding = "10px";
    heading.style.background = "#ff6347";
    heading.style.color = "white";
    heading.style.borderRadius = "6px";
    heading.style.gridColumn = "1 / -1";
    menuDiv.appendChild(heading);

    chefSpecialItems.forEach(item => {
      item.itemId = item.itemId || item.ItemId || item.id || item.ID;

      const div = document.createElement("div");
      div.className = "menu-item fadeIn";

       div.innerHTML = buildMenuCardHTML(item, renderIndex);
  renderIndex++;
      menuDiv.appendChild(div);
      activateVariantSelector(item, renderIndex - 1);

    });
  }

  // ====== CATEGORY GROUPING ======
  categoryOrder.forEach(cat => {
    const group = items.filter(i => {
      const can = rawToCanonical[(i.category || "").toString()];
      return (can || "").toLowerCase() === cat.toLowerCase();
    });

    if (group.length > 0) {
      const heading = document.createElement("h2");
      heading.classList.add("slideIn");

      heading.innerHTML = cat;
      heading.style.margin = "10px 0 5px";
      heading.style.padding = "10px";
      heading.style.background = "#ff6347";
      heading.style.color = "white";
      heading.style.borderRadius = "6px";
      heading.style.gridColumn = "1 / -1";
      menuDiv.appendChild(heading);

      group.forEach(item => {
        item.itemId = item.itemId || item.ItemId || item.id || item.ID;

        const div = document.createElement('div');
        div.className = 'menu-item fadeIn';

         div.innerHTML = buildMenuCardHTML(item, renderIndex);
  renderIndex++;
        
        menuDiv.appendChild(div);
        activateVariantSelector(item, renderIndex - 1);
      });
    }
  });
}


function clearFilters() {
  document.getElementById("menuSearch").value = "";
  document.getElementById("categoryFilter").value = "";

  // Reset menu to original grouped view
  renderMenu(menuItems);
}
function rebuildCart() {

  // Read correct cart based on login state
  if (!isLoggedIn()) {
    cart = JSON.parse(localStorage.getItem("guestCart") || "[]");
  } else {
    cart = JSON.parse(localStorage.getItem("cart") || "[]");
  }

  cart = cart.map(item => {
    // quantity fix
    item.qty = Number(item.qty || item.quantity || 1);

    // rate fix
    item.rate = Number(item.rate || item.price || 0);

    // total recalc
    item.total = item.rate * item.qty;

    // discount recalc
    if (item.discPercent > 0) {
      item.discAmt = item.total * (item.discPercent / 100);
      item.netAmt = item.total - item.discAmt;
    } else {
      delete item.discAmt;
      delete item.netAmt;
    }

    return item;
  });

  // store updated clean cart (guest vs logged-in)
  if (!isLoggedIn()) {
    localStorage.setItem("guestCart", JSON.stringify(cart));
  } else {
    localStorage.setItem("cart", JSON.stringify(cart));
  }

  // rerender
  renderCart();
}

function addToCart(name, unit, rate, discPercent = 0, itemIdFromBtn = "", variantIdFromBtn = "") {
// --- Prevent spam clicking ---
if (addClickLock) return;
addClickLock = true;

setTimeout(() => addClickLock = false, 150);
  showCartOverlay("Adding item…");

  // STEP 1C – Normalize
  const cleanUnit = String(unit || "").trim().toLowerCase();
  const cleanName = String(name || "").trim().toLowerCase();
// Read correct cart based on login state
let stored;
if (!isLoggedIn()) {
  stored = JSON.parse(localStorage.getItem("guestCart") || "[]");
} else {
  stored = JSON.parse(localStorage.getItem("cart") || "[]");
}

  let itemId = "";
  let variantId = "";

  // STEP 1B — If button already passed correct IDs, use them
  if (itemIdFromBtn) {
    itemId = itemIdFromBtn;
    variantId = variantIdFromBtn || "";
} else {
    console.warn("FATAL: addToCart called WITHOUT itemIdFromBtn. Button must send correct IDs.");
    hideCartOverlay();
    return;
}


  // --------------------------------------------
  // Perfect merge logic using itemId + variantId
  const existing = stored.find(i => i.itemId == itemId && i.variantId == variantId);

  if (existing) {
    existing.qty = Number(existing.qty || 0) + 1;
    existing.total = parseFloat((existing.qty * existing.rate).toFixed(2));

    if (existing.discPercent > 0) {
      const discAmt = (existing.rate * existing.discPercent) / 100;
      existing.discAmt = parseFloat(discAmt.toFixed(2));
      existing.netAmt = parseFloat(((existing.rate - discAmt) * existing.qty).toFixed(2));
    } else {
      delete existing.discAmt;
      delete existing.netAmt;
    }
  }

  // NEW ITEM
  else {
      // Find exact menu item using itemId (best method)
    const menuItemFull = (window.menuItems || []).find(
  m => m.itemId == itemId
);

    const qty = 1;

    const total = rate * qty;
    const discAmt = (rate * discPercent) / 100;
    const netRate = rate - discAmt;

   
    let newItem = {
      name,
      unit,
      qty,
      rate: Number(rate),
      total: parseFloat(total.toFixed(2)),
      itemId,
      variantId,
      discPercent: Number(discPercent),
       image: menuItemFull?.image || ""
    };

    if (discPercent > 0) {
      newItem.discAmt = parseFloat(discAmt.toFixed(2));
      newItem.netAmt = parseFloat((netRate * qty).toFixed(2));
    }

    stored.push(newItem);
  }

  // SAVE to localStorage only
  // ⭐ Guest users MUST save here
if (!isLoggedIn()) {
    localStorage.setItem("guestCart", JSON.stringify(stored));
} else {
    localStorage.setItem("cart", JSON.stringify(stored));
}

  cart = stored;
  window.cart = stored;

  renderCart();

  // --------------------------------------------
 if (isLoggedIn()) {
  saveCartToBackend().finally(() => hideCartOverlay());
} else {
  hideCartOverlay();
}


  alert(`${name} (${unit}) added to cart`);
}




function renderCart() {
   console.log("Rendering Cart...");
   console.log(cart);

  const cartItemsContainer = document.querySelector('#cartItems');
cartItemsContainer.innerHTML = '';
  const thead = document.querySelector('#cartTable thead tr');
  
// ---- SUPER SANITIZER (Prevents render bugs) ----
cart = cart.map(item => {
   // ADD THIS FIX 
  const menuMatch = window.menuItems?.find(m => m.itemId == item.itemId);
  if (menuMatch) item.image = menuMatch.image;
  const menuItem = (window.menuItems || []).find(m => m.itemId == item.itemId);

  // 1) NAME FIX
  if (!item.name && menuItem?.name) item.name = menuItem.name;

  // 2) UNIT FIX (for Multi items)
  if (!item.unit) {
    const variant = (window.cat_allocations || []).find(v => v.variantId == item.variantId);
    if (variant) item.unit = variant.unit;
  }

  // 3) IMAGE FIX
  if (!item.image && menuItem?.image) item.image = menuItem.image;

  // 4) TYPE FIX (force correct numeric)
  item.qty = Number(item.qty || 1);
  item.rate = Number(item.rate || 0);
  item.discPercent = Number(item.discPercent || 0);

  // 5) TOTAL RECALC
  const discAmt = (item.rate * item.discPercent) / 100;
  item.discAmt = Number(discAmt.toFixed(2));

  const netRate = item.rate - item.discAmt;

  item.total = item.discPercent > 0 
    ? Number((netRate * item.qty).toFixed(2))
    : Number((item.rate * item.qty).toFixed(2));

  return item;
});

 // ⭐ SAVE sanitized image back to storage
if (!isLoggedIn()) {
  localStorage.setItem("guestCart", JSON.stringify(cart));
} else {
  localStorage.setItem("cart", JSON.stringify(cart));
}


  // ===== Check discount usage =====
  const anyDiscount = cart.some(i => Number(i.discPercent) > 0);

  // ===== Build header =====
  // ===== PERMANENT FULL HEADER (no flicker) =====
thead.innerHTML = `
  <th>Item</th>
  <th>Qty</th>
  <th>Rate (MRP)</th>
  <th class="col-disc">Disc %</th>
  <th class="col-disc">Disc Amt</th>
  <th class="col-disc">Net Amt</th>
  <th>Total</th>
  <th>Action</th>
`;
// ===== Hide / Show discount columns =====
const showDisc = cart.some(i => Number(i.discPercent) > 0);

  let grandTotal = 0;

  // ================================================
  //               BUILD CART TABLE ROWS
  // ================================================
  cart.forEach((item, idx) => {

    const rate = Number(item.rate);
    const qty  = Number(item.qty);
    const disc = Number(item.discPercent || 0);

    // fresh safe calculations
    const discAmt = parseFloat(((rate * disc) / 100).toFixed(2));
    const netRate = rate - discAmt;

    // FIX: for no discount → use MRP * qty
    const total = disc > 0 
      ? parseFloat((netRate * qty).toFixed(2))
      : parseFloat((rate * qty).toFixed(2));

    grandTotal += total;

    

const card = document.createElement("div");
card.className = "cart-card mb-3 p-4 bg-white rounded-lg shadow flex items-center justify-between gap-4"; // Added gap-4 and padding increased

card.innerHTML = `
<div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4 w-full">
 <img 
      src="${item.image || 'https://via.placeholder.com/60'}" 
      class="w-20 h-20 object-cover rounded-md"
    />

<div class="flex-1">
  <div class="font-semibold text-gray-800 leading-tight">${item.name} (${item.unit})</div>
   <div class="text-gray-500 text-sm">Rate: ₹${rate.toFixed(2)}</div>
   </div>
 ${disc > 0 ? `
   <div class="text-right text-sm text-gray-600 leading-tight">
    <div class="text-sm text-gray-500">Disc %: <span class="font-semibold">${disc}%</span></div>
    <div class="text-sm text-gray-500">Disc Amt: <span class="font-semibold">₹${discAmt.toFixed(2)}</span></div>
    <div class="text-sm text-gray-500">Net Rate: <span class="font-semibold">₹${netRate.toFixed(2)}</span></div>
  </div>
` : ""}
<div class="flex items-center gap-2">
    <div class="flex items-center gap-2">
  <button 
    onclick="updateQty(${idx}, ${qty - 1})" 
    class="w-8 h-8 flex items-center justify-center border rounded-full"
  >−</button>

  <div class="w-10 text-center font-semibold">${qty}</div>

  <button 
    onclick="updateQty(${idx}, ${qty + 1})" 
    class="w-8 h-8 flex items-center justify-center border border-gray-400 rounded-full text-xl"
  >+</button>
</div>

  </div>

 


 <div class="font-semibold text-lg text-gray-800">
  ₹${total.toFixed(2)}
</div>

 
  <button class="text-red-500" onclick="removeItem(${idx})">Delete</button>
`;
cartItemsContainer.appendChild(card);


  });

  // ===== FINAL TOTAL SET =====
  let baseTotal = parseFloat(grandTotal.toFixed(2));
  document.getElementById("cartTotal").innerText = baseTotal.toFixed(2);

  // TAX BLOCK unchanged
  let taxHtml = "";

  if (restaurantTax.taxType === "On Bill") {

    const serviceAmt = parseFloat(((baseTotal * restaurantTax.servicePercent) / 100).toFixed(2));
    const taxableAmount = parseFloat((baseTotal + serviceAmt).toFixed(2));

    const cgstAmt = parseFloat(((taxableAmount * restaurantTax.cgstPercent) / 100).toFixed(2));
    const sgstAmt = parseFloat(((taxableAmount * restaurantTax.sgstPercent) / 100).toFixed(2));
    const igstAmt = parseFloat(((taxableAmount * restaurantTax.igstPercent) / 100).toFixed(2));

    const grandTotalCalc = parseFloat((taxableAmount + cgstAmt + sgstAmt + igstAmt).toFixed(2));

    taxHtml = `
      ${restaurantTax.servicePercent > 0 
        ? `<p style="margin:2px 0;">Service Charges (${restaurantTax.servicePercent}%): ₹${serviceAmt.toFixed(2)}</p>`
        : ""
      }

      <p style="margin:2px 0;">CGST (${restaurantTax.cgstPercent}%): ₹${cgstAmt.toFixed(2)}</p>
      <p style="margin:2px 0;">SGST (${restaurantTax.sgstPercent}%): ₹${sgstAmt.toFixed(2)}</p>
      ${restaurantTax.igstPercent > 0 ? `<p style="margin:2px 0;">IGST (${restaurantTax.igstPercent}%): ₹${igstAmt.toFixed(2)}</p>` : ""}
      <div class="flex justify-between items-center mt-4">
  <div class="font-semibold text-lg text-gray-800">Grand Total</div>
  <div class="font-semibold text-lg text-red-500">₹${grandTotalCalc.toFixed(2)}</div>
</div>

    `;
  }

  const taxSummaryEl = document.getElementById("taxSummary");
  if (taxSummaryEl) taxSummaryEl.innerHTML = taxHtml;
}



function updateQty(index, qty) {

  clearTimeout(qtyDebounce);

  qtyDebounce = setTimeout(() => {

    qty = parseInt(qty);
    if (qty < 1) qty = 1;

    const item = cart[index];

    const rate = Number(item.rate);
    const disc = Number(item.discPercent || 0);

    const discAmt = parseFloat(((rate * disc) / 100).toFixed(2));
    const netRate = rate - discAmt;

    const total = disc > 0
      ? parseFloat((netRate * qty).toFixed(2))
      : parseFloat((rate * qty).toFixed(2));

    item.qty = qty;

    if (disc > 0) {
      item.discAmt = discAmt;
      item.netAmt  = parseFloat(netRate.toFixed(2));
    } else {
      delete item.discAmt;
      delete item.netAmt;
    }

    item.total = total;

    // SAVE LOCALLY
    if (!isLoggedIn()) {
      localStorage.setItem("guestCart", JSON.stringify(cart));
    } else {
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    renderCart();

    // BACKEND SYNC (safe & debounced)
    if (isLoggedIn()) {
      saveCartToBackend(); 
    }

  }, 200); // 200ms debounce

}

    function openCheckout() {
      if (cart.length === 0) {
        alert("Your cart is empty!");
        return;
      }
      document.getElementById('checkoutModal').style.display = 'flex';
    }

    function closeCheckout() {
      document.getElementById('checkoutModal').style.display = 'none';
    }
function deleteCart() {
  showCartOverlay("Clearing cart…");

  cart = [];

  if (!isLoggedIn()) {
    localStorage.removeItem("guestCart");
    renderCart();
    hideCartOverlay();
    return;
  }

  // Logged-in: clear only LOCAL mirror (NEVER delete backend)
  localStorage.setItem("cart", "[]");
  renderCart();

  hideCartOverlay();
}

function removeItem(index) {
 showCartOverlay();

  const item = cart[index];
  if (!item) {
    hideCartOverlay();
    return;
  }

  clearTimeout(deleteDebounce);

  deleteDebounce = setTimeout(() => {

    cart.splice(index, 1);

    // SAVE LOCALLY
    if (!isLoggedIn()) {
      localStorage.setItem("guestCart", JSON.stringify(cart));
    } else {
      localStorage.setItem("cart", JSON.stringify(cart));
    }

    renderCart();

    // BACKEND SYNC
    if (isLoggedIn()) {
    saveCartToBackend().finally(() => hideCartOverlay());
  } else {
    hideCartOverlay();
  }

  }, 150); // small debounce for delete

}


 function checkCustomerByMobile() {
  const mobile = document.getElementById('mobile').value.trim();

  // If mobile incomplete ? reset everything
  if (mobile.length !== 10) {

    // Reset Order Type
    const orderSelect = document.getElementById('orderType');
    orderSelect.value = ""; 
    orderSelect.style.display = "none"; 

    // Hide customer fields
    document.getElementById('customerName').style.display = "none";
    document.getElementById('email').style.display = "none";
    document.getElementById('address').style.display = "none";
    document.getElementById('paymentMethod').style.display = "none";
    document.getElementById('infoMsg').style.display = "none";

    return;
  }

  // When valid mobile ? show Order Type
  document.getElementById('orderType').style.display = "block";
}

function toggleAddressField() {
  const orderType = document.getElementById('orderType').value;
  if (!orderType) return;

  const mobile = document.getElementById('mobile').value.trim();
  if (!/^[0-9]{10}$/.test(mobile)) {
    alert("Enter a valid 10-digit mobile number first.");
    return;
  }

  const nameField = document.getElementById('customerName');
  const emailField = document.getElementById('email');
  const addressField = document.getElementById('address');
  const paymentField = document.getElementById('paymentMethod');
  const infoMsg = document.getElementById('infoMsg');
  const overlay = document.getElementById('loadingOverlay');

  // Show overlay while lookup is in progress
  overlay.style.display = "flex";

  // Disable only the Order Type select temporarily
  document.getElementById('orderType').disabled = true;

  // ?? New fetch API instead of google.script.run
  apiGet("getCustomerDetailsByMobile", { mobile })
    .then(data => {
      // Autofill if data exists
      nameField.value = data?.name || "";
      emailField.value = data?.email || "";
      addressField.value = data?.address || "";

      // Show customer fields
      nameField.style.display = "block";
      emailField.style.display = "block";

      // Show address only if Home Delivery
      if (orderType === "Home Delivery") {
        addressField.style.display = "block";
        addressField.required = true;
      } else {
        addressField.style.display = "none";
        addressField.required = false;
        addressField.value = "";
      }

      // Make fields editable
      nameField.readOnly = false;
      emailField.readOnly = false;
      addressField.readOnly = false;

      // Show Payment Method field
      paymentField.style.display = "block";

      // Warning message if found
      if (data && (data.name || data.email || data.address)) {
        alert("We have retrieved your previous details. Please review them carefully and update any information if necessary.");
      } else {
        infoMsg.style.display = "none";
      }

      // Hide overlay & enable order select
      overlay.style.display = "none";
      document.getElementById('orderType').disabled = false;
    })
    .catch(err => {
      console.error("Customer lookup error:", err);

      overlay.style.display = "none";
      document.getElementById('orderType').disabled = false;

      alert("Error loading customer details.");
    });
}
function placeOrder() {
  if (window._orderLock) return;
window._orderLock = true;

  const customerName = document.getElementById('customerName').value.trim();
  const email = document.getElementById('email').value.trim();
  const mobile = document.getElementById('mobile').value.trim();
  const orderType = document.getElementById('orderType').value;
  const address = document.getElementById('address').value.trim();
  const paymentMethod = document.getElementById('paymentMethod').value;

  if (!/^[0-9]{10}$/.test(mobile)) {
    alert("Enter a valid 10-digit mobile number");
    return;
  }
  if (orderType === "Home Delivery" && !address) {
    alert("Please enter delivery address");
    return;
  }

  // BASE TOTAL (without tax)
let baseTotal = parseFloat(document.getElementById('cartTotal').innerText);

// Defaults for "On Item"
let serviceAmt = 0;
let taxableAmount = baseTotal;
let cgstAmt = 0;
let sgstAmt = 0;
let igstAmt = 0;
let grandTotalFinal = baseTotal;

// If Tax_Type = "On Bill", then apply tax logic
if (restaurantTax.taxType === "On Bill") {

  // Service Charge
 serviceAmt =
  restaurantTax.servicePercent > 0
    ? parseFloat(((baseTotal * restaurantTax.servicePercent) / 100).toFixed(2))
    : 0;


  // Taxable amount = base + service charge
  taxableAmount = parseFloat((baseTotal + serviceAmt).toFixed(2));

  // CGST
  cgstAmt = parseFloat(((taxableAmount * restaurantTax.cgstPercent) / 100).toFixed(2));

  // SGST
  sgstAmt = parseFloat(((taxableAmount * restaurantTax.sgstPercent) / 100).toFixed(2));

  // IGST
  igstAmt = parseFloat(((taxableAmount * restaurantTax.igstPercent) / 100).toFixed(2));

  // FINAL GRAND TOTAL
  grandTotalFinal = parseFloat((taxableAmount + cgstAmt + sgstAmt + igstAmt).toFixed(2));
}

// FINAL AMOUNT TO SAVE / SEND TO SHEET
const totalAmount = grandTotalFinal;


  const orderData = {
  customerName,
  email,
  mobile,
  orderType,
  address,
  cartItems: cart,

  // BASE totals
  baseTotal,
  serviceAmt,
  taxableAmount,
  cgstAmt,
  sgstAmt,
  igstAmt,
  grandTotal: grandTotalFinal,

  paymentMethod
};


  // ?? Show overlay & lock UI
  const overlay = document.getElementById('loadingOverlay');
  overlay.innerText = "Processing your order... Please wait...";
  overlay.style.display = "flex";

  document.querySelectorAll('#checkoutForm input, #checkoutForm select, #checkoutForm button')
    .forEach(el => el.disabled = true);

  // ?? REPLACEMENT (fetch API instead of google.script.run)
  apiPost("placeOrder", orderData)
    .then(res => {
      if (res.success) {
        alert(
          `Order placed successfully!\nYour Order Number: ${res.orderNumber}\n\n${res.message}`
        );
        cart = [];
         localStorage.removeItem("cart");
        renderCart();
        
        closeCheckout();
      } else {
        alert(res.message || "Order failed.");
      }

      // Unlock UI
      overlay.style.display = "none";
      document.querySelectorAll('#checkoutForm input, #checkoutForm select, #checkoutForm button')
        .forEach(el => el.disabled = false);
    })
    .catch(err => {
      console.error("Order error:", err);
      alert("Error placing order. Please try again.");

      overlay.style.display = "none";
      document.querySelectorAll('#checkoutForm input, #checkoutForm select, #checkoutForm button')
        .forEach(el => el.disabled = false);
    });
  window._orderLock = false;

}

function filterMenu() {
  const text = document.getElementById("menuSearch").value.toLowerCase();
  const selected = document.getElementById("categoryFilter").value; // note: keep original case (Title Case)

  // priority list - same as renderMenu/populateCategoryDropdown
  const categoryPriority = [
    "starters",
    "snacks",
    "drinks",
    "mocktails",
    "cocktails",
    "main course",
    "sweets",
    "desserts"
  ];

  // Step 1: canonical category detect (PASS priority list)
  let filtered = menuItems.map(i => ({
    ...i,
    canonical: canonicalCategory(i.category, categoryPriority).toLowerCase()
  }));

  // Step 2: Apply category filter (if selected not empty)
  if (selected && selected.trim() !== "") {
    const selLower = selected.toLowerCase();
    filtered = filtered.filter(i => i.canonical === selLower);
  }

  // Step 3: Apply text filter
  if (text.trim() !== "") {
    const q = text.trim();
    filtered = filtered.filter(i =>
      (String(i.name || "").toLowerCase().includes(q)) ||
      (i.description && String(i.description).toLowerCase().includes(q))
    );
  }

  // If no filter ? show full grouped menu (reuse renderMenu)
  if ((!selected || selected === "") && text.trim() === "") {
    renderMenu(menuItems);
    return;
  }

  const menuDiv = document.getElementById("menu");
  menuDiv.innerHTML = "";

  if (filtered.length === 0) {
    menuDiv.innerHTML = "<p style='padding:10px;'>No items found.</p>";
    return;
  }

  // Step 4: Group filtered results by canonical category (preserve ordering by priority)
  const groups = {};
  filtered.forEach(item => {
    const cat = item.canonical || "Other";
    if (!groups[cat]) groups[cat] = [];
    groups[cat].push(item);
  });

  // Build order: priority first, then alphabetic
  const groupKeys = Object.keys(groups);
  groupKeys.sort((a,b) => {
    const ai = categoryPriority.indexOf(a);
    const bi = categoryPriority.indexOf(b);
    if (ai !== -1 && bi !== -1) return ai - bi;
    if (ai !== -1) return -1;
    if (bi !== -1) return 1;
    return a.localeCompare(b);
  });

  // Step 5: Render groups using buildMenuCardHTML + activateVariantSelector
  groupKeys.forEach(cat => {
    const heading = document.createElement("h2");
    heading.classList.add("slideIn");
    // Title case heading
    heading.innerHTML = cat.replace(/\b\w/g, c => c.toUpperCase());
    heading.style.margin = "10px 0 5px";
    heading.style.padding = "10px";
    heading.style.background = "#ff6347";
    heading.style.color = "white";
    heading.style.borderRadius = "6px";
    heading.style.gridColumn = "1 / -1";
    menuDiv.appendChild(heading);

    groups[cat].forEach(item => {
      const div = document.createElement("div");
      div.className = "menu-item fadeIn";

      // Use the same card builder as the main view (handles Single / Multi)
      div.innerHTML = buildMenuCardHTML(item);
      menuDiv.appendChild(div);

      // Activate variant selector if item is multi (so radio -> button enabling works)
      try {
        activateVariantSelector(item);
      } catch (e) {
        // fail-safe: don't break UI on JS errors
        console.error("activateVariantSelector error:", e);
      }
    });
  });
}


  </script>
<div id="loginProgressOverlay"
     class="fixed inset-0 bg-black bg-opacity-40 z-[10000] hidden 
            flex items-center justify-center text-white text-xl font-semibold">
  Login in progress…
</div>


  <div id="loadingOverlay" style="
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 24px;
  ">
    Processing your order...
  </div>

<div id="fpOverlay" style="
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.4);
  z-index:9999;
  color:white;
  font-size:22px;
  align-items:center;
  justify-content:center;
">
  Sending OTP...
</div>

<!-- LOGIN OVERLAY (NEW TAILWIND VERSION) -->
<div id="loginModal"
  class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center">

  <div class="bg-white w-11/12 max-w-sm rounded-xl p-6 shadow-lg relative">

    <!-- Close -->
    <button onclick="closeLogin()"
      class="absolute top-3 right-3 text-gray-600 text-2xl font-semibold">
      &times;
    </button>

    <h2 class="text-xl font-semibold text-gray-800 text-center mb-6">
      Login to Continue
    </h2>

    <!-- Mobile -->
    <input id="loginMobile" type="tel" maxlength="10"
      placeholder="Enter Mobile Number"
      class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-3 focus:ring focus:ring-orange-300" />

    <!-- Password -->
    <input id="loginPassword" type="password"
      placeholder="Enter Password"
      class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:ring focus:ring-orange-300" />

    <!-- Login Button -->
    <button onclick="loginUser()"
      class="w-full bg-orange-500 text-white py-2 rounded-lg font-medium hover:bg-orange-600">
      Login
    </button>

  </div>
</div>



<!-- FORGOT PASSWORD MODAL -->
<div id="forgotPasswordModal"
     class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center">
  <div class="bg-white w-11/12 max-w-sm rounded-xl p-6 shadow-lg text-center">


    <h2 style="font-size:18px;color:#333;margin-bottom:10px;">
      Reset Your Password
    </h2>

    <input type="tel" id="fpMobile" placeholder="Enter Mobile Number"
           maxlength="10"
           style="margin-bottom:10px;">

    <button onclick="sendResetOTP()">Send OTP</button>

    <input type="text" id="fpOTP" placeholder="Enter OTP"
           style="display:none;margin-top:10px;">

    <input type="password" id="fpNewPass" placeholder="Enter New Password"
           style="display:none;margin-top:10px;">

    <button id="resetBtn" onclick="resetPassword()" 
            style="display:none;margin-top:10px;">
      Update Password
    </button>

    <button onclick="closeForgotPassword()" 
            style="margin-top:15px;padding:8px 12px;background:#444;
                   color:#fff;border:none;border-radius:6px;">
      Close
    </button>
  </div>
</div>

<!-- SIGNUP MODAL (simple welcome text) -->
<div id="signupModal"
     class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center">
  <div class="bg-white w-11/12 max-w-md rounded-xl p-6 shadow-lg">

    <h2>Welcome User</h2>

    <p style="font-size:14px;color:#555;margin-top:10px;">
      This is a test signup window.  
      No backend code is triggered.
    </p>

      <input type="text" id="suMobile" placeholder="Mobile">

    <input type="password" id="suPassword" placeholder="Password">

    <input type="text" id="suName" placeholder="Name">

    <input type="email" id="suEmail" placeholder="Email">

<button type="button" onclick="sendEmailOTP()">Send OTP</button>

<input type="text" id="suEmailOTP" placeholder="Enter Email OTP">

   <textarea id="suAddress" placeholder="Address"></textarea>
   <!-- NEW PINCODE FIELD -->
<select id="suPincode" onchange="onPincodeSelect()">
  <option value="">Select Pincode</option>
</select>

   <input type="text" id="suCity" placeholder="City" readonly>

    <!-- STATE (Auto-filled) -->
    <input type="text" id="suState" placeholder="State" readonly>

    <button onclick="verifyAndSignup()">Submit</button>
    <button onclick="closeSignup()">Close</button>
  </div>
</div>

<script>

//open login
function openLogin() {
  const modal = document.getElementById("loginModal");
  modal.classList.remove("hidden");
}

function closeLogin() {
  const modal = document.getElementById("loginModal");
  modal.classList.add("hidden");
}


function logoutUser() {
  // UI resets
  document.getElementById("userInfoBox").style.display = "none";
  document.getElementById("loggedEmail").innerText = "";

  document.querySelector("button[onclick='openLogin()']").style.display = "inline-block";
  document.querySelector("button[onclick='openSignup()']").style.display = "inline-block";

  document.getElementById("logoutBtn").style.display = "none";
  document.getElementById("signupLabelBox").style.display = "block";
  document.getElementById("hamburgerBtn").style.display = "none";

  document.getElementById("leftNav").style.display = "none";

  document.getElementById("menuWrapper").style.display = "block";
  document.getElementById("pageWrapper").style.display = "none";

  document.getElementById("profilePage").style.display = "none";
  document.getElementById("ordersPage").style.display = "none";
  document.getElementById("offersPage").style.display = "none";

  document.querySelectorAll("#premiumMenu li").forEach(li => li.classList.remove("active"));
  document.getElementById("mainContent").style.marginLeft = "0";

  // Remove login identifiers
  localStorage.removeItem("userMobile");
  localStorage.removeItem("userEmail");

  // MOST IMPORTANT (Cart Behave Rule)
  // ❗ Clear only local cart, NOT backend cart
  localStorage.removeItem("cart");   // remove local mirror
  cart = [];
  window.cart = [];

  // ❗ Clear sessionId (start fresh next login)
  localStorage.removeItem("sessionId");

  // Refresh cart UI
  renderCart();

  alert("Logged out successfully.");
}


</script>
<script>
let cityList = []; // map sheet data store

function openSignup() {
  document.getElementById("signupModal").style.display = "flex";

  // Load city/pincode list only once
  if (cityList.length === 0) {
    apiGet("getCityList")
      .then(res => fillPincodeDropdown(res.cities))
      .catch(err => {
        console.error("City list load error:", err);
        alert("Failed to load city/pincode list.");
      });
  }
}




function closeSignup() {
  document.getElementById("signupModal").style.display = "none";
}

function fillPincodeDropdown(list) {
  cityList = list;

  const ddl = document.getElementById("suPincode");
  ddl.innerHTML = `<option value="">Select Pincode</option>`;

  list.forEach(item => {
    const opt = document.createElement("option");
    opt.value = item.pin;
    opt.textContent = item.pin;
    ddl.appendChild(opt);
  });
}

function onPincodeSelect() {
  const pin = document.getElementById("suPincode").value;
  const cityBox = document.getElementById("suCity");
  const stateBox = document.getElementById("suState");

  if (!pin) {
    cityBox.value = "";
    stateBox.value = "";
    return;
  }

  const record = cityList.find(r => String(r.pin) === String(pin));

  if (record) {
    cityBox.value = record.city;
    stateBox.value = record.state;
  } else {
    cityBox.value = "";
    stateBox.value = "";
    alert("Pincode not found.");
  }
}

function finalSignup() {
  const user = {
    mobile: document.getElementById("suMobile").value.trim(),
    password: document.getElementById("suPassword").value.trim(),
    name: document.getElementById("suName").value.trim(),
    email: document.getElementById("suEmail").value.trim(),
    address: document.getElementById("suAddress").value.trim(),
    pincode: document.getElementById("suPincode").value.trim(),
    city: document.getElementById("suCity").value.trim(),
    state: document.getElementById("suState").value.trim()
  };

  // BASIC VALIDATIONS
  if (!/^[0-9]{10}$/.test(user.mobile)) {
    alert("Enter valid 10-digit mobile.");
    return;
  }
  if (!user.password) return alert("Enter password");
  if (!user.name) return alert("Enter name");
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(user.email)) {
    alert("Enter valid email.");
    return;
  }
  if (user.pincode.length !== 6) {
    alert("Enter valid 6-digit pincode.");
    return;
  }
  if (!user.city || !user.state) {
    alert("Invalid pincode area.");
    return;
  }

  // FORM ALREADY LOCKED BY verifyAndSignup()
  // ? DO NOT CALL lockSignupForm() AGAIN
  updateSignupOverlayMessage("Creating account...");

  // ? CORRECT POST REQUEST
  fetch(API_BASE + "?api=registerUser", {
    method: "POST",
     body: JSON.stringify(user)
  })
    .then(r => {
      // If server returned non-JSON ? avoid crash
      if (!r.ok) throw new Error("Server error " + r.status);
      return r.json();
    })
    .then(res => {
      unlockSignupForm();

      if (res.success) {
        alert(res.message || "Signup successful!");
        closeSignup();
      } else {
        alert(res.message || "Signup failed.");
      }
    })
    .catch(err => {
      unlockSignupForm();
      alert("Signup failed: " + err.message);
    });
}


function lockSignupForm() {
  const modal = document.querySelector("#signupModal .modal-content");

  // Disable all fields inside modal
  [...modal.querySelectorAll("input, select, textarea, button")].forEach(el => {
    el.disabled = true;
  });

  // Overlay
  const overlay = document.createElement("div");
  overlay.id = "signupProgressOverlay";
  overlay.style.position = "fixed";
  overlay.style.inset = "0";
  overlay.style.background = "rgba(0,0,0,0.35)";
  overlay.style.display = "flex";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.fontSize = "22px";
  overlay.style.color = "#fff";
  overlay.style.zIndex = "9999";
  overlay.textContent = "Signup in progress…";
  document.body.appendChild(overlay);
}
function unlockSignupForm() {
  const modal = document.querySelector("#signupModal .modal-content");

  // Enable everything
  [...modal.querySelectorAll("input, select, textarea, button")].forEach(el => {
    el.disabled = false;
  });

  // Remove overlay
  const overlay = document.getElementById("signupProgressOverlay");
  if (overlay) overlay.remove();
}

function sendEmailOTP() {
  const email = document.getElementById("suEmail").value.trim();

  if (!email) {
    alert("Please enter email first.");
    return;
  }

  // ?? lock UI while sending OTP
  lockSignupForm();
  updateSignupOverlayMessage("Sending OTP...");

  // ? GAS ? Netlify API call conversion
  apiGet("sendSignupEmailOTP", { email })
    .then(res => {
      unlockSignupForm();

      if (res.success) {
        alert("OTP sent to your email!");
      } else {
        alert(res.message);
      }
    })
    .catch(err => {
      unlockSignupForm();
      alert("Error sending OTP: " + err.message);
    });
}

function verifyAndSignup() {
  const email = document.getElementById("suEmail").value.trim();
  const otp = document.getElementById("suEmailOTP").value.trim();

  if (!otp) {
    alert("Please enter OTP.");
    return;
  }

  // ?? LOCK UI + show overlay "Verifying OTP..."
  lockSignupForm();
  updateSignupOverlayMessage("Verifying OTP...");

  // ? Netlify API CALL (GAS ?????)
  apiGet("verifyEmailOTP", { email, otp })
    .then(res => {
      if (!res.success) {
        unlockSignupForm();
        alert(res.message);
        return;
      }

      // OTP verified ? show next message
      updateSignupOverlayMessage("Creating Account...");

      // Now create new user
      finalSignup();
    })
    .catch(err => {
      unlockSignupForm();
      alert("OTP verification failed: " + err.message);
    });
}

 
function updateSignupOverlayMessage(msg) {
  const overlay = document.getElementById("signupProgressOverlay");
  if (overlay) overlay.textContent = msg;
}

// === FINAL STABLE LOAD HANDLER ===
window.addEventListener("load", () => {


  // clear login fields
  const loginMobile = document.getElementById("loginMobile");
  const loginPassword = document.getElementById("loginPassword");
  if (loginMobile) loginMobile.value = "";
  if (loginPassword) loginPassword.value = "";

  const mobile = localStorage.getItem("userMobile");
  const email  = localStorage.getItem("userEmail");
  //  LOAD USER CART FROM BACKEND IF LOGGED IN


  // Always reset full UI first
  document.getElementById("menuWrapper").style.display = "block";
  document.getElementById("pageWrapper").style.display = "none";

  document.getElementById("profilePage").style.display = "none";
  document.getElementById("ordersPage").style.display = "none";
  document.getElementById("offersPage").style.display = "none";

  document.getElementById("leftNav").classList.remove("active");
  document.getElementById("leftNav").style.display = "none";
  document.getElementById("mainContent").style.marginLeft = "0";

  document.getElementById("hamburgerBtn").style.display = "none";
  document.getElementById("logoutBtn").style.display = "none";
  document.getElementById("userInfoBox").style.display = "none";

  document.querySelector("button[onclick='openLogin()']").style.display = "inline-block";
  document.querySelector("button[onclick='openSignup()']").style.display = "inline-block";
  document.getElementById("signupLabelBox").style.display = "block";

  // ----- if logged in -----
  if (mobile) {

    // Show user info
    document.getElementById("loggedEmail").innerText = email || "";
    document.getElementById("userInfoBox").style.display = "block";

    // Hide login/signup
    document.querySelector("button[onclick='openLogin()']").style.display = "none";
    document.querySelector("button[onclick='openSignup()']").style.display = "none";
    document.getElementById("signupLabelBox").style.display = "none";

    // Show nav + hamburger
    document.getElementById("leftNav").style.display = "block";
    document.getElementById("hamburgerBtn").style.display = "block";
    document.getElementById("logoutBtn").style.display = "inline-block";

    // Always show menu page after refresh
    showPage("menuPage");

    // highlight first item
    const firstMenu = document.querySelector("#premiumMenu li");
    if (firstMenu) firstMenu.classList.add("active");
  }
   loadUserCartOnStart();
});

function validateLoginMobile() {
  const input = document.getElementById("loginMobile");
  const error = document.getElementById("mobileError");

  const original = input.value;          // User typed value
  const digitsOnly = original.replace(/\D/g, "");  // Remove letters

  // Update field to digits only
  input.value = digitsOnly;

  //  If user typed any non-digit (abcd etc.)
  if (original !== digitsOnly) {
    error.style.display = "block";
    error.innerText = "Please enter only mobile numbers. Letters are not allowed.";
    return;
  }

  //  Less than 10 digits but typed correctly
  if (digitsOnly.length > 0 && digitsOnly.length < 10) {
    error.style.display = "block";
    error.innerText = "Please enter a valid 10-digit mobile number.";
    return;
  }

  //  Exactly 10 digits ? no warning
  if (digitsOnly.length === 10) {
    error.style.display = "none";
    return;
  }

  //  Empty field ? hide error
  error.style.display = "none";
}

function lockLoginForm() {
  document.querySelectorAll("#loginModal input, #loginModal button")
    .forEach(el => el.disabled = true);

  document.getElementById("loginProgressOverlay").classList.remove("hidden");
}


function unlockLoginForm() {
  document.querySelectorAll("#loginModal input, #loginModal button")
    .forEach(el => el.disabled = false);

  document.getElementById("loginProgressOverlay").classList.add("hidden");
}



function openForgotPassword() {
  document.getElementById("forgotPasswordModal").style.display = "flex";
}

function closeForgotPassword() {
  document.getElementById("forgotPasswordModal").style.display = "none";

  // Reset fields
  document.getElementById("fpMobile").value = "";
  document.getElementById("fpOTP").value = "";
  document.getElementById("fpNewPass").value = "";

  // Hide OTP and Password fields
  document.getElementById("fpOTP").style.display = "none";
  document.getElementById("fpNewPass").style.display = "none";
  document.getElementById("resetBtn").style.display = "none";
}

// STEP 1: SEND OTP
function sendResetOTP() {
  const mobile = document.getElementById("fpMobile").value.trim();

  if (!/^[0-9]{10}$/.test(mobile)) {
    alert("Please enter valid 10-digit mobile.");
    return;
  }

  // SHOW OVERLAY + LOCK UI
  document.getElementById("fpOverlay").style.display = "flex";
  lockForgotForm();
  updateForgotOverlay("Sending OTP...");

  // ? Netlify GET API call
  apiGet("sendPasswordResetOTP", { mobile })
    .then(res => {
      document.getElementById("fpOverlay").style.display = "none";
      unlockForgotForm();

      if (res.success) {
        alert("OTP sent successfully!");

        // show hidden fields
        document.getElementById("fpOTP").style.display = "block";
        document.getElementById("fpNewPass").style.display = "block";
        document.getElementById("resetBtn").style.display = "block";
      } else {
        alert(res.message);
      }
    })
    .catch(err => {
      document.getElementById("fpOverlay").style.display = "none";
      unlockForgotForm();
      alert("Error: " + err.message);
    });
}


// STEP 2: RESET PASSWORD
function resetPassword() {
  const mobile = document.getElementById("fpMobile").value.trim();
  const otp = document.getElementById("fpOTP").value.trim();
  const newPass = document.getElementById("fpNewPass").value.trim();

  if (!otp) {
    alert("Enter OTP.");
    return;
  }
  if (!newPass) {
    alert("Enter new password.");
    return;
  }

  // SHOW OVERLAY + LOCK UI
  document.getElementById("fpOverlay").style.display = "flex";
  lockForgotForm();
  updateForgotOverlay("Updating password...");

  // ? Netlify POST API
  apiPost("resetPassword", { mobile, otp, newPass })
    .then(res => {
      document.getElementById("fpOverlay").style.display = "none";
      unlockForgotForm();

      if (res.success) {
        alert("Password updated successfully!");
        closeForgotPassword();
      } else {
        alert(res.message);
      }
    })
    .catch(err => {
      document.getElementById("fpOverlay").style.display = "none";
      unlockForgotForm();
      alert("Error: " + err.message);
    });
}


function lockForgotForm() {
  const modal = document.querySelector("#forgotPasswordModal .modal-content");
  [...modal.querySelectorAll("input, button")].forEach(el => el.disabled = true);
}

function unlockForgotForm() {
  const modal = document.querySelector("#forgotPasswordModal .modal-content");
  [...modal.querySelectorAll("input, button")].forEach(el => el.disabled = false);
}

function updateForgotOverlay(msg) {
  document.getElementById("fpOverlay").textContent = msg;
}
function showPage(pageId) {
  // Always hide both wrappers first
  document.getElementById("menuWrapper").style.display = "none";
  document.getElementById("pageWrapper").style.display = "none";

  // Hide all inner pages
  document.getElementById("profilePage").style.display = "none";
  document.getElementById("ordersPage").style.display = "none";
  document.getElementById("offersPage").style.display = "none";

  // Show requested
  if (pageId === "menuPage") {
    document.getElementById("menuWrapper").style.display = "block";
  } else {
    document.getElementById("pageWrapper").style.display = "block";
    document.getElementById(pageId).style.display = "block";
  }
}



function activateMenu(element) {
  document.querySelectorAll("#premiumMenu li").forEach(li => li.classList.remove("active"));
  element.classList.add("active");
}

function toggleSidebar() {
  const sidebar = document.getElementById("leftNav");
  const menuBtn = document.getElementById("hamburgerBtn");
  const main = document.getElementById("mainContent");

  // Sidebar hidden ? open
  if (!sidebar.classList.contains("active")) {
    sidebar.classList.add("active");
    main.style.marginLeft = "220px";
    menuBtn.innerHTML = `
<svg width="22" height="22">
  <path d="M4 4 L20 20 M20 4 L4 20" stroke="#FFD166" stroke-width="3"/>
</svg>`;

  } 
  else {
    // close sidebar
    sidebar.classList.remove("active");
    main.style.marginLeft = "0";
    menuBtn.innerHTML = `
<svg width="24" height="24" fill="#FFD166">
  <rect y="4" width="24" height="3"></rect>
  <rect y="10" width="24" height="3"></rect>
  <rect y="16" width="24" height="3"></rect>
</svg>`;


  }
}
function loadUserProfile() {
  const mobile = localStorage.getItem("userMobile");

  if (!mobile) {
    alert("Session expired. Please login again.");
    return;
  }

  // ? SHOW SIMPLE LOADING TEXT
  document.getElementById("profileLoading").style.display = "block";

  // ? Netlify API replacement
  apiGet("getUserProfile", { mobile })
    .then(res => {
      document.getElementById("profileLoading").style.display = "none";

      if (!res.success) {
        alert("User not found");
        return;
      }

      fillProfileForm(res);
    })
    .catch(err => {
      document.getElementById("profileLoading").style.display = "none";
      alert("Failed: " + err.message);
    });
}
function loadUserOrders() {
  const mobile = localStorage.getItem("userMobile");
  if (!mobile) {
    alert("Session expired. Please login again.");
    return;
  }
  // ? SHOW SIMPLE LOADING TEXT
  document.getElementById("ordersLoading").style.display = "block";
  // ? Netlify API replacement
  apiGet("getUserOrders", { mobile })
    .then(res => {
      document.getElementById("ordersLoading").style.display = "none";
      if (!res.success) {
        alert("No orders found");
        return;
      }
      fillOrdersList(res.orders);
    })
    .catch(err => {
      document.getElementById("ordersLoading").style.display = "none";
      alert("Failed: " + err.message);
    });
}
function loadOffers() {
  // ? SHOW SIMPLE LOADING TEXT
  document.getElementById("offersLoading").style.display = "block";
  // ? Netlify API replacement
  apiGet("getOffers", {})
    .then(res => {
      document.getElementById("offersLoading").style.display = "none";
      if (!res.success) {
        alert("No offers available");
        return;
      }
      fillOffersList(res.offers);
    })
    .catch(err => {
      document.getElementById("offersLoading").style.display = "none";
      alert("Failed: " + err.message);
    });
}

function fillProfileForm(res) {
  document.getElementById("profileLoading").style.display = "none";

  if (!res.success) {
    alert("User not found");
    return;
  }

  // Autofill
  document.getElementById("pName").value = res.name || "";
  document.getElementById("pMobile").value = res.mobile || "";
  document.getElementById("pEmail").value = res.email || "";
  document.getElementById("pAddress").value = res.address || "";
   document.getElementById("ppin").value = res.pincode || "";
  document.getElementById("pCity").value = res.city || "";
  document.getElementById("pState").value = res.state || "";
  setProfileReadonly(true);
}
function showProfilePage() {
  hideAllPages();
  document.getElementById("profilePage").style.display = "block";
  loadUserProfile();   // ? profile load karo
}

function setProfileReadonly(state) {
  document.getElementById("pName").readOnly = state;
  document.getElementById("pEmail").readOnly = state;
  document.getElementById("pAddress").readOnly = state;
  document.getElementById("ppin").readOnly = state;
  document.getElementById("pCity").readOnly = state;
  document.getElementById("pState").readOnly = state;

  // Mobile never editable
  document.getElementById("pMobile").disabled = true;
}
function enableProfileEdit() {
  setProfileReadonly(false);

  document.getElementById("editBtn").style.display = "none";
  document.getElementById("saveBtn").style.display = "inline-block";
  document.getElementById("cancelBtn").style.display = "inline-block";
}
function cancelProfileEdit() {
  loadUserProfile();   // reload original values
  document.getElementById("editBtn").style.display = "inline-block";
  document.getElementById("saveBtn").style.display = "none";
  document.getElementById("cancelBtn").style.display = "none";
}

function saveProfile() {
  const data = {
    mobile: document.getElementById("pMobile").value.trim(),
    name: document.getElementById("pName").value.trim(),
    email: document.getElementById("pEmail").value.trim(),
    address: document.getElementById("pAddress").value.trim(),
    pincode: document.getElementById("ppin").value.trim(),
    city: document.getElementById("pCity").value.trim(),
    state: document.getElementById("pState").value.trim()
  };

  if (!data.name) return alert("Name cannot be empty");
  if (!data.email) return alert("Email cannot be empty");
  if (data.pincode.length !== 6) return alert("Enter valid 6-digit pincode");

  // ? Show overlay
  document.getElementById("profileOverlay").classList.add("active");

  // Disable buttons
  document.getElementById("editBtn").disabled = true;
  document.getElementById("saveBtn").disabled = true;
  document.getElementById("cancelBtn").disabled = true;

  // ? Netlify POST request
  apiPost("updateUserProfile", data)
    .then(res => {
      document.getElementById("profileOverlay").classList.remove("active");

      // Re-enable buttons
      document.getElementById("editBtn").disabled = false;
      document.getElementById("saveBtn").disabled = false;
      document.getElementById("cancelBtn").disabled = false;

      if (res.success) {
        alert("Profile updated successfully!");
        loadUserProfile();

        document.getElementById("editBtn").style.display = "inline-block";
        document.getElementById("saveBtn").style.display = "none";
        document.getElementById("cancelBtn").style.display = "none";
      } else {
        alert(res.message);
      }
    })
    .catch(err => {
      document.getElementById("profileOverlay").classList.remove("active");
      alert("Error: " + err.message);
    });
}


</script>
<script>
let deferredPrompt;

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;

  // Show button
  document.getElementById("installBtn").style.display = "block";
});

// When user clicks install button
document.getElementById("installBtn").addEventListener("click", async () => {
  if (!deferredPrompt) return;

  deferredPrompt.prompt();

  const result = await deferredPrompt.userChoice;

  if (result.outcome === "accepted") {
    alert("App installed successfully!");
  }

  deferredPrompt = null;

  // Hide button after install
  document.getElementById("installBtn").style.display = "none";
});

// Hide button if already installed
window.addEventListener("appinstalled", () => {
  document.getElementById("installBtn").style.display = "none";
});
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')

    .then(reg => {
      console.log('SW Registered on Netlify');

      // SAME UPDATE CHECK SYSTEM
      reg.addEventListener("updatefound", () => {
        const newWorker = reg.installing;
        newWorker.addEventListener("statechange", () => {
          if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
            if (confirm("A new version of the app is available. Update now?")) {
              window.location.reload();
            }
          }
        });
      });

    })
    .catch(err => {
      console.error('SW Failed:', err);
    });
}
</script>
<script>
async function loginUser() {
  const mobile = document.getElementById("loginMobile").value.trim();
  const password = document.getElementById("loginPassword").value.trim();

  if (!/^[0-9]{10}$/.test(mobile)) {
    alert("Enter valid 10-digit mobile.");
    return;
  }

  lockLoginForm();

  apiPost("login", { mobile, password })
    .then(async res => {   // <-- make this async
      unlockLoginForm();

      if (!res.success) {
        alert(res.message || "Login failed.");
        return;
      }

      // 1️⃣ Save identity FIRST (IMPORTANT)
      localStorage.setItem("userMobile", mobile);
      localStorage.setItem("userEmail", res.email || "");

      // 2️⃣ Update UI email immediately
      document.getElementById("loggedEmail").innerText = res.email || "";

      // 3️⃣ NOW do cart merge (MUST happen AFTER email saved)
      await onUserLogin(mobile);

      // 4️⃣ UI panel updates
      document.getElementById("userInfoBox").style.display = "block";

      document.querySelector("button[onclick='openLogin()']").style.display = "none";
      document.querySelector("button[onclick='openSignup()']").style.display = "none";
      document.getElementById("signupLabelBox").style.display = "none";

      document.getElementById("logoutBtn").style.display = "inline-block";
      document.getElementById("hamburgerBtn").style.display = "block";
      document.getElementById("leftNav").style.display = "block";

      closeLogin();
    })
    .catch(err => {
      unlockLoginForm();
      alert("Login error: " + err.message);
    });
}


  function openMenuPageProperly(el) {
  activateMenu(el);
  hideAllPages();
  document.getElementById("menuWrapper").style.display = "block";
}


</script>
<script>
function hideAllPages() {
  document.getElementById("menuWrapper").style.display = "none";
  document.getElementById("profilePage").style.display = "none";
  document.getElementById("ordersPage").style.display = "none";
  document.getElementById("offersPage").style.display = "none";
}
</script>
<script>

function apiPost(api, data = {}) {
  return fetch(API_BASE + "?api=" + api, {
    method: "POST",
    body: JSON.stringify(data)  // ??? ?? header ?? ????
  }).then(res => res.json());
}

function isLoggedIn() {
  return Boolean(localStorage.getItem("userMobile"));
}

  
function buildMenuCardHTML(item, idx) {
item.itemId = item.itemId || item.ItemId || item.id || item.ID;

  let priceSection = "";
  let cartSection = "";

  // ==========================
  //       SINGLE ITEM
  // ==========================
  if (item.cat2 === "Single") {

    // FINAL PRICE CALCULATION (MENU SHEET)
    const mrp  = Number(item.price);               // From menu sheet
    const disc = Number(item.discPercent || 0);
    const finalPrice = parseFloat((mrp - (mrp * disc / 100)).toFixed(2));

    priceSection = `
      <div class="variant-box">
        <div class="variant-row">
          <div class="left-side">
            <span class="unit">${item.unit || ""}</span>

            ${disc > 0 ? `
              <span style="background:#ff3e3e;color:#fff;font-size:11px;
                           padding:2px 4px;border-radius:3px;">
                ${disc}% OFF
              </span>
            ` : ""}
          </div>

          <div style="text-align:right;">
            <span class="final-price" style="font-weight:700;font-size:16px;">
              ₹${finalPrice}
            </span>

            ${disc > 0 ? `
              <span class="mrp" 
                    style="text-decoration:line-through;color:#777;
                           margin-left:6px;font-size:13px;">
                ₹${mrp}
              </span>
            ` : ""}
          </div>
        </div>
      </div>
    `;

    cartSection = `
      <button class="add-btn"
        data-name="${item.name}"
        data-unit="${item.unit}"
        data-price="${mrp}"
        data-disc="${disc}"
        data-item-id="${item.itemId}">
        Add to Cart
      </button>
    `;
  }

  // ==========================
  //       MULTI ITEM
  // ==========================
  if (item.cat2 === "Multi") {
    const idSafe = slugify(item.name) + "-" + idx;


    let variantsHTML = "";

    item.variants.forEach(v => {

      // FINAL PRICE CALCULATION (CAT_ALLOCATION SHEET)
      const mrp  = Number(v.price);                  // From cat_allocation sheet
      const disc = Number(v.discPercent || 0);
      const finalPrice = parseFloat((mrp - (mrp * disc / 100)).toFixed(2));

      variantsHTML += `
        <label class="variant-row">
          <div class="left-side">
            <input type="radio"
                   name="var-${idSafe}"
                   data-unit="${v.unit}"
                   data-mrp="${mrp}"
                   data-disc="${disc}"
                   data-variant-id="${v.variantId}">

            <span class="unit">${v.unit}</span>

            ${disc > 0 ? `
              <span style="background:#ff3e3e;color:#fff;
                           font-size:11px;padding:2px 4px;
                           border-radius:3px;">
                ${disc}% OFF
              </span>
            ` : ""}
          </div>

          <div style="text-align:right;">
            <span class="final-price" 
                  style="font-weight:700;font-size:16px;">
              ₹${finalPrice}
            </span>

            ${disc > 0 ? `
              <span style="text-decoration:line-through;
                           color:#777;margin-left:6px;font-size:13px;">
                ₹${mrp}
              </span>
            ` : ""}
          </div>
        </label>
      `;
    });

    priceSection = `<div class="variant-box">${variantsHTML}</div>`;

    cartSection = `
      <button class="add-btn disabled-btn"
            id="btn-${idSafe}"
            data-name="${item.name}">
        Add to Cart
      </button>
    `;
  }

  // ==========================
  //       RETURN CARD
  // ==========================
  return `
    <img src="${item.image}" alt="${item.name}">
    <h4>${item.name}</h4>
    <p>${item.description || ""}</p>
    ${priceSection}
    ${cartSection}
  `;
}

function activateVariantSelector(item, idx) {

  if (item.cat2 !== "Multi") return;

  const idSafe = slugify(item.name) + "-" + idx;

const radios = document.querySelectorAll(`input[name="var-${idSafe}"]`);
const btn = document.getElementById(`btn-${idSafe}`);

  radios.forEach(r => {
   r.addEventListener("change", () => {
  // enable visually: remove the disabled visual class
  btn.classList.remove("disabled-btn");

  // store selected variant data on button (used by delegated click handler)
  btn.dataset.price = r.dataset.mrp;
  btn.dataset.unit  = r.dataset.unit;
     btn.dataset.variantId = r.dataset.variantId;


  // restore normal appearance
  btn.style.background = "#ff6347";
  btn.style.opacity = "1";
});

  });
}

function addVariantToCart(name) {
  const safe = slugify(name);
  const selected = document.querySelector(`input[name^="var-${safe}-"]:checked`);
  if (!selected) return null;

  const mrp  = Number(selected.dataset.mrp || 0);
  const disc = Number(selected.dataset.disc || 0);

  return {
    name: name,
    unit: selected.dataset.unit,
    rate: mrp,
    discPercent: disc,
    variantId: selected.dataset.variantId,
    itemId: menuItems.find(m => m.name === name)?.itemId
};

}





// Delegated click handler for all Add buttons (works for Single and Multi)
// ADD-TO-CART HANDLER
document.addEventListener('click', function (e) {
  const btn = e.target.closest('.add-btn');
  if (!btn) return;

  const name = btn.dataset.name;

  if (btn.classList.contains('disabled-btn')) {
    alert("Please select an option before adding to cart.");
    return;
  }

  // MULTI ITEM
  if (btn.id && btn.id.startsWith("btn-")) {
    const info = addVariantToCart(name);
    if (!info) return alert("Please select an option before adding to cart.");

    if (!info.rate || info.rate <= 0 || isNaN(info.rate)) {
      alert("Price not found for this variant.");
      return;
    }

  addToCart(info.name, info.unit, info.rate, info.discPercent, info.itemId, info.variantId);


// 1a — RESET VARIANT RADIOS
const parentCard = btn.closest(".menu-item");
if (parentCard) {
  parentCard.querySelectorAll('input[type="radio"]').forEach(r => r.checked = false);
}

// 1b — DISABLE ADD BUTTON (only appearance)
btn.classList.add("disabled-btn");
btn.style.background = "#ccc";
btn.style.opacity = "0.6";

// 1d — FULL DATA RESET (correct place)
btn.dataset.price = "";
btn.dataset.unit = "";
btn.dataset.disc = "";

    return;
  }

  // SINGLE ITEM
  const unit = btn.dataset.unit || "";
  const price = Number(btn.dataset.price || 0);
  const discPercent = Number(btn.dataset.disc || 0);

  if (!price || price <= 0 || isNaN(price)) {
    alert("Price not found for this item.");
    return;
  }

  addToCart(name, unit, price, discPercent, btn.dataset.itemId, "");



});


// DELETE HANDLER — MUST BE BELOW ADD HANDLER
document.addEventListener("click", function (e) {
  const del = e.target.closest(".delete-btn");
  if (!del) return;

  const index = Number(del.dataset.index);
  removeItem(index);
});

async function saveCartToBackend(cartData = null) {
  return new Promise(async (resolve) => {

    // Only if logged in
    if (!isLoggedIn()) return resolve();

    const mobile = localStorage.getItem("userMobile");
    if (!mobile) return resolve();

    // ---- QUEUE SYSTEM (Race fix) ----
    if (window.cartSaveLock) {
      window.cartSaveQueued = true;
      return resolve();
    }
    window.cartSaveLock = true;

    // Ensure sessionId
    let sessionId = localStorage.getItem("sessionId");
    if (!sessionId) {
      sessionId = "SESS-" + Date.now();
      localStorage.setItem("sessionId", sessionId);
    }

    // Use passed data OR use global cart
    const cartToSend = (cartData && Array.isArray(cartData)) ? cartData : cart;

    // Clean final payload
    const cleanedCart = cartToSend.map(item => ({
      name: item.name || "",
      unit: item.unit || "",
      qty: Number(item.qty || 1),
      rate: Number(item.rate || 0),
      discPercent: Number(item.discPercent || 0),
      itemId: item.itemId || "",
      variantId: item.variantId || "",
      image: item.image || ""
    }));

    try {
      await apiPost("saveCart", {
        mobile,
        email: localStorage.getItem("userEmail") || "",
        sessionId,
        cartItems: cleanedCart
      });

    } catch (err) {
      console.error("Cart Save Error:", err);

    } finally {

      window.cartSaveLock = false;

      if (window.cartSaveQueued) {
        window.cartSaveQueued = false;
        await saveCartToBackend();
      }

      // === STEP 4C: VERIFY BACKEND CART (FULL AWAIT) ===
      setTimeout(async () => {
        try {
          const mobile = localStorage.getItem("userMobile");
          const check = await apiPost("getCart", { mobile });
          const backendLatest = check.cart || check.data || [];

          if (JSON.stringify(backendLatest) !== JSON.stringify(cart)) {
            console.warn("Backend mismatch detected → fixing...");
            localStorage.setItem("cart", JSON.stringify(backendLatest));
            cart = backendLatest;
            renderCart();
          }

        } catch (err) {
          console.error("Backend verify error:", err);
        }

        // ⭐ Resolve ONLY after verify done
        resolve();

      }, 1500);

    }
  });
}


 function loadUserCartOnStart() {

  // Only load if user is actually logged in
  if (!isLoggedIn()) return;

  const mobile = localStorage.getItem("userMobile");
  if (!mobile) return;

  apiPost("getCart", { mobile })
    .then(res => {
      const backendCart = res.cart || res.data || res.cartItems || [];

      // Sanitize every item to avoid null/missing fields
      const cleaned = backendCart.map(item => ({
        ...item,
        itemId: item.itemId || "",
        variantId: item.variantId || "",
        qty: Number(item.qty || 1),
        rate: Number(item.rate || 0),
        discPercent: Number(item.discPercent || 0)
      }));

      // Save merged/cleaned cart locally
      localStorage.setItem("cart", JSON.stringify(cleaned));
      cart = cleaned;
      window.cart = cleaned;

      renderCart();
    })
    .catch(err => console.error("Load cart on start error:", err));
}

function getBackendCart(mobile) {
  return apiPost("getCart", { mobile })
    .then(res => {
      if (res.success && Array.isArray(res.data)) {
        return res.data;   // ← backend cart array return
      }
      return [];
    })
    .catch(err => {
      console.error("Fetch Backend Cart Error:", err);
      return [];
    });
}

function mergeCarts(localCart, backendCart) {
  let finalCart = [];

  const map = new Map();

  // Step 1: Backend items safe
  backendCart.forEach(item => {
    const key = `${item.itemId}_${item.variantId}`;
    map.set(key, { ...item });
  });

  // Step 2: Local cart merge
 localCart.forEach(localItem => {

  // ❗ skip if invalid IDs
  if (!localItem.itemId) return;
  if (localItem.variantId === undefined) return;

  const key = `${localItem.itemId}_${localItem.variantId}`;

    if (map.has(key)) {
      let exist = map.get(key);
      exist.qty = Number(exist.qty) + Number(localItem.qty);
      exist.total = exist.qty * exist.rate;
      map.set(key, exist);
    } else {
      map.set(key, {
        ...localItem,
        cartId: "",      
        sessionId: "",
        mobile: "",
        timestamp: ""
      });
    }
  });

  map.forEach(item => finalCart.push(item));
  return finalCart;
}
async function onUserLogin(mobile) {

  // ALWAYS load email first (IMPORTANT)
  const email = localStorage.getItem("userEmail") || "";
  //  Ensure sessionId exists
  let sessionId = localStorage.getItem("sessionId");
  if (!sessionId) {
    sessionId = "SESS-" + Date.now();
    localStorage.setItem("sessionId", sessionId);
  }

  // -------------------------------
  // 1) Fetch backend cart
  // -------------------------------
  const backendRes = await apiPost("getCart", { mobile });
  const backendCartRaw = backendRes.cart || [];

  const backendCart = backendCartRaw.map(i => ({
    name: i.name || "",
    unit: i.unit || "",
    qty: Number(i.qty || 1),
    rate: Number(i.rate || 0),
    discPercent: Number(i.discPercent || 0),
    itemId: i.itemId || "",
    variantId: i.variantId || "",
    image: i.image || ""
  }));

  // -------------------------------
  // 2) Read local guest cart
  // -------------------------------
  const guestRaw = JSON.parse(localStorage.getItem("guestCart") || "[]");

  const guestCart = guestRaw.map(i => ({
    name: i.name || "",
    unit: i.unit || "",
    qty: Number(i.qty || 1),
    rate: Number(i.rate || 0),
    discPercent: Number(i.discPercent || 0),
    itemId: i.itemId || "",
    variantId: i.variantId || "",
    image: i.image || ""
  }));

  // -------------------------------
  // 3A) Merge (guest + backend)
  // -------------------------------
  let merged = mergeCarts(guestCart, backendCart);  

  // -------------------------------
  // 3B) Add backend items NOT in merged
  // -------------------------------
  backendCart.forEach(b => {
    const exists = merged.some(m =>
      m.itemId == b.itemId && m.variantId == b.variantId
    );
    if (!exists) merged.push(b);
  });

  // -------------------------------
  // 3D) Final Normalize
  // -------------------------------
  const finalMerged = merged.map(item => {
    item.qty = Number(item.qty || 1);
    item.rate = Number(item.rate || 0);
    item.discPercent = Number(item.discPercent || 0);

    const discAmt = (item.rate * item.discPercent) / 100;
    const netRate = item.rate - discAmt;

    item.discAmt = Number(discAmt.toFixed(2));
    item.netAmt  = Number(netRate.toFixed(2));

    item.total = item.discPercent > 0
      ? Number((netRate * item.qty).toFixed(2))
      : Number((item.rate * item.qty).toFixed(2));

    return item;
  });

  // -------------------------------
  // 4) Save to backend
  // -------------------------------
  cart = finalMerged;
  window.cart = finalMerged;
localStorage.setItem("userEmail", email);

  await saveCartToBackend(finalMerged);

  // Clear guest cart
  localStorage.removeItem("guestCart");

  // -------------------------------
  // 5) Save local mirror
  // -------------------------------
  localStorage.setItem("cart", JSON.stringify(finalMerged));

  // -------------------------------
  // 6) Render UI
  // -------------------------------
  renderCart();
  // STEP 5B — Force second render to fix stale UI
setTimeout(() => renderCart(), 50);
// === STEP 5C — Final backend verify after login ===
setTimeout(async () => {
  try {
    const check = await apiPost("getCart", { mobile });
    const latest = check.cart || check.data || [];

    // Compare backend vs local
    if (JSON.stringify(latest) !== JSON.stringify(cart)) {
      console.warn("🔧 Login Sync: Backend mismatch → correcting");
      localStorage.setItem("cart", JSON.stringify(latest));
      cart = latest;
      window.cart = latest;
      renderCart();
    }

  } catch (err) {
    console.error("Login final verify error:", err);
  }
}, 1000);

}
function showCartOverlay(msg = "Updating your cart…") {
  const o = document.getElementById("cartOverlay");
  if (o) {
    o.textContent = msg;
    o.style.display = "flex";
  }
}

function hideCartOverlay() {
  const o = document.getElementById("cartOverlay");
  if (o) o.style.display = "none";
}
async function someCartAction() {
  showCartOverlay("Working...");

  try {
      // 1) local storage update
      // 2) cart rebuild
      // 3) backend save (if logged in)
      // 4) renderCart()
      // 5) any recheck or merge
  }
  catch(err) {
     console.error(err);
  }
  finally {
     hideCartOverlay();   // <-- ALWAYS LAST
  }
}

</script>
</body>
</html>





