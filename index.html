  
<!DOCTYPE html>
<html lang="en">
  
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chaap Express</title>
<script src="https://cdn.tailwindcss.com"></script>

  <!-- Real Manifest File -->
  <link rel="manifest" href="/manifest.json">

  <!-- Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" sizes="192x192" href="/icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="/icons/icon-512.png">

  <meta name="theme-color" content="#ff6f00" />
  <style>
    /* Fade-in effect for menu items */
.fadeIn {
  animation: fadeIn 0.6s ease forwards;
  opacity: 0;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Slide-in animation for category titles */
.slideIn {
  animation: slideIn 0.7s ease forwards;
  opacity: 0;
}
@keyframes slideIn {
  from { transform: translateX(-30px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Ripple animation for buttons */
button {
  position: relative;
  overflow: hidden;
}
button::after {
  content: "";
  position: absolute;
  background: rgba(255,255,255,0.4);
  width: 0;
  height: 0;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  opacity: 0;
}
button:active::after {
  width: 200px;
  height: 200px;
  top: 50%;
  left: 50%;
  opacity: 1;
  transition: 0.4s ease;
}

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: #fffdf7;
      color: #333;
    }
    header {
      text-align: center;
      background: #ff6347;
      color: white;
      padding: 20px;
    }
    .menu-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      padding: 20px;
    }
    .menu-item {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 10px;
    }
      .menu-item h4, 
      .menu-item p,
      .menu-item img {
     text-align: left !important;
    }
    /* FIX SINGLE ITEM PRICE ALIGNMENT */
.menu-item .variant-row {
  text-align: left !important;
}

.menu-item .variant-row .unit,
.menu-item .variant-row .price {
  text-align: left !important;
}

    /* Keep button fixed at bottom */
.menu-item {
  display: flex;
  flex-direction: column;
  min-height: 350px;   /* adjust as needed */
}

.menu-item button {
  margin-top: auto;
  display: inline-block;   /* full width nahi lega */
  width: auto;             /* text ke hisaab se size */
  padding: 6px 14px;       /* perfect compact size */
  font-size: 14px;
  align-self: center;      /* center me aayega */
}

.variant-box {
  margin-bottom: 10px;
}

/* FIX: Ensure price never gets cut */
.variant-row {
  overflow: visible !important;
}

/* FIX: Give space on right side so ‚Çπ price doesn't clip */
.variant-box {
  padding-right: 14px !important;
}

/* FIX: prevent label flex from shrinking price */
.price {
  flex-shrink: 0 !important;
  margin-left: auto !important;
}
/* Move price slightly inward */
.price {
  margin-right: 8px !important;
}

/* Keep Multi-variant in single line ALWAYS */
.variant-row {
  white-space: nowrap !important;
}

/* Left side ko shrink hone se rokna */
.left-side {
  flex-shrink: 0 !important;
}

/* Unit text 1st column me rahe, wrap na ho */
.unit {
  white-space: nowrap !important;
}

/* Price right me fix ho jaye, wrap na ho */
.price {
  white-space: nowrap !important;
}

    .menu-item img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 8px;
    }
    .cart {
      padding: 20px;
      background: #fff8f0;
      border-top: 2px solid #ff6347;
    }
    cart-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      margin: 2px 0;
      border-bottom: 1px solid #eee;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border-bottom: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th:nth-child(2), td:nth-child(2) {
      width: 60px;
    }
    button.default-btn {
  background: #ff6347;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
}

    button:hover { background: #e7533d; }
    checkout-btn {
      width: auto;
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
    }
    #checkoutForm button[type="button"] {
      margin-top: 25px;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
    }
    input, textarea, select {
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    
#menu p {
  color: #000;
  font-weight: 600;
}
body {
  background: linear-gradient(135deg, #fff9f2, #ffe6d5);
  background-attachment: fixed;
}
    
.variant-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 6px;
  margin-bottom: 6px;
  cursor: pointer;
  width: 100%;  
  
}
    
.left-side {
  display: flex !important;
  align-items: center !important;
  gap: 10px !important;
}

.left-side {
  display: flex;
  align-items: center;
  gap: 8px;
}
.price {
  font-weight: 600;
}


.variant-row .left-side {
  display: flex;
  align-items: center;
  gap: 10px;
}

.variant-row input[type="radio"] {
  transform: scale(1.3);
}

.variant-box {
  border: 1px solid #ddd;
  padding: 8px;
  border-radius: 8px;
  margin-top: 10px;
  background: #fafafa;
  width: 100%;
  box-sizing: border-box;
  box-sizing: border-box;    /* ‚Üê JO MOST IMPORTANT FIX HAI */
  overflow: hidden;          /* ‚Üê extra expansion stop */
}

/* Center only the title and description */
.menu-item h4,
.menu-item p {
  text-align: center !important;
}
.variant-row { white-space: normal; }

@media (min-width:520px) {
  .variant-row { white-space: nowrap; }
}
/* Visual-only "disabled" look so clicks still work */
.disabled-btn {
  background: #ccc !important;
  opacity: 0.6;
  cursor: not-allowed;
  pointer-events: auto !important; /* ensure clicks are still delivered */
}
    .final-price {
  font-size: 16px;
  font-weight: 700;
}
.mrp {
  text-decoration: line-through;
  color: #777;
  margin-left: 6px;
  font-size: 13px;
}


/* Profile Page Input Styling */
#profilePage input {
  width: 280px !important;       /* Fixed compact width */
  max-width: 90% !important;     /* Responsive */
  font-size: 14px !important;    /* Smaller text */
  height: 32px !important;       /* Compact height */
  padding: 4px 10px !important;  /* Balanced padding */
  border: 1px solid #bbb;
  border-radius: 6px;
  margin-bottom: 10px;
  box-sizing: border-box;
}
#profilePage input[readonly] {
  background: #f5f5f5;
  color: #555;
}
#pageWrapper {
  position: relative;
}


#editBtn, #saveBtn, #cancelBtn {
  font-size: 14px !important;
  padding: 6px 12px !important;
}

/* PREMIUM LEFT SIDEBAR */
#leftNav {
  position: fixed;
  left: 0;
  width: 220px;
  top: 180px;    /* header ?? ???? */
  bottom: 0;
  background: #2A0A4A;  /* elegant royal blue */
  color: white;
  padding: 20px 15px;
  border-right: 1px solid rgba(255,255,255,0.15);
  box-shadow: 2px 0 12px rgba(0,0,0,0.12);
  border-top-right-radius: 12px;
   transform: translateX(-100%);
  transition: transform 0.3s ease;

}

/* Menu UL */
#leftNav ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

/* Items */
#leftNav li {
  padding: 12px 10px;
  margin-bottom: 6px;
  cursor: pointer;
  color: white;
  font-size: 16px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: 0.2s;  
}

/* Hover effect */
#leftNav li:hover {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(4px);
}

/* Active menu */
#leftNav li.active {
  background: white;
  color: #1e3a8a;
  font-weight: 600;
}

/* Premium badge for numbers */
.nav-badge {
  background: white;
  color: #1e3a8a;
  padding: 2px 7px;
  border-radius: 6px;
  font-weight: bold;
}
/* Premium Navigation Icons */
.nav-icon {
  font-size: 22px;       /* Bigger size */
  color: #ffd166;        /* Soft gold/yellow ‚Äì looks premium on blue */
  font-weight: bold;
}
#profileOverlay { 
   display: none; 
   position: fixed; 
   inset: 0;
   background: rgba(0,0,0,0.45);
   z-index: 9999;
   color: white;
   font-size: 22px;
   align-items: center;
   justify-content: center;
}
#profileOverlay.active {
   display: flex;
}

/* soft noise overlay */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
  opacity: 0.15;
  pointer-events: none;
}
/* Sidebar hidden by default (slide-left) */

/* When sidebar is active */
#leftNav.active {
  transform: translateX(0);
}

  button:focus,
  button:active,
  button:focus-visible {
    outline: none !important;
    box-shadow: none !important;
  }

  *:focus {
    outline: none !important;
    box-shadow: none !important;
  }
.nohighlight {
  -webkit-tap-highlight-color: transparent !important;
  background: transparent !important;
}
.nohighlight:active,
.nohighlight:focus {
  background: transparent !important;
  outline: none !important;
  box-shadow: none !important;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.96); }
  to   { opacity: 1; transform: scale(1); }
}
.animate-fadeIn {
  animation: fadeIn .25s ease-out;
}
  .disabled-btn {
  opacity: 0.5 !important;
  cursor: not-allowed !important;
  background: #ccc !important;
  pointer-events: auto !important; /* click allowed for alert */
}  
      #savedAddressDropdown {
    font-family: monospace;
  }
    .added-flash {
  @apply scale-105 transition duration-150 ease-out;
}

    .cart-badge-pop {
  animation: cartPop 0.25s ease-out;
}

@keyframes cartPop {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.25); }
  100% { transform: scale(1); }
}
#cartDrawer {
  position: fixed;
  top: 0;
  right: -100%;           /* hidden by default */
  width: 90%;
  max-width: 380px;
  height: 100vh;
  background: #ffffff;
  box-shadow: -4px 0 12px rgba(0,0,0,0.12);
  z-index: 99999;
  padding: 20px;
  overflow-y: auto;
  transition: right 0.35s ease-out;   /* smooth slide */
}

/* Drawer Visible */
#cartDrawer.active {
  right: 0;
}

/* Dim Background */
#cartBackdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  z-index: 99998;
}

/* Active State */
#cartBackdrop.active {
  display: block;
}
/* Z10 ‚Äî Responsive Zomato-style drawer spacing */
#cartDrawer {
  padding-top: 50px !important;
}

#cartDrawer h2 {
  margin-top: 10px;
  margin-bottom: 18px;
}

#cartItems .cart-card {
  padding: 12px !important;
}
#cartDrawer {
  position: fixed;
  top: 0;
  right: -100%;
  width: 90%;
  max-width: 380px;
  height: 100vh;
  background: #ffffff;
  box-shadow: -4px 0 12px rgba(0,0,0,0.12);
  z-index: 99999;
  padding: 20px;
  overflow-y: auto;
  transition: right 0.35s ease-out;
  position: fixed;
}
#cartDrawer {
  position: fixed;
  top: 0;
  right: -100%;
  width: 88%;
  max-width: 380px;
  height: 100vh;
  background: #ffffff;
  box-shadow: -6px 0 18px rgba(0,0,0,0.18);
  
  border-top-left-radius: 18px;
  border-bottom-left-radius: 18px;

  z-index: 99999;
  padding: 20px;
  overflow-y: auto;

  transition: right 0.30s cubic-bezier(0.25, 0.8, 0.25, 1); /* premium smooth */
}
#cartBackdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(3px);
  -webkit-backdrop-filter: blur(3px);
  display: none;
  z-index: 99998;
  transition: opacity 0.25s ease;
  opacity: 0;
}

#cartBackdrop.active {
  display: block;
  opacity: 1;
}
.qty-pop {
  animation: qtyPop 0.25s ease-out;
}

@keyframes qtyPop {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.3); }
  100% { transform: scale(1); }
}

  .add-btn {
  display: none !important;
}
   .cart {
  display: none;
}

#menuSearch:-webkit-autofill {
  box-shadow: 0 0 0px 1000px white inset !important;
}
    
/* Chrome autofill yellow/grey overlay ko 100% neutralize */
#menuSearch:-webkit-autofill,
#menuSearch:-webkit-autofill:hover,
#menuSearch:-webkit-autofill:focus {
    -webkit-text-fill-color: #000 !important;
    transition: background-color 9999s ease-in-out 0s;
}

/* ===== CHECKOUT MODAL SCROLLBAR (SLIM) ===== */
#checkoutModal ::-webkit-scrollbar {
  width: 5px;
}

#checkoutModal ::-webkit-scrollbar-track {
  background: transparent;
}

#checkoutModal ::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.25);
  border-radius: 10px;
}

#checkoutModal ::-webkit-scrollbar-thumb:hover {
  background-color: rgba(0, 0, 0, 0.4);
}



  </style>
</head>
<body>
  <div id="loadingOverlay" style="
  
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 15000;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 24px;
  ">
    Processing your order...
  </div>

<div id="cartOverlay" class="fixed inset-0 bg-black bg-opacity-45 z-50 text-white text-xl font-medium flex items-center justify-center hidden">
  Updating your cart‚Ä¶
</div>


  <button onclick="openLogin()" 
        style="position:absolute; right:100px; top:60px; z-index:9999;
               background:#444;color:white;padding:8px 14px;border:none;
               border-radius:6px;cursor:pointer;">
  Login
</button>
<button id="logoutBtn"
        onclick="logoutUser()" 
        style="position:absolute; right:58px; top:60px; z-index:9999;
               background:#444;color:white;padding:8px 14px;border:none;
               border-radius:6px;cursor:pointer; display:none;">
  Logout
</button>

<button onclick="openSignup()" 
        style="position:absolute; right:12px; top:60px; z-index:9999;
               background:#444;color:white;padding:8px 14px;border:none;
               border-radius:6px;cursor:pointer;">
  Signup
</button>
<div  id="signupLabelBox" 
style="
  position:absolute;
  right:12px;
  top:100px;
  width:180px;
  text-align:right;
  font-size:13px;
  color:#FFFFFF; 
  font-weight:500;
  font-family:Poppins, sans-serif;
  line-height:16px;
">
  
  <span style="color:#FFFFFF; font-weight:600; text-decoration:none; cursor:pointer;"
        onclick="openSignup()">
  Are you not registered? <br> Just Sign Up
  </span>
</div>

  <div id="cartBackdrop" onclick="closeCartDrawer()"></div> 
<div id="cartDrawer"> 
   <button onclick="closeCartDrawer()" 
    class="absolute right-3 top-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">
    &times;
  </button>
<h2 class="text-xl font-semibold mb-3">Your Cart</h2> 
<div id="drawerItemsList"></div>

<!-- OFFER SECTION (BOTTOM OF DRAWER) -->
  
<div id="offerSection" class="p-3 border-t mt-3" style="background:#fff;">

  <button id="applyCouponBtn"
          onclick="openCouponList()"

          class="w-full py-2 rounded-lg border text-left px-3 bg-gray-100">
    üíù Apply Coupon
  </button>
 <!-- üî• Alert message goes HERE -->
  
  <div id="bestOfferApplied" class="mt-2 text-green-600 font-medium" style="display:none;"></div>

  <div id="offerList"
    onclick="event.stopPropagation()"
        class="mt-3 bg-gray-50 p-2 rounded-lg border"
        style="display:none; max-height:220px; overflow:auto;">
         <!-- üëá STEP-2 loader added inside offerList -->
     <div id="offerLoadingText" 
          style="display:none; padding:10px; text-align:center; color:#666;">
         Fetching offers, please wait‚Ä¶
     </div>

  </div>
<div id="couponMessage" 
       style="display:none; margin-top:10px; 
              background:#ffefef; color:#b30000; 
              padding:8px 12px; border-radius:6px; 
              font-size:14px; border:1px solid #ffcccc;">
  </div>
</div>


  
<div class="mt-4 border-t pt-3 flex justify-between text-lg font-bold">
  <span>Base Total:</span>
  <span id="drawerTotalAmount">0</span>
</div>


<!-- NEW BASE + TAX + GRAND TOTAL BLOCK (SHIFTED FROM VIEW CART) -->
<div class="mt-4 border-t pt-3">
 
  <div id="taxSummary" class="text-right font-semibold mt-2"></div>

  <div class="flex justify-between mt-4 text-xl font-bold">
    
  </div>

</div>




  
<button onclick="openCheckout()" class="mt-4 w-full bg-red-500 hover:bg-red-600 text-white font-semibold py-2 rounded-lg"> Checkout </button> </div> 

<button onclick="openCartDrawer()" 
  style="position:absolute; right:160px; top:60px; background:#ff6347; color:white;
  padding:8px 12px; border-radius:6px; border:none;"> View Cart (<span id="cartCount">0</span>) </button>
  

 <!-- HAMBURGER BUTTON (appears only after login) -->
<button id="hamburgerBtn"
        onclick="toggleSidebar()"
        style="position:fixed; top:15px; left:15px; font-size:26px;
               background:#7A0010; color:#FFD166; border:none;
               padding:8px 12px; border-radius:8px; cursor:pointer;
               box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:9999; display:none;">
  <svg id="hamburgerIcon" viewBox="0 0 24 24" width="24" height="24" fill="#FFD166">
    <rect y="4" width="24" height="3"></rect>
    <rect y="10" width="24" height="3"></rect>
    <rect y="16" width="24" height="3"></rect>
  </svg>
</button>

<button id="installBtn" 
        style="
          display:none;
          position:fixed;
          bottom:20px;
          right:20px;
          background:#ff6347;
          color:white;
          padding:10px 16px;
          border-radius:8px;
          font-size:16px;
          border:none;
          box-shadow:0 4px 10px rgba(0,0,0,0.2);
          z-index:99999;
        ">
  Install App
</button>

  <header>
    <div id="userInfoBox" 
     style="background:#ff6347; color:white; padding:6px 12px;
            border-radius:6px; display:none; font-size:14px;
            margin-top:10px; display:inline-block;">

  Logged in: <span id="loggedEmail"></span><br>
 
</div>
    <div id="restaurantInfo">
      <h1 id="restaurantName">Loading...</h1>
      <p id="restaurantAddress"></p>
    </div>
    <p>Delicious meals delivered fast!</p>
    
  </header>


<!-- LEFT NAVIGATION PANEL -->
<!-- LEFT NAVIGATION PANEL -->
<div id="leftNav"
     style="
       position:fixed;
       left:0;
       top:90px;
       bottom:0;
       width:180px;
       background:#1976d2;
       color:white;
       border-right:1px solid #e6e6e6;
       box-shadow: 2px 0 4px rgba(0,0,0,0.06); /* soft professional shadow */
       padding:20px;
       z-index:999;
       overflow-y:auto;
       display:block; /* default hidden */
       
     ">
  <ul id="premiumMenu">
  <li onclick="openMenuPageProperly(this)">

  <span class="nav-icon">
  <svg viewBox="0 0 24 24" width="32" height="32">
    <path d="M6 7V6a6 6 0 0 1 12 0v1h2a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1h2Zm2 0h8V6a4 4 0 0 0-8 0v1Z" 
          fill="#FFD166"></path>
  </svg>
</span>

  Continue Shopping
</li>

      <li onclick="activateMenu(this); showPage('profilePage'); loadUserProfile();">
    <span class="nav-badge">1</span>
    My Profile
  </li>

  <li onclick="activateMenu(this); showPage('ordersPage'); loadUserOrders();">

    <span class="nav-badge">2</span>
    My Orders
  </li>

 <li onclick="activateMenu(this); showPage('offersPage'); loadOffers();">
    <span class="nav-badge">3</span>
    Offers
  </li>

</ul>

</div>

<!-- RIGHT SIDE MAIN CONTENT -->
<!-- MAIN CONTENT AREA -->
<div id="mainContent" 
     style="margin-left:0px; padding:20px; transition:0.2s ease;">

    <!--  MENU WRAPPER (default visible) -->
    <div id="menuWrapper">

        <!-- FILTER AREA -->
        <div id="filterWrapper" style="text-align:center; margin-bottom:15px;">
 <!-- Category Filter -->
        <select id="categoryFilter" onchange="filterMenu()"
            style="width:45%;max-width:200px;padding:10px;font-size:16px;
                   border-radius:6px;border:1px solid #ccc;background:white;">
            <option value="">All Categories</option>
        </select>
<input type="text" style="display:none" autocomplete="off">

        <!-- Search -->
      <input
  type="text"
  id="menuSearch"
  name="never_autofill_search"
  placeholder="Search food item..."
  autocomplete="off"
  inputmode="search"
  aria-autocomplete="none"
  autocorrect="off"
  autocapitalize="off"
  spellcheck="false"
  onfocus="this.setAttribute('autocomplete','off')"
  oninput="filterMenu()"
  style="width:45%;max-width:200px;padding:10px;font-size:16px;
         border-radius:6px;border:1px solid #ccc;margin-left:10px;">


        <!-- Clear -->
        <button onclick="clearFilters()"
            style="padding:10px 15px;margin-left:10px;background:#777;color:white;
                   border:none;border-radius:6px;cursor:pointer;">
            Clear
        </button>



            <!-- Your existing category filter + search + clear button will be here -->
        </div>

        <!-- OTHER PAGES WRAPPER (default hidden) -->


        <!-- MENU LIST -->
        <div id="menu" class="menu-container">
            <p>Loading menu...</p>
        </div>

<div class="cart">
    <h3 class="text-xl font-semibold mb-3 text-gray-800">Your Cart</h3>
        <!-- CART -->
        <div id="cartWrapper" class="p-4 bg-white shadow rounded-md">
<div id="cartItems" class="space-y-3"></div>

            <!-- Your current cart HTML goes here -->


    <table id="cartTable" class="hidden">

  <thead>
    <tr class="bg-gray-100 border-b">
      <th class="px-4 py-2 text-left">Item</th>
      <th class="px-4 py-2 text-left">Qty</th>
      <th class="px-4 py-2 text-left">Rate (MRP)</th>
      <th class="px-4 py-2 text-left">Disc %</th>
      <th class="px-4 py-2 text-left">Disc Amt</th>
      <th class="px-4 py-2 text-left">Net Amt</th>
      <th class="px-4 py-2 text-left">Total</th>
      <th class="px-4 py-2 text-left">Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  
<p id="cartBaseTotal" class="text-right font-semibold mt-2 mb-4">
  Total: <span id="cartTotal">0.00</span>
</p>


<!-- Tax Summary Comes Here -->
<div id="taxSummary" class="text-right font-semibold mt-2"></div>

      
<button onclick="openCheckout()" class="w-full bg-orange-500 text-white py-3 rounded-lg mt-4 hover:bg-orange-600">
  Checkout
</button>

  </div>
        </div>
    </div>

  <div id="pageWrapper" style="display:none; padding:10px;">

    <!-- PROFILE PAGE -->
    <div id="profilePage" style="display:none;">
        <h2>My Profile</h2>
        
        <div id="profileLoading" style="display:none; color:red;">Loading...</div>
        <input id="pName" placeholder="Full Name" readonly><br>
        <input id="pMobile" placeholder="Mobile" disabled><br>
        <input id="pEmail" placeholder="Email" readonly><br>
        <input id="pAddress" placeholder="Address" readonly><br>
        <input id="ppin" placeholder="Pincode" readonly><br>
        <input id="pCity" placeholder="City" readonly><br>
        <input id="pState" placeholder="State" readonly><br>

        <button id="editBtn" onclick="enableProfileEdit()">Edit</button>
        <button id="saveBtn" onclick="saveProfile()" style="display:none;">Save Changes</button>
        <button id="cancelBtn" onclick="cancelProfileEdit()" style="display:none;">Cancel</button>

        <div id="profileOverlay"
             style="
               position:fixed;
               inset:0;
               background:rgba(0,0,0,0.45);
               z-index:9999;
               color:white;
               font-size:22px;
               align-items:center;
               justify-content:center;
             ">
          Saving your profile‚Ä¶
        </div>
    </div>

    <!-- ORDERS PAGE -->
    <div id="ordersPage" style="display:none;">
        <h2>My Orders</h2>
        <p>No order history available.</p>
    </div>

    <!-- OFFERS PAGE -->
    <div id="offersPage" style="display:none;">
        <h2>Offers</h2>
        <p>No offers available currently.</p>
    </div>

</div>


<!-- CHECKOUT MODAL (Tailwind Updated ‚Äî with ALL your original fields) -->

<div id="checkoutModal"
     class="fixed inset-0 bg-black bg-opacity-40 hidden z-[9999] flex items-center justify-center p-2">

 <div class="bg-white w-full max-w-[380px] rounded-2xl shadow-xl
            px-4 py-2 relative animate-fadeIn
            max-h-[85vh] overflow-y-auto">




    <!-- Close Button -->
    <button onclick="closeCheckout()"
  class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-lg font-semibold">
  ‚úï
</button>

   
<h2 class="text-lg font-semibold text-gray-900 mb-2">
  Checkout
</h2>




    <form id="checkoutForm" class="space-y-1.5">

      <!-- Mobile -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Mobile</label>
        <input id="mobile"
               type="tel"
               pattern="^[0-9]{10}$"
               placeholder="Enter 10-digit Mobile"
               required
               oninput="checkCustomerByMobile()"
               class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                      focus:outline-none focus:ring-2 focus:ring-orange-500" />
        <p id="infoMsg" class="text-green-600 text-sm mt-1 hidden"></p>
      </div>

      <!-- Order Type -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Order Type</label>
        <select id="orderType" required onchange="toggleAddressField()"
                class="w-full border border-gray-300 rounded-lg p-2.5 bg-white
                       focus:outline-none focus:ring-2 focus:ring-orange-500">
          <option value="">Select Order Type</option>
          <option value="Dine In">Dine In</option>
          <option value="Take Away">Take Away</option>
          <option value="Home Delivery">Home Delivery</option>
        </select>
      </div>

      <!-- Name -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
        <input id="customerName"
               type="text"
               placeholder="Your Name"
               required
               class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                      focus:outline-none focus:ring-2 focus:ring-orange-500">
      </div>

      <!-- Email -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
        <input id="email"
               type="email"
               placeholder="Email"
               required
               class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                      focus:outline-none focus:ring-2 focus:ring-orange-500">
      </div>

      <!-- Address -->
<div id="addressWrapper">
  <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
  <textarea id="address"
            placeholder="Address"
            class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                   focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
</div>

<!-- PINCODE -->
<div id="pincodeWrapper" style="display:none; margin-top:10px;">
  <label class="block text-sm font-medium text-gray-700 mb-1">Pincode</label>
  <input id="pincode"
         readonly
         class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                bg-gray-100 cursor-not-allowed">
</div>

<!-- CITY -->
<div id="cityWrapper" style="display:none; margin-top:10px;">
  <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
  <input id="city"
         readonly
         class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                bg-gray-100 cursor-not-allowed">
</div>

<!-- STATE -->
<div id="stateWrapper" style="display:none; margin-top:10px;">
  <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
  <input id="state"
         readonly
         class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                bg-gray-100 cursor-not-allowed">
</div>


<!-- CHANGE ADDRESS BUTTON (shown only for logged-in users via JS) -->
<div class="space-y-3">
   <button
  id="changeAddressBtn"
  type="button"
  onclick="onChangeAddressClick()"
  class="hidden w-full mt-2
         border border-orange-500 text-orange-600
         bg-white
         py-2.5 rounded-xl text-sm font-semibold
         hover:bg-orange-50
         transition">
  Change Address
</button>
<p id="addressStatus"
   class="text-xs text-gray-500 mt-1 hidden">
</p>



<!-- SAVED ADDRESS DROPDOWN -->
<div id="addressSelectContainer" class="mt-3 hidden">
  <label class="block text-sm font-medium mb-1">Select Saved Address</label>
  <select id="savedAddressDropdown"
          class="w-full border rounded px-2 py-2 text-sm">
    <!-- Options added dynamically -->
  </select>
  <!-- STEP 3D BUTTON BELOW DROPDOWN -->
  <button type="button"
        onclick="onChangeAddressAddNew()"
         class="w-full mt-2
         bg-orange-100 text-orange-700
         py-2.5 rounded-xl text-sm font-semibold
         hover:bg-orange-200
         transition">
  + Add New Address
</button>

  </div>   <!-- ‚úÖ CLOSE addressSelectContainer -->

</div>   

      
     <!-- Payment Method -->
<div>
  <label class="block text-sm font-medium text-gray-700 mb-1">
    Payment Method
  </label>

  <!-- Hidden input (same id so backend / placeOrder stays safe) -->
  <input type="hidden" id="paymentMethod" value="">

  <div class="flex gap-2">
    <button type="button"
            class="payment-btn flex-1 border border-gray-300 rounded-lg py-2 text-sm
                   hover:border-orange-500"
            data-value="Cash on Delivery">
      Cash on Delivery
    </button>

    <button type="button"
            class="payment-btn flex-1 border border-gray-300 rounded-lg py-2 text-sm
                   hover:border-orange-500"
            data-value="Online">
      Online
    </button>
  </div>
</div>

<!-- BUTTONS -->
<div class="mt-3 grid grid-cols-2 gap-3">

  <!-- Place Order (LEFT) -->
 <button
  type="button"
  onclick="placeOrder()"
  class="w-full py-2.5 rounded-xl text-sm font-semibold
         bg-orange-600 hover:bg-orange-700 text-white">
  Place Order
</button>


  <!-- Cancel (RIGHT - matching size & theme) -->
  <button type="button" onclick="closeCheckout()"
    class="w-full py-2.5 rounded-xl text-sm font-semibold
           bg-orange-100 text-orange-700 border border-orange-300
           hover:bg-orange-200">
    Cancel
  </button>

</div>




    </form>


  </div>
</div>


<!-- NEW ADDRESS MODAL (STEP-2A) -->
<div id="newAddressModal"
     class="fixed inset-0 bg-black bg-opacity-40 hidden z-[10000]
            flex items-center justify-center">

  <div class="bg-white w-full max-w-[380px]
              rounded-2xl shadow-xl p-4 relative">

    <!-- Placeholder (STEP-2A only) -->
   <h3 class="text-lg font-semibold mb-2">Add New Address</h3>

<div id="newAddressForm" class="mt-4 hidden border p-3 rounded bg-gray-50">

  <label class="text-sm font-medium">Mobile</label>
  <input id="newAddressMobile"
         class="w-full border px-2 py-2 rounded bg-gray-200 text-gray-700"
         readonly />

  <label class="text-sm font-medium mt-3">Address</label>
  <textarea id="newAddressField"
  autocomplete="off"
  autocorrect="off"
  autocapitalize="off"
  spellcheck="false"
  name="new-address-never"
  class="w-full border px-2 py-2 rounded"
  placeholder="Enter full address">
</textarea>


  <label class="text-sm font-medium mt-3">Pincode</label>
  <input id="newPincode"
       maxlength="6"
       oninput="onNewPincodeChange()"
       class="w-full border px-2 py-2 rounded"
       placeholder="Enter pincode" />
<p id="pincodeStatus"
   class="text-xs text-gray-500 mt-1 hidden">
  Checking pincode‚Ä¶
</p>



  <label class="text-sm font-medium mt-3">City</label>
  <input id="newCity"
         class="w-full border px-2 py-2 rounded"
         placeholder="Enter city" />

  <label class="text-sm font-medium mt-3">State</label>
  <input id="newState"
         class="w-full border px-2 py-2 rounded"
         placeholder="Enter state" />

  <button id="saveNewAddressBtn"
          onclick="saveNewAddress()"
          class="mt-4 w-full bg-green-600 text-white py-2 rounded">
    Save Address
  </button>
  <button type="button"
        onclick="closeNewAddressModal()"
        class="mt-2 w-full bg-gray-200 text-gray-700 py-2 rounded">
  Cancel
</button>
<button type="button"
        onclick="closeNewAddressModal()"
        class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl font-bold">
  ‚úï
</button>


</div>



  <script>

document.addEventListener("DOMContentLoaded", function() {
    const s = document.getElementById("menuSearch");

    // multiple attempts to beat Chrome autofill timing
    const clearNow = () => {
        if (s) {
            s.value = "";
            s.setAttribute("value", "");
        }
    };

    clearNow();
    setTimeout(clearNow, 100);
    setTimeout(clearNow, 300);
});
document.addEventListener("DOMContentLoaded", function() {
    const s = document.getElementById("menuSearch");
    if (!s) return;

    // JAB USER SEARCH BOX PE CLICK/FOCUS KARE ‚Üí autofill ko turant blank
    s.addEventListener("focus", () => {
        s.value = "";
        s.setAttribute("value", "");
    });

    // Kuch browsers mousedown pe autofill karte hain
    s.addEventListener("mousedown", () => {
        s.value = "";
        s.setAttribute("value", "");
    });
});
// ‚≠ê Restore signup discount on refresh (GLOBAL)
window.signupDiscount = Number(localStorage.getItem("signupDiscount") || 0);

// === GLOBAL CURRENCY SETUP ===
window.CURRENCY = window.CURRENCY || "‚Çπ";


function fmt(amount, digits = 2) {
  if (amount === null || amount === undefined) amount = 0;
  const n = Number(amount) || 0;
  return `${window.CURRENCY}${n.toFixed(digits)}`;

}

function fmtNoSymbol(amount, digits = 2) {
  const n = Number(amount) || 0;
  return n.toFixed(digits);
}
    // === AUTO LOAD RESTAURANT CURRENCY ===
async function loadRestaurantSettings() {
  try {
    const res = await apiGet("getRestaurantInfo");

    if (res && res.success && res.currency) {
      window.CURRENCY = res.currency.trim();
      console.log("üî• Currency Loaded:", window.CURRENCY);
    }
  } catch (err) {
    console.error("Currency load error:", err);
  }
}

// === END CURRENCY SETUP ===

    function animateQty(id) {
  const el = document.getElementById(id);
  if (!el) return;

  el.classList.remove("qty-pop");
  void el.offsetWidth; // reflow reset
  el.classList.add("qty-pop");
}

    let restaurantTax = {
  taxType: "",
  servicePercent: 0,
  cgstPercent: 0,
  sgstPercent: 0,
  igstPercent: 0
};
let cart = [];   // start empty

 // --- CART SAVE LOCK SYSTEM (Fix race condition) ---
let cartSaveLock = false;
let cartSaveQueued = false;
// ---- ADD-TO-CART CLICK LOCK ----
let addClickLock = false;
// --- Debounce variables (qty/update/delete) ---
let qtyDebounce = null;
let deleteDebounce = null;
let blockRender = false;

    function levenshtein(a, b) {
  a = a || ""; b = b || "";
  const m = a.length, n = b.length;
  if (m === 0) return n;
  if (n === 0) return m;
  const dp = Array.from({length: m+1}, () => new Array(n+1).fill(0));
  for (let i=0;i<=m;i++) dp[i][0] = i;
  for (let j=0;j<=n;j++) dp[0][j] = j;
  for (let i=1;i<=m;i++) {
    for (let j=1;j<=n;j++) {
      const cost = a[i-1] === b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(dp[i-1][j] + 1, dp[i][j-1] + 1, dp[i-1][j-1] + cost);
    }
  }
  return dp[m][n];
}

// Normalize text for comparison
function normalizeText(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, "")   // remove punctuation
    .replace(/\s+/g, " ")         // collapse spaces
    .trim();
}

// Map several synonyms / common variants to canonical form
const CANONICAL_MAP = {
  "starter": "Starters",
  "starters": "Starters",
  "startrer": "Starters",
  "snack": "Snacks",
  "snacks": "Snacks",
  "drink": "Drink",
  "drinks": "Drinks",
  "mocktail": "Mocktail",
  "mocktails": "Mocktails",
  "cocktail": "Cocktail",
  "cocktails": "Cocktails",
  "main course": "Main Course",
  "main": "Main Course",
  "maincourse": "Main Course",
  "sweets": "Sweets",
  "sweet": "Sweet",
  "dessert": "Dessert",
  "desserts": "Desserts"
};

// Return canonical name for a category string using map + fuzzy fallback
function canonicalCategory(raw, priorityListLower) {
  const norm = normalizeText(raw);
  if (!norm) return ""; // blank

  // direct map
  if (CANONICAL_MAP[norm]) return CANONICAL_MAP[norm];

  // singular/plural quick fix: strip trailing 's'
  if (norm.endsWith("s") && CANONICAL_MAP[norm.slice(0,-1)]) {
    return CANONICAL_MAP[norm.slice(0,-1)];
  }

  // fuzzy match against priority list and canonical map keys
  let best = {score: Infinity, key: null, target: null};

  // check known canonical keys (map keys)
  for (const key of Object.keys(CANONICAL_MAP)) {
    const d = levenshtein(norm, key);
    if (d < best.score) { best = {score: d, key, target: CANONICAL_MAP[key]}; }
  }

  // check priority list labels (lowercase versions)
  for (const label of priorityListLower) {
    const d = levenshtein(norm, label);
    if (d < best.score) { best = {score: d, key: label, target: label.split(" ").map(w=>w[0].toUpperCase()+w.slice(1)).join(" ")}; }
  }

  // if very close (threshold), accept fuzzy match
  if (best.score <= Math.max(1, Math.floor(Math.min(norm.length, (best.key||"").length) * 0.35))) {
    // return capitalized target (if target from priorityListLower, it might be lowercase)
    const t = best.target || best.key;
    // ensure Title Case
    return String(t).split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
  }

  // fallback: title-case the original normalized string
  return norm.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
}

// NEW populateCategoryDropdown ‚Äî shows canonical categories (no duplicates from typos)

function populateCategoryDropdown(items) {
  const dropdown = document.getElementById("categoryFilter");
  dropdown.innerHTML = `<option value="">All Categories</option>`;

  // priority list (same as renderMenu)
  const categoryPriority = [
    "starters","snacks","drinks","mocktails","cocktails","main course","sweets","desserts"
  ];
  const priorityLower = categoryPriority.slice();

  // Build set of canonical categories
  const canonicalSet = new Set();
  items.forEach(i => {
    const can = canonicalCategory(i.category, priorityLower);
    if (can) canonicalSet.add(can);
  });

  // Sort canonical list using priority (known ones first in defined order, others alphabetic)
  const list = Array.from(canonicalSet);
  list.sort((a,b) => {
    const A = a.toLowerCase(), B = b.toLowerCase();
    const ai = priorityLower.indexOf(A);
    const bi = priorityLower.indexOf(B);
    if (ai !== -1 && bi !== -1) return ai - bi;
    if (ai !== -1) return -1;
    if (bi !== -1) return 1;
    return A.localeCompare(B);
  });

  list.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    dropdown.appendChild(opt);
  });
}

    

    let menuItems = [];
 
const API_BASE = "https://script.google.com/macros/s/AKfycbxleEglSOjPz55V7xead3ipNhrYlFWE0MeTayb0R-ncMH9JfYh1PMtz-VTd9WeqiHzd/exec";

function apiGet(api, params = {}) {
  const url = new URL(API_BASE);
  url.searchParams.set("api", api);

  Object.keys(params).forEach(k => 
    url.searchParams.set(k, params[k])
  );

  return fetch(url.toString(), {
    method: "GET",
    headers: { "Accept": "application/json" }
  }).then(res => res.json());
}
apiGet("getMenu")
  .then(res => {
    // ‚≠ê Add image field to each menu item
    res.menu = (res.menu || []).map(row => ({
      ...row,
      image: row["Image Url"] || row.image || row.Image || row.img || ""
   // auto-detect column
    }));
   window.menuItems = res.menu;
    renderMenu(res.menu);
  })
  .catch(err => console.error("Menu load error:", err));

// LOAD cat_allocation sheet
apiGet("getCatAllocations")
  .then(res => {
    window.cat_allocations = res.cat_allocations || [];
    console.log("Cat Allocations Loaded:", window.cat_allocations);
  })
  .catch(err => console.error("cat allocation load error:", err));

apiGet("getRestaurantInfo")
  .then(res => {

    document.getElementById("restaurantName").innerHTML = "&#127860; " + res.name;
    document.getElementById("restaurantAddress").innerText = res.address;

    // STORE COUPON MODE (manual / auto)
    window.couponMode = (res.coupon || "")
      .toString()
      .trim()
      .toLowerCase()
      .replace(/[^a-z]/g, "");   // Manual Coupon ‚Üí manualcoupon

    console.log("Coupon Mode =", window.couponMode);

    // === COUPON UI CONTROL ===
    const couponSection = document.getElementById("offerSection");
    const applyBtn = document.getElementById("applyCouponBtn");
    
if (window.couponMode === "manualcoupon") {

      console.log("MODE = Manual Coupon");

      if (couponSection) couponSection.style.display = "block";
      if (applyBtn) applyBtn.style.display = "block";

    } else {

      console.log("MODE = BEST OFFER");

      if (applyBtn) applyBtn.style.display = "none";
      if (couponSection) couponSection.style.display = "block";
    }

    // TAX SETTINGS
    restaurantTax.taxType        = res.taxType || "";
    restaurantTax.servicePercent = (res.servicePercent && res.servicePercent !== "NIL") 
                                   ? Number(res.servicePercent) 
                                   : 0;

    restaurantTax.cgstPercent    = Number(res.cgstPercent) || 0;
    restaurantTax.sgstPercent    = Number(res.sgstPercent) || 0;
    restaurantTax.igstPercent    = Number(res.igstPercent) || 0;

    console.log("Restaurant Tax Settings Loaded:", restaurantTax);
  })
  .catch(err => {
    console.error("Restaurant info load error:", err);
  });



    
function slugify(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/\s+/g, "-")
    .replace(/[^a-z0-9\-_]/g, "");
}


function renderMenu(items) {
  menuItems = items;

  // Auto-fill category dropdown (canonical)
  populateCategoryDropdown(items);

  const menuDiv = document.getElementById('menu');
  menuDiv.innerHTML = '';
let renderIndex = 0;
  // priority brain
  const categoryPriority = [
    "starters",
    "snacks",
    "drinks",
    "mocktails",
    "cocktails",
    "main course",
    "sweets",
    "desserts"
  ];

  // Build map: original raw category -> canonical
  const rawToCanonical = {};
  items.forEach(it => {
    const raw = (it.category || "").toString();
    rawToCanonical[raw] = canonicalCategory(raw, categoryPriority);
  });

  // Extract unique canonical categories (preserve order)
  let categoryOrder = [...new Set(
    Object.values(rawToCanonical).filter(c => c && c !== "")
  )];

  // Sort categoryOrder using priority (canonical lowercases)
  categoryOrder.sort((a,b) => {
    const A = a.toLowerCase(), B = b.toLowerCase();
    const ai = categoryPriority.indexOf(A);
    const bi = categoryPriority.indexOf(B);
    if (ai !== -1 && bi !== -1) return ai - bi;
    if (ai !== -1) return -1;
    if (bi !== -1) return 1;
    return A.localeCompare(B);
  });

  // ====== CHEF SPECIAL SECTION ======
  const chefSpecialItems = items.filter(i => {
    const val = (i.hotselling || i.Hotselling || "").toString().trim().toUpperCase();
    return val === "TRUE";
  });

  if (chefSpecialItems.length > 0) {
    const heading = document.createElement("h2");
    heading.classList.add("slideIn");
    heading.innerHTML = "Chef Special";
    heading.style.margin = "10px 0 5px";
    heading.style.padding = "10px";
    heading.style.background = "#ff6347";
    heading.style.color = "white";
    heading.style.borderRadius = "6px";
    heading.style.gridColumn = "1 / -1";
    menuDiv.appendChild(heading);

    chefSpecialItems.forEach(item => {
      item.itemId = item.itemId || item.ItemId || item.id || item.ID;

      const div = document.createElement("div");
      div.className = "menu-item fadeIn";

       div.innerHTML = buildMenuCardHTML(item, renderIndex);
menuDiv.appendChild(div);

renderIndex++;

    });
  }

  // ====== CATEGORY GROUPING ======
  categoryOrder.forEach(cat => {
    const group = items.filter(i => {
      const can = rawToCanonical[(i.category || "").toString()];
      return (can || "").toLowerCase() === cat.toLowerCase();
    });

    if (group.length > 0) {
      const heading = document.createElement("h2");
      heading.classList.add("slideIn");

      heading.innerHTML = cat;
      heading.style.margin = "10px 0 5px";
      heading.style.padding = "10px";
      heading.style.background = "#ff6347";
      heading.style.color = "white";
      heading.style.borderRadius = "6px";
      heading.style.gridColumn = "1 / -1";
      menuDiv.appendChild(heading);

      group.forEach(item => {
        item.itemId = item.itemId || item.ItemId || item.id || item.ID;

        const div = document.createElement('div');
        div.className = 'menu-item fadeIn';

         div.innerHTML = buildMenuCardHTML(item, renderIndex);
menuDiv.appendChild(div);

renderIndex++;

      });
       }
  });
     
  // ‚≠ê CORRECT PLACE
   setTimeout(() => {
       restoreFullCartUI();
   }, 50);
}


function clearFilters() {
  document.getElementById("menuSearch").value = "";
  document.getElementById("categoryFilter").value = "";

  // Reset menu to original grouped view
  renderMenu(menuItems);
}
function rebuildCart() {

  // Read correct cart based on login state
  if (!isLoggedIn()) {
    cart = JSON.parse(localStorage.getItem("guestCart") || "[]");
  } else {
    cart = JSON.parse(localStorage.getItem("cart") || "[]");
  }

  cart = cart.map(item => {
    // quantity fix
    item.qty = Number(item.qty || item.quantity || 1);

    // rate fix
    item.rate = Number(item.rate || item.price || 0);

    // total recalc
    item.total = item.rate * item.qty;

    // discount recalc
    if (item.discPercent > 0) {
      item.discAmt = item.total * (item.discPercent / 100);
      item.netAmt = item.total - item.discAmt;
    } else {
      delete item.discAmt;
      delete item.netAmt;
    }

    return item;
  });

  // store updated clean cart (guest vs logged-in)
  if (!isLoggedIn()) {
    localStorage.setItem("guestCart", JSON.stringify(cart));
  } else {
    
  }

  // rerender
  renderCart();
}

function addToCart(name, unit, rate, discPercent = 0, itemIdFromBtn = "", variantIdFromBtn = "") {
// --- Prevent spam clicking ---
if (addClickLock) return;
addClickLock = true;

setTimeout(() => addClickLock = false, 150);
  showCartOverlay("Adding item‚Ä¶");

  // STEP 1C ‚Äì Normalize
  const cleanUnit = String(unit || "").trim().toLowerCase();
  const cleanName = String(name || "").trim().toLowerCase();
// Read correct cart based on login state
let stored;
if (!isLoggedIn()) {
  stored = JSON.parse(localStorage.getItem("guestCart") || "[]");
} else {
  stored = JSON.parse(localStorage.getItem("cart") || "[]");
}

  let itemId = "";
  let variantId = "";

  // STEP 1B ‚Äî If button already passed correct IDs, use them
  if (itemIdFromBtn) {
    itemId = itemIdFromBtn;
    variantId = variantIdFromBtn || "";
} else {
    console.warn("FATAL: addToCart called WITHOUT itemIdFromBtn. Button must send correct IDs.");
    hideCartOverlay();
    return;
}


  // --------------------------------------------
  // Perfect merge logic using itemId + variantId
  const existing = stored.find(i => i.itemId == itemId && i.variantId == variantId);

  if (existing) {
    existing.qty = Number(existing.qty || 0) + 1;
    existing.total = parseFloat((existing.qty * existing.rate).toFixed(2));

    if (existing.discPercent > 0) {
      const discAmt = (existing.rate * existing.discPercent) / 100;
      existing.discAmt = parseFloat(discAmt.toFixed(2));
      existing.netAmt = parseFloat(((existing.rate - discAmt) * existing.qty).toFixed(2));
    } else {
      delete existing.discAmt;
      delete existing.netAmt;
    }
  }

  // NEW ITEM
  else {
      // Find exact menu item using itemId (best method)
    const menuItemFull = (window.menuItems || []).find(
  m => m.itemId == itemId
);

    const qty = 1;

    const total = rate * qty;
    const discAmt = (rate * discPercent) / 100;
    const netRate = rate - discAmt;

   
    let newItem = {
      name,
      unit,
      qty,
      rate: Number(rate),
      total: parseFloat(total.toFixed(2)),
      itemId,
      variantId,
      discPercent: Number(discPercent),
       image: menuItemFull?.image || ""
    };

    if (discPercent > 0) {
      newItem.discAmt = parseFloat(discAmt.toFixed(2));
      newItem.netAmt = parseFloat((netRate * qty).toFixed(2));
    }

    stored.push(newItem);
  }

  // SAVE to localStorage only
  // ‚≠ê Guest users MUST save here
if (!isLoggedIn()) {
    localStorage.setItem("guestCart", JSON.stringify(stored));
} else {
    localStorage.setItem("cart", JSON.stringify(stored));
}

  cart = stored;
  window.cart = stored;

  renderCart();

  // --------------------------------------------
 if (isLoggedIn()) {
  saveCartToBackend().finally(() => hideCartOverlay());
} else {
  hideCartOverlay();
}


  alert(`${name} (${unit}) added to cart`);
}

function openCartPanel(cartArr = []) {

  const list = Array.isArray(cartArr) && cartArr.length > 0
    ? cartArr
    : getCart();

  const container = document.getElementById("drawerItemsList");
  if (!container) return;

  container.innerHTML = "";

  if (list.length === 0) {
    container.innerHTML = `
      <div class="p-4 text-center text-gray-500">
        Your cart is empty
      </div>
    `;
    try { updateDrawerTotals(); } catch(e){}
    return;
  }

  let html = "";

  list.forEach(ci => {

    const itemId = String(ci.itemId);
    const variantId = String(ci.variantId || "");
    const qty = Number(ci.qty || 1);
    const rate = Number(ci.rate || 0);
    const disc = Number(ci.discPercent || 0);

    const discAmt = (rate * disc) / 100;
    const netRate = rate - discAmt;
    const lineTotal = (netRate * qty).toFixed(2);

    html += `
      <div class="flex gap-3 py-2 border-b">

        <!-- IMAGE -->
        <img 
          src="${ci.image || 'https://via.placeholder.com/60'}" 
          class="w-16 h-16 rounded object-cover"
        />

        <!-- RIGHT SIDE DETAILS -->
        <div class="flex-1">

          <!-- NAME + UNIT -->
          <div class="font-semibold text-gray-800">
            ${ci.name} 
            <span class="text-sm text-gray-500">${ci.unit || ""}</span>
          </div>

          <!-- MRP + DISCOUNT -->
          <div class="text-xs text-gray-600 mt-1 leading-tight">
            <div>MRP: <span class="font-semibold">${fmt(rate)}</span></div>

            ${disc > 0 ? `
              <div>Discount: <span class="font-semibold">${disc}%</span></div>
              <div>Disc Amt: <span class="font-semibold">${fmt(discAmt)}</span></div>
              <div>Net Rate: <span class="font-semibold">${fmt(netRate)}</span></div>
            ` : ""}
          </div>

          <!-- QTY + TOTAL -->
          <div class="flex justify-between items-center mt-2">

            <div class="flex items-center gap-2">
              <button 
                class="px-2 bg-gray-300 rounded"
                onclick="updateCart('${itemId}','${variantId}','dec')"
              >‚àí</button>

              <span class="font-semibold">${qty}</span>

              <button 
                class="px-2 bg-gray-300 rounded"
                onclick="updateCart('${itemId}','${variantId}','add')"
              >+</button>
            </div>

            <div class="font-bold text-gray-800 text-base">
              ${fmt(lineTotal)}
            </div>

          </div>

        </div>
      </div>
    `;
  });

  container.innerHTML = html;

  try { updateDrawerTotals(); } catch(e){}
}

function renderCart() {
if (blockRender) return;
  console.log("Rendering Cart...");
   console.log(cart);

  const cartItemsContainer = document.querySelector('#cartItems');
cartItemsContainer.innerHTML = '';
  const thead = document.querySelector('#cartTable thead tr');
  
// ---- SUPER SANITIZER (Prevents render bugs) ----
cart = cart.map(item => {
   // ADD THIS FIX 
  const menuMatch = window.menuItems?.find(m => m.itemId == item.itemId);
  if (menuMatch) item.image = menuMatch.image;
  const menuItem = (window.menuItems || []).find(m => m.itemId == item.itemId);

  // 1) NAME FIX
  if (!item.name && menuItem?.name) item.name = menuItem.name;

  // 2) UNIT FIX (for Multi items)
  if (!item.unit) {
    const variant = (window.cat_allocations || []).find(v => v.variantId == item.variantId);
    if (variant) item.unit = variant.unit;
  }

  // 3) IMAGE FIX
  if (!item.image && menuItem?.image) item.image = menuItem.image;

  // 4) TYPE FIX (force correct numeric)
  item.qty = Number(item.qty || 1);
  item.rate = Number(item.rate || 0);
  item.discPercent = Number(item.discPercent || 0);

  // 5) TOTAL RECALC
  const discAmt = (item.rate * item.discPercent) / 100;
  item.discAmt = Number(discAmt.toFixed(2));

  const netRate = item.rate - item.discAmt;

  item.total = item.discPercent > 0 
    ? Number((netRate * item.qty).toFixed(2))
    : Number((item.rate * item.qty).toFixed(2));

  return item;
});

 // ‚≠ê SAVE sanitized image back to storage
if (!isLoggedIn()) {
  localStorage.setItem("guestCart", JSON.stringify(cart));
} else {
  
}


  // ===== Check discount usage =====
  const anyDiscount = cart.some(i => Number(i.discPercent) > 0);

  // ===== Build header =====
  // ===== PERMANENT FULL HEADER (no flicker) =====
thead.innerHTML = `
  <th>Item</th>
  <th>Qty</th>
  <th>Rate (MRP)</th>
  <th class="col-disc">Disc %</th>
  <th class="col-disc">Disc Amt</th>
  <th class="col-disc">Net Amt</th>
  <th>Total</th>
  <th>Action</th>
`;
// ===== Hide / Show discount columns =====
const showDisc = cart.some(i => Number(i.discPercent) > 0);

  let grandTotal = 0;

  // ================================================
  //               BUILD CART TABLE ROWS
  // ================================================
  cart.forEach((item, idx) => {

    const rate = Number(item.rate);
    const qty  = Number(item.qty);
    const disc = Number(item.discPercent || 0);

    // fresh safe calculations
    const discAmt = parseFloat(((rate * disc) / 100).toFixed(2));
    const netRate = rate - discAmt;

    // FIX: for no discount ‚Üí use MRP * qty
    const total = disc > 0 
      ? parseFloat((netRate * qty).toFixed(2))
      : parseFloat((rate * qty).toFixed(2));

    grandTotal += total;

    

const card = document.createElement("div");
card.className = "cart-card mb-3 p-4 bg-white rounded-lg shadow flex items-center justify-between gap-4"; // Added gap-4 and padding increased

card.innerHTML = `
<div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4 w-full">
 <img 
      src="${item.image || 'https://via.placeholder.com/60'}" 
      class="w-20 h-20 object-cover rounded-md"
    />

<div class="flex-1">
  <div class="font-semibold text-gray-800 leading-tight">${item.name} (${item.unit})</div>
  <div class="text-gray-500 text-sm">Rate: ${fmt(rate)}</div>
</div>

${disc > 0 ? `
  <div class="text-right text-sm text-gray-600 leading-tight">
    <div class="text-sm text-gray-500">
      Disc %: <span class="font-semibold">${disc}%</span>
    </div>

    <div class="text-sm text-gray-500">
      Disc Amt: <span class="font-semibold">${fmt(discAmt)}</span>
    </div>

    <div class="text-sm text-gray-500">
      Net Rate: <span class="font-semibold">${fmt(netRate)}</span>
    </div>
  </div>
` : ""}

<div class="flex items-center gap-2">
    <div class="flex items-center gap-2">
  <button 
    onclick="updateQty(${idx}, ${qty - 1})" 
    class="w-8 h-8 flex items-center justify-center border rounded-full"
  >‚àí</button>

  <div class="w-10 text-center font-semibold">${qty}</div>

  <button 
    onclick="updateQty(${idx}, ${qty + 1})" 
    class="w-8 h-8 flex items-center justify-center border border-gray-400 rounded-full text-xl"
  >+</button>
</div>

  </div>

 


 <div class="font-semibold text-lg text-gray-800">
    ${fmt(total)}
</div>

 
  <button class="text-red-500" onclick="removeItem(${idx})">Delete</button>
`;
cartItemsContainer.appendChild(card);


  });

  // ===== FINAL TOTAL SET =====
  let baseTotal = parseFloat(grandTotal.toFixed(2));
  document.getElementById("cartTotal").innerText = fmt(baseTotal);


  // TAX BLOCK unchanged
  let taxHtml = "";

  if (restaurantTax.taxType === "On Bill") {

    const serviceAmt = parseFloat(((baseTotal * restaurantTax.servicePercent) / 100).toFixed(2));
    const taxableAmount = parseFloat((baseTotal + serviceAmt).toFixed(2));

    const cgstAmt = parseFloat(((taxableAmount * restaurantTax.cgstPercent) / 100).toFixed(2));
    const sgstAmt = parseFloat(((taxableAmount * restaurantTax.sgstPercent) / 100).toFixed(2));
    const igstAmt = parseFloat(((taxableAmount * restaurantTax.igstPercent) / 100).toFixed(2));

    const grandTotalCalc = parseFloat((taxableAmount + cgstAmt + sgstAmt + igstAmt).toFixed(2));

  taxHtml = `
  ${restaurantTax.servicePercent > 0 
    ? `<p style="margin:2px 0;">
         Service Charges (${restaurantTax.servicePercent}%): 
         ${fmt(serviceAmt)}
       </p>`
    : ""
  }

  <p style="margin:2px 0;">
    CGST (${restaurantTax.cgstPercent}%): 
    ${fmt(cgstAmt)}
  </p>

  <p style="margin:2px 0;">
    SGST (${restaurantTax.sgstPercent}%): 
    ${fmt(sgstAmt)}
  </p>

  ${restaurantTax.igstPercent > 0 
    ? `<p style="margin:2px 0;">
         IGST (${restaurantTax.igstPercent}%): 
         ${fmt(igstAmt)}
       </p>`
    : ""
  }

  <div class="flex justify-between items-center mt-4">
    <div class="font-semibold text-lg text-gray-800">Grand Total</div>
    <div class="font-semibold text-lg text-red-500">
     ${fmt(grandTotal)}
    </div>
  </div>
`;

  }

  const taxSummaryEl = document.getElementById("taxSummary");
  if (taxSummaryEl) taxSummaryEl.innerHTML = taxHtml;

  updateCartBadge();
}



// Ultra-stable qty update handler (no debounce, no rollback)
async function updateQty(index, newQty) {

  // If backend save is running ‚Üí skip UI update
  if (blockRender) return;

  // 1 ‚Äî Validate qty
  newQty = Number(newQty);
  if (isNaN(newQty) || newQty < 1) newQty = 1;

  // ‚≠ê G3: REMOVE COUPON IF QTY CHANGES (only for onetime coupons)
  if (selectedCoupon && (selectedCoupon.type === "onetime" || selectedCoupon.type === "regular"))  {

      // remove coupon
      selectedCoupon = null;
      alreadyAppliedCouponId = "";

      // show message to user
      showCouponError("Coupon removed because cart quantity changed. Please apply again.");

      // hide coupon applied box
      const appliedBox = document.getElementById("bestOfferApplied");
      if (appliedBox) appliedBox.style.display = "none";
  }

  // 2 ‚Äî Update cart safely
  cart[index].qty = newQty;

  // 3 ‚Äî Save immediately to local storage
  if (!isLoggedIn()) {
    localStorage.setItem("guestCart", JSON.stringify(cart));
  } else {
    // logged-in ‚Üí backend sync handled below
  }

  // 4 ‚Äî Re-render cart instantly (no delay, no flicker)
  renderCart();

  // 5 ‚Äî Backend save (queued, safe, no double-event)
  updateCartBadge();

  await saveCartToBackend();
}

    
function loadPrimaryAddress() {
  // Logged-in users only
  if (!isLoggedIn()) return;

  const mobile = localStorage.getItem("mobile");
  if (!mobile) return;

  const orderType = document.getElementById("orderType")?.value;

  // Only apply primary address for Home Delivery
  if (orderType !== "Home Delivery") return;

  const addressField = document.getElementById("address");
  const addressWrapper = document.getElementById("addressWrapper");
  if (!addressField || !addressWrapper) return;

  // Show wrapper
  addressWrapper.style.display = "block";

  // Fetch user profile
  apiGet("getUserProfile", { mobile })
    .then(res => {
      if (res.success && res.address) {
        addressField.value = res.address.trim();
      }
    })
    .catch(err => console.error("loadPrimaryAddress error:", err));
}

async function loadSavedAddresses() {
  const mobile = localStorage.getItem("userMobile");

  if (!mobile) {
    return {
      primaryObj: null,
      multiObjList: [],
      hasMulti: false
    };
  }

  const overlay = document.getElementById("loadingOverlay");

  try {
    if (overlay) overlay.style.display = "flex";

    // -------------------------------
    // 1Ô∏è‚É£ GET PRIMARY (user sheet)
    // -------------------------------
    const userRes = await fetch(
      `https://script.google.com/macros/s/AKfycbz8B-nwXivGHzKgcWT8zTvS4sAWG6dKfsDh8rsn29CGXCeIxxeNJ9NaPcL03cQBGHEf/exec?action=getUserByMobile&mobile=${mobile}`
    );
    const user = await userRes.json();

    let primaryObj = null;

    if (user?.address) {
      primaryObj = {
        address: user.address,
        pincode: user.pincode || "",
        city: user.city || "",
        state: user.state || "",
        type: "primary"
      };
    }

    // -------------------------------
    // 2Ô∏è‚É£ GET MULTI_ADD (OBJECT FORMAT)
    // -------------------------------
    const multiRes = await fetch(
      `https://script.google.com/macros/s/AKfycbz8B-nwXivGHzKgcWT8zTvS4sAWG6dKfsDh8rsn29CGXCeIxxeNJ9NaPcL03cQBGHEf/exec?action=getMultiAddress&mobile=${mobile}`
    );
    const multi = await multiRes.json();

    // multi.addresses is ALREADY object array
    const multiObjList = Array.isArray(multi?.addresses)
      ? multi.addresses.map(a => ({
          address: a.address || "",
          pincode: a.pincode || "",
          city: a.city || "",
          state: a.state || "",
          type: "multi"
        }))
      : [];

    return {
      primaryObj,
      multiObjList,
      hasMulti: multiObjList.length > 0
    };
  }
  catch (err) {
    console.error("Address Load Error:", err);
    return {
      primaryObj: null,
      multiObjList: [],
      hasMulti: false
    };
  }
}

    
document.getElementById("changeAddressBtn").addEventListener("click", async () => {

  const overlay = document.getElementById("loadingOverlay");
  const dropdown = document.getElementById("savedAddressDropdown");
  const ddlBox = document.getElementById("addressSelectContainer");
  const formBox = document.getElementById("newAddressForm");

  // STEP 1 ‚Äî Start overlay
  if (overlay) overlay.style.display = "flex";

  // STEP 2 ‚Äî Reset UI
  dropdown.innerHTML = "";
  ddlBox.classList.add("hidden");
  formBox.classList.add("hidden");

  // STEP 3 ‚Äî Fetch new format addresses
  const data = await loadSavedAddresses();

  // ---------------------------
  // üî∂ CASE 2 ‚Äî No multi_add addresses
  // ---------------------------
  if (!data.hasMulti && !data.primaryObj) {

    // Show new address form directly (same as old code)
    formBox.classList.remove("hidden");

    document.getElementById("newAddressMobile").value =
      localStorage.getItem("userMobile") || "";

    if (overlay) overlay.style.display = "none";
    return;
  }

  // ---------------------------
  // üî∂ CASE 1 ‚Äî We have saved addresses
  // ---------------------------
  ddlBox.classList.remove("hidden");

  // --- Primary address (new object format)
  if (data.primaryObj) {
    const p = data.primaryObj;
    const opt1 = document.createElement("option");
    opt1.value = JSON.stringify(p);   // NEW FORMAT
    opt1.textContent = `Primary: ${p.address}, ${p.pincode}, ${p.city}, ${p.state}`;
    dropdown.appendChild(opt1);
  }

  // --- MultiAdd Addresses (new object format)
  data.multiObjList.forEach((a, index) => {
    const opt = document.createElement("option");
    opt.value = JSON.stringify(a);   // NEW FORMAT
    opt.textContent = `${a.address}, ${a.pincode}, ${a.city}, ${a.state}`;
    dropdown.appendChild(opt);
  });

  // --- Add New Address (same as old)
  const addNew = document.createElement("option");
  addNew.value = "__ADD_NEW__";
  addNew.textContent = "‚ûï Add New Address";
  dropdown.appendChild(addNew);
// ---------------------------
// STEP-5: Auto Default Selection
// ---------------------------

let defaultAddressObj = null;

// 1Ô∏è‚É£ If primary exists ‚Üí select primary automatically
if (data.primaryObj) {
  defaultAddressObj = data.primaryObj;
  dropdown.value = JSON.stringify(data.primaryObj);
}

// 2Ô∏è‚É£ Else if multiAdd available ‚Üí auto-select first address
else if (data.multiObjList.length > 0) {
  defaultAddressObj = data.multiObjList[0];
  dropdown.value = JSON.stringify(data.multiObjList[0]);
}

// 3Ô∏è‚É£ If default address found ‚Üí autofill fields
if (defaultAddressObj) {
  document.getElementById("address").value  = defaultAddressObj.address || "";
  document.getElementById("pincode").value = defaultAddressObj.pincode || "";
  document.getElementById("city").value    = defaultAddressObj.city || "";
  document.getElementById("state").value   = defaultAddressObj.state || "";
}

  // STEP 4 ‚Äî Smooth fade animation
  ddlBox.style.opacity = "0";
  setTimeout(() => {
    ddlBox.style.transition = "opacity 0.25s ease";
    ddlBox.style.opacity = "1";
  }, 10);

  // STEP 5 ‚Äî Hide overlay
  if (overlay) overlay.style.display = "none";
});


document.getElementById("savedAddressDropdown").addEventListener("change", async function () {
  const selected = this.value;

  const formBox = document.getElementById("newAddressForm");
  const addressField = document.getElementById("address");
  const pinField = document.getElementById("pincode");
  const cityField = document.getElementById("city");
  const stateField = document.getElementById("state");

  // Always hide new-form by default
  formBox.classList.add("hidden");

  // 1Ô∏è‚É£ ADD NEW ADDRESS (same as old flow)
  if (selected === "__ADD_NEW__") {
    formBox.classList.remove("hidden");

    document.getElementById("newAddressMobile").value =
      localStorage.getItem("userMobile") || "";

    return;
  }

  // ----------------------------------------
  // 2Ô∏è‚É£ NEW FORMAT: selected is JSON object
  // ----------------------------------------
  let parsed = null;

  try {
    parsed = JSON.parse(selected);   // Works for both Primary & Multi (new format)
  } catch (e) {
    console.error("Invalid JSON address:", selected);
  }

  // If parsed object exists ‚Üí auto-fill 4 fields
  if (parsed && typeof parsed === "object") {
    addressField.value = parsed.address || "";
    pinField.value = parsed.pincode || "";
    cityField.value = parsed.city || "";
    stateField.value = parsed.state || "";
    return;
  }

  // ---------------------------------------------------
  // 3Ô∏è‚É£ BACKWARD-COMPATIBLE MODE (if old format selected)
  // ---------------------------------------------------

  const data = await loadSavedAddresses();

  // OLD Primary
  if (selected === "__PRIMARY__") {
    addressField.value = data.primaryAddress || "";
    return;
  }

  // OLD Multi
  if (selected.startsWith("__MULTI__")) {
    const index = parseInt(selected.replace("__MULTI__", ""));
    const selectedAddress = data.multiAddresses[index] || "";
    addressField.value = selectedAddress;
    return;
  }
});




function closeCheckout() {
  const modal = document.getElementById("checkoutModal");
  if (modal) modal.style.display = "none";

  // üî• Restore scroll
  document.body.style.overflow = "auto";

  // üî• Kill loading overlay if any
  const overlay = document.getElementById("loadingOverlay");
  if (overlay) overlay.style.display = "none";

  // üî• Kill ALL leftover backdrops / overlays
  forceClearOverlays();

  // ‚úÖ EXTRA SAFETY (important)
  document.activeElement && document.activeElement.blur();
}

function deleteCart() {
  showCartOverlay("Clearing cart‚Ä¶");

  cart = [];

  if (!isLoggedIn()) {
    localStorage.removeItem("guestCart");
    renderCart();
    hideCartOverlay();
    return;
  }

  // Logged-in: clear only LOCAL mirror (NEVER delete backend)
  localStorage.setItem("cart", "[]");
  renderCart();

  hideCartOverlay();
}

function removeItem(index) {
 showCartOverlay();

  const item = cart[index];
  if (!item) {
    hideCartOverlay();
    return;
  }

  clearTimeout(deleteDebounce);

  deleteDebounce = setTimeout(() => {

    cart.splice(index, 1);

    // SAVE LOCALLY
    if (!isLoggedIn()) {
      localStorage.setItem("guestCart", JSON.stringify(cart));
    } else {
      
    }

    renderCart();

    // BACKEND SYNC
    if (isLoggedIn()) {
    saveCartToBackend().finally(() => hideCartOverlay());
  } else {
    hideCartOverlay();
  }

  }, 150); // small debounce for delete
updateCartBadge();

}


function checkCustomerByMobile() {
  if (isLoggedIn()) {
  document.getElementById('mobile').readOnly = true;
  return; // stop guest mobile logic
}
  const mobile = document.getElementById('mobile').value.trim();
  

  // If mobile incomplete -> reset and hide complete row (label + input)
  if (mobile.length !== 10) {

    // Reset Order Type row
    document.getElementById('orderType').parentElement.style.display = "none";

    // Hide full rows (label + input)
    document.getElementById('customerName').parentElement.style.display = "none";
    document.getElementById('email').parentElement.style.display = "none";
    document.getElementById('addressWrapper').style.display = "none";

    // Hide optional info text
    document.getElementById('infoMsg').style.display = "none";

    return;
  }

  // Valid mobile ‚Üí show orderType row
  document.getElementById('orderType').parentElement.style.display = "block";
}



    
 document.getElementById("orderType").addEventListener("change", () => {
  toggleAddressField();
  setupAddressUIVisibility();   // ‚úÖ STEP 1B correct location
});

    
document.getElementById("mobile").addEventListener("input", function () {
  const mobile = document.getElementById('mobile').value.trim();
  if (/^[0-9]{10}$/.test(mobile)) {
    // Only run when Order Type already selected
    if (document.getElementById('orderType').value) {
      toggleAddressField();
    }
  }
});

let lastLookupMobile = "";
let lastLookupOrderType = "";


    
function toggleAddressField() {
console.log("toggleAddressField fired");

  const mobile = document.getElementById("mobile").value.trim();
  const orderType = document.getElementById("orderType").value;

  if (!orderType) return;

  // --- 1) Validate mobile ---
  if (!/^[0-9]{10}$/.test(mobile)) {
      console.log("mobile invalid, returning");   
    alert("Enter a valid 10-digit mobile number.");
    return;
  }

  // --- 2) Base references ---
  const nameField = document.getElementById("customerName");
  const emailField = document.getElementById("email");
  const addressField = document.getElementById("address");

  const addressWrapper = document.getElementById("addressWrapper");
  const paymentField = document.getElementById("paymentMethod");
  const overlay = document.getElementById("loadingOverlay");
  const orderSelect = document.getElementById("orderType");
  const changeBtn = document.getElementById("changeAddressBtn");

  // NEW FIELDS
  const pincodeField = document.getElementById("pincode");
  const cityField    = document.getElementById("city");
  const stateField   = document.getElementById("state");

  const pincodeWrapper = document.getElementById("pincodeWrapper");
  const cityWrapper    = document.getElementById("cityWrapper");
  const stateWrapper   = document.getElementById("stateWrapper");

  if (!nameField || !emailField || !addressField) return;

  // --- 3) Make name + email always visible ---
  nameField.closest("div").style.display = "block";
  emailField.closest("div").style.display = "block";
  paymentField.style.display = "block";
console.log("overlay about to show");   //
  // --- 4) Always show overlay (both cases) ---
  overlay.style.display = "flex";
  orderSelect.disabled = true;

  // ==========================================================
  //                LOGGED-IN USER LOGIC
  // ==========================================================
  if (isLoggedIn()) {

    nameField.readOnly = true;
    emailField.readOnly = true;
    addressField.readOnly = true;

    // Fetch everything from USER SHEET
    apiGet("getUserProfile", { mobile })
      .then(res => {
        if (res.success) {

          // Fill all fields FROM USER SHEET
          nameField.value = res.name || "";
          emailField.value = res.email || "";
          addressField.value = res.address || "";

          pincodeField.value = res.pincode || "";
          cityField.value    = res.city || "";
          stateField.value   = res.state || "";
        }
      })
      .finally(() => {

        // UI rules based on order type
        if (orderType === "Home Delivery") {

          // Address + 3 other fields visible
          addressWrapper.style.display = "block";
          pincodeWrapper.style.display = "block";
          cityWrapper.style.display    = "block";
          stateWrapper.style.display   = "block";
          changeBtn?.classList.remove("hidden");

          addressField.required = true;

        } else {
          // Takeaway / Dine-In ‚Üí hide address + pincode/city/state
          addressWrapper.style.display = "none";
          pincodeWrapper.style.display = "none";
          cityWrapper.style.display    = "none";
          stateWrapper.style.display   = "none";

          changeBtn?.classList.add("hidden");

          addressField.required = false;
        }

        overlay.style.display = "none";
        orderSelect.disabled = false;

      });

    return; // STOP HERE ‚Äî DO NOT TOUCH GUEST LOGIC
  }

  // ==========================================================
  //                GUEST USER LOGIC (UNTOUCHED)
  // ==========================================================

  nameField.readOnly = false;
  emailField.readOnly = false;
  addressField.readOnly = false;

  // Hide pincode/city/state for guest always
  pincodeWrapper.style.display = "none";
  cityWrapper.style.display    = "none";
  stateWrapper.style.display   = "none";

  apiGet("getCustomerDetailsByMobile", { mobile })
    .then(rows => {

      let orders = Array.isArray(rows) ? rows : [];

      if (orders.length === 0) {
        nameField.value = "";
        emailField.value = "";
        addressField.value = "";

        if (orderType === "Home Delivery") {
          addressWrapper.style.display = "block";
 addressField.required = true;
    addressField.readOnly = false;
    } else {
    addressWrapper.style.display = "none";
    addressField.required = false;
        }
        return;
      }

      // ----- Pick latest row -----
      let latest = orders.reduce((max, row) =>
        row.rowNumber > max.rowNumber ? row : max
      );

      // Fill name/email
      nameField.value = latest.name || "";
      emailField.value = latest.email || "";

      // ----- Latest HD Address -----
      let latestHD = "";
      for (let i = orders.length - 1; i >= 0; i--) {
        const row = orders[i];
        const hd =
          row.Address?.trim() ||
          row.address?.trim() ||
          row.Address1?.trim() ||
          row.Address2?.trim() ||
          "";

        if (row.orderType === "Home Delivery" && hd !== "") {
          latestHD = hd;
          break;
        }
      }

      // ----- Show/hide based on order type -----
      if (orderType === "Home Delivery") {
        addressWrapper.style.display = "block";
        addressField.required = true;
        addressField.readOnly = false;
        addressField.value = latestHD || "";

      } else {
        addressWrapper.style.display = "none";
        addressField.value = "";
        addressField.required = false;
      }

    })
    .catch(err => {
      console.error(err);
      alert("Error loading customer details.");
    })
    .finally(() => {
      overlay.style.display = "none";
      orderSelect.disabled = false;
    });

}


    
function normalizeCartForOrder(cart) {
  return cart.map(item => {
    const qty = Number(item.qty || 1);
    const rate = Number(item.rate || item.price || 0);
    const discPercent = Number(item.discPercent || 0);

    const discAmt = +(rate * discPercent / 100).toFixed(2);
    const netRate = +(rate - discAmt).toFixed(2);
    const netAmt  = +(netRate * qty).toFixed(2);

    return {
      itemId: item.itemId || "",
      variantId: item.variantId || "",
      name: item.name,
      unit: item.unit || "",
      qty: qty,
      rate: rate,
      discPercent: discPercent,
      discAmt: discAmt,
      netAmt: netAmt,
      total: netAmt,          // ‚≠ê IMPORTANT
      image: item.image || ""
    };
  });
}

function resetMenuCartUI() {
  console.log("‚úÖ resetMenuCartUI called");

  // sab menu + buttons pakdo
  document.querySelectorAll("button[onclick^='menuPlus']").forEach(plusBtn => {

    // minus button (previous sibling)
    const minusBtn = plusBtn.previousElementSibling;

    // qty text node (minus aur plus ke beech)
    const qtyNode = plusBtn.previousSibling;

    // qty reset
    if (qtyNode && qtyNode.nodeType === Node.TEXT_NODE) {
      qtyNode.textContent = "0";
    }

    // minus hide
    if (minusBtn && minusBtn.tagName === "BUTTON") {
      minusBtn.classList.add("hidden");
    }
  });
}


    
function placeOrder() {
  console.log("---- DEBUG START ----");
  console.log("getCart() returns:", getCart());
  console.log("global cart variable:", cart);

  if (window._orderLock) return;
  window._orderLock = true;

  const customerName = document.getElementById('customerName').value.trim();
  const email = document.getElementById('email').value.trim();
  const mobile = document.getElementById('mobile').value.trim();
  const orderType = document.getElementById('orderType').value;
  const address = document.getElementById('address').value.trim();
  const paymentMethod = document.getElementById('paymentMethod').value;
// ‚úÖ OPTION A: Address sirf Home Delivery me hi save hoga
const finalAddress =
  orderType === "Home Delivery" ? address : "";

  if (!orderType) {
  alert("Please select Order Type");
  window._orderLock = false;
  return;
}
if (!paymentMethod) {
  alert("Please select Payment Method");
  window._orderLock = false;
  return;
}


  if (!/^[0-9]{10}$/.test(mobile)) {
    alert("Enter a valid 10-digit mobile number");
    window._orderLock = false;
    return;
  }

  if (orderType === "Home Delivery" && !address) {
    alert("Please enter delivery address");
    window._orderLock = false;
    return;
  }

  const dt = window._drawerTotals || {};

  // üîí IMPORTANT: cart ka COPY bhejo (reference nahi)
  const safeCartItems = getCart().map(i => ({ ...i }));

  const orderData = {
    customerName,
    email,
    mobile,
    orderType,
    address: finalAddress,
    cartItems: normalizeCartForOrder(safeCartItems),


    baseTotal: Number(dt.baseTotal || 0),
    offerDiscount: Number(dt.offerDiscount || 0),
    signupDiscount: Number(dt.signupDiscount || 0),
    payableAfterDiscount: Number(dt.payableAfterDiscount || 0),

    serviceAmt: Number(dt.serviceAmt || 0),
    taxableAmount: Number(dt.taxableAmount || 0),
    cgstAmt: Number(dt.cgstAmt || 0),
    sgstAmt: Number(dt.sgstAmt || 0),
    igstAmt: Number(dt.igstAmt || 0),
    grandTotal: Number(dt.grandTotal || 0),

    paymentMethod,

    couponId: selectedCoupon ? selectedCoupon.id : "",
    couponType: selectedCoupon ? selectedCoupon.type : "",
    couponDiscount: selectedCoupon
      ? (selectedCoupon.flat
          ? selectedCoupon.flat
          : ((selectedCoupon.discount / 100) * Number(dt.baseTotal || 0)))
      : 0
  };
console.log("üöÄ ORDER PAYLOAD TO BACKEND:", JSON.stringify(orderData, null, 2));

  const overlay = document.getElementById('loadingOverlay');
  overlay.innerText = "Processing your order... Please wait...";
  overlay.style.display = "flex";

  document.querySelectorAll('#checkoutForm input, #checkoutForm select, #checkoutForm button')
    .forEach(el => el.disabled = true);

  apiPost("placeOrder", orderData)
    .then(res => {
      if (res.success) {
        alert(
          `Order placed successfully!\nYour Order Number: ${res.orderNumber}\n\n${res.message}`
        );

        // ‚úÖ SAME cart reference ko empty karo
        // 1Ô∏è‚É£ clear global cart
cart.length = 0;

// 2Ô∏è‚É£ clear storage (guest + logged in safe)
localStorage.removeItem("cart");
localStorage.removeItem("guestCart");
  //  FIX: signup discount one-time only
  window.signupDiscount = 0;
  localStorage.removeItem("signupDiscount");
// 3Ô∏è‚É£ reset drawer totals
window._drawerTotals = null;

// 4Ô∏è‚É£ UI refresh
renderCart();


        closeCheckout();

         setTimeout(() => {
    location.reload();
  }, 300);
      } else {
        alert(res.message || "Order failed.");
      }
    })
    .catch(err => {
      console.error("Order error:", err);
      alert("Error placing order. Please try again.");
    })
    .finally(() => {
      overlay.style.display = "none";
      document.querySelectorAll('#checkoutForm input, #checkoutForm select, #checkoutForm button')
        .forEach(el => el.disabled = false);

      window._orderLock = false;
    });
}


function filterMenu() {
  const text = document.getElementById("menuSearch").value.toLowerCase();
  const selected = document.getElementById("categoryFilter").value; // note: keep original case (Title Case)

  // priority list - same as renderMenu/populateCategoryDropdown
  const categoryPriority = [
    "starters",
    "snacks",
    "drinks",
    "mocktails",
    "cocktails",
    "main course",
    "sweets",
    "desserts"
  ];

  // Step 1: canonical category detect (PASS priority list)
  let filtered = menuItems.map(i => ({
    ...i,
    canonical: canonicalCategory(i.category, categoryPriority).toLowerCase()
  }));

  // Step 2: Apply category filter (if selected not empty)
  if (selected && selected.trim() !== "") {
    const selLower = selected.toLowerCase();
    filtered = filtered.filter(i => i.canonical === selLower);
  }

  // Step 3: Apply text filter
  if (text.trim() !== "") {
    const q = text.trim();
    filtered = filtered.filter(i =>
      (String(i.name || "").toLowerCase().includes(q)) ||
      (i.description && String(i.description).toLowerCase().includes(q))
    );
  }

  // If no filter ? show full grouped menu (reuse renderMenu)
  if ((!selected || selected === "") && text.trim() === "") {
    renderMenu(menuItems);
    return;
  }

  const menuDiv = document.getElementById("menu");
  menuDiv.innerHTML = "";

  if (filtered.length === 0) {
    menuDiv.innerHTML = "<p style='padding:10px;'>No items found.</p>";
    return;
  }

  // Step 4: Group filtered results by canonical category (preserve ordering by priority)
  const groups = {};
  filtered.forEach(item => {
    const cat = item.canonical || "Other";
    if (!groups[cat]) groups[cat] = [];
    groups[cat].push(item);
  });

  // Build order: priority first, then alphabetic
  const groupKeys = Object.keys(groups);
  groupKeys.sort((a,b) => {
    const ai = categoryPriority.indexOf(a);
    const bi = categoryPriority.indexOf(b);
    if (ai !== -1 && bi !== -1) return ai - bi;
    if (ai !== -1) return -1;
    if (bi !== -1) return 1;
    return a.localeCompare(b);
  });

  // Step 5: Render groups using buildMenuCardHTML + activateVariantSelector
  groupKeys.forEach(cat => {
    const heading = document.createElement("h2");
    heading.classList.add("slideIn");
    // Title case heading
    heading.innerHTML = cat.replace(/\b\w/g, c => c.toUpperCase());
    heading.style.margin = "10px 0 5px";
    heading.style.padding = "10px";
    heading.style.background = "#ff6347";
    heading.style.color = "white";
    heading.style.borderRadius = "6px";
    heading.style.gridColumn = "1 / -1";
    menuDiv.appendChild(heading);

    groups[cat].forEach(item => {
      const div = document.createElement("div");
      div.className = "menu-item fadeIn";

      // Use the same card builder as the main view (handles Single / Multi)
      div.innerHTML = buildMenuCardHTML(item);
      menuDiv.appendChild(div);

      // Activate variant selector if item is multi (so radio -> button enabling works)
      try {
        activateVariantSelector(item);
      } catch (e) {
        // fail-safe: don't break UI on JS errors
        console.error("activateVariantSelector error:", e);
      }
    });
  });
}


  </script>
<div id="loginProgressOverlay"
     class="fixed inset-0 bg-black bg-opacity-40 z-[10000] hidden 
            flex items-center justify-center text-white text-xl font-semibold">
  Login in progress‚Ä¶
</div>


  



<!-- LOGIN OVERLAY (NEW TAILWIND VERSION) -->
<div id="loginModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">

    <div class="bg-white w-full max-w-sm rounded-xl p-5 relative">


    <button onclick="closeLogin()"
      class="absolute top-3 right-3 text-gray-600 text-2xl font-semibold">
      &times;
    </button>

    <h2 class="text-xl font-semibold text-gray-800 text-center mb-6">
      Login to Continue
    </h2>

    <!-- Mobile -->
    <input id="loginMobile" type="tel" maxlength="10"
      placeholder="Enter Mobile Number"
      class="w-full border border-gray-300 rounded-lg px-4 py-3 text-base 
       focus:ring-2 focus:ring-orange-400 outline-none"
      />

    <!-- Password -->
    <input id="loginPassword" type="password"
      placeholder="Enter Password"
      class="w-full border border-gray-300 rounded-lg px-4 py-3 text-base 
       focus:ring-2 focus:ring-orange-400 outline-none"
       />

    <!-- Login Button -->
    <button onclick="loginUser()"
      class="w-full bg-orange-500 text-white py-3 rounded-lg font-semibold 
       shadow-md hover:bg-orange-600 transition">
      Login
    </button>

<!-- Forgot Password -->
<button onclick="openForgotPassword()"
  class="text-orange-600 text-sm font-medium mt-3 nohighlight"
  style="background:none; border:none; padding:0;">
  Forgot Password?
</button>


<!-- Signup Link -->
<div class="text-center text-sm text-gray-600 mt-2">
  Not registered?
  <span onclick="openSignup()" class="text-orange-600 font-semibold cursor-pointer">
    Sign Up
  </span>
</div>

      
  </div>
</div>



<!-- FORGOT PASSWORD MODAL -->
<div id="forgotPasswordModal"
     class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center">

  <div class="bg-white w-11/12 max-w-sm rounded-xl p-6 shadow-lg text-center relative">

    <h2 class="text-[18px] text-gray-800 mb-2">Reset Your Password</h2>

    <!-- Mobile -->
    <input id="fpMobile" type="tel" maxlength="10"
      placeholder="Enter Mobile Number"
      class="w-full border border-gray-300 rounded-lg px-4 py-3 mt-2" />

    <!-- Send OTP -->
    <button onclick="sendResetOTP()"
      class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold mt-3">
      Send OTP
    </button>

    <!-- OTP -->
    <input id="fpOTP" type="text" style="display:none"
      placeholder="Enter OTP"
      class="w-full border border-gray-300 rounded-lg px-4 py-3 mt-3" />

    <!-- New Password -->
    <input id="fpNewPass" type="password" style="display:none"
      placeholder="Enter New Password"
      class="w-full border border-gray-300 rounded-lg px-4 py-3 mt-3" />

    <!-- Update Button -->
    <button id="resetBtn" onclick="resetPassword()" style="display:none"
      class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold mt-3">
      Update Password
    </button>

    <!-- Close -->
    <button onclick="closeForgotPassword()"
      class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg mt-3">
      Close
    </button>

    <!-- üü¢ OVERLAY INSIDE CARD -->
    <div id="fpOverlay"
      class="absolute inset-0 bg-black bg-opacity-40 text-white font-semibold text-lg
             flex items-center justify-center rounded-xl hidden">
      Sending OTP...
    </div>

  </div>
</div>


<!-- SIGNUP MODAL (COMPACT + CLEAN) -->
<div id="signupModal"
     class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center">
  <div class="modal-content bg-white w-11/12 max-w-sm rounded-xl p-5 shadow-lg space-y-3 overflow-y-auto"

       style="max-height: 90vh;">

    <h2 class="text-lg font-semibold text-gray-800 text-center">Welcome User</h2>

    <p class="text-sm text-gray-600 text-center -mt-1">
      This is a test signup window. No backend code is triggered.
    </p>

    <!-- Mobile -->
    <input type="text" id="suMobile" placeholder="Mobile Number"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
             focus:ring-2 focus:ring-orange-400 outline-none"/>

    <!-- Password -->
    <input type="password" id="suPassword" placeholder="Password"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
             focus:ring-2 focus:ring-orange-400 outline-none"/>

    <!-- Name -->
    <input type="text" id="suName" placeholder="Full Name"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
             focus:ring-2 focus:ring-orange-400 outline-none"/>

    <!-- Email -->
    <input type="email" id="suEmail" placeholder="Email Address"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
             focus:ring-2 focus:ring-orange-400 outline-none"/>

    <!-- Send OTP -->
    <button type="button" onclick="sendEmailOTP()"
      class="w-full bg-blue-500 text-white py-2 rounded-lg text-sm font-semibold 
             shadow hover:bg-blue-600 transition">
      Send OTP
    </button>

    <!-- Email OTP -->
    <input type="text" id="suEmailOTP" placeholder="Enter Email OTP" 
  style="display:none"
  class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
         focus:ring-2 focus:ring-orange-400 outline-none"/>


    <!-- Address -->
    <textarea id="suAddress" placeholder="Address"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
             focus:ring-2 focus:ring-orange-400 outline-none resize-none h-20"></textarea>

    <!-- NEW PINCODE FIELD -->
    <select id="suPincode" onchange="onPincodeSelect()"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
             focus:ring-2 focus:ring-orange-400 outline-none">
      <option value="">Select Pincode</option>
    </select>

    <!-- City -->
    <input type="text" id="suCity" placeholder="City" readonly
      class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-sm 
             text-gray-600 outline-none"/>

    <!-- State -->
    <input type="text" id="suState" placeholder="State" readonly
      class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-sm 
             text-gray-600 outline-none"/>

    <!-- Submit -->
    <button onclick="verifyAndSignup()"
      class="w-full bg-green-600 text-white py-2 rounded-lg text-sm font-semibold 
             shadow hover:bg-green-700 transition">
      Submit
    </button>

    <!-- Close -->
    <button onclick="closeSignup()"
      class="w-full bg-gray-200 text-gray-800 py-2 rounded-lg text-sm font-medium 
             shadow hover:bg-gray-300 transition">
      Close
    </button>

    
  </div>
</div>

<script>

function openLogin() {
  const modal = document.getElementById("loginModal");
   modal.style.display = "flex";
  modal.classList.remove("hidden");
 document.getElementById("signupLabelBox").style.display = "none";
}


function closeLogin() {
  const modal = document.getElementById("loginModal");

  // FULL HARD CLOSE
  modal.style.display = "none";
  modal.classList.add("hidden");

  // REMOVE ANY POSSIBLE OVERLAY FREEZE
  unlockLoginForm();

  // Force hide all overlays inside login
  const overlay = document.getElementById("loginProgressOverlay");
  if (overlay) overlay.classList.add("hidden");

  // Clear fields (safety)
  document.getElementById("loginMobile").value = "";
  document.getElementById("loginPassword").value = "";

  // ‚≠ê IMPORTANT FIX: Show signup label again
  const label = document.getElementById("signupLabelBox");
  if (label) label.style.display = "block";
}

function logoutUser() {
  // UI resets
  document.getElementById("userInfoBox").style.display = "none";
  document.getElementById("loggedEmail").innerText = "";

  document.querySelector("button[onclick='openLogin()']").style.display = "inline-block";
  document.querySelector("button[onclick='openSignup()']").style.display = "inline-block";

  document.getElementById("logoutBtn").style.display = "none";
  document.getElementById("signupLabelBox").style.display = "block";
  document.getElementById("hamburgerBtn").style.display = "none";

  document.getElementById("leftNav").style.display = "none";
  document.getElementById("leftNav").classList.remove("active");

  document.getElementById("menuWrapper").style.display = "block";
  document.getElementById("pageWrapper").style.display = "none";

  document.getElementById("profilePage").style.display = "none";
  document.getElementById("ordersPage").style.display = "none";
  document.getElementById("offersPage").style.display = "none";

  document.querySelectorAll("#premiumMenu li").forEach(li =>
    li.classList.remove("active")
  );
  document.getElementById("mainContent").style.marginLeft = "0";

  // ==== LOGIN IDENTITY CLEAR ====
  localStorage.removeItem("userMobile");
  localStorage.removeItem("userEmail");

  // ==== CART LOGOUT RULE ====
  localStorage.removeItem("cart");
  localStorage.removeItem("guestCart");
  cart = [];
  window.cart = [];
  resetMenuUIForLogout();

  // Reset session
  localStorage.removeItem("sessionId");

  // Reset checkout UI
  document.getElementById("mobile").value = "";
  document.getElementById("customerName").value = "";
  document.getElementById("email").value = "";
  document.getElementById("address").value = "";

  // Re-render cart
  renderCart();

  // üî• VERY IMPORTANT: clear overlays BEFORE alert
  forceClearOverlays();

  // ‚úÖ Alert AFTER cleanup
  setTimeout(() => {
    alert("Logged out successfully.");
  }, 50);
}
function forceClearOverlays() {

  ["loadingOverlay","cartOverlay","newAddressModal","couponOverlayBG"]
    .forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.style.display = "none";
      el.classList.add("hidden");
    });

  const backdrop = document.getElementById("cartBackdrop");
  if (backdrop) {
    backdrop.classList.remove("active");
    backdrop.style.display = "none";
    backdrop.style.pointerEvents = "none";
  }

  document.body.style.overflow = "auto";
}



</script>
<script>
let cityList = []; // map sheet data store

function openSignup() {
  document.getElementById("signupModal").style.display = "flex";

  // Load city/pincode list only once
  if (cityList.length === 0) {
    apiGet("getCityList")
      .then(res => fillPincodeDropdown(res.cities))
      .catch(err => {
        console.error("City list load error:", err);
        alert("Failed to load city/pincode list.");
      });
  }
}




function closeSignup() {
  document.getElementById("signupModal").style.display = "none";
}

function fillPincodeDropdown(list) {
  cityList = list;

  const ddl = document.getElementById("suPincode");
  ddl.innerHTML = `<option value="">Select Pincode</option>`;

  list.forEach(item => {
    const opt = document.createElement("option");
    opt.value = item.pin;
    opt.textContent = item.pin;
    ddl.appendChild(opt);
  });
}

function onPincodeSelect() {
  const pin = document.getElementById("suPincode").value;
  const cityBox = document.getElementById("suCity");
  const stateBox = document.getElementById("suState");

  if (!pin) {
    cityBox.value = "";
    stateBox.value = "";
    return;
  }

  const record = cityList.find(r => String(r.pin) === String(pin));

  if (record) {
    cityBox.value = record.city;
    stateBox.value = record.state;
  } else {
    cityBox.value = "";
    stateBox.value = "";
    alert("Pincode not found.");
  }
}

function finalSignup() {
  const user = {
    mobile: document.getElementById("suMobile").value.trim(),
    password: document.getElementById("suPassword").value.trim(),
    name: document.getElementById("suName").value.trim(),
    email: document.getElementById("suEmail").value.trim(),
    address: document.getElementById("suAddress").value.trim(),
    pincode: document.getElementById("suPincode").value.trim(),
    city: document.getElementById("suCity").value.trim(),
    state: document.getElementById("suState").value.trim()
  };

  // BASIC VALIDATIONS
  if (!/^[0-9]{10}$/.test(user.mobile)) {
    alert("Enter valid 10-digit mobile.");
    return;
  }
  if (!user.password) return alert("Enter password");
  if (!user.name) return alert("Enter name");
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(user.email)) {
    alert("Enter valid email.");
    return;
  }
  if (user.pincode.length !== 6) {
    alert("Enter valid 6-digit pincode.");
    return;
  }
  if (!user.city || !user.state) {
    alert("Invalid pincode area.");
    return;
  }

  // FORM ALREADY LOCKED BY verifyAndSignup()
  // ? DO NOT CALL lockSignupForm() AGAIN
  updateSignupOverlayMessage("Creating account...");

  // ? CORRECT POST REQUEST
  fetch(API_BASE + "?api=registerUser", {
    method: "POST",
     body: JSON.stringify(user)
  })
    .then(r => {
      // If server returned non-JSON ? avoid crash
      if (!r.ok) throw new Error("Server error " + r.status);
      return r.json();
    })
    .then(res => {
      unlockSignupForm();

      if (res.success) {
        alert(res.message || "Signup successful!");
        closeSignup();
      } else {
        alert(res.message || "Signup failed.");
      }
    })
    .catch(err => {
      unlockSignupForm();
      alert("Signup failed: " + err.message);
    });
}


function lockSignupForm() {
  const modal = document.querySelector("#signupModal .modal-content");

  // Disable all fields inside modal
  [...modal.querySelectorAll("input, select, textarea, button")].forEach(el => {
    el.disabled = true;
  });

  // Overlay
  const overlay = document.createElement("div");
  overlay.id = "signupProgressOverlay";
  overlay.style.position = "fixed";
  overlay.style.inset = "0";
  overlay.style.background = "rgba(0,0,0,0.35)";
  overlay.style.display = "flex";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.fontSize = "22px";
  overlay.style.color = "#fff";
  overlay.style.zIndex = "9999";
  overlay.textContent = "Signup in progress‚Ä¶";
  document.body.appendChild(overlay);
}
function unlockSignupForm() {
  const modal = document.querySelector("#signupModal .modal-content");

  // Enable everything
  [...modal.querySelectorAll("input, select, textarea, button")].forEach(el => {
    el.disabled = false;
  });

  // Remove overlay
  const overlay = document.getElementById("signupProgressOverlay");
  if (overlay) overlay.remove();
}

function sendEmailOTP() {
  const email = document.getElementById("suEmail").value.trim();

  if (!email) {
    alert("Please enter email first.");
    return;
  }

  // ?? lock UI while sending OTP
  lockSignupForm();
  updateSignupOverlayMessage("Sending OTP...");

  // ? GAS ? Netlify API call conversion
  apiGet("sendSignupEmailOTP", { email })
    .then(res => {
      unlockSignupForm();

      if (res.success) {
        alert("OTP sent to your email!");
        document.getElementById("suEmailOTP").style.display = "block";
      } else {
        alert(res.message);
      }
    })
    .catch(err => {
      unlockSignupForm();
      alert("Error sending OTP: " + err.message);
    });
}

function verifyAndSignup() {
  const email = document.getElementById("suEmail").value.trim();
  const otp = document.getElementById("suEmailOTP").value.trim();

  if (!otp) {
    alert("Please enter OTP.");
    return;
  }

  // ?? LOCK UI + show overlay "Verifying OTP..."
  lockSignupForm();
  updateSignupOverlayMessage("Verifying OTP...");

  // ? Netlify API CALL (GAS ?????)
  apiGet("verifyEmailOTP", { email, otp })
    .then(res => {
      if (!res.success) {
        unlockSignupForm();
        alert(res.message);
        return;
      }

      // OTP verified ? show next message
      updateSignupOverlayMessage("Creating Account...");

      // Now create new user
      finalSignup();
    })
    .catch(err => {
      unlockSignupForm();
      alert("OTP verification failed: " + err.message);
    });
}

 
function updateSignupOverlayMessage(msg) {
  const overlay = document.getElementById("signupProgressOverlay");
  if (overlay) overlay.textContent = msg;
}

// === FINAL STABLE LOAD HANDLER ===
window.addEventListener("load", async () => {
  await loadRestaurantSettings();

  // clear login fields
  const loginMobile = document.getElementById("loginMobile");
  const loginPassword = document.getElementById("loginPassword");
  if (loginMobile) loginMobile.value = "";
  if (loginPassword) loginPassword.value = "";

  const mobile = localStorage.getItem("userMobile");
  const email  = localStorage.getItem("userEmail");
  //  LOAD USER CART FROM BACKEND IF LOGGED IN


  // Always reset full UI first
  document.getElementById("menuWrapper").style.display = "block";
  document.getElementById("pageWrapper").style.display = "none";

  document.getElementById("profilePage").style.display = "none";
  document.getElementById("ordersPage").style.display = "none";
  document.getElementById("offersPage").style.display = "none";

  document.getElementById("leftNav").classList.remove("active");
  document.getElementById("leftNav").style.display = "none";
  document.getElementById("mainContent").style.marginLeft = "0";

  document.getElementById("hamburgerBtn").style.display = "none";
  document.getElementById("logoutBtn").style.display = "none";
  document.getElementById("userInfoBox").style.display = "none";

  document.querySelector("button[onclick='openLogin()']").style.display = "inline-block";
  document.querySelector("button[onclick='openSignup()']").style.display = "inline-block";
  document.getElementById("signupLabelBox").style.display = "block";

  // ----- if logged in -----
  if (mobile) {

    // Show user info
    document.getElementById("loggedEmail").innerText = email || "";
    document.getElementById("userInfoBox").style.display = "block";

    // Hide login/signup
    document.querySelector("button[onclick='openLogin()']").style.display = "none";
    document.querySelector("button[onclick='openSignup()']").style.display = "none";
    document.getElementById("signupLabelBox").style.display = "none";

    // Show nav + hamburger
    document.getElementById("leftNav").style.display = "block";
    document.getElementById("hamburgerBtn").style.display = "block";
    document.getElementById("logoutBtn").style.display = "inline-block";

    // Always show menu page after refresh
    showPage("menuPage");

    // highlight first item
    const firstMenu = document.querySelector("#premiumMenu li");
    if (firstMenu) firstMenu.classList.add("active");
  }
   loadCartOnStart();
  if (!isLoggedIn()) {
  const guest = JSON.parse(localStorage.getItem("guestCart") || "[]");

  // Render only if actually a valid array
  if (Array.isArray(guest) && guest.length > 0) {
    cart = guest;
    window.cart = guest;
    renderCart();
   
     document.getElementById("cartToggleBar")?.classList.add("active-cart");
  }
}
});

function validateLoginMobile() {
  const input = document.getElementById("loginMobile");
  const error = document.getElementById("mobileError");

  const original = input.value;          // User typed value
  const digitsOnly = original.replace(/\D/g, "");  // Remove letters

  // Update field to digits only
  input.value = digitsOnly;

  //  If user typed any non-digit (abcd etc.)
  if (original !== digitsOnly) {
    error.style.display = "block";
    error.innerText = "Please enter only mobile numbers. Letters are not allowed.";
    return;
  }

  //  Less than 10 digits but typed correctly
  if (digitsOnly.length > 0 && digitsOnly.length < 10) {
    error.style.display = "block";
    error.innerText = "Please enter a valid 10-digit mobile number.";
    return;
  }

  //  Exactly 10 digits ? no warning
  if (digitsOnly.length === 10) {
    error.style.display = "none";
    return;
  }

  //  Empty field ? hide error
  error.style.display = "none";
}

function lockLoginForm() {
  document.querySelectorAll("#loginModal input, #loginModal button")
    .forEach(el => el.disabled = true);

  document.getElementById("loginProgressOverlay").classList.remove("hidden");
}


function unlockLoginForm() {
  document.querySelectorAll("#loginModal input, #loginModal button")
    .forEach(el => el.disabled = false);

  document.getElementById("loginProgressOverlay").classList.add("hidden");
}



function openForgotPassword() {

  // CLOSE LOGIN MODAL
  document.getElementById("loginModal").style.display = "none";

  // OPEN FORGOT MODAL
  document.getElementById("forgotPasswordModal").style.display = "flex";

  // RESET FIELDS
  document.getElementById("fpOTP").style.display = "none";
  document.getElementById("fpNewPass").style.display = "none";
  document.getElementById("resetBtn").style.display = "none";
}



function closeForgotPassword() {
  document.getElementById("forgotPasswordModal").style.display = "none";

  // Reset fields
  document.getElementById("fpMobile").value = "";
  document.getElementById("fpOTP").value = "";
  document.getElementById("fpNewPass").value = "";

  // Hide OTP and Password fields
  document.getElementById("fpOTP").style.display = "none";
  document.getElementById("fpNewPass").style.display = "none";
  document.getElementById("resetBtn").style.display = "none";
}

// STEP 1: SEND OTP
function sendResetOTP() {
  const mobile = document.getElementById("fpMobile").value.trim();

  if (!/^[0-9]{10}$/.test(mobile)) {
    alert("Please enter valid 10-digit mobile.");
    return;
  }

  // SHOW Overlay (inside modal only)
  const overlay = document.getElementById("fpOverlay");
  overlay.style.display = "flex";
  overlay.textContent = "Sending OTP...";

  // LOCK form
  lockForgotForm();

  // API CALL
  apiGet("sendPasswordResetOTP", { mobile })
    .then(res => {
      overlay.style.display = "none";
      unlockForgotForm();

      if (res.success) {
        alert("OTP sent successfully!");

        // SHOW OTP fields
        document.getElementById("fpOTP").style.display = "block";
        document.getElementById("fpNewPass").style.display = "block";
        document.getElementById("resetBtn").style.display = "block";
      } else {
        alert(res.message);
      }
    })
    .catch(err => {
      overlay.style.display = "none";
      unlockForgotForm();
      alert("Error: " + err.message);
    });
}


// STEP 2: RESET PASSWORD
function resetPassword() {
  const mobile = document.getElementById("fpMobile").value.trim();
  const otp = document.getElementById("fpOTP").value.trim();
  const newPass = document.getElementById("fpNewPass").value.trim();

  if (!otp) {
    alert("Enter OTP.");
    return;
  }
  if (!newPass) {
    alert("Enter new password.");
    return;
  }

  // SHOW OVERLAY + LOCK UI
  document.getElementById("fpOverlay").style.display = "flex";
  lockForgotForm();
  updateForgotOverlay("Updating password...");

  apiPost("resetPassword", { mobile, otp, newPass })
    .then(res => {
      document.getElementById("fpOverlay").style.display = "none";
      unlockForgotForm();

      if (res.success) {
        alert("Password updated successfully!");

        closeForgotPassword();

        //  FIX 1 ‚Äî ensure login form is unlocked
        unlockLoginForm();

        //  FIX 2 ‚Äî open login modal again
        document.getElementById("loginModal").style.display = "flex";
      } else {
        alert(res.message);
      }
    })
    .catch(err => {
      document.getElementById("fpOverlay").style.display = "none";
      unlockForgotForm();
      alert("Error: " + err.message);

      //  Ensure login is not stuck locked
      unlockLoginForm();
    });
}

function lockForgotForm() {
  const modal = document.querySelector("#forgotPasswordModal > div");
  modal.querySelectorAll("input, button").forEach(el => el.disabled = true);
}

function unlockForgotForm() {
  const modal = document.querySelector("#forgotPasswordModal > div");
  modal.querySelectorAll("input, button").forEach(el => el.disabled = false);
}


function updateForgotOverlay(msg) {
  document.getElementById("fpOverlay").textContent = msg;
}
function showPage(pageId) {
  // Always hide both wrappers first
  document.getElementById("menuWrapper").style.display = "none";
  document.getElementById("pageWrapper").style.display = "none";

  // Hide all inner pages
  document.getElementById("profilePage").style.display = "none";
  document.getElementById("ordersPage").style.display = "none";
  document.getElementById("offersPage").style.display = "none";

  // Show requested
  if (pageId === "menuPage") {
    document.getElementById("menuWrapper").style.display = "block";
  } else {
    document.getElementById("pageWrapper").style.display = "block";
    document.getElementById(pageId).style.display = "block";
  }
}



function activateMenu(element) {
  document.querySelectorAll("#premiumMenu li").forEach(li => li.classList.remove("active"));
  element.classList.add("active");
}

function toggleSidebar() {
  const sidebar = document.getElementById("leftNav");
  const menuBtn = document.getElementById("hamburgerBtn");
  const main = document.getElementById("mainContent");

  // Sidebar hidden ? open
  if (!sidebar.classList.contains("active")) {
    sidebar.classList.add("active");
    main.style.marginLeft = "220px";
    menuBtn.innerHTML = `
<svg width="22" height="22">
  <path d="M4 4 L20 20 M20 4 L4 20" stroke="#FFD166" stroke-width="3"/>
</svg>`;

  } 
  else {
    // close sidebar
    sidebar.classList.remove("active");
    main.style.marginLeft = "0";
    menuBtn.innerHTML = `
<svg width="24" height="24" fill="#FFD166">
  <rect y="4" width="24" height="3"></rect>
  <rect y="10" width="24" height="3"></rect>
  <rect y="16" width="24" height="3"></rect>
</svg>`;


  }
}
function loadUserProfile() {
  const mobile = localStorage.getItem("userMobile");

  if (!mobile) {
    alert("Session expired. Please login again.");
    return;
  }

  // ? SHOW SIMPLE LOADING TEXT
  document.getElementById("profileLoading").style.display = "block";

  // ? Netlify API replacement
  apiGet("getUserProfile", { mobile })
    .then(res => {
      document.getElementById("profileLoading").style.display = "none";

      if (!res.success) {
        alert("User not found");
        return;
      }

      fillProfileForm(res);
    })
    .catch(err => {
      document.getElementById("profileLoading").style.display = "none";
      alert("Failed: " + err.message);
    });
}
function loadUserOrders() {
  const mobile = localStorage.getItem("userMobile");
  if (!mobile) {
    alert("Session expired. Please login again.");
    return;
  }
  // ? SHOW SIMPLE LOADING TEXT
  document.getElementById("ordersLoading").style.display = "block";
  // ? Netlify API replacement
  apiGet("getUserOrders", { mobile })
    .then(res => {
      document.getElementById("ordersLoading").style.display = "none";
      if (!res.success) {
        alert("No orders found");
        return;
      }
      fillOrdersList(res.orders);
    })
    .catch(err => {
      document.getElementById("ordersLoading").style.display = "none";
      alert("Failed: " + err.message);
    });
}
function loadOffers() {
  // ? SHOW SIMPLE LOADING TEXT
  document.getElementById("offersLoading").style.display = "block";
  // ? Netlify API replacement
  apiGet("getOffers", {})
    .then(res => {
      document.getElementById("offersLoading").style.display = "none";
      if (!res.success) {
        alert("No offers available");
        return;
      }
      fillOffersList(res.offers);
    })
    .catch(err => {
      document.getElementById("offersLoading").style.display = "none";
      alert("Failed: " + err.message);
    });
}

function fillProfileForm(res) {
  document.getElementById("profileLoading").style.display = "none";

  if (!res.success) {
    alert("User not found");
    return;
  }

  // Autofill
  document.getElementById("pName").value = res.name || "";
  document.getElementById("pMobile").value = res.mobile || "";
  document.getElementById("pEmail").value = res.email || "";
  document.getElementById("pAddress").value = res.address || "";
   document.getElementById("ppin").value = res.pincode || "";
  document.getElementById("pCity").value = res.city || "";
  document.getElementById("pState").value = res.state || "";
  setProfileReadonly(true);
}
function showProfilePage() {
  hideAllPages();
  document.getElementById("profilePage").style.display = "block";
  loadUserProfile();   // ? profile load karo
}

function setProfileReadonly(state) {
  document.getElementById("pName").readOnly = state;
  document.getElementById("pEmail").readOnly = state;
  document.getElementById("pAddress").readOnly = state;
  document.getElementById("ppin").readOnly = state;
  document.getElementById("pCity").readOnly = state;
  document.getElementById("pState").readOnly = state;

  // Mobile never editable
  document.getElementById("pMobile").disabled = true;
}
function enableProfileEdit() {
  setProfileReadonly(false);

  document.getElementById("editBtn").style.display = "none";
  document.getElementById("saveBtn").style.display = "inline-block";
  document.getElementById("cancelBtn").style.display = "inline-block";
}
function cancelProfileEdit() {
  loadUserProfile();   // reload original values
  document.getElementById("editBtn").style.display = "inline-block";
  document.getElementById("saveBtn").style.display = "none";
  document.getElementById("cancelBtn").style.display = "none";
}

function saveProfile() {
  const data = {
    mobile: document.getElementById("pMobile").value.trim(),
    name: document.getElementById("pName").value.trim(),
    email: document.getElementById("pEmail").value.trim(),
    address: document.getElementById("pAddress").value.trim(),
    pincode: document.getElementById("ppin").value.trim(),
    city: document.getElementById("pCity").value.trim(),
    state: document.getElementById("pState").value.trim()
  };

  if (!data.name) return alert("Name cannot be empty");
  if (!data.email) return alert("Email cannot be empty");
  if (data.pincode.length !== 6) return alert("Enter valid 6-digit pincode");

  // ? Show overlay
  document.getElementById("profileOverlay").classList.add("active");

  // Disable buttons
  document.getElementById("editBtn").disabled = true;
  document.getElementById("saveBtn").disabled = true;
  document.getElementById("cancelBtn").disabled = true;

  // ? Netlify POST request
  apiPost("updateUserProfile", data)
    .then(res => {
      document.getElementById("profileOverlay").classList.remove("active");

      // Re-enable buttons
      document.getElementById("editBtn").disabled = false;
      document.getElementById("saveBtn").disabled = false;
      document.getElementById("cancelBtn").disabled = false;

      if (res.success) {
        alert("Profile updated successfully!");
        loadUserProfile();

        document.getElementById("editBtn").style.display = "inline-block";
        document.getElementById("saveBtn").style.display = "none";
        document.getElementById("cancelBtn").style.display = "none";
      } else {
        alert(res.message);
      }
    })
    .catch(err => {
      document.getElementById("profileOverlay").classList.remove("active");
      alert("Error: " + err.message);
    });
}


</script>
<script>
let deferredPrompt;

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;

  // Show button
  document.getElementById("installBtn").style.display = "block";
});

// When user clicks install button
document.getElementById("installBtn").addEventListener("click", async () => {
  if (!deferredPrompt) return;

  deferredPrompt.prompt();

  const result = await deferredPrompt.userChoice;

  if (result.outcome === "accepted") {
    alert("App installed successfully!");
  }

  deferredPrompt = null;

  // Hide button after install
  document.getElementById("installBtn").style.display = "none";
});

// Hide button if already installed
window.addEventListener("appinstalled", () => {
  document.getElementById("installBtn").style.display = "none";
});
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')

    .then(reg => {
      console.log('SW Registered on Netlify');

      // SAME UPDATE CHECK SYSTEM
      reg.addEventListener("updatefound", () => {
        const newWorker = reg.installing;
        newWorker.addEventListener("statechange", () => {
          if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
            if (confirm("A new version of the app is available. Update now?")) {
              window.location.reload();
            }
          }
        });
      });

    })
    .catch(err => {
      console.error('SW Failed:', err);
    });
}
</script>
  
<script>
async function loginUser() {
  const mobile = document.getElementById("loginMobile").value.trim();
  const password = document.getElementById("loginPassword").value.trim();

  if (!/^[0-9]{10}$/.test(mobile)) {
    alert("Enter valid 10-digit mobile.");
    return;
  }

  lockLoginForm(); // overlay ON

  apiPost("login", { mobile, password })
    .then(async res => {

      if (!res.success) {
        unlockLoginForm();
        alert(res.message || "Login failed.");
        return;
      }

      // 1Ô∏è‚É£ Save user identity
      localStorage.setItem("userMobile", mobile);
      localStorage.setItem("userEmail", res.email || "");

      // 2Ô∏è‚É£ Save SIGNUP DISCOUNT immediately (most important)
      const sd = Number(res.signupDiscount || 0);
      localStorage.setItem("signupDiscount", sd);
      window.signupDiscount = sd;
      console.log("üî• Signup Discount Saved:", sd);

      // 3Ô∏è‚É£ Update UI email
      document.getElementById("loggedEmail").innerText = res.email || "";

      // 4Ô∏è‚É£ Merge guest cart ‚Üí backend cart
      await onUserLogin(mobile);

      // 5Ô∏è‚É£ Recalculate drawer totals so discount shows instantly
      try { updateDrawerTotals(); } catch(e){ console.error(e); }

      // 6Ô∏è‚É£ Update UI panels
      document.getElementById("userInfoBox").style.display = "block";
      document.querySelector("button[onclick='openLogin()']").style.display = "none";
      document.querySelector("button[onclick='openSignup()']").style.display = "none";
      document.getElementById("signupLabelBox").style.display = "none";
      document.getElementById("logoutBtn").style.display = "inline-block";
      document.getElementById("hamburgerBtn").style.display = "block";
      document.getElementById("leftNav").style.display = "block";

      // 7Ô∏è‚É£ Close modal
      setTimeout(() => {
        closeLogin();
        unlockLoginForm();
      }, 50);

    })
    .catch(err => {
      unlockLoginForm();
      alert("Login error: " + err.message);
    });
}


  function openMenuPageProperly(el) {
  activateMenu(el);
  hideAllPages();
  document.getElementById("menuWrapper").style.display = "block";
}


</script>
<script>
function hideAllPages() {
  document.getElementById("menuWrapper").style.display = "none";
  document.getElementById("profilePage").style.display = "none";
  document.getElementById("ordersPage").style.display = "none";
  document.getElementById("offersPage").style.display = "none";
}
</script>
<script>

function apiPost(api, data = {}) {
  return fetch(API_BASE + "?api=" + api, {
    method: "POST",
    redirect: "follow", // ‚≠ê MUST
    body: JSON.stringify(data)
  })
  .then(async res => {
    const text = await res.text();   // üîë GAS redirect safe
    try {
      return JSON.parse(text);
    } catch (e) {
      console.error("API RAW RESPONSE:", text);
      throw new Error("Invalid JSON from backend");
    }
  });
}


function isLoggedIn() {
  return Boolean(localStorage.getItem("userMobile"));
}

  
function buildMenuCardHTML(item, idx) {
// A2A ‚Äî Ensure stable itemId (Single + Multi)
item.itemId = String(
  item.itemId ||
  item.ItemId ||
  item.id ||
  item.ID ||
  slugify(item.name)
);
  
  let priceSection = "";
  let cartSection = "";

  // ==========================
  //       SINGLE ITEM
  // ==========================
  if (item.cat2 === "Single") {

    // FINAL PRICE CALCULATION (MENU SHEET)
    const mrp  = Number(item.price);               // From menu sheet
    const disc = Number(item.discPercent || 0);
    const finalPrice = parseFloat((mrp - (mrp * disc / 100)).toFixed(2));

    priceSection = `
      <div class="variant-box">
        <div class="variant-row">
          <div class="left-side">
            <span class="unit">${item.unit || ""}</span>

            ${disc > 0 ? `
              <span style="background:#ff3e3e;color:#fff;font-size:11px;
                           padding:2px 4px;border-radius:3px;">
                ${disc}% OFF
              </span>
            ` : ""}
          </div>

          <div style="text-align:right;">
            <span class="final-price" style="font-weight:700;font-size:16px;">
               ${fmt(finalPrice)}
            </span>

            ${disc > 0 ? `
              <span class="mrp" 
                    style="text-decoration:line-through;color:#777;
                           margin-left:6px;font-size:13px;">
                 ${fmt(mrp)}
              </span>
            ` : ""}
          </div>
        </div>
      </div>
    `;

    cartSection = `
  <button class="add-btn hidden"
    data-name="${item.name}"
    data-unit="${item.unit}"
    data-price="${mrp}"
    data-disc="${disc}"
    data-item-id="${item.itemId}">
    Add
  </button>
    `;
  }

   // ==========================
  //       MULTI ITEM
  // ==========================
  if (item.cat2 === "Multi") {
    const idSafe = slugify(item.name) + "-" + idx;

    // AUTO-GENERATE variantId if missing
    item.variants = item.variants.map((v, vidx) => ({
      ...v,
      variantId: v.variantId || slugify(v.unit) || `v${vidx + 1}`
    }));

    let variantsHTML = "";

    item.variants.forEach(v => {
      // FINAL PRICE CALCULATION (CAT_ALLOCATION SHEET)
      const mrp  = Number(v.price);                  // From cat_allocation sheet
      const disc = Number(v.discPercent || 0);
      const finalPrice = parseFloat((mrp - (mrp * disc / 100)).toFixed(2));

      const boxId    = `box-${item.itemId}_${v.variantId}-${idx}`;
      const qtyTextId = `qtyText-${item.itemId}_${v.variantId}-${idx}`;

      variantsHTML += `
        <label class="variant-row">
          <div class="left-side">
            <input type="radio"
                   name="var-${idSafe}"
                   onclick="activateVariantSelector('${item.itemId}', '${v.variantId}', '${v.unit}', ${mrp}, ${disc}, ${idx})"
                   data-unit="${v.unit}"
                   data-mrp="${mrp}"
                   data-disc="${disc}"
                   data-variant-id="${v.variantId}"
                   data-item-id="${item.itemId}">

            <span class="unit">${v.unit}</span>

            ${disc > 0 ? `
              <span style="background:#ff3e3e;color:#fff;
                           font-size:11px;padding:2px 4px;
                           border-radius:3px;">
                ${disc}% OFF
              </span>
            ` : ""}
          </div>

          <div style="text-align:right;">
            <span class="final-price" 
                  style="font-weight:700;font-size:16px;">
             ${fmt(finalPrice)}
            </span>

            ${disc > 0 ? `
              <span style="text-decoration:line-through;
                           color:#777;margin-left:6px;font-size:13px;">
                ${fmt(mrp)}
              </span>
            ` : ""}
          </div>
        </label>

        <!-- HIDDEN QTY BOX FOR THIS VARIANT (CARD-SPECIFIC) -->
        <div id="${boxId}"
             class="hidden flex items-center gap-3 mt-2">

          <button class="px-2 bg-gray-300 rounded text-lg"
                  onclick="updateCart('${item.itemId}', '${v.variantId}', 'dec')">‚àí</button>

          <span class="font-semibold" id="${qtyTextId}">1</span>

          <button class="px-2 bg-gray-300 rounded text-lg"
                  onclick="updateCart('${item.itemId}', '${v.variantId}', 'add')">+</button>
        </div>
      `;
    });

    priceSection = `<div class="variant-box">${variantsHTML}</div>`;
    // Multi item ‚Üí no global ADD button
    cartSection = "";
  }


  // ==========================
  //       RETURN CARD
  // ==========================

  // üëâ NEW: Menu-level controls only for Single items
  let menuControls = "";

  if (item.cat2 === "Single") {
    menuControls = `
      <!-- ADD BUTTON (Single only) -->
      <button id="addBtn-${item.itemId}"
              class="addBtn bg-[#ff6f00] text-white px-3 py-1 rounded font-semibold mt-2"
              onclick="addFromMenu('${item.itemId}')">
        ADD
      </button>

      <!-- QTY BOX (Single only) -->
      <div id="qtyBox-${item.itemId}" 
           class="qtyBox hidden flex items-center justify-center gap-3 mt-2">

        <button class="px-2 py-1 bg-gray-300 rounded text-lg"
                onclick="menuMinus('${item.itemId}')">‚àí</button>

        <span id="qtyText-${item.itemId}" class="font-semibold">1</span>

        <button class="px-2 py-1 bg-gray-300 rounded text-lg"
                onclick="menuPlus('${item.itemId}')">+</button>

      </div>
    `;
  } else {
    // Multi item ‚Üí NO global ADD, only variant-wise qty using activateVariantSelector
    menuControls = "";
  }

  return `
    <img src="${item.image}" alt="${item.name}">
    <h4>${item.name}</h4>
    <p>${item.description || ""}</p>
    ${priceSection}
    ${cartSection}
    ${menuControls}
  `;
}





// Delegated click handler for all Add buttons (works for Single and Multi)
// ADD-TO-CART HANDLER

async function saveCartToBackend(cartData = null) {
  return new Promise(async (resolve) => {

    // Only if logged in
    if (!isLoggedIn()) return resolve();

    const mobile = localStorage.getItem("userMobile");
    if (!mobile) return resolve();

    // ---- QUEUE SYSTEM (Race fix) ----
    if (window.cartSaveLock) {
      window.cartSaveQueued = true;
      return resolve();
    }
    window.cartSaveLock = true;

    // Ensure sessionId
    let sessionId = localStorage.getItem("sessionId");
    if (!sessionId) {
      sessionId = "SESS-" + Date.now();
      localStorage.setItem("sessionId", sessionId);
    }

    // Use passed data OR global cart
    const cartToSend = (cartData && Array.isArray(cartData)) ? cartData : cart;

    // Clean final payload
    const cleanedCart = cartToSend.map(item => ({
      name: item.name || "",
      unit: item.unit || "",
      qty: Number(item.qty || 1),
      rate: Number(item.rate || 0),
      discPercent: Number(item.discPercent || 0),
      itemId: item.itemId || "",
      variantId: item.variantId || "",
      image: item.image || ""
    }));

    try {
       blockRender = true;  
      await apiPost("saveCart", {
        mobile,
        email: localStorage.getItem("userEmail") || "",
        sessionId,
        cartItems: cleanedCart
      });

    } catch (err) {
      console.error("Cart Save Error:", err);

    } finally {
 blockRender = false;  
      window.cartSaveLock = false;

      if (window.cartSaveQueued) {
        window.cartSaveQueued = false;
        await saveCartToBackend();
      }
  // FINAL SAFE CHECK
    if (isLoggedIn()) {
        
    }
      // === STEP 4C: DISABLED BACKEND VERIFY TO PREVENT QTY ROLLBACK ===
      resolve();
    }

  });
}



 

function getBackendCart(mobile) {
  return apiPost("getCart", { mobile })
    .then(res => {
      if (res.success && Array.isArray(res.data)) {
        return res.data;   // ‚Üê backend cart array return
      }
      return [];
    })
    .catch(err => {
      console.error("Fetch Backend Cart Error:", err);
      return [];
    });
}

function mergeCarts(localCart, backendCart) {
  let finalCart = [];

  const map = new Map();

  // Step 1: Backend items safe
  backendCart.forEach(item => {
    const key = `${item.itemId}_${item.variantId}`;
    map.set(key, { ...item });
  });

  // Step 2: Local cart merge
 localCart.forEach(localItem => {

  // ‚ùó skip if invalid IDs
  if (!localItem.itemId) return;
  if (localItem.variantId === undefined) return;

  const key = `${localItem.itemId}_${localItem.variantId}`;

    if (map.has(key)) {
      let exist = map.get(key);
      exist.qty = Number(exist.qty) + Number(localItem.qty);
      exist.total = exist.qty * exist.rate;
      map.set(key, exist);
    } else {
      map.set(key, {
        ...localItem,
        cartId: "",      
        sessionId: "",
        mobile: "",
        timestamp: ""
      });
    }
  });

  map.forEach(item => finalCart.push(item));
  return finalCart;
}
async function onUserLogin(mobile) {

  // ALWAYS load email first (IMPORTANT)
  const email = localStorage.getItem("userEmail") || "";

  // Ensure sessionId exists
  let sessionId = localStorage.getItem("sessionId");
  if (!sessionId) {
    sessionId = "SESS-" + Date.now();
    localStorage.setItem("sessionId", sessionId);
  }

  // -------------------------------
  // 1) Fetch backend cart
  // -------------------------------
  const backendRes = await apiPost("getCart", { mobile });
  const backendCartRaw = backendRes.cart || [];

  const backendCart = backendCartRaw.map(i => ({
    name: i.name || "",
    unit: i.unit || "",
    qty: Number(i.qty || 1),
    rate: Number(i.rate || 0),
    discPercent: Number(i.discPercent || 0),
    itemId: i.itemId || "",
    variantId: i.variantId || "",
    image: i.image || ""
  }));

  // -------------------------------
  // 2) Read local guest cart
  // -------------------------------
  const guestRaw = JSON.parse(localStorage.getItem("guestCart") || "[]");

  const guestCart = guestRaw.map(i => ({
    name: i.name || "",
    unit: i.unit || "",
    qty: Number(i.qty || 1),
    rate: Number(i.rate || 0),
    discPercent: Number(i.discPercent || 0),
    itemId: i.itemId || "",
    variantId: i.variantId || "",
    image: i.image || ""
  }));

  // -------------------------------
  // 3A) Merge guest + backend (ONLY ONCE)
  // -------------------------------
  let merged = mergeCarts(guestCart, backendCart);

  // -------------------------------
  // 3D) Final Normalize
  // -------------------------------
  const finalMerged = merged.map(item => {
    item.qty = Number(item.qty || 1);
    item.rate = Number(item.rate || 0);
    item.discPercent = Number(item.discPercent || 0);

    const discAmt = (item.rate * item.discPercent) / 100;
    const netRate = item.rate - discAmt;

    item.discAmt = Number(discAmt.toFixed(2));
    item.netAmt  = Number(netRate.toFixed(2));

    item.total = item.discPercent > 0
      ? Number((netRate * item.qty).toFixed(2))
      : Number((item.rate * item.qty).toFixed(2));

    return item;
  });

  // -------------------------------
  // 4) Save to backend
  // -------------------------------
  cart = finalMerged;
  window.cart = finalMerged;

  localStorage.setItem("userEmail", email);
  await saveCartToBackend(finalMerged);

  // Clear guest cart
  localStorage.removeItem("guestCart");

  // -------------------------------
  // 5) Save local mirror
  // -------------------------------
  localStorage.setItem("cart", JSON.stringify(finalMerged));

  // -------------------------------
  // 6) Render UI
  // -------------------------------
  renderCart();
  setTimeout(() => refreshUI(), 50);
}


async function someCartAction() {
  showCartOverlay("Working...");

  try {
      // 1) local storage update
      // 2) cart rebuild
      // 3) backend save (if logged in)
      // 4) renderCart()
      // 5) any recheck or merge
  }
  catch(err) {
     console.error(err);
  }
  finally {
     hideCartOverlay();   // <-- ALWAYS LAST
  }
}

function resetCheckoutFieldsDefault() {

  // SHOW only these 3 rows
  document.getElementById("mobile").parentElement.style.display = "block";
  document.getElementById("orderType").parentElement.style.display = "block";
  document.getElementById("paymentMethod").parentElement.style.display = "block";

  // HIDE Name + Email + Address (label + input together)
  document.getElementById("customerName").parentElement.style.display = "none";
  document.getElementById("email").parentElement.style.display = "none";
  document.getElementById("addressWrapper").style.display = "none";

  // Ensure fields remain editable when shown later
  document.getElementById("customerName").readOnly = false;
  document.getElementById("email").readOnly = false;
  document.getElementById("address").readOnly = false;

  // Payment MUST remain visible always
  document.getElementById("paymentMethod").style.display = "block";
}


function setupAddressUIVisibility() {
  const changeBtn = document.getElementById("changeAddressBtn");
  const dropdownContainer = document.getElementById("addressSelectContainer");
  const newAddressForm = document.getElementById("newAddressForm");

  if (!changeBtn || !dropdownContainer || !newAddressForm) return;

  if (isLoggedIn()) {
    // ONLY logged-in users see the button
    changeBtn.classList.remove("hidden");

    // Dropdown & New address form remain hidden until user clicks
    dropdownContainer.classList.add("hidden");
    newAddressForm.classList.add("hidden");
  } else {
    // Guest User ‚Üí everything OFF
    changeBtn.classList.add("hidden");
    dropdownContainer.classList.add("hidden");
    newAddressForm.classList.add("hidden");
  }
}

// run on page load
document.addEventListener("DOMContentLoaded", setupAddressUIVisibility);
 
  
function autofillMobileForLoggedIn() {
  const mobileInput = document.getElementById("mobile");

  if (!mobileInput) return;

  // Only logged-in users
  const mobile = localStorage.getItem("userMobile");
  if (!mobile) {
    // Guest ‚Üí allow typing
    mobileInput.value = "";
    mobileInput.readOnly = false;
    return;
  }

  // Logged-in user ‚Üí auto-fill and lock the field
  mobileInput.value = mobile;
  mobileInput.readOnly = true;
}

// Run when checkout modal shows up

function onChangeAddressClick() {
 // üîπ STATUS MESSAGE SHOW
  const status = document.getElementById("addressStatus");
  if (status) {
    status.innerText = "Fetching your saved address‚Ä¶";
     status.className = "text-sm text-red-600 font-medium";
    status.classList.remove("hidden");
  }
  const mobile = localStorage.getItem("mobile") || localStorage.getItem("userMobile");
  if (!mobile) return;

  const overlay = document.getElementById("loadingOverlay");
  if (overlay) overlay.style.display = "flex";

  const dropdownBox = document.getElementById("addressSelectContainer");
  const newFormBox = document.getElementById("newAddressForm");

  dropdownBox.classList.add("hidden");
  newFormBox.classList.add("hidden");

  const ddl = document.getElementById("savedAddressDropdown");
  ddl.innerHTML = "";
  ddl.classList.remove("hidden");

  // 1Ô∏è‚É£ Fetch Primary + MultiAdd together
  Promise.all([
    apiGet("getUserProfile", { mobile }),
    apiGet("getUserMultiAddresses", { mobile })
  ])
  .then(([userRes, multiRes]) => {

      const primary = userRes?.address
        ? {
            address: userRes.address,
            pincode: userRes.pincode || "",
            city: userRes.city || "",
            state: userRes.state || "",
            type: "primary"
          }
        : null;

      const multiList = Array.isArray(multiRes?.addresses)
        ? multiRes.addresses.map(a => ({
            address: a.address || "",
            pincode: a.pincode || "",
            city: a.city || "",
            state: a.state || "",
            type: "multi"
          }))
        : [];

      // 2Ô∏è‚É£ If nothing saved ‚Üí show new form
      // 2Ô∏è‚É£ If nothing saved ‚Üí DO NOT auto-open new address form in checkout
if (!primary && multiList.length === 0) {
  dropdownBox.classList.add("hidden");

  // just inform user
  const status = document.getElementById("addressStatus");
  if (status) {
    status.innerText = "No saved address found. Please add a new address.";
    status.className = "text-sm text-red-600 font-medium";
    status.classList.remove("hidden");
  }

  if (overlay) overlay.style.display = "none";
  return;
}


      // 3Ô∏è‚É£ Show dropdown box
      dropdownBox.classList.remove("hidden");

      let count = 1;

      // --- Add Primary ---
      if (primary) {
        const opt = document.createElement("option");
        opt.value = JSON.stringify(primary);
        opt.textContent =
          `${count}) ${primary.address} | ${primary.pincode} | ${primary.city} | ${primary.state}`;
        ddl.appendChild(opt);
        count++;
      }

      // --- Add multi_add addresses ---
      multiList.forEach(a => {
        const opt = document.createElement("option");
        opt.value = JSON.stringify(a);
        opt.textContent =
          `${count}) ${a.address} | ${a.pincode} | ${a.city} | ${a.state}`;
        ddl.appendChild(opt);
        count++;
      });

      // 4Ô∏è‚É£ Auto-select first address
      const first = ddl.options[0];
      if (first) {
        ddl.value = first.value;
        const obj = JSON.parse(first.value);
        document.getElementById("address").value  = obj.address;
        document.getElementById("pincode").value = obj.pincode;
        document.getElementById("city").value    = obj.city;
        document.getElementById("state").value   = obj.state;
      }

      // ‚≠ê SUPER SAFE OVERLAY HIDE ‚Üí when dropdown truly visible
      const waitRender = setInterval(() => {
  const optionsReady = ddl.options.length > 0;
  const visible = !dropdownBox.classList.contains("hidden");

  if (optionsReady && visible) {
    clearInterval(waitRender);

    // ensure browser paints dropdown before hiding overlay
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        if (overlay) overlay.style.display = "none";

        // ‚úÖ SUCCESS MESSAGE (STEP-1C)
        const status = document.getElementById("addressStatus");
        if (status) {
          status.innerText = "Address loaded successfully";
          status.className = "text-sm text-green-600 font-medium";
          status.classList.remove("hidden");

          // auto hide after 1.5 sec
          setTimeout(() => {
            status.classList.add("hidden");
          }, 1500);
        }
      });
    });
  }

}, 50);



      // 5Ô∏è‚É£ Dropdown change handler
      ddl.onchange = () => {
        try {
          const obj = JSON.parse(ddl.value);
          document.getElementById("address").value  = obj.address;
          document.getElementById("pincode").value = obj.pincode;
          document.getElementById("city").value    = obj.city;
          document.getElementById("state").value   = obj.state;
        } catch (e) {}
      };

  })
  .catch(err => {
      console.error("Address load error:", err);
      alert("Unable to load saved addresses.");
      if (overlay) overlay.style.display = "none";
    const status = document.getElementById("addressStatus");
  if (status) status.classList.add("hidden");
  });
}



function onChangeAddressAddNew() {

  // ‚úÖ Open New Address modal
  const modal = document.getElementById("newAddressModal");
  if (!modal) return;

  modal.classList.remove("hidden");
  modal.classList.add("flex");

  // ‚úÖ Show form INSIDE modal
  const form = document.getElementById("newAddressForm");
  if (form) form.classList.remove("hidden");
   loadPincodeDropdown();
}

function closeNewAddressModal() {

  const modal = document.getElementById("newAddressModal");
  if (!modal) return;

  // hide modal
  modal.classList.add("hidden");
  modal.classList.remove("flex");

  // ‚ùå safety: checkout ke andar inline form kabhi visible na ho
  const inlineForm = document.getElementById("newAddressForm");
  if (inlineForm) inlineForm.classList.add("hidden");
}

function saveNewAddress() {
if (window._savingAddress) return;
window._savingAddress = true;

  const mobile =
    localStorage.getItem("mobile") ||
    localStorage.getItem("userMobile");

  if (!mobile) {
    alert("Login required.");
    window._savingAddress = false;
    return;
  }
  const btn = document.getElementById("saveNewAddressBtn");
if (btn) {
  btn.disabled = true;
  btn.innerText = "Saving...";
}


  const addr  = document.getElementById("newAddressField").value.trim();
  const pin   = document.getElementById("newPincode").value.trim();
  const city  = document.getElementById("newCity").value.trim();
  const state = document.getElementById("newState").value.trim();

  if (!addr || pin.length !== 6 || !city || !state) {
    alert("Please fill all address fields correctly.");
    window._savingAddress = false;
if (btn) {
    btn.disabled = false;
    btn.innerText = "Save Address";
}
    
    return;
  }

  apiPost("saveUserNewAddress", {
    mobile,
    address: addr,
    pincode: pin,
    city,
    state
  })
  .then(res => {
    if (!res || !res.success) {
      alert(res?.message || "Failed to save address.");
      window._savingAddress = false;

  if (btn) {
    btn.disabled = false;
    btn.innerText = "Save Address";
  }
      return;
    }
window._savingAddress = false;
if (btn) {
  btn.disabled = false;
  btn.innerText = "Save Address";
}

    // ‚úÖ Close modal
    closeNewAddressModal();

    // ‚úÖ Clear modal inputs
    document.getElementById("newAddressField").value = "";
    document.getElementById("newPincode").value = "";
    document.getElementById("newCity").value = "";
    document.getElementById("newState").value = "";

    // ‚úÖ Refresh dropdown
    onChangeAddressClick();

    // ‚úÖ Auto-select newly added address
    setTimeout(() => {
      const ddl = document.getElementById("savedAddressDropdown");
      if (ddl && ddl.options.length > 0) {
        ddl.selectedIndex = ddl.options.length - 1;
        ddl.dispatchEvent(new Event("change"));
      }
    }, 300);

  })
  .catch(err => {
    console.error(err);
   console.log("NEW MODAL SAVE FLOW RUNNING");

    console.warn("Save address fetch failed, but may be saved:", err);
window._savingAddress = false;
if (btn) {
  btn.disabled = false;
  btn.innerText = "Save Address";
}

  closeNewAddressModal();
  onChangeAddressClick();
  });
}


const originalBodyOverflow = document.body.style.overflow || "";  
// STEP 8 ‚Äî Autofill New Address Form with logged-in mobile
function autofillNewAddressMobile() {
  const mobile = localStorage.getItem("userMobile") || "";
  const field = document.getElementById("newAddressMobile");
  if (field && mobile) {
    field.value = mobile;
  }
}
  
function updateCartBadge() {

  // Always use master engine getter
  const cartArr = getCart();

  let totalQty = 0;

  cartArr.forEach(ci => {
    totalQty += Number(ci.qty || 0);
  });

  const badge = document.getElementById("cartCount");
  if (!badge) return;

  if (totalQty > 0) {
    badge.textContent = totalQty;
    badge.classList.remove("hidden");
  } else {
    badge.textContent = "";
    badge.classList.add("hidden");
  }
}

async function openCheckout() {

  // ‚úÖ 0Ô∏è‚É£ FIRST ‚Äî close drawer cart
  closeCartDrawer();

  // üîí ADD THIS (VERY IMPORTANT)
  document.body.style.overflow = "hidden";

  // Always use master cart (NO backend calls)
  const freshCart = getCart();

  cart = freshCart;
  window.cart = freshCart;

  if (freshCart.length === 0) {
    alert("Your cart is empty!");
    document.body.style.overflow = ""; // safety
    return;
  }

  // Autofill + UI setup
  autofillMobileForLoggedIn();
  resetCheckoutFieldsDefault();
  setupAddressUIVisibility();
  loadPrimaryAddress();

  // Build checkout items
  refreshCheckout();
  // üî¥ IMPORTANT: hide Change Address by default
  document.getElementById("changeAddressBtn")?.classList.add("hidden");

  // ‚úÖ LAST ‚Äî open checkout modal
  const modal = document.getElementById("checkoutModal");
  modal.style.display = "flex";

  // üîÅ RE-APPLY UI if order type already selected
setTimeout(() => {
  const orderType = document.getElementById("orderType")?.value;
  if (orderType) {
    toggleAddressField();
  }
}, 0);

}



async function openCartDrawer() {
 closeCheckout();
  //  OPEN DRAWER INSTANTLY (NO DELAY)
  document.getElementById("cartBackdrop").classList.add("active");
  document.getElementById("cartDrawer").classList.add("active");
  document.body.style.overflow = "hidden";

  // Fetch offers in background (NO await)
  fetchOffersFromBackend().then(() => {
    try { updateDrawerTotals(); } catch(e){}
  });

  // 1) Always get latest cart (master engine)
  let freshCart = getCart();

  // STEP 1D ‚Üí Restore missing images
  freshCart = restoreCartImages(freshCart);

  // 2) Sync global
  cart = freshCart;
  window.cart = freshCart;

  // 3) Rebuild drawer UI
  openCartPanel(freshCart);
  renderCart();

  // ----------------------------------------
  // ‚≠ê FIXED RESTORE: coupon should restore ONLY if valid
  // ----------------------------------------
  if (alreadyAppliedCouponId && (!selectedCoupon || selectedCoupon.id !== alreadyAppliedCouponId)) {

    const offers = window.liveOffers || [];
    const found = offers.find(x => x.id === alreadyAppliedCouponId);

    if (found) {
      selectedCoupon = found;
    } else {
      // coupon expired or removed ‚Üí reset
      alreadyAppliedCouponId = "";
      selectedCoupon = null;
    }
  }

  // ----------------------------------------
// ‚≠ê G4: REVALIDATE COUPON on drawer open
// ----------------------------------------
if (selectedCoupon && selectedCoupon.type === "onetime") {

    const subtotal = cart.reduce((sum, ci) => {
        const mrp = Number(ci.rate || 0);
        const disc = Number(ci.discPercent || 0);
        const qty  = Number(ci.qty || 1);
        return sum + (mrp - (mrp * disc / 100)) * qty;
    }, 0);

    if (subtotal < Number(selectedCoupon.min || 0)) {
        selectedCoupon = null;
        alreadyAppliedCouponId = "";
        showCouponError("Coupon removed because cart value changed.");
    }
}
  // 4) Update totals + badge
  try { updateDrawerTotals(); } catch(e){}
  try { updateCartBadge(); } catch(e){}
}


function closeCartDrawer() {
  const backdrop = document.getElementById("cartBackdrop");
  const drawer   = document.getElementById("cartDrawer");

  if (drawer) {
    drawer.classList.remove("active");
  }

  if (backdrop) {
    backdrop.classList.remove("active");
  }

  document.body.style.overflow = "auto";
}




function toggleCartDrawer() {
  const drawer = document.getElementById("cartDrawer");
  if (drawer.classList.contains("active")) {
    closeCartDrawer();
  } else {
    openCartDrawer();
  }
   
}

  document.addEventListener("DOMContentLoaded", () => {   
  restoreFullCartUI();   
  updateCartBadge();    
});

// ===== SWIPE TO CLOSE Drawer (Zomato style) =====
let touchStartX = 0;

document.addEventListener("touchstart", function(e) {
  const drawer = document.getElementById("cartDrawer");
  if (!drawer.classList.contains("active")) return;

  touchStartX = e.touches[0].clientX;
});

document.addEventListener("touchmove", function(e) {
  const drawer = document.getElementById("cartDrawer");
  if (!drawer.classList.contains("active")) return;

  const currentX = e.touches[0].clientX;
  const diff = currentX - touchStartX;

  // Swipe right only
  if (diff > 60) {
    closeCartDrawer();
  }
});
// ===== ESC Key Close =====
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    closeCartDrawer();
  }
});

function addFromMenu(itemId) {

  itemId = String(itemId);

  const addBtn  = document.getElementById("addBtn-" + itemId);
  const qtyBox  = document.getElementById("qtyBox-" + itemId);
  const qtyText = document.getElementById("qtyText-" + itemId);

  if (addBtn) addBtn.classList.add("hidden");
  if (qtyBox) qtyBox.classList.remove("hidden");
  if (qtyText) qtyText.innerText = "1";

  try { animateQty("qtyText-" + itemId); } catch(e){}

  // MASTER ENGINE
  updateCart(itemId, "", "add");
}

function menuPlus(itemId) {

  itemId = String(itemId);

  const qtyText = document.getElementById("qtyText-" + itemId);
  if (!qtyText) return;

  let q = Number(qtyText.innerText) + 1;
  qtyText.innerText = q;

  try { animateQty("qtyText-" + itemId); } catch(e){}

  // MASTER ENGINE
  updateCart(itemId, "", "add");
}

function menuMinus(itemId) {

  itemId = String(itemId);

  const qtyText = document.getElementById("qtyText-" + itemId);
  const qtyBox  = document.getElementById("qtyBox-" + itemId);
  const addBtn  = document.getElementById("addBtn-" + itemId);

  if (!qtyText) return;

  let q = Number(qtyText.innerText);

  // If qty is 1 ‚Üí this press means remove
  if (q === 1) {

    qtyText.innerText = "0";

    if (qtyBox) qtyBox.classList.add("hidden");
    if (addBtn) addBtn.classList.remove("hidden");

    // MASTER ENGINE remove
    updateCart(itemId, "", "dec");

    return;
  }

  // Normal decrement
  q--;
  qtyText.innerText = q;

  try { animateQty("qtyText-" + itemId); } catch(e){}

  // MASTER ENGINE
  updateCart(itemId, "", "dec");
}


function menuMinus_multi(id) {

  const [itemId, variantId] = id.split("_");
  const qtyText = document.getElementById("qtyText-" + id);
  let q = Number(qtyText.innerText);

  // ------------------------------------------------
  // CASE A ‚Üí NORMAL DECREMENT (qty > 1)
  // ------------------------------------------------
  if (q > 1) {

    q--;
    qtyText.innerText = q;
    animateQty("qtyText-" + id);

    updateDrawerItemQty(String(itemId), String(variantId), q);

    let cartArr = isLoggedIn()
      ? JSON.parse(localStorage.getItem("cart") || "[]")
      : JSON.parse(localStorage.getItem("guestCart") || "[]");

    const item = cartArr.find(
      c => c.itemId === itemId && c.variantId === variantId
    );
    if (item) item.qty = q;

    cart = cartArr;
    window.cart = cartArr;

    if (isLoggedIn()) {
      localStorage.setItem("cart", JSON.stringify(cartArr));
      saveCartToBackend(cartArr);
    } else {
      localStorage.setItem("guestCart", JSON.stringify(cartArr));
    }

    updateCartBadge();
    refreshCartDrawer();
    updateDrawerTotals();
    return;
  }

  // ------------------------------------------------
  // CASE B ‚Üí REMOVE ITEM (qty = 1)
  // ------------------------------------------------
  if (q === 1) {

    let cartArr = isLoggedIn()
      ? JSON.parse(localStorage.getItem("cart") || "[]")
      : JSON.parse(localStorage.getItem("guestCart") || "[]");

    // Remove exact variant
    cartArr = cartArr.filter(
      c => !(c.itemId === itemId && c.variantId === variantId)
    );

    // Drawer remove ‚Äî FIXED ID format
    removeItemFromDrawer(`${itemId}_${variantId}`);

    // Save in storage
    if (isLoggedIn()) {
      localStorage.setItem("cart", JSON.stringify(cartArr));
      saveCartToBackend(cartArr);
    } else {
      localStorage.setItem("guestCart", JSON.stringify(cartArr));
    }

    cart = cartArr;
    window.cart = cartArr;

    // Hide qty box
    const box = document.getElementById("qtyBox-" + id);
    if (box) box.classList.add("hidden");

    // Reset radio
    const radio = document.querySelector(`input[data-variant-id="${variantId}"]`);
    if (radio) radio.checked = false;

    updateCartBadge();
    refreshCartDrawer();
    updateDrawerTotals();
  }
}



function cleanCartConsistency(cartArr) {

  // Remove invalid items
  cartArr = cartArr.filter(c =>
    c && c.itemId && Number(c.qty) > 0
  );

  // Remove duplicates (same item + same variant)
  const map = {};
  const cleaned = [];

  cartArr.forEach(c => {
    const key = c.itemId + "_" + (c.variantId || "single");
    if (!map[key]) {
      map[key] = true;
      cleaned.push(c);
    }
  });

  return cleaned;
}


function menuPlus_multi(id) {
  // id = "itemId_variantId"
  const [itemId, variantId] = id.split("_");

  // 1Ô∏è‚É£ UI increment
  const qtyText = document.getElementById("qtyText-" + id);
  let q = Number(qtyText.innerText);
  q++;
  qtyText.innerText = q;
  animateQty("qtyText-" + id);

  // Drawer qty update
  updateDrawerItemQty(String(itemId), String(variantId), q);

  // 2Ô∏è‚É£ Load cart
  let cartArr = isLoggedIn()
    ? JSON.parse(localStorage.getItem("cart") || "[]")
    : JSON.parse(localStorage.getItem("guestCart") || "[]");

  // 3Ô∏è‚É£ Find exact multi variant
  const item = cartArr.find(
    c => c.itemId === itemId && c.variantId === variantId
  );
  if (!item) return;

  // 4Ô∏è‚É£ Update qty
  item.qty = q;

  // Save in global state
  cart = cartArr;
  window.cart = cartArr;

  // 5Ô∏è‚É£ Save to correct storage
  if (isLoggedIn()) {
    localStorage.setItem("cart", JSON.stringify(cartArr));
    saveCartToBackend(cartArr);
  } else {
    localStorage.setItem("guestCart", JSON.stringify(cartArr));
  }

  // 6Ô∏è‚É£ UI update
  updateCartBadge();
  if (document.getElementById("cartDrawer").classList.contains("active")) {
    refreshCartDrawer();
    updateDrawerTotals();
  }
}

function loadCartOnStart() {

  let cartArr = getCart();   // master engine getter

  // STEP 1C ‚Üí image restore apply
  cartArr = restoreCartImages(cartArr);

  cart = cartArr;
  window.cart = cartArr;

  updateCartBadge();
  restoreFullCartUI();
}


  
function refreshCartDrawer() {

  // Drawer closed? ‚Üí skip
  const drawer = document.getElementById("cartDrawer");
  if (!drawer || !drawer.classList.contains("active")) return;

  // Always read latest cart
  const cartArr = getCart();

  // Rebuild drawer UI fresh
  openCartPanel(cartArr);

  // Update totals + badge
  try { updateDrawerTotals(); } catch(e){}
  try { updateCartBadge(); } catch(e){}
}

  function updateDrawerItemQty(itemId, variantId = "", newQty) {

  itemId = String(itemId);
  variantId = String(variantId);

  // Drawer closed ‚Üí skip
  const drawer = document.getElementById("cartDrawer");
  if (!drawer || !drawer.classList.contains("active")) return;

  // Row ID detect
  const rowId = variantId
    ? `drawerRow-${itemId}_${variantId}`
    : `drawerRow-${itemId}`;

  const row = document.getElementById(rowId);
  if (!row) return;

  // Update qty text
  const qtyEl = row.querySelector(".drawer-qty");
  if (qtyEl) qtyEl.textContent = newQty;

  // Recalculate total inside drawer
  const mrp = Number(row.dataset.price || 0);
  const disc = Number(row.dataset.disc || 0);

  const priceAfterDisc = mrp - (mrp * disc / 100);
  const lineTotal = (priceAfterDisc * newQty).toFixed(2);

  const totalEl = row.querySelector(".drawer-total");
  if (totalEl) totalEl.textContent = fmt(lineTotal);

}



function removeItemFromDrawer(itemId, variantId = "") {

  itemId = String(itemId);
  variantId = String(variantId);

  // Drawer closed ‚Üí ignore
  const drawer = document.getElementById("cartDrawer");
  if (!drawer || !drawer.classList.contains("active")) return;

  // Row ID
  const rowId = variantId
    ? `drawerRow-${itemId}_${variantId}`
    : `drawerRow-${itemId}`;

  const row = document.getElementById(rowId);
  if (row) row.remove();

  // Update totals + badge
  try { updateDrawerTotals(); } catch(e){}
  try { updateCartBadge(); } catch(e){}
}

async function loadCartBeforeDrawer() {

  const cartArr = getCart();   // guest => guestCart, login => cart (localStorage)

  cart = Array.isArray(cartArr) ? cartArr : [];
  window.cart = cart;

  return cart;
}



function showCartOverlay(msg = "Loading‚Ä¶") {
  const o = document.getElementById("cartOverlay");
  if (!o) return;
  o.innerText = msg;
  o.classList.remove("hidden");
}

function hideCartOverlay() {
  const o = document.getElementById("cartOverlay");
  if (!o) return;
  o.classList.add("hidden");
}


  function activateVariantSelector(itemId, variantId, unit, price, disc, idx) {

  itemId = String(itemId);
  variantId = String(variantId);

  const boxId     = `box-${itemId}_${variantId}-${idx}`;
  const qtyTextId = `qtyText-${itemId}_${variantId}-${idx}`;

  // 1Ô∏è‚É£ Hide ALL other variant qty-boxes of this card
  document.querySelectorAll(`div[id^="box-${itemId}_"][id$="-${idx}"]`)
    .forEach(b => b.classList.add("hidden"));

  // 2Ô∏è‚É£ Show selected variant qty-box
  const targetBox = document.getElementById(boxId);
  if (targetBox) targetBox.classList.remove("hidden");

  // 3Ô∏è‚É£ Check existing cart item
  const ex = findCartItem(itemId, variantId);

  if (ex) {
    // Restore qty
    const qtyLabel = document.getElementById(qtyTextId);
    if (qtyLabel) qtyLabel.textContent = ex.qty;
    return; // IMPORTANT ‚Üí no add on re-select
  }

  // 4Ô∏è‚É£ If not in cart ‚Üí add via Master Engine
  updateCart(itemId, variantId, "add", {
    unit,
    price,
    discount: disc
  });

  // 5Ô∏è‚É£ Initialize qty = 1
  const qtyLabel = document.getElementById(qtyTextId);
  if (qtyLabel) qtyLabel.textContent = "1";
}


  
function removeAllOldMultiEvents() {
  document.querySelectorAll("input[data-variant-id]").forEach(el => {
    const clean = el.cloneNode(true); 
    el.replaceWith(clean);
  });
}
function buildCartObject(itemId, variantId, meta = {}) {

  itemId = String(itemId || "");
  variantId = String(variantId || "");

  // MENU lookups
  const menuItem = window.menuItems?.find(m =>
    String(m.itemId) === itemId
  );

  let variant = null;
  if (menuItem?.variants && variantId) {
    variant = menuItem.variants.find(v =>
      String(v.variantId) === variantId
    );
  }

  // FINAL SAFE META BUILD
  const name = meta.name || menuItem?.name || "";
  const unit = meta.unit || variant?.unit || menuItem?.unit || "";
  const price = Number(meta.price || variant?.price || menuItem?.price || 0);
  const discount = Number(meta.discount || variant?.discPercent || menuItem?.discPercent || 0);

  return {
    itemId,
    variantId,
    name,
    unit,
    price,
    discPercent: discount,
    qty: 1,
    image: menuItem?.image || "",

    // UI helpers ‚Äî optional
    rate: price,
    total: price,
  };
}


  function updateCart(itemId, variantId = "", action, meta = {}) {

  itemId = String(itemId);
  variantId = String(variantId);

  // Read correct storage
let cartArr = getCart();  // master engine safe getter


  // Find match
  let existing = cartArr.find(c =>
    String(c.itemId) === itemId &&
    String(c.variantId || "") === variantId
  );

  // ---------------------
  // ACTION: ADD / INC
  // ---------------------
 // ADD FLOW (Master Engine)
if (action === "add") {

  // If exists ‚Üí increase qty
  if (existing) {
    existing.qty++;
    return setCart(cartArr);
  }

  // If not exists ‚Üí build & push
  const newObj = buildCartObject(itemId, variantId, meta);
  cartArr.push(newObj);

  return setCart(cartArr);
}

  // ---------------------
  // ACTION: DEC
  // ---------------------
 // DEC FLOW (Master Engine)
if (action === "dec") {

  if (!existing) return setCart(cartArr);

  // If qty > 1 ‚Üí decrement
  if (existing.qty > 1) {
    existing.qty--;
    return setCart(cartArr);
  }

  // If qty == 1 ‚Üí delete item
  cartArr = cartArr.filter(c =>
    !(String(c.itemId) === itemId &&
      String(c.variantId || "") === variantId)
  );

  return setCart(cartArr);
}
}
function cleanCartInvalidItems(arr) {
  return arr.filter(i =>
    i &&
    i.itemId && String(i.itemId).trim() !== "" &&
    i.name && String(i.name).trim() !== "" &&
    i.unit && String(i.unit).trim() !== "" &&
    !isNaN(i.rate) &&
    Number(i.rate) > 0
  );
}
function getUserMobile() {
  return localStorage.getItem("mobile") || "";
}

function getCartSubtotal() {
  let subtotal = 0;
  cart.forEach(ci => {
    const rate = Number(ci.rate || 0);
    const disc = Number(ci.discPercent || 0);
    const qty = Number(ci.qty || 1);
    subtotal += (rate - (rate * disc / 100)) * qty;
  });
  return subtotal;
}

async function fetchOffersFromBackend() {
  try {
    const mobile = isLoggedIn() ? getUserMobile() : "";
    const cartTotal = getCartSubtotal();  // ‚≠ê MIN is checked on backend also

    const res = await fetch(API_BASE + "?api=getOffers&mobile=" + mobile + "&cartTotal=" + cartTotal);

    const data = await res.json();

    if (data.success && Array.isArray(data.offers)) {
      window.liveOffers = data.offers;
      return data.offers;
    }
  } catch (err) {
    console.error("Offer load error:", err);
  }

  window.liveOffers = [];
  return [];
}
function getCart() {

  // Guest user
  if (!isLoggedIn()) {
    let g = JSON.parse(localStorage.getItem("guestCart") || "[]");
    return g;
  }

  // Logged-in user
  let c = JSON.parse(localStorage.getItem("cart") || "[]");
  return c;
}


// STEP 1A ‚Üí Menu se image fetch karne ka helper
function getMenuImage(itemId, variantId) {
  itemId = String(itemId);
  variantId = String(variantId || "");

  const item = (window.menuItems || []).find(
    m => String(m.id) === itemId || String(m.itemId) === itemId
  );

  if (!item) return "";

  // agar multi variant hai aur variant image rakhi hai
  if (variantId && Array.isArray(item.variants)) {
    const v = item.variants.find(x => String(x.variantId || x.id) === variantId);
    if (v && v.image) return v.image;
  }

  return item.image || "";
}
// ---------- STEP 1B: Offers data + best-offer calculation ----------



function getBestOffer(total) {
  const offers = window.liveOffers || [];

  let best = null;
  let bestValue = 0;

  offers.forEach(o => {
    if (total >= (o.min || 0)) {
      let val = 0;
      if (o.discount) val = total * (o.discount / 100);
      if (o.flat) val = o.flat;

      if (val > bestValue) {
        bestValue = val;
        best = { ...o, value: Number(val.toFixed(2)) };
      }
    }
  });

  return best;
}
 

// STEP 2A ‚Äì Apply Coupon button (open offer list)
async function openCouponList() {

  const listBox = document.getElementById("offerList");
  const loader  = document.getElementById("offerLoadingText");

  try {
      if (!listBox || !loader) return;

      // ‚≠ê 1. SHOW LIST + LOADER
      listBox.style.display = "block";
      loader.style.display  = "block";

      // ‚≠ê 2. Fetch latest offers
      if (!window.liveOffers || window.liveOffers.length === 0) {
          await fetchOffersFromBackend();
      }

      const offers = window.liveOffers || [];

      // ‚≠ê 3. Clear list but keep loader in top
      listBox.innerHTML = "";
      listBox.appendChild(loader);
      loader.style.display = "none";

      // ‚≠ê 4. No offers
      if (offers.length === 0) {
          listBox.innerHTML += `
              <div class="p-2 text-gray-500 text-center">
                No offers available
              </div>`;
          return;
      }

      // ‚≠ê 5. Show offers
      listBox.innerHTML += offers.map(o => `
        <div class="p-2 border-b cursor-pointer hover:bg-gray-100"
             onclick="applyCoupon('${o.id}')">
          <div class="font-semibold">${o.text}</div>
          <div class="text-sm text-gray-500">Min: ${fmt(o.min)}</div>
        </div>
      `).join("");

  } catch (err) {
      console.error("openCouponList ERROR:", err);
  }
}

function closeCouponList() {
  const list = document.getElementById("offerList");
  const loader = document.getElementById("offerLoadingText");

  if (list) list.style.display = "none";
  if (loader) loader.style.display = "none";
}

let selectedCoupon = null;        // coupon object (UI + totals)
let alreadyAppliedCouponId = "";  // coupon ID (restore + protection)

function applyCoupon(couponId) {

  const offers = window.liveOffers || [];
  const o = offers.find(x => x.id === couponId);

  if (!o) return;

  // calculate subtotal
  const subtotal = getCart().reduce((sum, ci) => {
    const mrp = Number(ci.rate || 0);
    const disc = Number(ci.discPercent || 0);
    const qty = Number(ci.qty || 1);
    return sum + (mrp - (mrp * disc / 100)) * qty;
  }, 0);

  // ‚ùå MINIMUM FAIL
  if (subtotal < Number(o.min || 0)) {

    showCouponError(
      `Cannot apply <b>${o.text}</b><br>
       Minimum required: ${fmt(o.min)}<br>
       Your subtotal: ${fmt(subtotal)}`
    );

    return;
  }

  // ‚≠ê VERY IMPORTANT ‚Äî Save applied coupon ID for restore
  alreadyAppliedCouponId = couponId;

  // ‚úî APPLY COUPON
  selectedCoupon = o;
  showCouponSuccess(`üéâ ${o.text} applied successfully!`);

  // hide offer list
  const listBox = document.getElementById("offerList");
  if (listBox) listBox.style.display = "none";

  // show applied message
  const appliedBox = document.getElementById("bestOfferApplied");
  if (appliedBox) {
    appliedBox.style.display = "block";
    appliedBox.innerHTML = `üéâ ${o.text} applied`;
  }

  updateDrawerTotals();

  // close list fully
  closeCouponList();
}

// =====================================================
// G3: Remove ONETIME coupon automatically on qty change
// =====================================================
function removeCouponIfNeeded() {
  if (!selectedCoupon) return;

  const type = (selectedCoupon.type || "").toLowerCase();

  // ONLY onetime coupon should be removed
  if (type === "onetime") {

    // Clear coupon
    selectedCoupon = null;
    alreadyAppliedCouponId = "";

    // Hide applied coupon UI
    const appliedBox = document.getElementById("bestOfferApplied");
    if (appliedBox) appliedBox.style.display = "none";

    // Show removal message (Message B)
    showCouponError(
      "Your applied coupon is no longer valid after quantity change. Please apply again."
    );

    // Recalculate totals
    updateDrawerTotals();
  }
}


// üî¥ RED error message
function showCouponError(msg) {
  const box = document.getElementById("couponMessage");
  if (!box) return;

  box.style.display = "block";
  box.style.background = "#ffefef";
  box.style.color = "#b30000";
  box.style.border = "1px solid #ffcccc";
  box.innerHTML = msg;

  setTimeout(() => {
    box.style.display = "none";
  }, 4000);
}

// üü¢ GREEN success message
function showCouponSuccess(msg) {
  const box = document.getElementById("couponMessage");
  if (!box) return;

  box.style.display = "block";
  box.style.background = "#ecffec";
  box.style.color = "#006600";
  box.style.border = "1px solid #b6ffb6";
  box.innerHTML = msg;

  setTimeout(() => {
    box.style.display = "none";
  }, 4000);
}


  
// STEP 1B ‚Üí Cart items ke image ko restore karne ka helper
function restoreCartImages(cartArr) {
  if (!Array.isArray(cartArr)) return [];

  return cartArr.map(ci => {
    ci = ci || {};

    // Agar image missing hai ‚Üí getMenuImage() se fetch karo
    if (!ci.image || String(ci.image).trim() === "") {
      ci.image = getMenuImage(ci.itemId, ci.variantId) || "";
    }

    return ci;
  });
}
  
function setCart(updatedCart) {

  if (!Array.isArray(updatedCart)) updatedCart = [];
 // ‚≠ê SAFETY FIREWALL ‚Äî remove invalid/blank items
  updatedCart = cleanCartInvalidItems(updatedCart);
  // 1) Update master engine globals
  cart = updatedCart;
  window.cart = updatedCart;

  // 2) Save to correct storage
  if (!isLoggedIn()) {
    localStorage.setItem("guestCart", JSON.stringify(updatedCart));
  } else {
    localStorage.setItem("cart", JSON.stringify(updatedCart));
  }

  // 3) UI update (FAST, NO BLOCK)
  refreshUI();

  // 4) Backend SAVE (DEBOUNCED ‚Äî prevents overwrite)
  if (isLoggedIn()) {

    if (window.cartSaveTimer)
      clearTimeout(window.cartSaveTimer);

    window.cartSaveTimer = setTimeout(() => {
      saveCartToBackend(updatedCart);
    }, 400);   // slightly increased debounce = safer
  }

  return updatedCart;
}
function refreshUI() {
  try { updateCartBadge(); } catch(e){}
  try { refreshCartDrawer(); } catch(e){}
  try { renderCart(); } catch(e){}
  try { updateDrawerTotals(); } catch(e){}
  //  MOST IMPORTANT: menu cards pe qty / ADD button sync
  try { restoreFullCartUI(); } catch(e){}
}

  
function findCartItem(itemId, variantId) {
  itemId = String(itemId || "");
  variantId = String(variantId || "");

  return cart.find(ci =>
    String(ci.itemId) === itemId &&
    String(ci.variantId || "") === variantId
  ) || null;
}
  
function variantPlus(itemId, variantId, idx) {

  itemId = String(itemId);
  variantId = String(variantId);

  const qtyTextId = `qtyText-${itemId}_${variantId}-${idx}`;
  const qtyEl = document.getElementById(qtyTextId);

  if (!qtyEl) return;

  let q = Number(qtyEl.innerText) + 1;
  qtyEl.innerText = q;

  try { animateQty(qtyTextId); } catch(e){}

  // MASTER ENGINE
  updateCart(itemId, variantId, "add");
}
  
function variantMinus(itemId, variantId, idx) {

  itemId = String(itemId);
  variantId = String(variantId);

  const qtyTextId = `qtyText-${itemId}_${variantId}-${idx}`;
  const boxId     = `box-${itemId}_${variantId}-${idx}`;

  const qtyEl = document.getElementById(qtyTextId);
  const boxEl = document.getElementById(boxId);

  if (!qtyEl) return;

  let q = Number(qtyEl.innerText);

  // If qty is 1 ‚Üí delete from UI
  if (q === 1) {

    qtyEl.innerText = "0";

    if (boxEl) boxEl.classList.add("hidden");

    // Untick radio button also
    const radios = document.querySelectorAll(
      `input[data-item-id="${itemId}"][data-variant-id="${variantId}"]`
    );
    radios.forEach(r => (r.checked = false));

    // MASTER ENGINE remove
    updateCart(itemId, variantId, "dec");

    return;
  }

  // Normal decrement
  q--;
  qtyEl.innerText = q;

  try { animateQty(qtyTextId); } catch(e){}

  // MASTER ENGINE
  updateCart(itemId, variantId, "dec");
}

  function restoreFullCartUI() {

  const cartArr = getCart();
  if (!Array.isArray(cartArr)) return;

  // RESET ALL UI FIRST
  document.querySelectorAll("div[id^='box-']").forEach(b => b.classList.add("hidden"));
  document.querySelectorAll("span[id^='qtyText-']").forEach(q => q.textContent = "");
  document.querySelectorAll("input[data-variant-id][data-item-id]").forEach(r => r.checked = false);

  document.querySelectorAll("[id^='qtyBox-']").forEach(b => b.classList.add("hidden"));
  document.querySelectorAll("[id^='addBtn-']").forEach(btn => btn.classList.remove("hidden"));


  // RESTORE FROM CART
  cartArr.forEach(ci => {

    const itemId = String(ci.itemId);
    const variantId = String(ci.variantId || "");
    const qty = Number(ci.qty || 1);

    // -------------------------
    // SINGLE ITEMS
    // -------------------------
    if (!variantId) {
      const addBtn  = document.getElementById("addBtn-" + itemId);
      const qtyBox  = document.getElementById("qtyBox-" + itemId);
      const qtyText = document.getElementById("qtyText-" + itemId);

      if (addBtn && qtyBox && qtyText) {
        addBtn.classList.add("hidden");
        qtyBox.classList.remove("hidden");
        qtyText.textContent = qty;
      }
      return;
    }

    // -------------------------
    // MULTI VARIANT ITEMS
    // -------------------------

    // All boxes of this variant (all card-index versions)
    const boxes = document.querySelectorAll(`div[id^="box-${itemId}_${variantId}-"]`);

    boxes.forEach(box => {
      box.classList.remove("hidden");

      const qtyLabel = box.querySelector(`span[id^="qtyText-${itemId}_${variantId}-"]`);
      if (qtyLabel) qtyLabel.textContent = qty;
    });

    // Tick all matching radios
    const radios = document.querySelectorAll(
      `input[data-item-id="${itemId}"][data-variant-id="${variantId}"]`
    );
    radios.forEach(r => (r.checked = true));
  });
}


  
function refreshCheckout() {

  const cartArr = getCart();
  const container = document.getElementById("checkoutItemsContainer");
  if (!container) return;

  container.innerHTML = "";

  let subtotal = 0;

  cartArr.forEach(ci => {

    const itemId = String(ci.itemId);
    const variantId = String(ci.variantId || "");
    const qty = Number(ci.qty || 1);

    const rate = Number(ci.rate || 0);
    const disc = Number(ci.discPercent || 0);

    const finalPrice = rate - (rate * disc / 100);
    const lineTotal = (finalPrice * qty).toFixed(2);

    subtotal += finalPrice * qty;

    const row = `
      <div class="checkout-row flex justify-between py-2 border-b">

        <div>
          <div class="font-semibold">${ci.name}</div>
          ${ci.unit ? `<div class="text-sm text-gray-500">${ci.unit}</div>` : ""}
        </div>

        <div class="flex items-center gap-3">

          <button class="px-2 bg-gray-300 rounded"
            onclick="updateCart('${itemId}', '${variantId}', 'dec'); refreshCheckout();">‚àí</button>

          <span class="font-semibold">${qty}</span>

          <button class="px-2 bg-gray-300 rounded"
            onclick="updateCart('${itemId}', '${variantId}', 'add'); refreshCheckout();">+</button>
        </div>

        <div class="font-semibold">${fmt(lineTotal)}</div>


      </div>
    `;

    container.insertAdjacentHTML("beforeend", row);
  });

  // Subtotal
  const subtotalEl = document.getElementById("checkoutSubtotal");
  if (subtotalEl) subtotalEl.textContent = fmt(subtotal);

}


function getCartForOrder() {

  const cartArr = getCart();  // master engine getter

  // Clean + prepare final order cart
  const finalList = cartArr.map(ci => ({

    itemId: String(ci.itemId || ""),
    variantId: String(ci.variantId || ""),

    name: ci.name || "",
    unit: ci.unit || "",

    qty: Number(ci.qty || 1),

    rate: Number(ci.rate || 0),
    discPercent: Number(ci.discPercent || 0),

    image: ci.image || ""
  }));

  return finalList;
}

function refreshCheckoutCart() {

  const cartArr = getCart();   // master engine getter
  const container = document.getElementById("checkoutCartContainer");

  if (!container) return;

  container.innerHTML = "";  // Reset checkout list

  let html = "";

  cartArr.forEach(ci => {

    const itemId = String(ci.itemId);
    const variantId = String(ci.variantId || "");
    const unitLabel = ci.unit ? `(${ci.unit})` : "";

    const qty = Number(ci.qty || 1);
    const rate = Number(ci.rate || 0);
    const disc = Number(ci.discPercent || 0);

    const priceAfterDisc = rate - (rate * disc / 100);
    const lineTotal = (priceAfterDisc * qty).toFixed(2);

    html += `
      <div class="checkout-row flex justify-between items-center py-2 border-b">
        
        <div class="flex flex-col">
          <span class="font-semibold">${ci.name} ${unitLabel}</span>
        </div>

        <div class="flex items-center gap-3">
          <span class="font-semibold">${qty}</span>
        </div>

        <div class="font-semibold">${fmt(lineTotal)}</div>


      </div>
    `;
  });

  container.innerHTML = html;
}

  function resetMenuUIForLogout() {

  // Hide all multi variant qty boxes
  document.querySelectorAll("div[id^='box-']").forEach(b => {
    b.classList.add("hidden");
  });

  // Show ADD buttons again
  document.querySelectorAll("[id^='addBtn-']").forEach(btn => {
    btn.classList.remove("hidden");
  });

  // Hide qtyBox for single items
  document.querySelectorAll("[id^='qtyBox-']").forEach(box => {
    box.classList.add("hidden");
  });

  // Reset all qtyText to 0 (not empty)
  document.querySelectorAll("span[id^='qtyText-']").forEach(q => {
    q.textContent = "0";
  });

  // Untick all multi variant radios
  document
    .querySelectorAll("input[data-variant-id][data-item-id]")
    .forEach(r => (r.checked = false));
}

function updateDrawerTotals() {

  const cartArr = getCart();
  let subtotal = 0;

  // ========== 1) Base Subtotal ==========
  cartArr.forEach(ci => {
    const mrp = Number(ci.rate || 0);
    const disc = Number(ci.discPercent || 0);
    const qty  = Number(ci.qty || 1);

    const priceAfterDisc = mrp - (mrp * disc / 100);
    subtotal += priceAfterDisc * qty;
  });

  subtotal = Number(subtotal.toFixed(2));

  // ‚≠ê If cart is empty ‚Üí force all values to zero
if (cartArr.length === 0) {

    const totalEl = document.getElementById("drawerTotalAmount");
  if (totalEl) totalEl.textContent = fmt(0);

  const taxBox = document.getElementById("taxSummary");
  if (taxBox) {
    taxBox.innerHTML = `
      <div class="text-right text-gray-700 space-y-1.5">
        <div class="flex justify-between"><span>Offer Discount:</span><span>- 0</span></div>
        <div class="flex justify-between"><span>Signup Discount:</span><span>- 0</span></div>
        <div class="flex justify-between"><span>Total after discount:</span><span>0</span></div>
        <div class="flex justify-between"><span>Service Charge:</span><span>0</span></div>
        <div class="flex justify-between"><span>Total after charges:</span><span>0</span></div>
        <div class="flex justify-between"><span>CGST:</span><span>0</span></div>
        <div class="flex justify-between"><span>SGST:</span><span>0</span></div>
        <div class="flex justify-between"><span>IGST:</span><span>0</span></div>
        <div class="flex justify-between font-bold text-lg"><span>Grand Total:</span><span>0</span></div>
      </div>
    `;
  }
  window._drawerTotals = {
    baseTotal: 0,
    offerDiscount: 0,
    signupDiscount: 0,
    payableAfterDiscount: 0,
    serviceAmt: 0,
    taxableAmount: 0,
    cgstAmt: 0,
    sgstAmt: 0,
    igstAmt: 0,
    grandTotal: 0
  };
  return;
}

  // ----------------------------------------
// ‚≠ê G4: REVALIDATE COUPON on totals update
// ----------------------------------------
if (selectedCoupon && (selectedCoupon.type === "onetime" || selectedCoupon.type === "regular"))
 {

    const min = Number(selectedCoupon.min || 0);

    if (subtotal < min) {
        selectedCoupon = null;
        alreadyAppliedCouponId = "";
        showCouponError("Coupon removed due to quantity/value change.");
    }
}


  // =====================================================
  // ‚≠ê‚≠ê RESTORE COUPON ON REFRESH (MAIN FIX)
  // =====================================================
  try {
    if (!selectedCoupon && alreadyAppliedCouponId && window.liveOffers) {
      const found = window.liveOffers.find(o => o.id === alreadyAppliedCouponId);
      if (found) selectedCoupon = found;
    }
  } catch (e) {}


  // =====================================================
  // ========== 2) COUPON & OFFER LOGIC ==================
  // =====================================================
  let offerDiscount = 0;
  let appliedOfferText = "";

  const mode = (window.couponMode || "").toLowerCase();

  // ------------ MANUAL MODE ---------------
  if (mode === "manualcoupon") {

    if (selectedCoupon) {
      const o = selectedCoupon;

      if (subtotal >= Number(o.min || 0)) {

        if (o.discount) {
          offerDiscount = subtotal * (o.discount / 100);
        }
        if (o.flat) {
          offerDiscount = Number(o.flat);
        }

        offerDiscount = Number(offerDiscount.toFixed(2));
        appliedOfferText = `üéÅ ${o.text} applied`;

      } else {
        selectedCoupon = null;
      }
    }
  }

  // ------------ AUTO MODE -----------------
  else {
    const best = getBestOffer(subtotal);

    if (best) {
      offerDiscount = Number(best.value || 0);
      appliedOfferText = `üéâ ${best.text} (Saved ${fmt(offerDiscount)})`;
    }
  }


  // Update Offer Message Box
  const appliedBox = document.getElementById("bestOfferApplied");
  if (appliedBox) {
    if (offerDiscount > 0) {
      appliedBox.style.display = "block";
      appliedBox.innerHTML = appliedOfferText;
    } else {
      appliedBox.style.display = "none";
    }
  }


  // ========== Subtotal after offer ==========
  let payable = subtotal - offerDiscount;
  if (payable < 0) payable = 0;
  payable = Number(payable.toFixed(2));


  // =====================================================
  // ‚≠ê‚≠ê 3) SIGNUP DISCOUNT APPLY (UI SIDE)
  // =====================================================
  let signupDiscount = 0;
  try {
    const mobile = localStorage.getItem("userMobile");
    if (mobile) {
      signupDiscount = Number(window.signupDiscount);
if (isNaN(signupDiscount)) signupDiscount = 0;

    }
  } catch (e) {}

  payable = payable - signupDiscount;
  if (payable < 0) payable = 0;
  payable = Number(payable.toFixed(2));


  // =====================================================
  // ========== 4) TAX + SERVICE CHARGE ==================
  // =====================================================
  const t = restaurantTax || {};

  let serviceAmt = 0;
  if (t.servicePercent > 0) {
    serviceAmt = payable * (t.servicePercent / 100);
  }

  let taxable = payable + serviceAmt;

  let cgstAmt = taxable * ((t.cgstPercent || 0) / 100);
  let sgstAmt = taxable * ((t.sgstPercent || 0) / 100);
  let igstAmt = taxable * ((t.igstPercent || 0) / 100);

  let grandTotal = taxable + cgstAmt + sgstAmt + igstAmt;

  serviceAmt  = Number(serviceAmt.toFixed(2));
  taxable     = Number(taxable.toFixed(2));
  cgstAmt     = Number(cgstAmt.toFixed(2));
  sgstAmt     = Number(sgstAmt.toFixed(2));
  igstAmt     = Number(igstAmt.toFixed(2));
  grandTotal  = Number(grandTotal.toFixed(2));


  // ========== UPDATE UI ==========
  const totalEl = document.getElementById("drawerTotalAmount");
  if (totalEl) totalEl.textContent = fmt(subtotal);

  const taxBox = document.getElementById("taxSummary");
  if (taxBox) {
   taxBox.innerHTML = `
      <div class="text-right text-gray-700 space-y-1.5">

        <div class="flex justify-between">
        <span>Offer Discount:</span>
        <span>- ${fmt(offerDiscount)}</span></div>

        ${signupDiscount > 0 
          ? `<div class="flex justify-between"><span>Signup Discount:</span><span>- ${fmt(signupDiscount)}</span></div>`
          : ``}

        <div class="flex justify-between"><span>Total after discount:</span>
        <span>${fmt(Number((subtotal - offerDiscount - signupDiscount).toFixed(2)))}</span></div>

        <div class="flex justify-between"><span>Service Charge (${t.servicePercent}%):</span>
        <span>${fmt(serviceAmt)}</span></div>

        <div class="flex justify-between"><span>Total after charges:</span>
        <span>${fmt(Number((payable + serviceAmt).toFixed(2)))}</span></div>

    <div class="flex justify-between"><span>CGST (${t.cgstPercent}%):</span> 
    <span>${fmt(cgstAmt)}</span></div>

    <div class="flex justify-between"><span>SGST (${t.sgstPercent}%): </span>
    <span>${fmt(sgstAmt)}</span></div>

    <div class="flex justify-between"><span>IGST (${t.igstPercent}%): </span>
    <span>${fmt(igstAmt)}</span></div>

    <div class="flex justify-between font-bold text-lg"><span>Grand Total: </span>
    <span>${fmt(grandTotal)}</span></div>

      </div>
    `;

  }
window._drawerTotals = {
    baseTotal: subtotal,
    offerDiscount: offerDiscount,
    signupDiscount: signupDiscount,
    payableAfterDiscount: payable,
    serviceAmt: serviceAmt,
    taxableAmount: taxable,
    cgstAmt: cgstAmt,
    sgstAmt: sgstAmt,
    igstAmt: igstAmt,
    grandTotal: grandTotal
  };

  try { updateCartBadge(); } catch(e){}

}

async function fetchSignupDiscount(mobile) {
  try {
    let res = await apiPost("checkSignupDiscount", { mobile });

    if (res.success) {
      window.signupDiscount = Number(res.amount || 0);
      updateDrawerTotals();  // UI refresh
    }
  } catch (e) {
    console.error("Signup discount fetch error:", e);
  }
}

</script>
<div id="couponAlert"
     style="display:none; position:fixed; bottom:20px; left:50%; 
            transform:translateX(-50%); background:#ffdddd; 
            color:#b30000; padding:12px 18px; border-radius:8px;
            box-shadow:0 3px 12px rgba(0,0,0,0.15);
            font-size:15px; z-index:9999;">
</div>
<script>
function showCouponAlert(msg) {
  const box = document.getElementById("couponAlert");
  if (!box) return;

  box.innerHTML = msg;
  box.style.display = "block";

  setTimeout(() => {
    box.style.display = "none";
  }, 10000); // hide after 10 seconds
}
function showCouponMessage(msg) {
  const box = document.getElementById("couponMessage");
  if (!box) return;

  box.innerHTML = msg;
  box.style.display = "block";

  // auto hide after 3 seconds
  setTimeout(() => {
    box.style.display = "none";
  }, 3000);
}
 document.querySelectorAll(".payment-btn").forEach(btn => {
    btn.addEventListener("click", () => {

      // remove active from all
      document.querySelectorAll(".payment-btn").forEach(b => {
        b.classList.remove("bg-orange-500", "text-white", "border-orange-500");
      });

      // add active to clicked
      btn.classList.add("bg-orange-500", "text-white", "border-orange-500");

      // set hidden input value (IMPORTANT)
      document.getElementById("paymentMethod").value = btn.dataset.value;
    });
  });
async function loadPincodeDropdown() {
  const ddl = document.getElementById("newPincode");
  if (!ddl) return;

  ddl.innerHTML = `<option value="">Select Pincode</option>`;

  try {
    const res = await apiGet("getCityList");

    if (!res || !res.success || !Array.isArray(res.cities)) return;

    res.cities.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.pin; // only pin as value
      opt.textContent = `${r.pin} ‚Äì ${r.city}, ${r.state}`;
      ddl.appendChild(opt);
    });

  } catch (e) {
    console.error("Pincode load failed", e);
  }
}
  
function onNewPincodeChange() {
  const pin = document.getElementById("newPincode").value.trim();
  const cityInput  = document.getElementById("newCity");
  const stateInput = document.getElementById("newState");

  // reset on partial input
  if (pin.length < 6) {
    cityInput.value = "";
    stateInput.value = "";
    cityInput.disabled = false;
    stateInput.disabled = false;
    return;
  }

  // üîí show wait inside fields
  cityInput.value = "Checking‚Ä¶";
  stateInput.value = "Please wait";
  cityInput.disabled = true;
  stateInput.disabled = true;

  apiGet("getCityStateByPincode", { pincode: pin })
    .then(res => {
      if (res && res.found) {
        cityInput.value  = res.city || "";
        stateInput.value = res.state || "";
      } else {
        // manual entry allowed
        cityInput.value = "";
        stateInput.value = "";
      }
    })
    .catch(err => {
      console.error("Pincode lookup failed", err);
      cityInput.value = "";
      stateInput.value = "";
    })
    .finally(() => {
      cityInput.disabled = false;
      stateInput.disabled = false;
    });
}






</script>
</body>
</html>


















