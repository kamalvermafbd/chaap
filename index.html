  
<!DOCTYPE html>
<html lang="en">
  
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Chaap Express</title>
<script src="https://cdn.tailwindcss.com"></script>

  <!-- Real Manifest File -->
  <link rel="manifest" href="/manifest.json">

  <!-- Icons -->
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <link rel="icon" sizes="192x192" href="/icons/icon-192.png">
  <link rel="icon" sizes="512x512" href="/icons/icon-512.png">

  <meta name="theme-color" content="#ff6f00" />
  <style>
    /* Fade-in effect for menu items */
.fadeIn {
  animation: fadeIn 0.6s ease forwards;
  opacity: 0;
}
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* Slide-in animation for category titles */
.slideIn {
  animation: slideIn 0.7s ease forwards;
  opacity: 0;
}
@keyframes slideIn {
  from { transform: translateX(-30px); opacity: 0; }
  to { transform: translateX(0); opacity: 1; }
}

/* Ripple animation for buttons */
button {
  position: relative;
  overflow: hidden;
}
button::after {
  content: "";
  position: absolute;
  background: rgba(255,255,255,0.4);
  width: 0;
  height: 0;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  opacity: 0;
}
button:active::after {
  width: 200px;
  height: 200px;
  top: 50%;
  left: 50%;
  opacity: 1;
  transition: 0.4s ease;
}

    body {
      font-family: 'Poppins', sans-serif;
      margin: 0;
      background: #fffdf7;
      color: #333;
    }
    header {
      position: relative;
  text-align: center;
  background: #ff6347;
  color: white;
  padding: 20px;
}


    .menu-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      padding: 20px;
    }
    .menu-item {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      padding: 10px;
    }
      .menu-item h4, 
      .menu-item p,
      .menu-item img {
     text-align: left !important;
    }
    /* FIX SINGLE ITEM PRICE ALIGNMENT */
.menu-item .variant-row {
  text-align: left !important;
}

.menu-item .variant-row .unit,
.menu-item .variant-row .price {
  text-align: left !important;
}

    /* Keep button fixed at bottom */
.menu-item {
  display: flex;
  flex-direction: column;
  min-height: 350px;   /* adjust as needed */
}

.menu-item button {
  margin-top: auto;
  display: inline-block;   /* full width nahi lega */
  width: auto;             /* text ke hisaab se size */
  padding: 6px 14px;       /* perfect compact size */
  font-size: 14px;
  align-self: center;      /* center me aayega */
}

.variant-box {
  margin-bottom: 10px;
}

/* FIX: Ensure price never gets cut */
.variant-row {
  overflow: visible !important;
}

/* FIX: Give space on right side so ‚Çπ price doesn't clip */
.variant-box {
  padding-right: 14px !important;
}

/* FIX: prevent label flex from shrinking price */
.price {
  flex-shrink: 0 !important;
  margin-left: auto !important;
}
/* Move price slightly inward */
.price {
  margin-right: 8px !important;
}

/* Keep Multi-variant in single line ALWAYS */
.variant-row {
  white-space: nowrap !important;
}

/* Left side ko shrink hone se rokna */
.left-side {
  flex-shrink: 0 !important;
}

/* Unit text 1st column me rahe, wrap na ho */
.unit {
  white-space: nowrap !important;
}

/* Price right me fix ho jaye, wrap na ho */
.price {
  white-space: nowrap !important;
}

    .menu-item img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 8px;
    }
    .cart {
      padding: 20px;
      background: #fff8f0;
      border-top: 2px solid #ff6347;
    }
    cart-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 6px 10px;
      margin: 2px 0;
      border-bottom: 1px solid #eee;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    th, td {
      border-bottom: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }
    th:nth-child(2), td:nth-child(2) {
      width: 60px;
    }
    button.default-btn {
  background: #ff6347;
  color: white;
  border: none;
  padding: 8px 12px;
  border-radius: 6px;
  cursor: pointer;
}

    button:hover { background: #e7533d; }
    checkout-btn {
      width: auto;
      padding: 10px 20px;
      font-size: 16px;
      margin-top: 10px;
    }
    #checkoutForm button[type="button"] {
      margin-top: 25px;
    }
    
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 400px;
    }
    input, textarea, select {
      width: 100%;
      margin: 6px 0;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    
#menu p {
  color: #000;
  font-weight: 600;
}
body {
  background: linear-gradient(135deg, #fff9f2, #ffe6d5);
  background-attachment: fixed;
}
    
.variant-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: #f9f9f9;
  border: 1px solid #ddd;
  border-radius: 6px;
  margin-bottom: 6px;
  cursor: pointer;
  width: 100%;  
  
}
    
.left-side {
  display: flex !important;
  align-items: center !important;
  gap: 10px !important;
}

.left-side {
  display: flex;
  align-items: center;
  gap: 8px;
}
.price {
  font-weight: 600;
}


.variant-row .left-side {
  display: flex;
  align-items: center;
  gap: 10px;
}

.variant-row input[type="radio"] {
  transform: scale(1.3);
}

.variant-box {
  border: 1px solid #ddd;
  padding: 8px;
  border-radius: 8px;
  margin-top: 10px;
  background: #fafafa;
  width: 100%;
  box-sizing: border-box;
  box-sizing: border-box;    /* ‚Üê JO MOST IMPORTANT FIX HAI */
  overflow: hidden;          /* ‚Üê extra expansion stop */
}

/* Center only the title and description */
.menu-item h4,
.menu-item p {
  text-align: center !important;
}
.variant-row { white-space: normal; }

@media (min-width:520px) {
  .variant-row { white-space: nowrap; }
}
/* Visual-only "disabled" look so clicks still work */
.disabled-btn {
  background: #ccc !important;
  opacity: 0.6;
  cursor: not-allowed;
  pointer-events: auto !important; /* ensure clicks are still delivered */
}
    .final-price {
  font-size: 16px;
  font-weight: 700;
}
.mrp {
  text-decoration: line-through;
  color: #777;
  margin-left: 6px;
  font-size: 13px;
}


/* Profile Page Input Styling */
#profilePage input {
  width: 280px !important;       /* Fixed compact width */
  max-width: 90% !important;     /* Responsive */
  font-size: 14px !important;    /* Smaller text */
  height: 32px !important;       /* Compact height */
  padding: 4px 10px !important;  /* Balanced padding */
  border: 1px solid #bbb;
  border-radius: 6px;
  margin-bottom: 10px;
  box-sizing: border-box;
}
#profilePage input[readonly] {
  background: #f5f5f5;
  color: #555;
}
#pageWrapper {
  position: relative;
}


#editBtn, #saveBtn, #cancelBtn {
  font-size: 14px !important;
  padding: 6px 12px !important;
}

/* PREMIUM LEFT SIDEBAR */
#leftNav {
  position: fixed;
  left: 0;
  top: 0;              /* üî• CHANGE */
  width: 220px;
  height: 100vh;
  background: #2A0A4A;
  color: white;
  padding: 200px 15px 20px; /* header ke liye space */
  border-right: 1px solid rgba(255,255,255,0.15);
  box-shadow: 2px 0 12px rgba(0,0,0,0.12);
  border-top-right-radius: 12px;
  transform: translateX(-100%);
  transition: transform 0.3s ease;
}


/* Menu UL */
#leftNav ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

/* Items */
#leftNav li {
  padding: 12px 10px;
  margin-bottom: 6px;
  cursor: pointer;
  color: white;
  font-size: 16px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  gap: 10px;
  transition: 0.2s;  
}

/* Hover effect */
#leftNav li:hover {
  background: rgba(255,255,255,0.15);
  backdrop-filter: blur(4px);
}

/* Active menu */
#leftNav li.active {
  background: white;
  color: #1e3a8a;
  font-weight: 600;
}

/* Premium badge for numbers */
.nav-badge {
  background: white;
  color: #1e3a8a;
  padding: 2px 7px;
  border-radius: 6px;
  font-weight: bold;
}
/* Premium Navigation Icons */
.nav-icon {
  font-size: 22px;       /* Bigger size */
  color: #ffd166;        /* Soft gold/yellow ‚Äì looks premium on blue */
  font-weight: bold;
}
#profileOverlay { 
   display: none; 
   position: fixed; 
   inset: 0;
   background: rgba(0,0,0,0.45);
   z-index: 9999;
   color: white;
   font-size: 22px;
   align-items: center;
   justify-content: center;
}
#profileOverlay.active {
   display: flex;
}

/* soft noise overlay */
body::before {
  content: "";
  position: fixed;
  inset: 0;
  background-image: url('https://www.transparenttextures.com/patterns/cubes.png');
  opacity: 0.15;
  pointer-events: none;
}
/* Sidebar hidden by default (slide-left) */

/* When sidebar is active */
#leftNav.active {
  transform: translateX(0);
}

  button:focus,
  button:active,
  button:focus-visible {
    outline: none !important;
    box-shadow: none !important;
  }

  *:focus {
    outline: none !important;
    box-shadow: none !important;
  }
.nohighlight {
  -webkit-tap-highlight-color: transparent !important;
  background: transparent !important;
}
.nohighlight:active,
.nohighlight:focus {
  background: transparent !important;
  outline: none !important;
  box-shadow: none !important;
}

@keyframes fadeIn {
  from { opacity: 0; transform: scale(0.96); }
  to   { opacity: 1; transform: scale(1); }
}
.animate-fadeIn {
  animation: fadeIn .25s ease-out;
}
  .disabled-btn {
  opacity: 0.5 !important;
  cursor: not-allowed !important;
  background: #ccc !important;
  pointer-events: auto !important; /* click allowed for alert */
}  
      #savedAddressDropdown {
    font-family: monospace;
  }
    .added-flash {
  @apply scale-105 transition duration-150 ease-out;
}

    .cart-badge-pop {
  animation: cartPop 0.25s ease-out;
}

@keyframes cartPop {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.25); }
  100% { transform: scale(1); }
}
    
#cartDrawer {
  position: fixed;
  top: 0;
  right: -100%;           /* hidden by default */
  width: 90%;
  max-width: 380px;
  height: 100vh;
  background: #ffffff;
  box-shadow: -4px 0 12px rgba(0,0,0,0.12);
  z-index: 99999;
  padding: 20px;
  overflow-y: auto;
  transition: right 0.35s ease-out;   /* smooth slide */
}

/* Drawer Visible */
#cartDrawer.active {
  right: 0;
}

/* Dim Background */
#cartBackdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  z-index: 99998;
}

/* Active State */
#cartBackdrop.active {
  display: block;
}
/* Z10 ‚Äî Responsive Zomato-style drawer spacing */
#cartDrawer {
  padding-top: 50px !important;
}

#cartDrawer h2 {
  margin-top: 10px;
  margin-bottom: 18px;
}

#cartItems .cart-card {
  padding: 12px !important;
}
#cartDrawer {
  position: fixed;
  top: 0;
  right: -100%;
  width: 90%;
  max-width: 380px;
  height: 100vh;
  background: #ffffff;
  box-shadow: -4px 0 12px rgba(0,0,0,0.12);
  z-index: 99999;
  padding: 20px;
  overflow-y: auto;
  transition: right 0.35s ease-out;
  position: fixed;
}

    #cartDrawer { position: fixed; top: 0; right: -100%; width: 88%; max-width: 380px; height: 100vh; background: #ffffff; box-shadow: -6px 0 18px rgba(0,0,0,0.18); border-top-left-radius: 18px; border-bottom-left-radius: 18px; z-index: 99999; padding: 20px; overflow-y: auto; transition: right 0.30s cubic-bezier(0.25, 0.8, 0.25, 1); /* premium smooth */ }
#cartBackdrop {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.25);
  backdrop-filter: blur(3px);
  -webkit-backdrop-filter: blur(3px);
  display: none;
  z-index: 99998;
  transition: opacity 0.25s ease;
  opacity: 0;
}

#cartBackdrop.active {
  display: block;
  opacity: 1;
}
.qty-pop {
  animation: qtyPop 0.25s ease-out;
}

@keyframes qtyPop {
  0%   { transform: scale(1); }
  40%  { transform: scale(1.3); }
  100% { transform: scale(1); }
}

  .add-btn {
  display: none !important;
}
   .cart {
  display: none;
}

#menuSearch:-webkit-autofill {
  box-shadow: 0 0 0px 1000px white inset !important;
}
    
/* Chrome autofill yellow/grey overlay ko 100% neutralize */
#menuSearch:-webkit-autofill,
#menuSearch:-webkit-autofill:hover,
#menuSearch:-webkit-autofill:focus {
    -webkit-text-fill-color: #000 !important;
    transition: background-color 9999s ease-in-out 0s;
}

/* ===== CHECKOUT MODAL SCROLLBAR (SLIM) ===== */
#checkoutModal ::-webkit-scrollbar {
  width: 5px;
}

#checkoutModal ::-webkit-scrollbar-track {
  background: transparent;
}

#checkoutModal ::-webkit-scrollbar-thumb {
  background-color: rgba(0, 0, 0, 0.25);
  border-radius: 10px;
}

#checkoutModal ::-webkit-scrollbar-thumb:hover {
  background-color: rgba(0, 0, 0, 0.4);
}

/* default hidden */
.mobile-error {
  display: none;
  color: #dc2626;
  font-size: 0.875rem;
  margin-top: 4px;
}

/* show error ONLY when invalid AND user typed */
#mobile:not(:focus):invalid ~ .mobile-error,
#mobile:focus:invalid ~ .mobile-error {
  display: block;
}
 #mobile.valid + #mobileError {
    display: none;
 }

    /* Payment buttons base fix */
.payment-btn {
  background-color: #ffffff;
  color: #111827;
  font-weight: 600;
}

/* ‚úÖ THIS IS THE MAIN FIX */
.payment-btn.active {
  background-color: #f97316;   /* Place Order orange */
  color: #ffffff;
  border-color: #f97316;
}

/* Optional hover (non-selected only) */
.payment-btn:not(.active):hover {
  background-color: #fff7ed;
}
/* Drawer collapsed state */
#cartDrawer.collapsed {
  transform: translateX(92%);
  transition: transform 0.3s ease;
}
/* Cart drawer handle */
#cartHandle {
  position: fixed;
  top: 50%;
  right: 0;
  transform: translateY(-50%);
  width: 36px;
  height: 90px;
  background: #ff6f00;
  color: #fff;
  border-radius: 10px 0 0 10px;
  display: none;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  z-index: 99999;
  box-shadow: -3px 0 8px rgba(0,0,0,0.25);
  font-size: 28px;
  font-weight: bold;
  opacity: 0.9;
  transition: transform 0.2s ease, opacity 0.2s ease, background 0.2s ease;
}

#cartHandle:hover {
  background: #e65f00;
  opacity: 1;
  transform: translateY(-50%) scale(1.05);
}
@keyframes dots {
  0%   { content: ""; }
  10%  { content: "."; }
  20%  { content: ".."; }
  30%  { content: "..."; }
  40%  { content: "..."; }
  50%  { content: ".."; }
  60%  { content: "."; }
  70%  { content: ""; }
  80%  { content: ""; }
  90%  { content: ""; }
  100% { content: ""; }
}

.coupon-loading::after {
  content: "";
  animation: dots 1.4s infinite;
}
    
@keyframes blink {
  0%   { opacity: 1; }
  50%  { opacity: 0.4; }
  100% { opacity: 1; }
}

.coupon-blink {
  animation: blink 1.2s infinite;
}
/* ===== MOBILE CART SCROLL FIX (SAFE & MINIMAL) ===== */
@media (max-width: 768px) {
  #cartItems {
    max-height: 65vh;
    overflow-y: auto;
    -webkit-overflow-scrolling: touch;
  }
}
/* MOBILE ONLY: allow scroll till checkout */
@media (max-width: 768px) {
  #cartDrawer {
    padding-bottom: 110px; /* üëà checkout button ki jagah */
  }
}

#pageWrapper {
  margin-left: 260px;   /* sidebar width */
  transition: margin-left 0.3s ease;
}

.menu-active #pageWrapper {
  margin-left: 0;
}

    #mainContent {
  transition: margin-left 0.3s ease;
}
    

#offersPage {
  padding-left: 0 !important;
  width: 100%;
  max-width: 100%;
}
    
#offersPromoBanner {
  width: 100%;
  max-width: 820px;     /* optional, thoda wide */
  margin-left: -20px;      /* üëà LEFT ALIGN */
}
    
#offersPromoSlides > div {
  margin-bottom: 12px;   /* pehle zyada hoga */
}


.offer-banner-card {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #fff;
  border-radius: 22px;
  padding: 22px;
  margin-bottom: 20px;
  box-shadow: 0 10px 28px rgba(0,0,0,0.08);
  cursor: pointer;
}

.offer-left {
  display: flex;
  gap: 16px;
  align-items: center;
}

.offer-icon {
  width: 56px;
  height: 56px;
  border-radius: 16px;
  background: #ffedd5;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 26px;
  font-weight: 900;
  color: #f97316;
}

.offer-title {
  font-size: 20px;
  font-weight: 900;
}

.offer-sub {
  color: #6b7280;
  margin-top: 4px;
}

.offer-img img {
  width: 90px;
  height: 90px;
  border-radius: 16px;
  object-fit: cover;
}

    /* ===== OFFERS PAGE ‚Äì PREMIUM BANNER ===== */

.offer-banner-card {
  position: relative;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 28px 32px;
  margin-bottom: 26px;
  border-radius: 22px;
  background: linear-gradient(135deg, #2563eb, #1e40af);
  color: #ffffff;
  box-shadow: 0 18px 40px rgba(37, 99, 235, 0.35);
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.offer-banner-card:hover {
  transform: translateY(-4px) scale(1.01);
  box-shadow: 0 22px 55px rgba(37, 99, 235, 0.45);
}

/* abstract blob shape */
.offer-banner-card::before {
  content: "";
  position: absolute;
  top: -40%;
  right: -20%;
  width: 420px;
  height: 420px;
  background: rgba(255,255,255,0.12);
  border-radius: 50%;
}

/* left section */
.offer-left {
  display: flex;
  align-items: center;
  gap: 18px;
  z-index: 1;
}

.offer-icon {
  width: 64px;
  height: 64px;
  border-radius: 18px;
  background: rgba(255,255,255,0.18);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 28px;
  font-weight: 800;
}

.offer-title {
  font-size: 22px;
  font-weight: 800;
  letter-spacing: 0.2px;
}

.offer-sub {
  font-size: 14px;
  opacity: 0.9;
  margin-top: 4px;
}

/* right image */
.offer-img {
  width: 110px;
  height: 110px;
  border-radius: 18px;
  overflow: hidden;
  background: rgba(255,255,255,0.15);
  z-index: 1;
}

.offer-img img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

/* mobile tweak */
@media (max-width: 768px) {
  .offer-banner-card {
    padding: 22px;
  }
  .offer-title {
    font-size: 18px;
  }
}
/* ===== SALE POSTER STYLE ===== */

.sale-card {
  position: relative;
  height: 220px;
  border-radius: 22px;
  background: #ffffff;
  box-shadow: 0 18px 40px rgba(0,0,0,0.12);
  overflow: hidden;
  margin-bottom: 30px;
  cursor: pointer;
}

/* abstract blob */
.sale-blob {
  position: absolute;
  inset: -40%;
  background: radial-gradient(circle at 30% 30%,
    #3b82f6,
    #2563eb,
    #1e40af);
  transform: rotate(-12deg);
}

/* content */
.sale-content {
  position: relative;
  z-index: 2;
  height: 100%;
  padding: 28px;
  color: #ffffff;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.sale-badge {
  font-size: 14px;
  font-weight: 700;
  opacity: 0.9;
  margin-bottom: 8px;
}

.sale-title {
  font-size: 30px;
  font-weight: 900;
  letter-spacing: 0.5px;
}

.sale-sub {
  font-size: 15px;
  opacity: 0.9;
  margin-top: 6px;
}

.sale-btn {
  margin-top: 18px;
  align-self: flex-start;
  background: #ffffff;
  color: #1e40af;
  border: none;
  padding: 8px 18px;
  font-weight: 700;
  border-radius: 999px;
  cursor: pointer;
}

.sale-btn:hover {
  background: #f1f5f9;
}

/* mobile */
@media (max-width: 768px) {
  .sale-card {
    height: 190px;
  }
  .sale-title {
    font-size: 22px;
  }
}

/* ===== OPTION 2 : VERTICAL OFFER POSTERS (4:5) ===== */

.offers-poster-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 22px;
  padding: 12px 0 40px;
}

/* Card */
.offer-poster {
  position: relative;
  aspect-ratio: 4 / 5;
  background: #ffffff;
  border-radius: 20px;
  box-shadow: 0 12px 30px rgba(0,0,0,0.12);
  overflow: hidden;
  cursor: pointer;
  transition: transform 0.25s ease, box-shadow 0.25s ease;
}

.offer-poster:hover {
  transform: translateY(-6px);
  box-shadow: 0 18px 40px rgba(0,0,0,0.18);
}

/* Blob */
.offer-blob {
  position: absolute;
  inset: 16% -25% auto -25%;
  height: 62%;
  border-radius: 50%;
}

/* Color variants */
.offer-blue   { background: radial-gradient(circle at 30% 30%, #4f8cff, #1e40af); }
.offer-orange { background: radial-gradient(circle at 30% 30%, #ff9f43, #f97316); }
.offer-pink   { background: radial-gradient(circle at 30% 30%, #f472b6, #db2777); }
.offer-green  { background: radial-gradient(circle at 30% 30%, #34d399, #059669); }

/* Content */
.offer-content {
  position: relative;
  z-index: 3;
  height: 100%;
  padding: 30px 20px 18px;   /* üëà text thoda niche */
  display: flex;
  flex-direction: column;
  justify-content: space-between;
}

.offer-top {
  font-size: 12px;
  font-weight: 700;
  color: #ffffffcc;
  letter-spacing: 1px;
}

.offer-title {
  font-size: 28px;
  font-weight: 800;
  color: #ffffff;
  line-height: 1.1;
  margin-top: 10px;
}

.offer-sub {
  font-size: 14px;
  color: #eef2ff;
  margin-top: 6px;
}

/* CTA BUTTON */
.offer-cta-btn {
  margin-top: 14px;
  padding: 7px 16px;
  font-size: 14px;
  font-weight: 600;
  border-radius: 999px;
  border: none;
  color: #fff;
  width: fit-content;
  cursor: pointer;
  position: relative;
  z-index: 4;
  box-shadow: 0 6px 14px rgba(0,0,0,0.18);
}

/* Button color match */
.offer-poster.offer-blue .offer-cta-btn {
  background: linear-gradient(135deg, #3b82f6, #1e40af);
}

.offer-poster.offer-orange .offer-cta-btn {
  background: linear-gradient(135deg, #fb923c, #f97316);
}

.offer-poster.offer-pink .offer-cta-btn {
  background: linear-gradient(135deg, #f472b6, #db2777);
}

.offer-poster.offer-green .offer-cta-btn {
  background: linear-gradient(135deg, #34d399, #059669);
}

/* Image */
.offer-img {
  position: absolute;
  right: 14px;
  bottom: 14px;
  width: 70px;
  height: 70px;
  border-radius: 16px;
  overflow: hidden;
  background: #000;
  z-index: 2;
}

.offer-img img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
#myCouponsPage {
  max-width: 720px;
  margin-left: 0;
  margin-right: auto;
}
.coupon-card {
  background: rgba(255, 255, 255, 0.75);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(0,0,0,0.06);
  border-radius: 14px;
  padding: 14px 16px;
  box-shadow: 0 6px 14px rgba(0,0,0,0.06);
}

#myCouponsPage {
  max-width: 680px; /* abhi thoda zyada wide lag raha */
}

    .coupon-amount {
  font-size: 18px;
  font-weight: 700;
}

    .used-coupon {
  opacity: 0.7;
}
    
.used-coupon {
  border-left: 4px solid #ef4444;   /* red indicator */
}

.used-coupon .coupon-status,
.used-coupon .coupon-meta {
  color: #dc2626; /* red-600 */
}

    .available-coupon {
  border-left: 4px solid #22c55e; /* green */
  background: rgba(34, 197, 94, 0.06);
}

.available-coupon .coupon-status,
.available-coupon .coupon-meta {
  color: #15803d; /* dark green */
}
.used-coupon {
  border-left: 4px solid #ef4444; /* red */
  background: rgba(239, 68, 68, 0.06);
}

.used-coupon .coupon-body {
  opacity: 0.85;
}

.used-coupon .coupon-status,
.used-coupon .coupon-meta {
  color: #dc2626;
}
/* Red pulse around Place Order when blocked */
.payment-attention {
  position: relative;
}

.payment-attention::after {
  content: "";
  position: absolute;
  inset: -6px;
  border-radius: 14px;
  border: 2px solid #ef4444;
  animation: paymentPulse 1.2s infinite;
}

@keyframes paymentPulse {
  0%   { opacity: 0.9; transform: scale(1); }
  50%  { opacity: 0.4; transform: scale(1.05); }
  100% { opacity: 0.9; transform: scale(1); }
}
#placeOrderBtn {
  overflow: visible !important;
  z-index: 5;
}

    
  </style>
</head>
<body>
  <div id="loadingOverlay" style="
  
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 20000;
    justify-content: center;
    align-items: center;
    color: white;
    font-size: 24px;
  ">
    Processing your order...
  </div>

<div id="cartOverlay" class="fixed inset-0 bg-black bg-opacity-45 z-50 text-white text-xl font-medium flex items-center justify-center hidden">
  Updating your cart‚Ä¶
</div>


 


  
<div id="signupLabelBox"
     style="
       position:absolute;
       right:12px;
       top:100px;
       width:180px;
       text-align:right;
       font-size:13px;
       color:#EA580C;
       font-weight:500;
       font-family:Poppins, sans-serif;
       line-height:16px;
     ">
  


</div>


  <div id="cartBackdrop" onclick="closeCartDrawer()"></div> 
<div id="cartDrawer"> 
   <button onclick="closeCartDrawer()" 
    class="absolute right-3 top-3 text-gray-500 hover:text-gray-800 text-2xl font-bold">
    &times;
  </button>
<h2 class="text-xl font-semibold mb-3">Your Cart</h2> 
<div id="drawerItemsList"></div>
  

  <div id="couponHintBox"
       class="text-sm text-red-600 font-semibold"
     style="display:none;">
  Checking best offers for you‚Ä¶
</div>

<!-- OFFER SECTION (BOTTOM OF DRAWER) -->
  
<div id="offerSection" class="p-3 border-t mt-3" style="background:#fff;">

  <button id="applyCouponBtn"
          onclick="openCouponList()"

          class="w-full py-2 rounded-lg border
               border-orange-300
               bg-orange-50
               text-orange-700
               font-semibold
               hover:bg-orange-100
               transition">
    üéÅ View Offers
  </button>
  
  
 <!-- üî• Alert message goes HERE -->
  
<!-- ‚úÖ APPLIED COUPON BOX -->
<div id="bestOfferApplied"
     class="hidden mt-2 p-3 rounded-lg border border-green-300 bg-green-50
            flex justify-between items-center">

  <div>
    <div id="appliedCouponText"
         class="font-semibold text-green-800"></div>

    <div id="appliedCouponSubText"
         class="text-sm text-green-700"></div>
  </div>

  <button
    onclick="removeAppliedCoupon()"
    class="text-sm text-red-600 font-semibold">
    Remove
  </button>
</div>



  <div id="offerList"
    onclick="event.stopPropagation()"
        class="mt-3 bg-gray-50 p-2 rounded-lg border"
        style="display:none; max-height:220px; overflow:auto;">
         <!-- üëá STEP-2 loader added inside offerList -->
     <div id="offerLoadingText" 
        class="coupon-loading"
          style="display:none; padding:10px; text-align:center; color:#16a34a; font-weight:600;">
         Fetching offers, please wait
     </div>

  </div>
<div id="couponMessage" 
       style="display:none; margin-top:10px; 
              background:#ffefef; color:#b30000; 
              padding:8px 12px; border-radius:6px; 
              font-size:14px; border:1px solid #ffcccc;">
  </div>
</div>

<!-- Coupon eligibility message -->

<!-- Reward Claim Box -->
<div id="rewardBox"
     class="hidden mt-4 p-4 rounded-lg border border-green-300 bg-green-50">

  <div id="rewardText"
       class="text-green-800 font-semibold mb-2">
  </div>

  <button id="claimRewardBtn"
          onclick="onClaimRewardClick()"
          class="px-4 py-2 rounded-md bg-green-600 text-white font-medium hover:bg-green-700">
    Claim Reward
  </button>

  <div id="rewardStatus"
       class="hidden mt-2 text-sm text-gray-700">
  </div>
</div>

  <div id="availableCouponsBox" class="mt-3 hidden">
  <div class="font-semibold mb-2">üéü Available Coupons</div>
  <div id="availableCouponsList" class="space-y-2"></div>
</div>

  
<div class="mt-4 border-t pt-3 flex justify-between text-lg font-bold">
  <span>Base Total:</span>
  <span id="drawerTotalAmount">0</span>
</div>


<!-- NEW BASE + TAX + GRAND TOTAL BLOCK (SHIFTED FROM VIEW CART) -->
<div class="mt-4 border-t pt-3">
 
  <div id="taxSummary" class="text-right font-semibold mt-2"></div>

  <div class="flex justify-between mt-4 text-xl font-bold">
    
  </div>

</div>

<div id="drawerCheckoutSlot"></div>


</div>

 <!-- HAMBURGER BUTTON (appears only after login) -->
<button id="hamburgerBtn"
        onclick="toggleSidebar()"
        style="position:fixed; top:15px; left:15px; font-size:26px;
               background:#7A0010; color:#FFD166; border:none;
               padding:8px 12px; border-radius:8px; cursor:pointer;
               box-shadow:0 2px 6px rgba(0,0,0,0.2); z-index:9999; display:none;">
  <svg id="hamburgerIcon" viewBox="0 0 24 24" width="24" height="24" fill="#FFD166">
    <rect y="4" width="24" height="3"></rect>
    <rect y="10" width="24" height="3"></rect>
    <rect y="16" width="24" height="3"></rect>
  </svg>
</button>

<button id="installBtn" 
        style="
          display:none;
          position:fixed;
          bottom:20px;
          right:20px;
          background:#ff6347;
          color:white;
          padding:10px 16px;
          border-radius:8px;
          font-size:16px;
          border:none;
          box-shadow:0 4px 10px rgba(0,0,0,0.2);
          z-index:99999;
        ">
  Install App
</button>

<header
  style="
    position: relative;
    display: flex;
    flex-wrap: wrap;
    align-items: center;
    padding: 10px 14px;
    gap: 8px;
  "
>

  <!-- USER INFO (FIRST LINE, FULL WIDTH) -->
  <div
    id="userInfoBox"
    class="bg-orange-500 text-white px-4 py-2 rounded-lg shadow-md text-sm hidden"
    style="width:100%; text-align:center;"
  >
    Logged in: <span id="loggedEmail"></span>
  </div>

  <!-- RIGHT SIDE ACTIONS -->
  <div
    class="header-actions"
    style="
      margin-left: auto;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      justify-content: flex-end;
      align-items: center;
    "
  >

    <!-- VIEW CART -->
   <button
  onclick="onViewCartClick()"
  style="
    background:#FFEDD5;
    color:#EA580C;
    padding:8px 16px;
    border:none;
    border-radius:9999px;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,0.08);
  "
  onmouseover="this.style.background='#FED7AA'"
  onmouseout="this.style.background='#FFEDD5'"
>
  View Cart (<span id="cartCount">0</span>)
</button>


    <!-- LOGIN -->
    <button
  id="loginBtn"
  onclick="openLogin()"
  style="
    display:none;
    background:#FFEDD5;
    color:#EA580C;
    padding:8px 16px;
    border:none;
    border-radius:9999px;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,0.08);
  "
  onmouseover="this.style.background='#FED7AA'"
  onmouseout="this.style.background='#FFEDD5'"
>
  Login
</button>


    <!-- LOGOUT -->
    <button
      id="logoutBtn"
      onclick="logoutUser()"
      style="
        background:#FFEDD5;
        color:#EA580C;
        padding:8px 16px;
        border:none;
        border-radius:9999px;
        font-weight:600;
        cursor:pointer;
        box-shadow:0 4px 10px rgba(0,0,0,0.08);
        display:none;
      "
      onmouseover="this.style.background='#FED7AA'"
      onmouseout="this.style.background='#FFEDD5'"
    >
      Logout
    </button>

    <!-- SIGNUP -->
    <button
  id="signupBtn"
  onclick="openSignup()"
  style="
    display:none;
    background:#FFEDD5;
    color:#EA580C;
    padding:8px 16px;
    border:none;
    border-radius:9999px;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 4px 10px rgba(0,0,0,0.08);
  "
  onmouseover="this.style.background='#FED7AA'"
  onmouseout="this.style.background='#FFEDD5'"
>
  Signup
</button>


  </div>
</header>

<!-- PROMOTION BANNER (ONLY DYNAMIC ‚Äì NO STATIC SLIDE) -->
<div id="promoBanner"
  class="mx-4 mt-4 mb-5
         py-2
         min-h-[220px]
         rounded-3xl
         relative
         shadow-xl
         border border-white/10
         bg-[#fff7f2]
         overflow-hidden
         hidden">

  <!-- CLOSE BUTTON -->
  <button onclick="closePromoBanner()"
          class="absolute top-2 right-3 z-10 text-gray-500 text-xl font-bold">
    √ó
  </button>

  <!-- SLIDER TRACK -->
  <div id="promoSlides"
       class="flex transition-transform duration-700 ease-in-out">
  </div>

  <!-- DOTS -->
  <div id="promoDots"
       class="absolute bottom-3 left-1/2 -translate-x-1/2 flex gap-2">
  </div>

</div>


<!-- LEFT NAVIGATION PANEL -->
<!-- LEFT NAVIGATION PANEL -->
<div id="leftNav"
     style="
       position:fixed;
       left:0;
       top:90px;
       bottom:0;
       width:180px;
       background:#1976d2;
       color:white;
       border-right:1px solid #e6e6e6;
       box-shadow: 2px 0 4px rgba(0,0,0,0.06); /* soft professional shadow */
       padding:20px;
       z-index:999;
       overflow-y:auto;
       display:block; /* default hidden */
       
     ">
  <ul id="premiumMenu">
  <li onclick="openMenuPageProperly(this)">

  <span class="nav-icon">
  <svg viewBox="0 0 24 24" width="32" height="32">
    <path d="M6 7V6a6 6 0 0 1 12 0v1h2a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V8a1 1 0 0 1 1-1h2Zm2 0h8V6a4 4 0 0 0-8 0v1Z" 
          fill="#FFD166"></path>
  </svg>
</span>

  Continue Shopping
</li>

      <li onclick="activateMenu(this); showPage('profilePage'); loadUserProfile();">
    <span class="nav-badge">1</span>
    My Profile
  </li>

 <li onclick="activateMenu(this); showPage('ordersPage');">


    <span class="nav-badge">2</span>
    My Orders
  </li>

 <li onclick="activateMenu(this); showPage('offersPage'); onOffersPageOpen();">
    <span class="nav-badge">3</span>
   My Offers
  </li>
<li onclick="activateMenu(this); showPage('myCouponsPage');">

  <span class="nav-badge">4</span>
  My Coupons
</li>


    
</ul>

</div>

<!-- RIGHT SIDE MAIN CONTENT -->
<!-- MAIN CONTENT AREA -->
<div id="mainContent" 
     style="margin-left:0px; padding:20px; transition:0.2s ease;">

    <!--  MENU WRAPPER (default visible) -->
    <div id="menuWrapper">

        <!-- FILTER AREA -->
        <div id="filterWrapper" style="text-align:center; margin-bottom:15px;">
 <!-- Category Filter -->
        <select id="categoryFilter" onchange="filterMenu()"
            style="width:45%;max-width:200px;padding:10px;font-size:16px;
                   border-radius:6px;border:1px solid #ccc;background:white;">
            <option value="">All Categories</option>
        </select>
<input type="text" style="display:none" autocomplete="off">

        <!-- Search -->
      <input
  type="text"
  id="menuSearch"
  name="never_autofill_search"
  placeholder="Search food item..."
  autocomplete="off"
  inputmode="search"
  aria-autocomplete="none"
  autocorrect="off"
  autocapitalize="off"
  spellcheck="false"
  onfocus="this.setAttribute('autocomplete','off')"
  oninput="filterMenu()"
  style="width:45%;max-width:200px;padding:10px;font-size:16px;
         border-radius:6px;border:1px solid #ccc;margin-left:10px;">


        <!-- Clear -->
        <button onclick="clearFilters()"
            style="padding:10px 15px;margin-left:10px;background:#777;color:white;
                   border:none;border-radius:6px;cursor:pointer;">
            Clear
        </button>



            <!-- Your existing category filter + search + clear button will be here -->
        </div>

        <!-- OTHER PAGES WRAPPER (default hidden) -->


        <!-- MENU LIST -->
        <div id="menu" class="menu-container">
            <p>Loading menu...</p>
        </div>

<div class="cart">
    <h3 class="text-xl font-semibold mb-3 text-gray-800">Your Cart</h3>
        <!-- CART -->
        <div id="cartWrapper" class="p-4 bg-white shadow rounded-md">
<div id="cartItems" class="space-y-3"></div>

            <!-- Your current cart HTML goes here -->


    <table id="cartTable" class="hidden">

  <thead>
    <tr class="bg-gray-100 border-b">
      <th class="px-4 py-2 text-left">Item</th>
      <th class="px-4 py-2 text-left">Qty</th>
      <th class="px-4 py-2 text-left">Rate (MRP)</th>
      <th class="px-4 py-2 text-left">Disc %</th>
      <th class="px-4 py-2 text-left">Disc Amt</th>
      <th class="px-4 py-2 text-left">Net Amt</th>
      <th class="px-4 py-2 text-left">Total</th>
      <th class="px-4 py-2 text-left">Action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

  
<p id="cartBaseTotal" class="text-right font-semibold mt-2 mb-4">
  Total: <span id="cartTotal">0.00</span>
</p>


<!-- Tax Summary Comes Here -->
<div id="taxSummary" class="text-right font-semibold mt-2"></div>

      


  </div>
        </div>
    </div>
</div>
  
  <div id="pageWrapper" style="display:none; padding:10px;">

    <!-- PROFILE PAGE -->
    <div id="profilePage" style="display:none;">
        <h2>My Profile</h2>
        
        <div id="profileLoading" style="display:none; color:red;">Loading...</div>
        <input id="pName" placeholder="Full Name" readonly><br>
        <input id="pMobile" placeholder="Mobile" disabled><br>
        <input id="pEmail" placeholder="Email" readonly><br>
        <input id="pAddress" placeholder="Address" readonly><br>
        <input id="ppin" placeholder="Pincode" readonly><br>
        <input id="pCity" placeholder="City" readonly><br>
        <input id="pState" placeholder="State" readonly><br>

        <button id="editBtn" onclick="enableProfileEdit()">Edit</button>
        <button id="saveBtn" onclick="saveProfile()" style="display:none;">Save Changes</button>
        <button id="cancelBtn" onclick="cancelProfileEdit()" style="display:none;">Cancel</button>

        <div id="profileOverlay"
             style="
               position:fixed;
               inset:0;
               background:rgba(0,0,0,0.45);
               z-index:9999;
               color:white;
               font-size:22px;
               align-items:center;
               justify-content:center;
             ">
          Saving your profile‚Ä¶
        </div>
    </div>

    <!-- ORDERS PAGE -->
   <div id="ordersPage"
     style="display:none;"
     class="px-3 md:px-6 w-full">


        <h2>My Orders</h2>
       <!-- ACTIVE -->
    <div class="mb-8">
      <h3 class="text-lg font-semibold text-gray-700 mb-3">
        Active Orders
      </h3>

      <div id="activeOrdersSection">
        <div class="text-center text-gray-400 py-6">
          Loading orders...
        </div>
      </div>
    </div>

    <!-- DISPATCHED -->
    <div>
      <h3 class="text-lg font-semibold text-gray-700 mb-3">
        Dispatched Orders
      </h3>

      <div id="dispatchedOrdersSection">
        <div class="text-center text-gray-400 py-6">
          No dispatched orders
        </div>
      </div>
    </div>

    </div>

    <!-- OFFERS PAGE -->
<div id="offersPage" style="display:none;">
  <h2>My Offers</h2>
<!-- OFFERS POSTER GRID -->
<div id="offersPosterGrid" class="offers-poster-grid hidden"></div>

  <!-- OFFERS ONLY BANNER -->
  <div id="offersCouponsBox" class="hidden">
    <div id="offersCouponsList" class="space-y-2"></div>
  </div>
</div>


<!-- ===================== -->
<!-- 4Ô∏è‚É£ My Coupons summary -->
<!-- ===================== -->
<div id="myCouponsPage" style="display:none;" class="mt-6">

 

  <!-- Unused Coupons -->
  <div id="unusedCouponsBlock" class="mb-5 hidden">
    <h3 class="text-sm font-semibold text-green-700 mb-2">
      üü¢ Available Coupons
    </h3>
    <div id="unusedCouponsList" class="space-y-2"></div>
  </div>

  <!-- Used Coupons -->
  <div id="usedCouponsBlock" class="hidden">
    <h3 class="text-sm font-semibold text-gray-600 mb-2">
      üïò Used Coupons
    </h3>
    <div id="usedCouponsList" class="space-y-2"></div>
  </div>

</div>

  </div>
<!-- CHECKOUT MODAL (Tailwind Updated ‚Äî with ALL your original fields) -->

<div id="checkoutModal"
     class="fixed inset-0 bg-black bg-opacity-40 hidden z-[9999] flex items-center justify-center p-2">

<div class="bg-white w-full max-w-[820px] rounded-2xl shadow-xl
            p-4 md:p-5 relative animate-fadeIn
            max-h-[90vh] overflow-y-auto">

    <!-- Close Button -->
    <button onclick="closeCheckout()"
  class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-lg font-semibold">
  ‚úï
</button>

   
<h2 class="text-lg font-semibold text-gray-900 mb-2">
  Checkouttest3
</h2>

<div class="flex gap-4">

 <div class="w-6/12">

  <form id="checkoutForm" class="space-y-2">

  <!-- Mobile -->
<div id="mobileWrapper" class="mb-3">
  <div class="flex items-center gap-4">

    <label class="text-sm font-medium text-gray-700 whitespace-nowrap">
      Mobile
    </label>

    <input
      id="mobile"
      type="tel"
      inputmode="numeric"
      maxlength="10"
      pattern="[0-9]{10}"
      placeholder="Enter 10-digit Mobile"
      required
      oninput="checkCustomerByMobile()"
      class="w-56 max-w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
             focus:outline-none focus:ring-2 focus:ring-orange-500"

    />
  </div>

  <label
    id="mobileHint"
    class="block text-red-600 text-sm mt-1"
  >
    Please enter 10 digit mobile number
  </label>
</div>





      <!-- Order Type -->
      <div id="orderTypeWrapper">
        <label class="block text-sm font-medium text-gray-700 mb-1">Order Type</label>
        <select id="orderType" required
        onchange="toggleAddressField(); recheckEligibilityOnOrderTypeChange()"
        class="w-full border border-gray-300 rounded-lg p-2.5 bg-white
               focus:outline-none focus:ring-2 focus:ring-orange-500">

          <option value="">Select Order Type</option>
          <option value="Dine In">Dine In</option>
          <option value="Take Away">Take Away</option>
          <option value="Home Delivery">Home Delivery</option>
        </select>
      </div>

      <!-- Name -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Name</label>
        <input id="customerName"
               type="text"
               placeholder="Your Name"
               required
               class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                      focus:outline-none focus:ring-2 focus:ring-orange-500">
        <div
    id="nameError"
    class="hidden text-red-600 text-sm mt-1"
  ></div>
      </div>

      <!-- Email -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
        <input id="email"
               type="email"
               placeholder="Email"
               required
               class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                      focus:outline-none focus:ring-2 focus:ring-orange-500">
        <div id="emailError" class="hidden text-red-600 text-sm mt-1"></div>
      </div>

      <!-- Address -->
<div id="addressWrapper">
  <label class="block text-sm font-medium text-gray-700 mb-1">Address</label>
  <textarea id="address"
            placeholder="Address"
            class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                   focus:outline-none focus:ring-2 focus:ring-orange-500"></textarea>
  <!-- üî¥ ADDRESS ERROR MESSAGE (PASTE HERE) -->
<div id="addressError"
     class="hidden mt-2 text-red-600 font-bold text-base">
</div>

</div>

<!-- PINCODE -->
<div id="pincodeWrapper" style="display:none; margin-top:10px;">
  <label class="block text-sm font-medium text-gray-700 mb-1">Pincode</label>
  <input id="pincode"
         readonly
         class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                bg-gray-100 cursor-not-allowed">
</div>

<!-- CITY -->
<div id="cityWrapper" style="display:none; margin-top:10px;">
  <label class="block text-sm font-medium text-gray-700 mb-1">City</label>
  <input id="city"
         readonly
         class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                bg-gray-100 cursor-not-allowed">
</div>

<!-- STATE -->
<div id="stateWrapper" style="display:none; margin-top:10px;">
  <label class="block text-sm font-medium text-gray-700 mb-1">State</label>
  <input id="state"
         readonly
         class="w-full border border-gray-300 rounded-lg p-2.5 text-gray-800
                bg-gray-100 cursor-not-allowed">
</div>
<!-- üìç Delivery Location Status -->
<div id="locationStatusRow"
     class="mt-3 px-3 py-2 rounded-lg border text-sm hidden cursor-pointer"
     onclick="openLocationPicker()">

  <span id="locationStatusIcon">üìç</span>
  <span id="locationStatusText">Set delivery location</span>
</div>
<!-- Mini Map Preview (hidden by default) -->
<div id="mapPreviewBox" class="mt-3 hidden">
  <div class="text-xs text-gray-500 mb-1">
    Delivery location preview
  </div>

  <div class="w-full h-[200px] rounded-lg overflow-hidden border">
    <iframe
      id="mapPreviewFrame"
      class="w-full h-full border-0"
      loading="lazy"
      referrerpolicy="no-referrer-when-downgrade">
    </iframe>
  </div>
</div>


<!-- CHANGE ADDRESS BUTTON (shown only for logged-in users via JS) -->
<div class="space-y-3">
   <button
  id="changeAddressBtn"
  type="button"
  onclick="onChangeAddressClick()"
  class="hidden w-full mt-2
         border border-orange-500 text-orange-600
         bg-white
         py-2.5 rounded-xl text-sm font-semibold
         hover:bg-orange-50
         transition">
  Change Address
</button>
<p id="addressStatus"
   class="text-xs text-gray-500 mt-1 hidden">
</p>



<!-- SAVED ADDRESS DROPDOWN -->
<div id="addressSelectContainer" class="mt-3 hidden">
  <label class="block text-sm font-medium mb-1">Select Saved Address</label>
  <select id="savedAddressDropdown"
          class="w-full border rounded px-2 py-2 text-sm">
    <!-- Options added dynamically -->
  </select>
  <!-- STEP 3D BUTTON BELOW DROPDOWN -->
  <button type="button"
        onclick="onChangeAddressAddNew()"
       class="w-full mt-2
         border border-orange-500 text-orange-600
         bg-white
         py-2.5 rounded-xl text-sm font-semibold
         hover:bg-orange-50
         transition">
  + Add New Address
</button>

  </div>   <!-- ‚úÖ CLOSE addressSelectContainer -->

</div>   

      
     <!-- Payment Method -->
<div>
  <label class="block text-sm font-medium text-gray-700 mb-1">
    Payment Method
  </label>

  <!-- Hidden input (same id so backend / placeOrder stays safe) -->
  <input type="hidden" id="paymentMethod" value="">

  <div class="flex gap-2">
    <button type="button"
            class="payment-btn flex-1 border border-gray-300 rounded-lg py-2 text-sm
                   hover:border-orange-500"
            data-value="Cash on Delivery">
      Cash on Delivery
    </button>

    <button type="button"
            class="payment-btn flex-1 border border-gray-300 rounded-lg py-2 text-sm
                   hover:border-orange-500"
            data-value="Online">
      Online
    </button>
  </div>
<!-- üî¥ PAYMENT ERROR MESSAGE (PASTE HERE) -->
  <div id="paymentError"
       class="hidden mt-2 text-red-600 font-bold text-base">
  </div>

 </div>
      
<!-- BUTTONS -->
<div class="mt-3 grid grid-cols-2 gap-3">

  <!-- Place Order (LEFT) -->
<button
  id="placeOrderBtn"
  type="button"
  onclick="placeOrder()"
  class="w-full py-2.5 rounded-xl text-sm font-semibold
         bg-orange-600 hover:bg-orange-700 text-white">
  Place Order
</button>



  <!-- Cancel (RIGHT - matching size & theme) -->
  <button type="button" onclick="closeCheckout()"
    class="w-full py-2.5 rounded-xl text-sm font-semibold
           bg-orange-100 text-orange-700 border border-orange-300
           hover:bg-orange-200">
    Cancel
  </button>

</div>
</form>
</div>
  <div class="w-6/12">
<div id="checkoutInvoiceContainer"></div>
</div>
  </div>
</div>
</div>

<!-- NEW ADDRESS MODAL (STEP-2A) -->
<!-- NEW ADDRESS MODAL (STEP-2A) -->
<div id="newAddressModal"
     class="fixed inset-0 bg-black bg-opacity-40 hidden z-[10000]
            flex items-center justify-center">

  <!-- WHITE CARD -->
  <div class="bg-white w-full max-w-[380px]
              rounded-2xl shadow-xl p-4 relative">

    <!-- Title -->
    <h3 class="text-lg font-semibold mb-2">Add New Address</h3>

    <!-- FORM WRAPPER -->
    <div id="newAddressForm" class="mt-4 hidden border p-3 rounded bg-gray-50">

      <label class="text-sm font-medium">Mobile</label>
      <input id="newAddressMobile"
             class="w-full border px-2 py-2 rounded bg-gray-200 text-gray-700"
             readonly />

      <label class="text-sm font-medium mt-3">Address</label>
      <textarea id="newAddressField"
        autocomplete="off"
        autocorrect="off"
        autocapitalize="off"
        spellcheck="false"
        name="new-address-never"
        class="w-full border px-2 py-2 rounded"
        placeholder="Enter full address"></textarea>

      <label class="text-sm font-medium mt-3">Pincode</label>
      <input id="newPincode"
             maxlength="6"
             oninput="onNewPincodeChange()"
             class="w-full border px-2 py-2 rounded"
             placeholder="Enter pincode" />

      <p id="pincodeStatus"
         class="text-xs text-gray-500 mt-1 hidden">
        Checking pincode‚Ä¶
      </p>

      <label class="text-sm font-medium mt-3">City</label>
      <input id="newCity"
             class="w-full border px-2 py-2 rounded"
             placeholder="Enter city" />

      <label class="text-sm font-medium mt-3">State</label>
      <input id="newState"
             class="w-full border px-2 py-2 rounded"
             placeholder="Enter state" />

      <button id="saveNewAddressBtn"
              onclick="saveNewAddress()"
              class="mt-4 w-full bg-green-600 text-white py-2 rounded">
        Save Address
      </button>

      <button type="button"
              onclick="closeNewAddressModal()"
              class="mt-2 w-full bg-gray-200 text-gray-700 py-2 rounded">
        Cancel
      </button>

      <button type="button"
              onclick="closeNewAddressModal()"
              class="absolute top-2 right-2 text-gray-400 hover:text-gray-700 text-xl font-bold">
        ‚úï
      </button>

    </div> <!-- ‚úÖ close newAddressForm -->

  </div> <!-- ‚úÖ close white card -->

</div> <!-- ‚úÖ close newAddressModal -->



  <script>

    const PROMO_SVGS = {
  signup: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <path d="M12 2l3 7h7l-5.5 4.5L18 21l-6-4-6 4 1.5-7.5L2 9h7z"/>
    </svg>
  `,
  flat: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <circle cx="12" cy="12" r="10"/>
      <path d="M8 12h8M12 8v8"/>
    </svg>
  `,
  percent: `
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"
         stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <line x1="19" y1="5" x2="5" y2="19"/>
      <circle cx="6.5" cy="6.5" r="2.5"/>
      <circle cx="17.5" cy="17.5" r="2.5"/>
    </svg>
  `
};

    function isUserLoggedIn() {
  return !!localStorage.getItem("userMobile");
}

document.querySelectorAll(".payment-btn").forEach(btn => {
  btn.addEventListener("click", () => {

    // set payment value
    document.getElementById("paymentMethod").value = btn.dataset.value;

    // active UI
    document.querySelectorAll(".payment-btn").forEach(b =>
      b.classList.remove("border-orange-500", "bg-orange-50")
    );
    btn.classList.add("border-orange-500", "bg-orange-50");

    // ‚úÖ STEP-2: clear payment error instantly
    const paymentError = document.getElementById("paymentError");
    if (paymentError) {
      paymentError.innerText = "";
      paymentError.classList.add("hidden");
    }
  });
});

document.addEventListener("DOMContentLoaded", function() {
    const s = document.getElementById("menuSearch");

    // multiple attempts to beat Chrome autofill timing
    const clearNow = () => {
        if (s) {
            s.value = "";
            s.setAttribute("value", "");
        }
    };

    clearNow();
    setTimeout(clearNow, 100);
    setTimeout(clearNow, 300);
});

document.addEventListener("DOMContentLoaded", function () {

  const menuWrapper = document.getElementById("menuWrapper");
  if (!menuWrapper) return;

  menuWrapper.addEventListener("click", function (e) {

    // cart drawer already open hai?
    if (isDrawerOpen()) {
      collapseDrawerCart();
    }

  }, true); // capture phase = safe
});

document.addEventListener("DOMContentLoaded", function() {
    const s = document.getElementById("menuSearch");
    if (!s) return;

    // JAB USER SEARCH BOX PE CLICK/FOCUS KARE ‚Üí autofill ko turant blank
    s.addEventListener("focus", () => {
        s.value = "";
        s.setAttribute("value", "");
    });

    // Kuch browsers mousedown pe autofill karte hain
    s.addEventListener("mousedown", () => {
        s.value = "";
        s.setAttribute("value", "");
    });
});
// ‚≠ê Restore signup discount on refresh (GLOBAL)
window.signupDiscount = Number(localStorage.getItem("signupDiscount") || 0);

// === GLOBAL CURRENCY SETUP ===
window.CURRENCY = window.CURRENCY || "‚Çπ";


function fmt(amount, digits = 2) {
  if (amount === null || amount === undefined) amount = 0;
  const n = Number(amount) || 0;
  return `${window.CURRENCY}${n.toFixed(digits)}`;

}

function fmtNoSymbol(amount, digits = 2) {
  const n = Number(amount) || 0;
  return n.toFixed(digits);
}
    // === AUTO LOAD RESTAURANT CURRENCY ===
window.taxRules = null;

async function loadRestaurantSettings() {
  try {
    const res = await apiGet("getRestaurantInfo");

    if (res && res.success) {

      if (res.currency) {
        window.CURRENCY = res.currency.trim();
      }

      window.gstOnDiscountedAmount =
        String(res.gstOnDiscountedAmount).toUpperCase() === "TRUE";

      window.cgstPercent = Number(res.cgstPercent || 0);
      window.sgstPercent = Number(res.sgstPercent || 0);
      window.igstPercent = Number(res.igstPercent || 0);

      // üî• ADD THIS LINE
      window.servicePercent = Number(res.servicePercent || 0);

      console.log("üî• RESTAURANT SETTINGS:", {
        servicePercent: window.servicePercent,
        cgst: window.cgstPercent,
        sgst: window.sgstPercent,
        igst: window.igstPercent,
        gstOnDiscountedAmount: window.gstOnDiscountedAmount
      });
    }
  } catch (err) {
    console.error("Restaurant settings load error:", err);
  }
}


// === END CURRENCY SETUP ===

    function animateQty(id) {
  const el = document.getElementById(id);
  if (!el) return;

  el.classList.remove("qty-pop");
  void el.offsetWidth; // reflow reset
  el.classList.add("qty-pop");
}

    let restaurantTax = {
  taxType: "",
  servicePercent: 0,
  cgstPercent: 0,
  sgstPercent: 0,
  igstPercent: 0
};
let cart = [];   // start empty

 // --- CART SAVE LOCK SYSTEM (Fix race condition) ---
let cartSaveLock = false;
let cartSaveQueued = false;
// ---- ADD-TO-CART CLICK LOCK ----
let addClickLock = false;
// --- Debounce variables (qty/update/delete) ---
let qtyDebounce = null;
let deleteDebounce = null;
let blockRender = false;

    function levenshtein(a, b) {
  a = a || ""; b = b || "";
  const m = a.length, n = b.length;
  if (m === 0) return n;
  if (n === 0) return m;
  const dp = Array.from({length: m+1}, () => new Array(n+1).fill(0));
  for (let i=0;i<=m;i++) dp[i][0] = i;
  for (let j=0;j<=n;j++) dp[0][j] = j;
  for (let i=1;i<=m;i++) {
    for (let j=1;j<=n;j++) {
      const cost = a[i-1] === b[j-1] ? 0 : 1;
      dp[i][j] = Math.min(dp[i-1][j] + 1, dp[i][j-1] + 1, dp[i-1][j-1] + cost);
    }
  }
  return dp[m][n];
}

// Normalize text for comparison
function normalizeText(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/[^a-z0-9\s]/g, "")   // remove punctuation
    .replace(/\s+/g, " ")         // collapse spaces
    .trim();
}

// Map several synonyms / common variants to canonical form
const CANONICAL_MAP = {
  "starter": "Starters",
  "starters": "Starters",
  "startrer": "Starters",
  "snack": "Snacks",
  "snacks": "Snacks",
  "drink": "Drink",
  "drinks": "Drinks",
  "mocktail": "Mocktail",
  "mocktails": "Mocktails",
  "cocktail": "Cocktail",
  "cocktails": "Cocktails",
  "main course": "Main Course",
  "main": "Main Course",
  "maincourse": "Main Course",
  "sweets": "Sweets",
  "sweet": "Sweet",
  "dessert": "Dessert",
  "desserts": "Desserts"
};

// Return canonical name for a category string using map + fuzzy fallback
function canonicalCategory(raw, priorityListLower) {
  const norm = normalizeText(raw);
  if (!norm) return ""; // blank

  // direct map
  if (CANONICAL_MAP[norm]) return CANONICAL_MAP[norm];

  // singular/plural quick fix: strip trailing 's'
  if (norm.endsWith("s") && CANONICAL_MAP[norm.slice(0,-1)]) {
    return CANONICAL_MAP[norm.slice(0,-1)];
  }

  // fuzzy match against priority list and canonical map keys
  let best = {score: Infinity, key: null, target: null};

  // check known canonical keys (map keys)
  for (const key of Object.keys(CANONICAL_MAP)) {
    const d = levenshtein(norm, key);
    if (d < best.score) { best = {score: d, key, target: CANONICAL_MAP[key]}; }
  }

  // check priority list labels (lowercase versions)
  for (const label of priorityListLower) {
    const d = levenshtein(norm, label);
    if (d < best.score) { best = {score: d, key: label, target: label.split(" ").map(w=>w[0].toUpperCase()+w.slice(1)).join(" ")}; }
  }

  // if very close (threshold), accept fuzzy match
  if (best.score <= Math.max(1, Math.floor(Math.min(norm.length, (best.key||"").length) * 0.35))) {
    // return capitalized target (if target from priorityListLower, it might be lowercase)
    const t = best.target || best.key;
    // ensure Title Case
    return String(t).split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
  }

  // fallback: title-case the original normalized string
  return norm.split(" ").map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(" ");
}

// NEW populateCategoryDropdown ‚Äî shows canonical categories (no duplicates from typos)

function populateCategoryDropdown(items) {
  const dropdown = document.getElementById("categoryFilter");
  dropdown.innerHTML = `<option value="">All Categories</option>`;

  // priority list (same as renderMenu)
  const categoryPriority = [
    "starters","snacks","drinks","mocktails","cocktails","main course","sweets","desserts"
  ];
  const priorityLower = categoryPriority.slice();

  // Build set of canonical categories
  const canonicalSet = new Set();
  items.forEach(i => {
    const can = canonicalCategory(i.category, priorityLower);
    if (can) canonicalSet.add(can);
  });

  // Sort canonical list using priority (known ones first in defined order, others alphabetic)
  const list = Array.from(canonicalSet);
  list.sort((a,b) => {
    const A = a.toLowerCase(), B = b.toLowerCase();
    const ai = priorityLower.indexOf(A);
    const bi = priorityLower.indexOf(B);
    if (ai !== -1 && bi !== -1) return ai - bi;
    if (ai !== -1) return -1;
    if (bi !== -1) return 1;
    return A.localeCompare(B);
  });

  list.forEach(cat => {
    const opt = document.createElement("option");
    opt.value = cat;
    opt.textContent = cat;
    dropdown.appendChild(opt);
  });
}

    

    let menuItems = [];
 
const API_BASE = "https://script.google.com/macros/s/AKfycbzFuronV7SPVqfQO81NrfS3EHG1UdDAB5PsKqm3XtR0RjC_2qL1PnCgXfdMaeO2zK-IyQ/exec";

// ===============================
// API HELPER
// ===============================
function apiGet(api, params = {}) {
  const url = new URL(API_BASE);
  url.searchParams.set("api", api);

  Object.keys(params).forEach(k =>
    url.searchParams.set(k, params[k])
  );

  return fetch(url.toString(), {
    method: "GET",
    headers: { "Accept": "application/json" }
  }).then(res => res.json());
}

// ===============================
// PROMO BANNER OFFER FETCH (SAFE)
// ===============================
async function fetchOffersForPromoBanner() {
  try {
    const res = await apiGet("getOffers");

    // üî• IMPORTANT FIX
    window._promoOffers = res.allOffersRaw || [];

    return window._promoOffers;
  } catch (e) {
    window._promoOffers = [];
    return [];
  }
}


// ===============================
// PROMO BANNER CALL (SITE OPEN)
// ===============================
document.addEventListener("DOMContentLoaded", () => {
  fetchOffersForPromoBanner().then(() => {
    showPromoBannerFromSheet();
  });
});

// ===============================
// MENU LOAD
// ===============================
apiGet("getMenu")
  .then(res => {
    res.menu = (res.menu || []).map(row => ({
      ...row,
      image: row["Image Url"] || row.image || row.Image || row.img || ""
    }));

    window.menuItems = res.menu;
    renderMenu(res.menu);
  })
  .catch(err => console.error("Menu load error:", err));

// ===============================
// CAT ALLOCATION LOAD
// ===============================
apiGet("getCatAllocations")
  .then(res => {
    window.cat_allocations = res.cat_allocations || [];
    console.log("Cat Allocations Loaded:", window.cat_allocations);
  })
  .catch(err => console.error("cat allocation load error:", err));

// ===============================
// RESTAURANT INFO LOAD
// ===============================
apiGet("getRestaurantInfo")
  .then(res => {

    const nameEl = document.getElementById("restaurantName");
    const addrEl = document.getElementById("restaurantAddress");

    if (nameEl) {
      nameEl.innerHTML = "&#127860; " + (res.name || "");
    }

    if (addrEl) {
      addrEl.innerText = res.address || "";
    }

    window.couponMode = (res.coupon || "")
      .toString()
      .trim()
      .toLowerCase()
      .replace(/[^a-z]/g, "");

    console.log("Coupon Mode =", window.couponMode);

    const couponSection = document.getElementById("offerSection");
    const applyBtn = document.getElementById("applyCouponBtn");

    if (window.couponMode === "manualcoupon") {
      if (couponSection) couponSection.style.display = "block";
      if (applyBtn) applyBtn.style.display = "block";
    } else {
      if (applyBtn) applyBtn.style.display = "none";
      if (couponSection) couponSection.style.display = "block";
    }

    restaurantTax.taxType = res.taxType || "";
    restaurantTax.servicePercent =
      res.servicePercent && res.servicePercent !== "NIL"
        ? Number(res.servicePercent)
        : 0;

    restaurantTax.cgstPercent = Number(res.cgstPercent) || 0;
    restaurantTax.sgstPercent = Number(res.sgstPercent) || 0;
    restaurantTax.igstPercent = Number(res.igstPercent) || 0;

    console.log("Restaurant Tax Settings Loaded:", restaurantTax);
  })
  .catch(err => {
    console.error("Restaurant info load error:", err);
  });

function slugify(s) {
  return String(s || "")
    .toLowerCase()
    .replace(/\s+/g, "-")
    .replace(/[^a-z0-9\-_]/g, "");
}


function renderMenu(items) {
  menuItems = items;

  // Auto-fill category dropdown (canonical)
  populateCategoryDropdown(items);

  const menuDiv = document.getElementById('menu');
  menuDiv.innerHTML = '';
let renderIndex = 0;
  // priority brain
  const categoryPriority = [
    "starters",
    "snacks",
    "drinks",
    "mocktails",
    "cocktails",
    "main course",
    "sweets",
    "desserts"
  ];

  // Build map: original raw category -> canonical
  const rawToCanonical = {};
  items.forEach(it => {
    const raw = (it.category || "").toString();
    rawToCanonical[raw] = canonicalCategory(raw, categoryPriority);
  });

  // Extract unique canonical categories (preserve order)
  let categoryOrder = [...new Set(
    Object.values(rawToCanonical).filter(c => c && c !== "")
  )];

  // Sort categoryOrder using priority (canonical lowercases)
  categoryOrder.sort((a,b) => {
    const A = a.toLowerCase(), B = b.toLowerCase();
    const ai = categoryPriority.indexOf(A);
    const bi = categoryPriority.indexOf(B);
    if (ai !== -1 && bi !== -1) return ai - bi;
    if (ai !== -1) return -1;
    if (bi !== -1) return 1;
    return A.localeCompare(B);
  });

  // ====== CHEF SPECIAL SECTION ======
  const chefSpecialItems = items.filter(i => {
    const val = (i.hotselling || i.Hotselling || "").toString().trim().toUpperCase();
    return val === "TRUE";
  });

  if (chefSpecialItems.length > 0) {
    const heading = document.createElement("h2");
    heading.classList.add("slideIn");
    heading.innerHTML = "Chef Special";
    heading.style.margin = "10px 0 5px";
    heading.style.padding = "10px";
    heading.style.background = "#ff6347";
    heading.style.color = "white";
    heading.style.borderRadius = "6px";
    heading.style.gridColumn = "1 / -1";
    menuDiv.appendChild(heading);

    chefSpecialItems.forEach(item => {
      item.itemId = item.itemId || item.ItemId || item.id || item.ID;

      const div = document.createElement("div");
      div.className = "menu-item fadeIn";

       div.innerHTML = buildMenuCardHTML(item, renderIndex);
menuDiv.appendChild(div);

renderIndex++;

    });
  }

  // ====== CATEGORY GROUPING ======
  categoryOrder.forEach(cat => {
    const group = items.filter(i => {
      const can = rawToCanonical[(i.category || "").toString()];
      return (can || "").toLowerCase() === cat.toLowerCase();
    });

    if (group.length > 0) {
      const heading = document.createElement("h2");
      heading.classList.add("slideIn");

      heading.innerHTML = cat;
      heading.style.margin = "10px 0 5px";
      heading.style.padding = "10px";
      heading.style.background = "#ff6347";
      heading.style.color = "white";
      heading.style.borderRadius = "6px";
      heading.style.gridColumn = "1 / -1";
      menuDiv.appendChild(heading);

      group.forEach(item => {
        item.itemId = item.itemId || item.ItemId || item.id || item.ID;

        const div = document.createElement('div');
        div.className = 'menu-item fadeIn';

         div.innerHTML = buildMenuCardHTML(item, renderIndex);
menuDiv.appendChild(div);

renderIndex++;

      });
       }
  });
     
  // ‚≠ê CORRECT PLACE
   setTimeout(() => {
       restoreFullCartUI();
   }, 50);
}


function clearFilters() {
  document.getElementById("menuSearch").value = "";
  document.getElementById("categoryFilter").value = "";

  // Reset menu to original grouped view
  renderMenu(menuItems);
}
function rebuildCart() {

  // Read correct cart based on login state
  if (!isLoggedIn()) {
    cart = JSON.parse(localStorage.getItem("guestCart") || "[]");
  } else {
    cart = JSON.parse(localStorage.getItem("cart") || "[]");
  }

  cart = cart.map(item => {
    // quantity fix
    item.qty = Number(item.qty || item.quantity || 1);

    // rate fix
    item.rate = Number(item.rate || item.price || 0);

    // total recalc
    item.total = item.rate * item.qty;

    // discount recalc
    if (item.discPercent > 0) {
      item.discAmt = item.total * (item.discPercent / 100);
      item.netAmt = item.total - item.discAmt;
    } else {
      delete item.discAmt;
      delete item.netAmt;
    }

    return item;
  });

  // store updated clean cart (guest vs logged-in)
  if (!isLoggedIn()) {
    localStorage.setItem("guestCart", JSON.stringify(cart));
  } else {
    
  }

  // rerender
  renderCart();
}

function addToCart(name, unit, rate, discPercent = 0, itemIdFromBtn = "", variantIdFromBtn = "") {
// --- Prevent spam clicking ---
if (addClickLock) return;
addClickLock = true;

setTimeout(() => addClickLock = false, 150);
  showCartOverlay("Adding item‚Ä¶");

  // STEP 1C ‚Äì Normalize
  const cleanUnit = String(unit || "").trim().toLowerCase();
  const cleanName = String(name || "").trim().toLowerCase();
// Read correct cart based on login state
let stored;
if (!isLoggedIn()) {
  stored = JSON.parse(localStorage.getItem("guestCart") || "[]");
} else {
  stored = JSON.parse(localStorage.getItem("cart") || "[]");
}

  let itemId = "";
  let variantId = "";

  // STEP 1B ‚Äî If button already passed correct IDs, use them
  if (itemIdFromBtn) {
    itemId = itemIdFromBtn;
    variantId = variantIdFromBtn || "";
} else {
    console.warn("FATAL: addToCart called WITHOUT itemIdFromBtn. Button must send correct IDs.");
    hideCartOverlay();
    return;
}


  // --------------------------------------------
  // Perfect merge logic using itemId + variantId
  const existing = stored.find(i => i.itemId == itemId && i.variantId == variantId);

  if (existing) {
    existing.qty = Number(existing.qty || 0) + 1;
    existing.total = parseFloat((existing.qty * existing.rate).toFixed(2));

    if (existing.discPercent > 0) {
      const discAmt = (existing.rate * existing.discPercent) / 100;
      existing.discAmt = parseFloat(discAmt.toFixed(2));
      existing.netAmt = parseFloat(((existing.rate - discAmt) * existing.qty).toFixed(2));
    } else {
      delete existing.discAmt;
      delete existing.netAmt;
    }
  }

  // NEW ITEM
  else {
      // Find exact menu item using itemId (best method)
    const menuItemFull = (window.menuItems || []).find(
  m => m.itemId == itemId
);

    const qty = 1;

    const total = rate * qty;
    const discAmt = (rate * discPercent) / 100;
    const netRate = rate - discAmt;

   
    let newItem = {
      name,
      unit,
      qty,
      rate: Number(rate),
      total: parseFloat(total.toFixed(2)),
      itemId,
      variantId,
      discPercent: Number(discPercent),
       image: menuItemFull?.image || ""
    };

    if (discPercent > 0) {
      newItem.discAmt = parseFloat(discAmt.toFixed(2));
      newItem.netAmt = parseFloat((netRate * qty).toFixed(2));
    }

    stored.push(newItem);
  }

  // SAVE to localStorage only
  // ‚≠ê Guest users MUST save here
if (!isLoggedIn()) {
    localStorage.setItem("guestCart", JSON.stringify(stored));
} else {
    localStorage.setItem("cart", JSON.stringify(stored));
}

  cart = stored;
  window.cart = stored;

  renderCart();

  // --------------------------------------------
 if (isLoggedIn()) {
  saveCartToBackend().finally(() => hideCartOverlay());
} else {
  hideCartOverlay();
}


  alert(`${name} (${unit}) added to cart`);
}

function openCartPanel(cartArr = []) {

  const list = Array.isArray(cartArr) && cartArr.length > 0
    ? cartArr
    : getCart();

  const container = document.getElementById("drawerItemsList");
  if (!container) return;

  container.innerHTML = "";

  if (list.length === 0) {
    container.innerHTML = `
      <div class="p-4 text-center text-gray-500">
        Your cart is empty
      </div>
    `;
    try { updateDrawerTotals(); } catch(e){}
    toggleClaimRewardOnCart(list); // ‚úÖ list pass karo

    return;
  }

  let html = "";

  list.forEach(ci => {

    const itemId = String(ci.itemId);
    const variantId = String(ci.variantId || "");
    const qty = Number(ci.qty || 1);
    const rate = Number(ci.rate || 0);
    const disc = Number(ci.discPercent || 0);

    const discAmt = (rate * disc) / 100;
    const netRate = rate - discAmt;
    const lineTotal = (netRate * qty).toFixed(2);

    html += `
      <div class="flex gap-3 py-2 border-b">

        <!-- IMAGE -->
        <img 
          src="${ci.image || 'https://via.placeholder.com/60'}" 
          class="w-16 h-16 rounded object-cover"
        />

        <!-- RIGHT SIDE DETAILS -->
        <div class="flex-1">

          <!-- NAME + UNIT -->
          <div class="font-semibold text-gray-800">
            ${ci.name} 
            <span class="text-sm text-gray-500">${ci.unit || ""}</span>
          </div>

          <!-- MRP + DISCOUNT -->
          <div class="text-xs text-gray-600 mt-1 leading-tight">
            <div>MRP: <span class="font-semibold">${fmt(rate)}</span></div>

            ${disc > 0 ? `
              <div>Discount: <span class="font-semibold">${disc}%</span></div>
              <div>Disc Amt: <span class="font-semibold">${fmt(discAmt)}</span></div>
              <div>Net Rate: <span class="font-semibold">${fmt(netRate)}</span></div>
            ` : ""}
          </div>

          <!-- QTY + TOTAL -->
          <div class="flex justify-between items-center mt-2">

            <div class="flex items-center gap-2">
              <button 
                class="px-2 bg-gray-300 rounded"
                onclick="updateCart('${itemId}','${variantId}','dec')"
              >‚àí</button>

              <span class="font-semibold">${qty}</span>

              <button 
                class="px-2 bg-gray-300 rounded"
                onclick="updateCart('${itemId}','${variantId}','add')"
              >+</button>
            </div>

            <div class="font-bold text-gray-800 text-base">
              ${fmt(lineTotal)}
            </div>

          </div>

        </div>
      </div>
    `;
  });

  container.innerHTML = html;

  try { updateDrawerTotals(); } catch(e){}
  toggleClaimRewardOnCart(list); // ‚úÖ FIX-2
}

function renderCart() {
   console.log(
    "üß© renderCart()",
    "cartUpdating:", window._cartUpdating,
    "blockRender:", blockRender,
    "checkoutBtn:", document.getElementById("checkoutBtn")
  );
  const checkoutBtn = document.getElementById("checkoutBtn");
if (checkoutBtn) {
  if (window._cartUpdating) {
    checkoutBtn.disabled = true;
    checkoutBtn.innerText = "Updating cart‚Ä¶";

    checkoutBtn.classList.remove("bg-red-500", "hover:bg-red-600");
    checkoutBtn.classList.add("bg-gray-400", "cursor-not-allowed", "opacity-60");

  } else {
    checkoutBtn.disabled = false;
    checkoutBtn.innerText = "Checkout";

    checkoutBtn.classList.remove("bg-gray-400", "cursor-not-allowed", "opacity-60");
    checkoutBtn.classList.add("bg-red-500", "hover:bg-red-600");
  }
}

if (blockRender) {
  // still allow checkout button state update
} else {
  console.log("Rendering Cart...");
  console.log(cart);
}
  const cartItemsContainer = document.querySelector('#cartItems');
cartItemsContainer.innerHTML = '';
  const thead = document.querySelector('#cartTable thead tr');
  
// ---- SUPER SANITIZER (Prevents render bugs) ----
cart = cart.map(item => {
   // ADD THIS FIX 
  const menuMatch = window.menuItems?.find(m => m.itemId == item.itemId);
  if (menuMatch) item.image = menuMatch.image;
  const menuItem = (window.menuItems || []).find(m => m.itemId == item.itemId);

  // 1) NAME FIX
  if (!item.name && menuItem?.name) item.name = menuItem.name;

  // 2) UNIT FIX (for Multi items)
  if (!item.unit) {
    const variant = (window.cat_allocations || []).find(v => v.variantId == item.variantId);
    if (variant) item.unit = variant.unit;
  }

  // 3) IMAGE FIX
  if (!item.image && menuItem?.image) item.image = menuItem.image;

  // 4) TYPE FIX (force correct numeric)
  item.qty = Number(item.qty || 1);
  item.rate = Number(item.rate || 0);
  item.discPercent = Number(item.discPercent || 0);

  // 5) TOTAL RECALC
  const discAmt = (item.rate * item.discPercent) / 100;
  item.discAmt = Number(discAmt.toFixed(2));

  const netRate = item.rate - item.discAmt;

  item.total = item.discPercent > 0 
    ? Number((netRate * item.qty).toFixed(2))
    : Number((item.rate * item.qty).toFixed(2));

  return item;
});

 // ‚≠ê SAVE sanitized image back to storage
if (!isLoggedIn()) {
  localStorage.setItem("guestCart", JSON.stringify(cart));
} else {
  
}


  // ===== Check discount usage =====
  const anyDiscount = cart.some(i => Number(i.discPercent) > 0);

  // ===== Build header =====
  // ===== PERMANENT FULL HEADER (no flicker) =====
thead.innerHTML = `
  <th>Item</th>
  <th>Qty</th>
  <th>Rate (MRP)</th>
  <th class="col-disc">Disc %</th>
  <th class="col-disc">Disc Amt</th>
  <th class="col-disc">Net Amt</th>
  <th>Total</th>
  <th>Action</th>
`;
// ===== Hide / Show discount columns =====
const showDisc = cart.some(i => Number(i.discPercent) > 0);

  let grandTotal = 0;

  // ================================================
  //               BUILD CART TABLE ROWS
  // ================================================
  cart.forEach((item, idx) => {

    const rate = Number(item.rate);
    const qty  = Number(item.qty);
    const disc = Number(item.discPercent || 0);

    // fresh safe calculations
    const discAmt = parseFloat(((rate * disc) / 100).toFixed(2));
    const netRate = rate - discAmt;

    // FIX: for no discount ‚Üí use MRP * qty
    const total = disc > 0 
      ? parseFloat((netRate * qty).toFixed(2))
      : parseFloat((rate * qty).toFixed(2));

    grandTotal += total;

    

const card = document.createElement("div");
card.className = "cart-card mb-3 p-4 bg-white rounded-lg shadow flex items-center justify-between gap-4"; // Added gap-4 and padding increased

card.innerHTML = `
<div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-3 sm:gap-4 w-full">
 <img 
      src="${item.image || 'https://via.placeholder.com/60'}" 
      class="w-20 h-20 object-cover rounded-md"
    />

<div class="flex-1">
  <div class="font-semibold text-gray-800 leading-tight">${item.name} (${item.unit})</div>
  <div class="text-gray-500 text-sm">Rate: ${fmt(rate)}</div>
</div>

${disc > 0 ? `
  <div class="text-right text-sm text-gray-600 leading-tight">
    <div class="text-sm text-gray-500">
      Disc %: <span class="font-semibold">${disc}%</span>
    </div>

    <div class="text-sm text-gray-500">
      Disc Amt: <span class="font-semibold">${fmt(discAmt)}</span>
    </div>

    <div class="text-sm text-gray-500">
      Net Rate: <span class="font-semibold">${fmt(netRate)}</span>
    </div>
  </div>
` : ""}

<div class="flex items-center gap-2">
    <div class="flex items-center gap-2">
  <button 
    onclick="updateQty(${idx}, ${qty - 1})" 
    class="w-8 h-8 flex items-center justify-center border rounded-full"
  >‚àí</button>

  <div class="w-10 text-center font-semibold">${qty}</div>

  <button 
    onclick="updateQty(${idx}, ${qty + 1})" 
    class="w-8 h-8 flex items-center justify-center border border-gray-400 rounded-full text-xl"
  >+</button>
</div>

  </div>

 


 <div class="font-semibold text-lg text-gray-800">
    ${fmt(total)}
</div>

 
  <button class="text-red-500" onclick="removeItem(${idx})">Delete</button>
`;
cartItemsContainer.appendChild(card);


  });

  // ===== FINAL TOTAL SET =====
  let baseTotal = parseFloat(grandTotal.toFixed(2));
  document.getElementById("cartTotal").innerText = fmt(baseTotal);


  // TAX BLOCK unchanged
  // ===== TAX CALCULATION (FINAL & SAFE) =====
let taxHtml = "";
let serviceAmt = 0;
let cgstAmt = 0;
let sgstAmt = 0;
let igstAmt = 0;
let grandTotalCalc = baseTotal;

if (restaurantTax.taxType === "On Bill") {

  serviceAmt = parseFloat(((baseTotal * restaurantTax.servicePercent) / 100).toFixed(2));
  const taxableAmount = baseTotal + serviceAmt;

  cgstAmt = parseFloat(((taxableAmount * restaurantTax.cgstPercent) / 100).toFixed(2));
  sgstAmt = parseFloat(((taxableAmount * restaurantTax.sgstPercent) / 100).toFixed(2));
  igstAmt = parseFloat(((taxableAmount * restaurantTax.igstPercent) / 100).toFixed(2));

  grandTotalCalc = taxableAmount + cgstAmt + sgstAmt + igstAmt;

  taxHtml = `
    ${serviceAmt ? `<p>Service Charge: ${fmt(serviceAmt)}</p>` : ""}
    ${cgstAmt ? `<p>CGST: ${fmt(cgstAmt)}</p>` : ""}
    ${sgstAmt ? `<p>SGST: ${fmt(sgstAmt)}</p>` : ""}
    ${igstAmt ? `<p>IGST: ${fmt(igstAmt)}</p>` : ""}
  `;
}

else if (restaurantTax.taxType === "On Item") {

  const totalTaxPercent =
    restaurantTax.cgstPercent +
    restaurantTax.sgstPercent +
    restaurantTax.igstPercent;

  const taxableBase = parseFloat(
    (baseTotal * 100 / (100 + totalTaxPercent)).toFixed(2)
  );

  const taxAmount = baseTotal - taxableBase;

  cgstAmt = restaurantTax.cgstPercent ? taxAmount / 2 : 0;
  sgstAmt = restaurantTax.sgstPercent ? taxAmount / 2 : 0;
  igstAmt = restaurantTax.igstPercent ? taxAmount : 0;

  grandTotalCalc = baseTotal; // tax included price

  taxHtml = `
    <p>Taxable Amount: ${fmt(taxableBase)}</p>
    ${cgstAmt ? `<p>CGST: ${fmt(cgstAmt)}</p>` : ""}
    ${sgstAmt ? `<p>SGST: ${fmt(sgstAmt)}</p>` : ""}
    ${igstAmt ? `<p>IGST: ${fmt(igstAmt)}</p>` : ""}
  `;
}

const taxSummaryEl = document.getElementById("taxSummary");
if (taxSummaryEl) taxSummaryEl.innerHTML = taxHtml;

  const d = window._drawerTotals || {};

window.cartSummary = {
  // ===== ITEMS =====
  items: cart,
  itemsSubtotal: d.baseTotal || baseTotal,

  // üî• EXACT drawer discount (Offer / Reward / Paid sab yahin aa chuka)
  couponAmount: d.offerDiscount || 0,
  signupDiscount: d.signupDiscount || 0,

  totalDiscount:
    Number(d.offerDiscount || 0) +
    Number(d.signupDiscount || 0),

  // ===== CHARGES =====
  serviceCharge: d.serviceAmt || 0,
  deliveryCharge: Number(window.deliveryCharge || 0),

  taxTotal:
    Number(d.cgstAmt || 0) +
    Number(d.sgstAmt || 0) +
    Number(d.igstAmt || 0),

  // ===== FINAL PAYABLE (DRAWER GRAND TOTAL) =====
  netPayable: d.grandTotal || baseTotal
};


const checkoutModal = document.getElementById("checkoutModal");
if (checkoutModal && checkoutModal.style.display === "flex") {
  updateCheckoutInvoice();
}

  updateCartBadge();
  // üîí Checkout button state must always follow cart transaction state
const slot = document.getElementById("drawerCheckoutSlot");
if (!slot) return;

slot.innerHTML = `
  <button id="checkoutBtn"
    onclick="openCheckout()"
    class="mt-4 w-full text-white font-semibold py-2 rounded-lg
    ${window._cartUpdating
      ? "bg-gray-400 cursor-not-allowed opacity-60"
      : "bg-red-500 hover:bg-red-600"}"
    ${window._cartUpdating ? "disabled" : ""}>
    ${window._cartUpdating ? "Updating cart‚Ä¶" : "Checkout"}
  </button>
`;


}



async function updateQty(index, newQty) {

  console.log("üü° updateQty CALLED", { index, newQty });

  // üîí TRANSACTION START
  window._cartUpdating = true;
  window._cartLockStart = Date.now();

  syncCheckoutButton?.();
  renderCart();

  if (blockRender) {
    console.warn("‚õî blockRender = true");
    return;
  }

  // 1 ‚Äî Validate qty
  newQty = Number(newQty);
  if (isNaN(newQty) || newQty < 1) newQty = 1;

  // ‚≠ê Remove onetime / regular coupon if qty changes
  if (selectedCoupon && (selectedCoupon.type === "onetime" || selectedCoupon.type === "regular")) {
    selectedCoupon = null;
    alreadyAppliedCouponId = "";
    showCouponError("Coupon removed because cart quantity changed. Please apply again.");
    const appliedBox = document.getElementById("bestOfferApplied");
    if (appliedBox) appliedBox.style.display = "none";
  }

  // 2 ‚Äî Update cart
  cart[index].qty = newQty;

  // 3 ‚Äî Save to localStorage for guests
  if (!isLoggedIn()) {
    localStorage.setItem("guestCart", JSON.stringify(cart));
  }

  // 4 ‚Äî Instant UI refresh
  renderCart();
  updateCartBadge();

  // 5 ‚Äî Backend save
  try {
    console.log("üì° saveCartToBackend START");
    window._cartSavePromise = saveCartToBackend();
    await window._cartSavePromise;
    console.log("‚úÖ saveCartToBackend DONE");
  }
  finally {

    // üîì ENSURE MINIMUM LOCK TIME
    const elapsed = Date.now() - window._cartLockStart;
    const MIN_LOCK = 400;

    const unlock = () => {
      console.log("üîì UNLOCK checkout");
      window._cartUpdating = false;
      syncCheckoutButton?.();
      renderCart();
    };

    if (elapsed < MIN_LOCK) {
      setTimeout(unlock, MIN_LOCK - elapsed);
    } else {
      unlock();
    }
  }
}

function loadPrimaryAddress() {
  // Logged-in users only
  if (!isLoggedIn()) return;

  const mobile = localStorage.getItem("mobile");
  if (!mobile) return;

  const orderType = document.getElementById("orderType")?.value;

  // Only apply primary address for Home Delivery
  if (orderType !== "Home Delivery") return;

  const addressField = document.getElementById("address");
  const addressWrapper = document.getElementById("addressWrapper");
  if (!addressField || !addressWrapper) return;

  // Show wrapper
  addressWrapper.style.display = "block";

  // Fetch user profile
  apiGet("getUserProfile", { mobile })
    .then(res => {
      if (res.success && res.address) {
        addressField.value = res.address.trim();
      }
    })
    .catch(err => console.error("loadPrimaryAddress error:", err));
}

async function loadSavedAddresses() {
  const mobile = localStorage.getItem("userMobile");

  if (!mobile) {
    return {
      primaryObj: null,
      multiObjList: [],
      hasMulti: false
    };
  }

  const overlay = document.getElementById("loadingOverlay");

  try {
    if (overlay) overlay.style.display = "flex";

    // -------------------------------
    // 1Ô∏è‚É£ GET PRIMARY (user sheet)
    // -------------------------------
    const userRes = await fetch(
      `https://script.google.com/macros/s/AKfycbz8B-nwXivGHzKgcWT8zTvS4sAWG6dKfsDh8rsn29CGXCeIxxeNJ9NaPcL03cQBGHEf/exec?action=getUserByMobile&mobile=${mobile}`
    );
    const user = await userRes.json();

    let primaryObj = null;

    if (user?.address) {
      primaryObj = {
        address: user.address,
        pincode: user.pincode || "",
        city: user.city || "",
        state: user.state || "",
        type: "primary"
      };
    }

    // -------------------------------
    // 2Ô∏è‚É£ GET MULTI_ADD (OBJECT FORMAT)
    // -------------------------------
    const multiRes = await fetch(
      `https://script.google.com/macros/s/AKfycbz8B-nwXivGHzKgcWT8zTvS4sAWG6dKfsDh8rsn29CGXCeIxxeNJ9NaPcL03cQBGHEf/exec?action=getMultiAddress&mobile=${mobile}`
    );
    const multi = await multiRes.json();

    // multi.addresses is ALREADY object array
    const multiObjList = Array.isArray(multi?.addresses)
      ? multi.addresses.map(a => ({
          address: a.address || "",
          pincode: a.pincode || "",
          city: a.city || "",
          state: a.state || "",
          type: "multi"
        }))
      : [];

    return {
      primaryObj,
      multiObjList,
      hasMulti: multiObjList.length > 0
    };
  }
  catch (err) {
    console.error("Address Load Error:", err);
    return {
      primaryObj: null,
      multiObjList: [],
      hasMulti: false
    };
  }
}

    
document.getElementById("changeAddressBtn").addEventListener("click", async () => {

  const overlay = document.getElementById("loadingOverlay");
  const dropdown = document.getElementById("savedAddressDropdown");
  const ddlBox = document.getElementById("addressSelectContainer");
  const formBox = document.getElementById("newAddressForm");

  // STEP 1 ‚Äî Start overlay
  if (overlay) overlay.style.display = "flex";

  // STEP 2 ‚Äî Reset UI
  dropdown.innerHTML = "";
  ddlBox.classList.add("hidden");
  formBox.classList.add("hidden");

  // STEP 3 ‚Äî Fetch new format addresses
  const data = await loadSavedAddresses();

  // ---------------------------
  // üî∂ CASE 2 ‚Äî No multi_add addresses
  // ---------------------------
  if (!data.hasMulti && !data.primaryObj) {

    // Show new address form directly (same as old code)
    formBox.classList.remove("hidden");

    document.getElementById("newAddressMobile").value =
      localStorage.getItem("userMobile") || "";

    if (overlay) overlay.style.display = "none";
    return;
  }

  // ---------------------------
  // üî∂ CASE 1 ‚Äî We have saved addresses
  // ---------------------------
  ddlBox.classList.remove("hidden");

  // --- Primary address (new object format)
  if (data.primaryObj) {
    const p = data.primaryObj;
    const opt1 = document.createElement("option");
    opt1.value = JSON.stringify(p);   // NEW FORMAT
    opt1.textContent = `Primary: ${p.address}, ${p.pincode}, ${p.city}, ${p.state}`;
    dropdown.appendChild(opt1);
  }

  // --- MultiAdd Addresses (new object format)
  data.multiObjList.forEach((a, index) => {
    const opt = document.createElement("option");
    opt.value = JSON.stringify(a);   // NEW FORMAT
    opt.textContent = `${a.address}, ${a.pincode}, ${a.city}, ${a.state}`;
    dropdown.appendChild(opt);
  });

  // --- Add New Address (same as old)
  const addNew = document.createElement("option");
  addNew.value = "__ADD_NEW__";
  addNew.textContent = "‚ûï Add New Address";
  dropdown.appendChild(addNew);
// ---------------------------
// STEP-5: Auto Default Selection
// ---------------------------

let defaultAddressObj = null;

// 1Ô∏è‚É£ If primary exists ‚Üí select primary automatically
if (data.primaryObj) {
  defaultAddressObj = data.primaryObj;
  dropdown.value = JSON.stringify(data.primaryObj);
}

// 2Ô∏è‚É£ Else if multiAdd available ‚Üí auto-select first address
else if (data.multiObjList.length > 0) {
  defaultAddressObj = data.multiObjList[0];
  dropdown.value = JSON.stringify(data.multiObjList[0]);
}

// 3Ô∏è‚É£ If default address found ‚Üí autofill fields
if (defaultAddressObj) {
  document.getElementById("address").value  = defaultAddressObj.address || "";
  document.getElementById("pincode").value = defaultAddressObj.pincode || "";
  document.getElementById("city").value    = defaultAddressObj.city || "";
  document.getElementById("state").value   = defaultAddressObj.state || "";
}

  // STEP 4 ‚Äî Smooth fade animation
  ddlBox.style.opacity = "0";
  setTimeout(() => {
    ddlBox.style.transition = "opacity 0.25s ease";
    ddlBox.style.opacity = "1";
  }, 10);

  // STEP 5 ‚Äî Hide overlay
  if (overlay) overlay.style.display = "none";
});


document.getElementById("savedAddressDropdown").addEventListener("change", async function () {
  const selected = this.value;

  const formBox = document.getElementById("newAddressForm");
  const addressField = document.getElementById("address");
  const pinField = document.getElementById("pincode");
  const cityField = document.getElementById("city");
  const stateField = document.getElementById("state");

  // Always hide new-form by default
  formBox.classList.add("hidden");

  // 1Ô∏è‚É£ ADD NEW ADDRESS (same as old flow)
  if (selected === "__ADD_NEW__") {
    formBox.classList.remove("hidden");

    document.getElementById("newAddressMobile").value =
      localStorage.getItem("userMobile") || "";

    return;
  }

  // ----------------------------------------
  // 2Ô∏è‚É£ NEW FORMAT: selected is JSON object
  // ----------------------------------------
  let parsed = null;

  try {
    parsed = JSON.parse(selected);   // Works for both Primary & Multi (new format)
  } catch (e) {
    console.error("Invalid JSON address:", selected);
  }

  // If parsed object exists ‚Üí auto-fill 4 fields
  if (parsed && typeof parsed === "object") {
    addressField.value = parsed.address || "";
    pinField.value = parsed.pincode || "";
    cityField.value = parsed.city || "";
    stateField.value = parsed.state || "";
    return;
  }

  // ---------------------------------------------------
  // 3Ô∏è‚É£ BACKWARD-COMPATIBLE MODE (if old format selected)
  // ---------------------------------------------------

  const data = await loadSavedAddresses();

  // OLD Primary
  if (selected === "__PRIMARY__") {
    addressField.value = data.primaryAddress || "";
    return;
  }

  // OLD Multi
  if (selected.startsWith("__MULTI__")) {
    const index = parseInt(selected.replace("__MULTI__", ""));
    const selectedAddress = data.multiAddresses[index] || "";
    addressField.value = selectedAddress;
    return;
  }
});




function closeCheckout() {
  const modal = document.getElementById("checkoutModal");
  if (modal) modal.style.display = "none";

  // üî• Restore scroll
  document.body.style.overflow = "auto";

  // üî• Kill loading overlay if any
  const overlay = document.getElementById("loadingOverlay");
  if (overlay) overlay.style.display = "none";

  // üî• Kill ALL leftover backdrops / overlays
  forceClearOverlays();

  // ‚úÖ EXTRA SAFETY (important)
  document.activeElement && document.activeElement.blur();
}

function deleteCart() {
  showCartOverlay("Clearing cart‚Ä¶");

  cart = [];

  if (!isLoggedIn()) {
    localStorage.removeItem("guestCart");
    renderCart();
    hideCartOverlay();
    return;
  }

  // Logged-in: clear only LOCAL mirror (NEVER delete backend)
  localStorage.setItem("cart", "[]");
  renderCart();

  hideCartOverlay();
}

function removeItem(index) {
 showCartOverlay();

  const item = cart[index];
  if (!item) {
    hideCartOverlay();
    return;
  }

  clearTimeout(deleteDebounce);

  deleteDebounce = setTimeout(() => {

    cart.splice(index, 1);

    // SAVE LOCALLY
    if (!isLoggedIn()) {
      localStorage.setItem("guestCart", JSON.stringify(cart));
    } else {
      
    }

    renderCart();

    // BACKEND SYNC
    if (isLoggedIn()) {
    saveCartToBackend().finally(() => hideCartOverlay());
  } else {
    hideCartOverlay();
  }

  }, 150); // small debounce for delete
updateCartBadge();

}

function onMobileChanged() {
  // üî• HARD RESET
  document.getElementById("orderType").value = "";

  document.getElementById("addressWrapper").style.display = "none";
  document.getElementById("pincodeWrapper").style.display = "none";
  document.getElementById("cityWrapper").style.display    = "none";
  document.getElementById("stateWrapper").style.display   = "none";

  guestPincodeEdited = false;
  guestAutoFilling   = false;
}

 function checkCustomerByMobile() {
  const mobile = document.getElementById("mobile").value.trim();
  const hint = document.getElementById("mobileHint");

  const orderType = document.getElementById("orderType");
  const orderTypeBox = document.getElementById("orderTypeWrapper");

  const nameInput  = document.getElementById("customerName");
  const emailInput = document.getElementById("email");

  const nameWrapper  = nameInput.closest("div");
  const emailWrapper = emailInput.closest("div");

  const addressWrapper = document.getElementById("addressWrapper");
  const pincodeWrapper = document.getElementById("pincodeWrapper");
  const cityWrapper    = document.getElementById("cityWrapper");
  const stateWrapper   = document.getElementById("stateWrapper");

  /* ‚ùå MOBILE < 10 DIGITS */
  if (mobile.length < 10) {

    // üî¥ hint show
    hint.style.display = "block";

    // ‚õî RESET ORDER TYPE
    if (orderType) orderType.value = "";
    if (orderTypeBox) orderTypeBox.style.display = "none";

    // ‚õî CLEAR + HIDE NAME / EMAIL
    nameInput.value  = "";
    emailInput.value = "";

    nameWrapper.style.display  = "none";
    emailWrapper.style.display = "none";

    // ‚õî CLEAR + HIDE ADDRESS BLOCK
    document.getElementById("address").value = "";
    document.getElementById("pincode").value = "";
    document.getElementById("city").value    = "";
    document.getElementById("state").value   = "";

    addressWrapper.style.display = "none";
    pincodeWrapper.style.display = "none";
    cityWrapper.style.display    = "none";
    stateWrapper.style.display   = "none";

    return;
  }

  /* ‚úÖ MOBILE = 10 DIGITS */
  hint.style.display = "none";

  // show only order type
  if (orderTypeBox) orderTypeBox.style.display = "block";
}


let lastLookupMobile = "";
let lastLookupOrderType = "";

let addressLookupRunning = false;

let guestPincodeEdited = false;
let guestAutoFilling  = false;
    
function toggleAddressField() {
console.log("toggleAddressField fired");

  const mobile = document.getElementById("mobile").value.trim();
  const orderType = document.getElementById("orderType").value;

if (!/^[0-9]{10}$/.test(mobile)) return;
if (!orderType) return;

 
  // --- 2) Base references ---
  const nameField = document.getElementById("customerName");
  const emailField = document.getElementById("email");
  const addressField = document.getElementById("address");

  const addressWrapper = document.getElementById("addressWrapper");
  const paymentField = document.getElementById("paymentMethod");
  const overlay = document.getElementById("loadingOverlay");
  const orderSelect = document.getElementById("orderType");
  const changeBtn = document.getElementById("changeAddressBtn");

  // NEW FIELDS
  const pincodeField = document.getElementById("pincode");
  const cityField    = document.getElementById("city");
  const stateField   = document.getElementById("state");

  const pincodeWrapper = document.getElementById("pincodeWrapper");
  const cityWrapper    = document.getElementById("cityWrapper");
  const stateWrapper   = document.getElementById("stateWrapper");

  if (!nameField || !emailField || !addressField) return;

  // --- 3) Make name + email always visible ---
  nameField.closest("div").style.display = "block";
  emailField.closest("div").style.display = "block";
  paymentField.style.display = "block";
console.log("overlay about to show");   //
  // --- 4) Always show overlay (both cases) ---
  overlay.style.display = "flex";
  orderSelect.disabled = true;

  // ==========================================================
  //                LOGGED-IN USER LOGIC
  // ==========================================================
  if (isLoggedIn()) {

    nameField.readOnly = true;
    emailField.readOnly = true;
    addressField.readOnly = true;

    // Fetch everything from USER SHEET
    apiGet("getUserProfile", { mobile })
      .then(res => {
        if (res.success) {

          // Fill all fields FROM USER SHEET
          nameField.value = res.name || "";
          emailField.value = res.email || "";
          addressField.value = res.address || "";

          pincodeField.value = res.pincode || "";
          cityField.value    = res.city || "";
          stateField.value   = res.state || "";
          // üîë Location readiness (lat/lng)
window._deliveryLocationReady =
  !!(res.lat && res.lng);
// üó∫Ô∏è If GPS already saved, show map preview also
if (res.lat && res.lng) {
  const mapBox = document.getElementById("mapPreviewBox");
  const mapFrame = document.getElementById("mapPreviewFrame");

  if (mapBox && mapFrame) {
    mapBox.classList.remove("hidden");
    mapFrame.src = `https://maps.google.com/maps?q=${res.lat},${res.lng}&z=16&output=embed`;
  }
}
// üî• If location already exists in user sheet, auto-validate it
if (res.lat && res.lng) {
  apiPost("checkDeliveryDistance", { mobile })
    .then(dist => {
      console.log("üìç AUTO DIST CHECK:", dist);

      const row  = document.getElementById("locationStatusRow");
      const txt  = document.getElementById("locationStatusText");
      const icon = document.getElementById("locationStatusIcon");

      if (!row || !txt || !icon) return;

      if (dist.success && dist.allowed === true) {
        // user is inside delivery radius
        window._deliveryLocationReady = true;

        row.classList.remove("border-red-400", "bg-red-50", "text-red-700");
        row.classList.add("border-green-400", "bg-green-50", "text-green-700");
        icon.innerText = "üìç";
        txt.innerText  = `Location verified (${dist.distanceKm} km)`;
row.dataset.autoChecked = "1";

      } else {
        // location exists but outside radius
        window._deliveryLocationReady = false;

        row.classList.remove("border-green-400", "bg-green-50", "text-green-700");
        row.classList.add("border-red-400", "bg-red-50", "text-red-700");
        icon.innerText = "‚ö†Ô∏è";
        txt.innerText  = dist.error || 
          `Outside delivery radius (${dist.distanceKm} km, limit ${dist.radiusKm} km)`;
        row.dataset.autoChecked = "1";

      }

      updatePlaceOrderLockByLocation();
    })
    .catch(err => {
      console.error("Distance auto check failed", err);
    });
}


        }
      })
      .finally(() => {

        // UI rules based on order type
        if (orderType === "Home Delivery") {
          // Address + 3 other fields visible
          addressWrapper.style.display = "block";
          pincodeWrapper.style.display = "block";
          cityWrapper.style.display    = "block";
          stateWrapper.style.display   = "block";
          changeBtn?.classList.remove("hidden");

          addressField.required = true;
          updatePlaceOrderLockByLocation();
        } else {
          // Takeaway / Dine-In ‚Üí hide address + pincode/city/state
          addressWrapper.style.display = "none";
          pincodeWrapper.style.display = "none";
          cityWrapper.style.display    = "none";
          stateWrapper.style.display   = "none";

          changeBtn?.classList.add("hidden");

          addressField.required = false;
          updatePlaceOrderLockByLocation();
        }

        overlay.style.display = "none";
        orderSelect.disabled = false;

      });

    return; // STOP HERE ‚Äî DO NOT TOUCH GUEST LOGIC
  }


  // ==========================================================
  //                GUEST USER LOGIC (UNTOUCHED)
  // ==========================================================


  nameField.readOnly = false;
  emailField.readOnly = false;
  addressField.readOnly = false;


  if (addressLookupRunning) return;
addressLookupRunning = true;

  console.log("üìû Guest lookup API CALL, mobile =", mobile);

apiGet("getCustomerDetailsByMobile", { mobile })
  .then(rows => {
    console.log("üì¶ Guest lookup RAW rows =", rows);

    let orders = Array.isArray(rows) ? rows : [];
    console.log("üßæ Orders array length =", orders.length, orders);

     if (orders.length === 0) {
  nameField.value = "";
  emailField.value = "";

  addressField.value = "";
  pincodeField.value = "";
  cityField.value    = "";
  stateField.value   = "";

if (orderType === "Home Delivery") {
  addressWrapper.style.display = "block";
  pincodeWrapper.style.display = "block";
  cityWrapper.style.display    = "block";
  stateWrapper.style.display   = "block";

  addressField.required = true;
  addressField.readOnly = false;
  updatePlaceOrderLockByLocation();

} else {
  addressWrapper.style.display = "none";
  pincodeWrapper.style.display = "none";
  cityWrapper.style.display    = "none";
  stateWrapper.style.display   = "none";

  addressField.value = "";
  pincodeField.value = "";
  cityField.value    = "";
  stateField.value   = "";

  addressField.required = false;
  updatePlaceOrderLockByLocation();

}

  return;
}


      // ----- Pick latest row -----
      let latest = orders.reduce((max, row) =>
        row.rowNumber > max.rowNumber ? row : max
      );

      // Fill name/email
      nameField.value = latest.name || "";
      emailField.value = latest.email || "";

      // ----- Latest HD Address -----
      let latestHD = "";
let latestPin = "";
let latestCity = "";
let latestState = "";

    
      for (let i = orders.length - 1; i >= 0; i--) {
        const row = orders[i];
        const hd =
          row.Address?.trim() ||
          row.address?.trim() ||
          row.Address1?.trim() ||
          row.Address2?.trim() ||
          "";

        const type = String(row.orderType || "").trim().toLowerCase();

if (type === "home delivery" && hd !== "") {
  latestHD    = hd;
  latestPin   = row.pincode || "";
  latestCity  = row.city || "";
  latestState = row.state || "";
  break;
}


      }
console.log("üè† Latest Home Delivery Address =", latestHD);

      // ----- Show/hide based on order type -----
     if (orderType === "Home Delivery") {
  addressWrapper.style.display = "block";
  pincodeWrapper.style.display = "block";
  cityWrapper.style.display    = "block";
  stateWrapper.style.display   = "block";

  addressField.required = true;
  addressField.readOnly = false;
pincodeField.readOnly = false;
  cityField.readOnly    = false;
  stateField.readOnly   = false;
       addressField.classList.remove("cursor-not-allowed", "bg-gray-100");
pincodeField.classList.remove("cursor-not-allowed", "bg-gray-100");
cityField.classList.remove("cursor-not-allowed", "bg-gray-100");
stateField.classList.remove("cursor-not-allowed", "bg-gray-100");

       
  guestAutoFilling = true;
  addressField.value = latestHD || "";
  pincodeField.value = latestPin || "";
  cityField.value    = latestCity || "";
  stateField.value   = latestState || "";
  guestAutoFilling = false;
  guestPincodeEdited = false;
} else {
  addressWrapper.style.display = "none";
  pincodeWrapper.style.display = "none";
  cityWrapper.style.display    = "none";
  stateWrapper.style.display   = "none";

  addressField.value = "";
  pincodeField.value = "";
  cityField.value    = "";
  stateField.value   = "";

  addressField.required = false;
}

    })
    .catch(err => {
      console.error(err);
      alert("Error loading customer details.");
    })
    .finally(() => {
      addressLookupRunning = false;
      overlay.style.display = "none";
      orderSelect.disabled = false;
    });

}
const pincodeField = document.getElementById("pincode");
pincodeField.addEventListener("input", () => {
  console.log("‚úÖ PINCODE INPUT EVENT FIRED");
  if (guestAutoFilling) return;     // autofill ignore
  if (isLoggedIn()) return;          // safety: login ignore
if (pincodeField.readOnly) return;
  guestPincodeEdited = true;

  const pin = pincodeField.value.trim();
  if (pin.length === 6) {
    onCheckoutPincodeChange();

  }
});

    
function normalizeCartForOrder(cart) {
  return cart.map(item => {
    const qty = Number(item.qty || 1);
    const rate = Number(item.rate || item.price || 0);
    const discPercent = Number(item.discPercent || 0);

    const discAmt = +(rate * discPercent / 100).toFixed(2);
    const netRate = +(rate - discAmt).toFixed(2);
    const netAmt  = +(netRate * qty).toFixed(2);

    return {
      itemId: item.itemId || "",
      variantId: item.variantId || "",
      name: item.name,
      unit: item.unit || "",
      qty: qty,
      rate: rate,
      discPercent: discPercent,
      discAmt: discAmt,
      netAmt: netAmt,
      total: netAmt,          // ‚≠ê IMPORTANT
      image: item.image || ""
    };
  });
}

function resetMenuCartUI() {
  console.log("‚úÖ resetMenuCartUI called");

  // sab menu + buttons pakdo
  document.querySelectorAll("button[onclick^='menuPlus']").forEach(plusBtn => {

    // minus button (previous sibling)
    const minusBtn = plusBtn.previousElementSibling;

    // qty text node (minus aur plus ke beech)
    const qtyNode = plusBtn.previousSibling;

    // qty reset
    if (qtyNode && qtyNode.nodeType === Node.TEXT_NODE) {
      qtyNode.textContent = "0";
    }

    // minus hide
    if (minusBtn && minusBtn.tagName === "BUTTON") {
      minusBtn.classList.add("hidden");
    }
  });
}

function resetPlaceOrderBtn() {
  const btn = document.querySelector(
    '#checkoutForm button[onclick="placeOrder()"]'
  );

  if (btn) {
    btn.disabled = false;
    btn.innerText = btn.dataset.originalText || "Place Order";
  }

  window._orderLock = false;
}

function disablePlaceOrder() {
  const btn = document.getElementById("placeOrderBtn");
  if (!btn) return;
  btn.disabled = true;
  btn.classList.add("opacity-50", "cursor-not-allowed");
}

function enablePlaceOrder() {
  const btn = document.getElementById("placeOrderBtn");
  if (!btn) return;
  btn.disabled = false;
  btn.classList.remove("opacity-50", "cursor-not-allowed");
}

async function canProceedPlaceOrder() {
  const paymentError = document.getElementById("paymentError");

  // helper functions (same UX everywhere)
  const showError = (msg) => {
    if (!paymentError) return;
    paymentError.innerText = msg;
    paymentError.classList.remove("hidden", "text-green-600");
    paymentError.classList.add("text-red-600");
     disablePlaceOrder(); 
  };

  const showSuccess = (msg) => {
    if (!paymentError) return;
    paymentError.innerText = msg;
    paymentError.classList.remove("hidden", "text-red-600");
    paymentError.classList.add("text-green-600");
     enablePlaceOrder();
  };

  try {
    window.orderEligibility = { allowed: false, extraCharge: 0, chargeType: "" };
  disablePlaceOrder();
  if (paymentError) paymentError.classList.add("hidden");

    const orderType = document.getElementById("orderType")?.value.trim();

  const amount = Number(window.cartSummary?.itemsSubtotal || 0);


    // üî¥ GUARD 1: Order Type mandatory
    if (!orderType) {
      showError("‚ö†Ô∏è Please select Order Type");
      return false;
    }

    // üî¥ GUARD 2: Cart must not be empty
    if (amount <= 0) {
      showError("‚ö†Ô∏è Cart is empty");
      return false;
    }

    // üî¥ GUARD 3: Backend eligibility (final authority)
    const mobile = document.getElementById("mobile")?.value.trim();

const res = await apiPost("checkOrderEligibility", {
  orderType,
  orderAmount: amount,
  mobile
});

    console.log("üß† FULL RES KEYS:", Object.keys(res));
console.log("üß† RES JSON:", JSON.stringify(res, null, 2));

console.log("üßæ FRONTEND ‚Üí BACKEND PAYLOAD:", {
  orderType,
  orderAmount: amount
});

console.log("üß™ BACKEND RESPONSE:", res);

    console.log("üß™ ELIGIBILITY CHECK:", res);
// üìç Location based delivery errors ‚Üí show under location box
if (
  res?.reason === "OUT_OF_DELIVERY_RADIUS" ||
  res?.reason === "LOCATION_NOT_SET"
) {
  const row = document.getElementById("locationStatusRow");
  const txt = document.getElementById("locationStatusText");

  if (row && txt) {
    row.classList.remove("hidden");
    row.classList.remove("border-green-400", "bg-green-50", "text-green-700");
    row.classList.add("border-red-400", "bg-red-50", "text-red-700");

    txt.innerText = res.message || "Delivery not available for this location";
  }

  // also show small message near payment
  showError(res.message || "Delivery not available for this location");
  return false;
}

    if (!res || res.allowed !== true) {
      showError(res?.message || "Order is not allowed at this time");
      return false;
    }
window.orderEligibility = {
  allowed: true,
  extraCharge: Number(res.extraCharge || 0),
  chargeType: res.chargeType || ""
};

    // ‚úÖ PASSED ALL CHECKS
    showSuccess("‚úÖ Eligible to place order");
    return true;

  } catch (err) {
    console.error("Eligibility check failed", err);
    showError("‚ö†Ô∏è System error. Please try again.");
    return false;
  }
}

// ==================================
// STEP-3: Live eligibility on OrderType change
// ==================================
async function recheckEligibilityOnOrderTypeChange() {
  const ok = await canProceedPlaceOrder();
  if (ok) {
    updateCheckoutInvoice(); // üî• eligibility set hone ke BAAD
  }
}

    
async function placeOrder() {
  console.log("üü¢ placeOrder() called");
console.log("üîí orderLock before:", window._orderLock);

  console.log("---- DEBUG START ----");
  console.log("getCart() returns:", getCart());
  console.log("global cart variable:", cart);

if (window._orderLock) return;
window._orderLock = true;

// üî• STEP-1: BUTTON IMMEDIATELY DISABLE + TEXT CHANGE
const placeOrderBtn = document.getElementById("placeOrderBtn");
if (placeOrderBtn) {
  placeOrderBtn.disabled = true;
  placeOrderBtn.dataset.originalText = placeOrderBtn.innerText;
  placeOrderBtn.innerText = "Processing...";
}

// üîí STEP-2: NOW eligibility check (slow ho sakta hai)
if (!(await canProceedPlaceOrder())) {
  window._orderLock = false;
  
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) overlay.style.display = "none";
  resetPlaceOrderBtn();
  return;
}

  const customerName = document.getElementById('customerName').value.trim();
  const email = document.getElementById('email').value.trim();
  const mobile = document.getElementById('mobile').value.trim();
  const orderType = document.getElementById('orderType').value;
  const address = document.getElementById('address').value.trim();
  const paymentMethod = document.getElementById('paymentMethod').value;

  const pincode = document.getElementById("pincode")?.value.trim() || "";
  const city    = document.getElementById("city")?.value.trim() || "";
  const state   = document.getElementById("state")?.value.trim() || "";

const userType = isUserLoggedIn() ? "logged" : "guest";


  // ----------------------------------
// AUTO CUSTOMER LOOKUP (ONCE)
// mobile + payment ready
// ----------------------------------


// ‚úÖ OPTION A: Address sirf Home Delivery me hi save hoga
const finalAddress =
  orderType === "Home Delivery" ? address : "";
// üîí BLOCK Home Delivery if GPS location not saved
if (orderType === "Home Delivery" && !window._deliveryLocationReady) {
  alert("üìç Please set your delivery location to continue.");
  resetPlaceOrderBtn();
  return;
}

  if (!orderType) {
  alert("Please select Order Type");
  resetPlaceOrderBtn();

  return;
}
const paymentError = document.getElementById("paymentError");

if (!paymentMethod) {
  if (paymentError) {
    paymentError.innerText = "‚ö†Ô∏è Please select a payment method";
    paymentError.classList.remove("hidden");
  }

  const btn = document.getElementById("placeOrderBtn");
  btn.classList.add("payment-attention");
  setTimeout(() => btn.classList.remove("payment-attention"), 4000);

  resetPlaceOrderBtn();

  return;
}

// clear error when valid
if (paymentError) {
  paymentError.innerText = "";
  paymentError.classList.add("hidden");
}



  // ‚ùå BLOCK ORDER IF MOBILE INVALID (NO ALERT)
if (!/^[0-9]{10}$/.test(mobile)) {
  const hint = document.getElementById("mobileHint");
  if (hint) {
    hint.style.display = "block";
  }

  // also hide dependent fields safely
  const orderTypeBox = document.getElementById("orderTypeWrapper");
  if (orderTypeBox) orderTypeBox.style.display = "none";

  resetPlaceOrderBtn();
  return;
}

// üîí FINAL ONETIME COUPON LOCK (PLACE ORDER LEVEL)
if (selectedCoupon && selectedCoupon.type === "onetime") {

  const check = await apiGet("hasUsedCoupon", {
    mobile,
    couponId: selectedCoupon.id
  });

  console.log("üîê PLACE ORDER COUPON CHECK:", check);

  // ‚ùó ONLY THIS CONDITION MATTERS
  if (check && check.success === true) {
    const couponLabel =
  selectedCoupon.text
    ? `${selectedCoupon.text} (${selectedCoupon.id})`
    : selectedCoupon.id;
    alert(
  `‚ùå The coupon "${couponLabel}" has already been used.\n\n` +
  `Please go back and remove this coupon to continue.`
);
   resetPlaceOrderBtn();
    return; // ‚õî HARD STOP
  }
}

  // -----------------------------
// FINAL GUEST VALIDATION (ORDER FLOW BASED)
// -----------------------------
if (orderType) {

  // NAME mandatory once orderType selected
  if (!customerName) {
    console.log("‚ùå Name validation hit", customerName);

  const nameInput = document.getElementById("customerName");
  const nameError = document.getElementById("nameError");

  // üîë force show row
  if (nameInput?.parentElement) {
    nameInput.parentElement.style.display = "block";
  }

  if (nameError) {
    nameError.innerText = "‚ö†Ô∏è Name is required";
    nameError.classList.remove("hidden");
  }

  resetPlaceOrderBtn();
  return;
}

  // EMAIL mandatory once orderType selected
  if (!email) {
    const emailError = document.getElementById("emailError");
    if (emailError) {
      emailError.innerText = "‚ö†Ô∏è Email is required";
      emailError.classList.remove("hidden");
    }
    resetPlaceOrderBtn();
    return;
  }

  // EMAIL format validation
  if (!/^\S+@\S+\.\S+$/.test(email)) {
    const emailError = document.getElementById("emailError");
    if (emailError) {
      emailError.innerText = "‚ö†Ô∏è Enter a valid email address";
      emailError.classList.remove("hidden");
    }
    resetPlaceOrderBtn();
    console.log("‚Ü©Ô∏è returning due to name validation");

    return;
  }
}

// -----------------------------
// STEP 2: Guest user ‚Äì visible fields mandatory
// -----------------------------


  const addressError = document.getElementById("addressError");

if (orderType === "Home Delivery" && !address) {
  if (addressError) {
    addressError.innerText = "‚ö†Ô∏è Please enter delivery address";
    addressError.classList.remove("hidden");
  }
 resetPlaceOrderBtn();

  return;
} else if (addressError) {
  addressError.innerText = "";
  addressError.classList.add("hidden");
}
  

    const overlay = document.getElementById('loadingOverlay');
  window._orderSubmitting = true; // ‚úÖ ADD THIS
  overlay.innerText = "Processing your order... Please wait...";
  overlay.style.display = "flex";

// clear error if valid

  const inv = window._checkoutInvoice;

if (!inv) {
  alert("Invoice not ready. Please reopen checkout.");
  resetPlaceOrderBtn();
  return;
}

// üîí cart & totals checkout invoice se aayenge
const safeCartItems = inv.items.map(i => ({ ...i }));


  const orderData = {
    customerName,
    email,
    mobile,
    orderType,
    address: finalAddress,
    cartItems: normalizeCartForOrder(safeCartItems),


    baseTotal: Number(inv.itemsSubtotal || 0),

offerDiscount: Number(inv.couponAmount || 0),
signupDiscount: Number(inv.signupDiscount || 0),
payableAfterDiscount: Number(
  (inv.taxableAmount || 0) -
  (inv.couponAmount || inv.signupDiscount || 0)
),

serviceAmt: Number(inv.serviceCharge || 0),
taxableAmount: Number(inv.taxableAmount || 0),

cgstAmt: Number(inv.cgst || 0),
sgstAmt: Number(inv.sgst || 0),
igstAmt: Number(inv.igst || 0),

grandTotal: Number(inv.netPayable || 0),


    paymentMethod,

    couponId: selectedCoupon ? selectedCoupon.id : "",
    couponType: selectedCoupon ? selectedCoupon.type : "",

couponDiscount: Number(inv.couponAmount || inv.signupDiscount || 0),

    
    pincode,
  city,
  state,
    userType
  };
  console.log("üë§ userType:", userType);

console.log("üöÄ ORDER PAYLOAD TO BACKEND:", JSON.stringify(orderData, null, 2));

document.querySelectorAll('#checkoutForm input, #checkoutForm select')
  .forEach(el => el.disabled = true);

  apiPost("placeOrder", orderData)
    .then(res => {
      if (res.success) {

        // üîë STEP-1: RESET COUPON STATE AFTER SUCCESS
selectedCoupon = null;
alreadyAppliedCouponId = "";
window._couponLocked = false;
window._appliedCouponType = null;
window._appliedCouponId = null;
window._appliedCouponDiscount = 0;        
// üî¥ RESET REWARD STATE (IMPORTANT)
window._rewardApplied = false;
window._rewardDiscount = 0;
window._rewardId = null;

// Hide reward UI
document.getElementById("rewardBox")?.classList.add("hidden");
document.getElementById("rewardText") && (document.getElementById("rewardText").innerText = "");
document.getElementById("rewardStatus")?.classList.add("hidden");

           overlay.style.display = "none";

        alert(
          `Order placed successfully!\nYour Order Number: ${res.orderNumber}\n\n${res.message}`
        );

        // ‚úÖ SAME cart reference ko empty karo
        // 1Ô∏è‚É£ clear global cart
cart.length = 0;

// 2Ô∏è‚É£ clear storage (guest + logged in safe)
localStorage.removeItem("cart");
localStorage.removeItem("guestCart");
  //  FIX: signup discount one-time only
  window.signupDiscount = 0;
  localStorage.removeItem("signupDiscount");
// 3Ô∏è‚É£ reset drawer totals
window._drawerTotals = null;

// 4Ô∏è‚É£ UI refresh
renderCart();
try { refreshCouponMotivationHint(); } catch(e){}
        closeCheckout();
        renderMenu(window.menuItems || []);


      setTimeout(async () => {
  await fetchOffersFromBackend();

  // üîë FORCE coupon UI refresh AFTER unlock
  try {
    renderAvailableUserCoupons(window.liveOffers || []);
  } catch (e) {}
}, 0);

        // ‚úÖ FINAL HARD RESET ‚Äì MUST BE LAST
setTimeout(() => {
  window.location.href = window.location.pathname + "?r=" + Date.now();
}, 300);

      } else {
        alert(res.message || "Order failed.");
      }
    })
    .catch(err => {
      console.error("Order error:", err);
      alert("Error placing order. Please try again.");
    })
    .finally(() => {
      window._orderLock = false;
      overlay.style.display = "none";
      document.querySelectorAll('#checkoutForm input, #checkoutForm select, #checkoutForm button')
        .forEach(el => el.disabled = false);
  window._orderSubmitting = false; // 
      resetPlaceOrderBtn();
    });
}
  

// -----------------------------
// MOBILE INPUT CONTROL (10 digit, no starting 0)
// -----------------------------
const mobileInput = document.getElementById("mobile");

if (mobileInput) {
  mobileInput.addEventListener("input", () => {
    // allow only digits
    let val = mobileInput.value.replace(/\D/g, "");

    // remove starting zeros
    val = val.replace(/^0+/, "");

    // limit to 10 digits
    if (val.length > 10) {
      val = val.slice(0, 10);
    }

    mobileInput.value = val;
     // STEP 1a: hide mobile error while typing
    
      // ‚úÖ IMPORTANT: re-trigger logic after auto-fix
    if (mobileInput._internalTrigger) return;
mobileInput._internalTrigger = true;
mobileInput.dispatchEvent(new Event("input"));
mobileInput._internalTrigger = false;

  });
}

// -----------------------------
// NAME INPUT ‚Äì STEP 1b
// hide name error while typing
// -----------------------------
const nameInput = document.getElementById("customerName");

if (nameInput) {
  nameInput.addEventListener("input", () => {
    const nameError = document.getElementById("nameError");
    if (nameError) {
      nameError.innerText = "";
      nameError.classList.add("hidden");
    }
  });
}

// -----------------------------
// EMAIL INPUT ‚Äì STEP 3b
// hide email error while typing
// -----------------------------
const emailInput = document.getElementById("email");

if (emailInput) {
  emailInput.addEventListener("input", () => {
    const emailError = document.getElementById("emailError");
    if (emailError) {
      emailError.innerText = "";
      emailError.classList.add("hidden");
    }
  });
}


function filterMenu() {
  const text = document.getElementById("menuSearch").value.toLowerCase();
  const selected = document.getElementById("categoryFilter").value; // note: keep original case (Title Case)

  // priority list - same as renderMenu/populateCategoryDropdown
  const categoryPriority = [
    "starters",
    "snacks",
    "drinks",
    "mocktails",
    "cocktails",
    "main course",
    "sweets",
    "desserts"
  ];

  // Step 1: canonical category detect (PASS priority list)
  let filtered = menuItems.map(i => ({
    ...i,
    canonical: canonicalCategory(i.category, categoryPriority).toLowerCase()
  }));

  // Step 2: Apply category filter (if selected not empty)
  if (selected && selected.trim() !== "") {
    const selLower = selected.toLowerCase();
    filtered = filtered.filter(i => i.canonical === selLower);
  }

  // Step 3: Apply text filter
  if (text.trim() !== "") {
    const q = text.trim();
    filtered = filtered.filter(i =>
      (String(i.name || "").toLowerCase().includes(q)) ||
      (i.description && String(i.description).toLowerCase().includes(q))
    );
  }

  // If no filter ? show full grouped menu (reuse renderMenu)
  if ((!selected || selected === "") && text.trim() === "") {
    renderMenu(menuItems);
    return;
  }

  const menuDiv = document.getElementById("menu");
  menuDiv.innerHTML = "";

  if (filtered.length === 0) {
    menuDiv.innerHTML = "<p style='padding:10px;'>No items found.</p>";
    return;
  }

  // Step 4: Group filtered results by canonical category (preserve ordering by priority)
  const groups = {};
  filtered.forEach(item => {
    const cat = item.canonical || "Other";
    if (!groups[cat]) groups[cat] = [];
    groups[cat].push(item);
  });

  // Build order: priority first, then alphabetic
  const groupKeys = Object.keys(groups);
  groupKeys.sort((a,b) => {
    const ai = categoryPriority.indexOf(a);
    const bi = categoryPriority.indexOf(b);
    if (ai !== -1 && bi !== -1) return ai - bi;
    if (ai !== -1) return -1;
    if (bi !== -1) return 1;
    return a.localeCompare(b);
  });

  // Step 5: Render groups using buildMenuCardHTML + activateVariantSelector
  groupKeys.forEach(cat => {
    const heading = document.createElement("h2");
    heading.classList.add("slideIn");
    // Title case heading
    heading.innerHTML = cat.replace(/\b\w/g, c => c.toUpperCase());
    heading.style.margin = "10px 0 5px";
    heading.style.padding = "10px";
    heading.style.background = "#ff6347";
    heading.style.color = "white";
    heading.style.borderRadius = "6px";
    heading.style.gridColumn = "1 / -1";
    menuDiv.appendChild(heading);

    groups[cat].forEach(item => {
      const div = document.createElement("div");
      div.className = "menu-item fadeIn";

      // Use the same card builder as the main view (handles Single / Multi)
      div.innerHTML = buildMenuCardHTML(item);
      menuDiv.appendChild(div);

      // Activate variant selector if item is multi (so radio -> button enabling works)
      try {
        activateVariantSelector(item);
      } catch (e) {
        // fail-safe: don't break UI on JS errors
        console.error("activateVariantSelector error:", e);
      }
    });
  });
}


  </script>
<div id="loginProgressOverlay"
     class="fixed inset-0 bg-black bg-opacity-40 z-[10000] hidden 
            flex items-center justify-center text-white text-xl font-semibold">
  Login in progress‚Ä¶
</div>


  



<!-- LOGIN OVERLAY (NEW TAILWIND VERSION) -->
<div id="loginModal"
  class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center">

    <div class="bg-white w-11/12 max-w-sm rounded-xl p-6 shadow-xl relative 
              flex flex-col gap-4">


    <!-- Close -->
    <button onclick="closeLogin()"
      class="absolute top-3 right-3 text-gray-600 text-2xl font-semibold">
      &times;
    </button>

    <h2 class="text-xl font-semibold text-gray-800 text-center mb-6">
      Login to Continue
    </h2>

    <!-- Mobile -->
    <input id="loginMobile" type="tel" maxlength="10"
      placeholder="Enter Mobile Number"
      class="w-full border border-gray-300 rounded-lg px-4 py-3 text-base 
       focus:ring-2 focus:ring-orange-400 outline-none"
      />

    <!-- Password -->
    <input id="loginPassword" type="password"
      placeholder="Enter Password"
      class="w-full border border-gray-300 rounded-lg px-4 py-3 text-base 
       focus:ring-2 focus:ring-orange-400 outline-none"
 
      />

    <!-- Login Button -->
    <button onclick="loginUser()"
      class="w-full bg-orange-500 text-white py-3 rounded-lg font-semibold 
       shadow-md hover:bg-orange-600 transition"

      >
      Login
    </button>

<!-- Forgot Password -->
<button onclick="openForgotPassword()"
  class="text-orange-600 text-sm font-medium mt-3 nohighlight"
  style="background:none; border:none; padding:0;">
  Forgot Password?
</button>






<!-- Signup Link -->
<div class="text-center text-sm text-gray-600 mt-2">
  Not registered?
  <span onclick="openSignup()" class="text-orange-600 font-semibold cursor-pointer">
    Sign Up
  </span>
</div>

      
  </div>
</div>



<!-- FORGOT PASSWORD MODAL -->
<div id="forgotPasswordModal"
     class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center">

  <div class="bg-white w-11/12 max-w-sm rounded-xl p-6 shadow-lg text-center relative">

    <h2 class="text-[18px] text-gray-800 mb-2">Reset Your Password</h2>

    <!-- Mobile -->
    <input id="fpMobile" type="tel" maxlength="10"
      placeholder="Enter Mobile Number"
      class="w-full border border-gray-300 rounded-lg px-4 py-3 mt-2" />

    <!-- Send OTP -->
    <button onclick="sendResetOTP()"
      class="w-full bg-blue-500 text-white py-3 rounded-lg font-semibold mt-3">
      Send OTP
    </button>

    <!-- OTP -->
    <input id="fpOTP" type="text" style="display:none"
      placeholder="Enter OTP"
      class="w-full border border-gray-300 rounded-lg px-4 py-3 mt-3" />

    <!-- New Password -->
    <input id="fpNewPass" type="password" style="display:none"
      placeholder="Enter New Password"
      class="w-full border border-gray-300 rounded-lg px-4 py-3 mt-3" />

    <!-- Update Button -->
    <button id="resetBtn" onclick="resetPassword()" style="display:none"
      class="w-full bg-green-600 text-white py-3 rounded-lg font-semibold mt-3">
      Update Password
    </button>

    <!-- Close -->
    <button onclick="closeForgotPassword()"
      class="w-full bg-gray-200 text-gray-800 py-3 rounded-lg mt-3">
      Close
    </button>

    <!-- üü¢ OVERLAY INSIDE CARD -->
    <div id="fpOverlay"
      class="absolute inset-0 bg-black bg-opacity-40 text-white font-semibold text-lg
             flex items-center justify-center rounded-xl hidden">
      Sending OTP...
    </div>

  </div>
</div>


<!-- SIGNUP MODAL (COMPACT + CLEAN) -->
<div id="signupModal"
     class="fixed inset-0 bg-black bg-opacity-50 z-[9999] hidden flex items-center justify-center">
  <div class="modal-content bg-white w-11/12 max-w-sm rounded-xl p-5 shadow-lg space-y-3 overflow-y-auto"

       style="max-height: 90vh;">

    <h2 class="text-lg font-semibold text-gray-800 text-center">Welcome User</h2>

    <p class="text-sm text-gray-600 text-center -mt-1">
      This is a test signup window. No backend code is triggered.
    </p>

    <!-- Mobile -->
    <input type="text" id="suMobile" placeholder="Mobile Number"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
             focus:ring-2 focus:ring-orange-400 outline-none"/>

    <!-- Password -->
    <input type="password" id="suPassword" placeholder="Password"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
             focus:ring-2 focus:ring-orange-400 outline-none"/>

    <!-- Name -->
    <input type="text" id="suName" placeholder="Full Name"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
             focus:ring-2 focus:ring-orange-400 outline-none"/>

    <!-- Email -->
    <input type="email" id="suEmail" placeholder="Email Address"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
             focus:ring-2 focus:ring-orange-400 outline-none"/>

    <!-- Send OTP -->
    <button type="button" onclick="sendEmailOTP()"
      class="w-full bg-blue-500 text-white py-2 rounded-lg text-sm font-semibold 
             shadow hover:bg-blue-600 transition">
      Send OTP
    </button>

    <!-- Email OTP -->
    <input type="text" id="suEmailOTP" placeholder="Enter Email OTP" 
  style="display:none"
  class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
         focus:ring-2 focus:ring-orange-400 outline-none"/>


    <!-- Address -->
    <textarea id="suAddress" placeholder="Address"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
             focus:ring-2 focus:ring-orange-400 outline-none resize-none h-20"></textarea>

    <!-- NEW PINCODE FIELD -->
    <select id="suPincode" onchange="onPincodeSelect()"
      class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm 
             focus:ring-2 focus:ring-orange-400 outline-none">
      <option value="">Select Pincode</option>
    </select>

    <!-- City -->
    <input type="text" id="suCity" placeholder="City" readonly
      class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-sm 
             text-gray-600 outline-none"/>

    <!-- State -->
    <input type="text" id="suState" placeholder="State" readonly
      class="w-full bg-gray-100 border border-gray-300 rounded-lg px-3 py-2 text-sm 
             text-gray-600 outline-none"/>

    <!-- Submit -->
    <button onclick="verifyAndSignup()"
      class="w-full bg-green-600 text-white py-2 rounded-lg text-sm font-semibold 
             shadow hover:bg-green-700 transition">
      Submit
    </button>

    <!-- Close -->
    <button onclick="closeSignup()"
      class="w-full bg-gray-200 text-gray-800 py-2 rounded-lg text-sm font-medium 
             shadow hover:bg-gray-300 transition">
      Close
    </button>

    
  </div>
</div>

<script>

//open login
function openLogin() {
  const modal = document.getElementById("loginModal");
  modal.style.display = "flex";
modal.classList.remove("hidden");
  document.getElementById("signupLabelBox").style.display = "none";

}

function closeLogin() {
  const modal = document.getElementById("loginModal");

  // FULL HARD CLOSE
  modal.style.display = "none";
  modal.classList.add("hidden");

  // REMOVE ANY POSSIBLE OVERLAY FREEZE
  unlockLoginForm();

  // Force hide all overlays inside login
  const overlay = document.getElementById("loginProgressOverlay");
  if (overlay) overlay.classList.add("hidden");

  // Clear fields (safety)
  document.getElementById("loginMobile").value = "";
  document.getElementById("loginPassword").value = "";

  // ‚≠ê IMPORTANT FIX: Show signup label again
  const label = document.getElementById("signupLabelBox");
  if (label) label.style.display = "block";
}

function logoutUser() {
  // =========================
  // UI resets
  // =========================
  document.getElementById("userInfoBox").style.display = "none";
  document.getElementById("loggedEmail").innerText = "";

  document.querySelector("button[onclick='openLogin()']").style.display = "inline-block";
  document.querySelector("button[onclick='openSignup()']").style.display = "inline-block";

  document.getElementById("logoutBtn").style.display = "none";
  document.getElementById("signupLabelBox").style.display = "block";
  document.getElementById("hamburgerBtn").style.display = "none";

  document.getElementById("leftNav").style.display = "none";
  document.getElementById("leftNav").classList.remove("active");

  document.getElementById("menuWrapper").style.display = "block";
  document.getElementById("pageWrapper").style.display = "none";

  document.getElementById("profilePage").style.display = "none";
  document.getElementById("ordersPage").style.display = "none";
  document.getElementById("offersPage").style.display = "none";

  document.querySelectorAll("#premiumMenu li").forEach(li =>
    li.classList.remove("active")
  );
  document.getElementById("mainContent").style.marginLeft = "0";

  // =========================
  // LOGIN IDENTITY CLEAR
  // =========================
  localStorage.removeItem("userMobile");
  localStorage.removeItem("userEmail");
  localStorage.removeItem("sessionId");

  // =========================
  // CART RESET
  // =========================
  localStorage.removeItem("cart");
  localStorage.removeItem("guestCart");
  cart = [];
  window.cart = [];
  resetMenuUIForLogout();

  // =========================
  // CHECKOUT FORM RESET
  // =========================
  const mobileInput = document.getElementById("mobile");
  if (mobileInput) mobileInput.value = "";

  const nameInput = document.getElementById("customerName");
  if (nameInput) nameInput.value = "";

  const emailInput = document.getElementById("email");
  if (emailInput) emailInput.value = "";

  const addressInput = document.getElementById("address");
  if (addressInput) addressInput.value = "";

  renderCart();

  // =========================
  // CLEAN OVERLAYS
  // =========================
  forceClearOverlays();

  // =========================
  // FINAL HARD RESET
  // =========================
  setTimeout(() => {
    alert("Logged out successfully.");
    window.location.reload();
  }, 50);
}

  
function forceClearOverlays() {
  [
    "loadingOverlay",
    "cartBackdrop",
    "cartOverlay",
    "newAddressModal",
    "couponOverlayBG"
  ].forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.style.display = "none";
      el.classList.remove("active","flex","show");
    }
  });
  document.body.style.overflow = "auto";
}


</script>
<script>
let cityList = []; // map sheet data store

function openSignup() {
  document.getElementById("signupModal").style.display = "flex";

  // Load city/pincode list only once
  if (cityList.length === 0) {
    apiGet("getCityList")
      .then(res => fillPincodeDropdown(res.cities))
      .catch(err => {
        console.error("City list load error:", err);
        alert("Failed to load city/pincode list.");
      });
  }
}




function closeSignup() {
  document.getElementById("signupModal").style.display = "none";
}

function fillPincodeDropdown(list) {
  cityList = list;

  const ddl = document.getElementById("suPincode");
  ddl.innerHTML = `<option value="">Select Pincode</option>`;

  list.forEach(item => {
    const opt = document.createElement("option");
    opt.value = item.pin;
    opt.textContent = item.pin;
    ddl.appendChild(opt);
  });
}

function onPincodeSelect() {
  const pin = document.getElementById("suPincode").value;
  const cityBox = document.getElementById("suCity");
  const stateBox = document.getElementById("suState");

  if (!pin) {
    cityBox.value = "";
    stateBox.value = "";
    return;
  }

  const record = cityList.find(r => String(r.pin) === String(pin));

  if (record) {
    cityBox.value = record.city;
    stateBox.value = record.state;
  } else {
    cityBox.value = "";
    stateBox.value = "";
    alert("Pincode not found.");
  }
}

function finalSignup() {
  const user = {
    mobile: document.getElementById("suMobile").value.trim(),
    password: document.getElementById("suPassword").value.trim(),
    name: document.getElementById("suName").value.trim(),
    email: document.getElementById("suEmail").value.trim(),
    address: document.getElementById("suAddress").value.trim(),
    pincode: document.getElementById("suPincode").value.trim(),
    city: document.getElementById("suCity").value.trim(),
    state: document.getElementById("suState").value.trim()
  };

  // BASIC VALIDATIONS
  if (!/^[0-9]{10}$/.test(user.mobile)) {
    alert("Enter valid 10-digit mobile.");
    return;
  }
  if (!user.password) return alert("Enter password");
  if (!user.name) return alert("Enter name");
  if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(user.email)) {
    alert("Enter valid email.");
    return;
  }
  if (user.pincode.length !== 6) {
    alert("Enter valid 6-digit pincode.");
    return;
  }
  if (!user.city || !user.state) {
    alert("Invalid pincode area.");
    return;
  }

  // FORM ALREADY LOCKED BY verifyAndSignup()
  // ? DO NOT CALL lockSignupForm() AGAIN
  updateSignupOverlayMessage("Creating account...");

  // ? CORRECT POST REQUEST
  fetch(API_BASE + "?api=registerUser", {
    method: "POST",
     body: JSON.stringify(user)
  })
    .then(r => {
      // If server returned non-JSON ? avoid crash
      if (!r.ok) throw new Error("Server error " + r.status);
      return r.json();
    })
    .then(res => {
      unlockSignupForm();

      if (res.success) {
        alert(res.message || "Signup successful!");
        closeSignup();
      } else {
        alert(res.message || "Signup failed.");
      }
    })
    .catch(err => {
      unlockSignupForm();
      alert("Signup failed: " + err.message);
    });
}


function lockSignupForm() {
  const modal = document.querySelector("#signupModal .modal-content");

  // Disable all fields inside modal
  [...modal.querySelectorAll("input, select, textarea, button")].forEach(el => {
    el.disabled = true;
  });

  // Overlay
  const overlay = document.createElement("div");
  overlay.id = "signupProgressOverlay";
  overlay.style.position = "fixed";
  overlay.style.inset = "0";
  overlay.style.background = "rgba(0,0,0,0.35)";
  overlay.style.display = "flex";
  overlay.style.alignItems = "center";
  overlay.style.justifyContent = "center";
  overlay.style.fontSize = "22px";
  overlay.style.color = "#fff";
  overlay.style.zIndex = "9999";
  overlay.textContent = "Signup in progress‚Ä¶";
  document.body.appendChild(overlay);
}
function unlockSignupForm() {
  const modal = document.querySelector("#signupModal .modal-content");

  // Enable everything
  [...modal.querySelectorAll("input, select, textarea, button")].forEach(el => {
    el.disabled = false;
  });

  // Remove overlay
  const overlay = document.getElementById("signupProgressOverlay");
  if (overlay) overlay.remove();
}

function sendEmailOTP() {
  const email = document.getElementById("suEmail").value.trim();

  if (!email) {
    alert("Please enter email first.");
    return;
  }

  // ?? lock UI while sending OTP
  lockSignupForm();
  updateSignupOverlayMessage("Sending OTP...");

  // ? GAS ? Netlify API call conversion
  apiGet("sendSignupEmailOTP", { email })
    .then(res => {
      unlockSignupForm();

      if (res.success) {
        alert("OTP sent to your email!");
        document.getElementById("suEmailOTP").style.display = "block";
      } else {
        alert(res.message);
      }
    })
    .catch(err => {
      unlockSignupForm();
      alert("Error sending OTP: " + err.message);
    });
}

function verifyAndSignup() {
  const email = document.getElementById("suEmail").value.trim();
  const otp = document.getElementById("suEmailOTP").value.trim();

  if (!otp) {
    alert("Please enter OTP.");
    return;
  }

  // ?? LOCK UI + show overlay "Verifying OTP..."
  lockSignupForm();
  updateSignupOverlayMessage("Verifying OTP...");

  // ? Netlify API CALL (GAS ?????)
  apiGet("verifyEmailOTP", { email, otp })
    .then(res => {
      if (!res.success) {
        unlockSignupForm();
        alert(res.message);
        return;
      }

      // OTP verified ? show next message
      updateSignupOverlayMessage("Creating Account...");

      // Now create new user
      finalSignup();
    })
    .catch(err => {
      unlockSignupForm();
      alert("OTP verification failed: " + err.message);
    });
}

 
function updateSignupOverlayMessage(msg) {
  const overlay = document.getElementById("signupProgressOverlay");
  if (overlay) overlay.textContent = msg;
}

// === FINAL STABLE LOAD HANDLER ===
window.addEventListener("load", async () => {
  await loadRestaurantSettings();

  // clear login fields
  const loginMobile = document.getElementById("loginMobile");
  const loginPassword = document.getElementById("loginPassword");
  if (loginMobile) loginMobile.value = "";
  if (loginPassword) loginPassword.value = "";

  const mobile = localStorage.getItem("userMobile");
  const email  = localStorage.getItem("userEmail");
  
  //  LOAD USER CART FROM BACKEND IF LOGGED IN


  // Always reset full UI first
  document.getElementById("menuWrapper").style.display = "block";
  document.getElementById("pageWrapper").style.display = "none";

  document.getElementById("profilePage").style.display = "none";
  document.getElementById("ordersPage").style.display = "none";
  document.getElementById("offersPage").style.display = "none";

  document.getElementById("leftNav").classList.remove("active");
  document.getElementById("leftNav").style.display = "none";
  document.getElementById("mainContent").style.marginLeft = "0";

  document.getElementById("hamburgerBtn").style.display = "none";
  document.getElementById("logoutBtn").style.display = "none";
  document.getElementById("userInfoBox").style.display = "none";

  document.querySelector("button[onclick='openLogin()']").style.display = "inline-block";
  document.querySelector("button[onclick='openSignup()']").style.display = "inline-block";
  document.getElementById("signupLabelBox").style.display = "block";

  // ----- if logged in -----
  if (mobile) {

    // Show user info
    document.getElementById("loggedEmail").innerText = email || "";
    document.getElementById("userInfoBox").style.display = "block";

    // Hide login/signup
    document.querySelector("button[onclick='openLogin()']").style.display = "none";
    document.querySelector("button[onclick='openSignup()']").style.display = "none";
    document.getElementById("signupLabelBox").style.display = "none";

    // Show nav + hamburger
    document.getElementById("leftNav").style.display = "block";
    document.getElementById("hamburgerBtn").style.display = "block";
    document.getElementById("logoutBtn").style.display = "inline-block";

    // Always show menu page after refresh
    showPage("menuPage");

    // highlight first item
    const firstMenu = document.querySelector("#premiumMenu li");
    if (firstMenu) firstMenu.classList.add("active");
  }
   loadCartOnStart();
  if (!isLoggedIn()) {
  const guest = JSON.parse(localStorage.getItem("guestCart") || "[]");

  // Render only if actually a valid array
  if (Array.isArray(guest) && guest.length > 0) {
    cart = guest;
    window.cart = guest;
    renderCart();
   
     document.getElementById("cartToggleBar")?.classList.add("active-cart");
  }
}
});

function validateLoginMobile() {
  const input = document.getElementById("loginMobile");
  const error = document.getElementById("mobileError");

  const original = input.value;          // User typed value
  const digitsOnly = original.replace(/\D/g, "");  // Remove letters

  // Update field to digits only
  input.value = digitsOnly;

  //  If user typed any non-digit (abcd etc.)
  if (original !== digitsOnly) {
    error.style.display = "block";
    error.innerText = "Please enter only mobile numbers. Letters are not allowed.";
    return;
  }

  //  Less than 10 digits but typed correctly
  if (digitsOnly.length > 0 && digitsOnly.length < 10) {
    error.style.display = "block";
    error.innerText = "Please enter a valid 10-digit mobile number.";
    return;
  }

  //  Exactly 10 digits ? no warning
  if (digitsOnly.length === 10) {
    error.style.display = "none";
    return;
  }

  //  Empty field ? hide error
  error.style.display = "none";
}

function lockLoginForm() {
  document.querySelectorAll("#loginModal input, #loginModal button")
    .forEach(el => el.disabled = true);

  document.getElementById("loginProgressOverlay").classList.remove("hidden");
}


function unlockLoginForm() {
  document.querySelectorAll("#loginModal input, #loginModal button")
    .forEach(el => el.disabled = false);

  document.getElementById("loginProgressOverlay").classList.add("hidden");
}



function openForgotPassword() {

  // CLOSE LOGIN MODAL
  document.getElementById("loginModal").style.display = "none";

  // OPEN FORGOT MODAL
  document.getElementById("forgotPasswordModal").style.display = "flex";

  // RESET FIELDS
  document.getElementById("fpOTP").style.display = "none";
  document.getElementById("fpNewPass").style.display = "none";
  document.getElementById("resetBtn").style.display = "none";
}



function closeForgotPassword() {
  document.getElementById("forgotPasswordModal").style.display = "none";

  // Reset fields
  document.getElementById("fpMobile").value = "";
  document.getElementById("fpOTP").value = "";
  document.getElementById("fpNewPass").value = "";

  // Hide OTP and Password fields
  document.getElementById("fpOTP").style.display = "none";
  document.getElementById("fpNewPass").style.display = "none";
  document.getElementById("resetBtn").style.display = "none";
}

// STEP 1: SEND OTP
function sendResetOTP() {
  const mobile = document.getElementById("fpMobile").value.trim();

  if (!/^[0-9]{10}$/.test(mobile)) {
    alert("Please enter valid 10-digit mobile.");
    return;
  }

  // SHOW Overlay (inside modal only)
  const overlay = document.getElementById("fpOverlay");
  overlay.style.display = "flex";
  overlay.textContent = "Sending OTP...";

  // LOCK form
  lockForgotForm();

  // API CALL
  apiGet("sendPasswordResetOTP", { mobile })
    .then(res => {
      overlay.style.display = "none";
      unlockForgotForm();

      if (res.success) {
        alert("OTP sent successfully!");

        // SHOW OTP fields
        document.getElementById("fpOTP").style.display = "block";
        document.getElementById("fpNewPass").style.display = "block";
        document.getElementById("resetBtn").style.display = "block";
      } else {
        alert(res.message);
      }
    })
    .catch(err => {
      overlay.style.display = "none";
      unlockForgotForm();
      alert("Error: " + err.message);
    });
}


// STEP 2: RESET PASSWORD
function resetPassword() {
  const mobile = document.getElementById("fpMobile").value.trim();
  const otp = document.getElementById("fpOTP").value.trim();
  const newPass = document.getElementById("fpNewPass").value.trim();

  if (!otp) {
    alert("Enter OTP.");
    return;
  }
  if (!newPass) {
    alert("Enter new password.");
    return;
  }

  // SHOW OVERLAY + LOCK UI
  document.getElementById("fpOverlay").style.display = "flex";
  lockForgotForm();
  updateForgotOverlay("Updating password...");

  apiPost("resetPassword", { mobile, otp, newPass })
    .then(res => {
      document.getElementById("fpOverlay").style.display = "none";
      unlockForgotForm();

      if (res.success) {
        alert("Password updated successfully!");

        closeForgotPassword();

        //  FIX 1 ‚Äî ensure login form is unlocked
        unlockLoginForm();

        //  FIX 2 ‚Äî open login modal again
        document.getElementById("loginModal").style.display = "flex";
      } else {
        alert(res.message);
      }
    })
    .catch(err => {
      document.getElementById("fpOverlay").style.display = "none";
      unlockForgotForm();
      alert("Error: " + err.message);

      //  Ensure login is not stuck locked
      unlockLoginForm();
    });
}

function lockForgotForm() {
  const modal = document.querySelector("#forgotPasswordModal > div");
  modal.querySelectorAll("input, button").forEach(el => el.disabled = true);
}

function unlockForgotForm() {
  const modal = document.querySelector("#forgotPasswordModal > div");
  modal.querySelectorAll("input, button").forEach(el => el.disabled = false);
}


function updateForgotOverlay(msg) {
  document.getElementById("fpOverlay").textContent = msg;
}
  
function showPage(pageId) {
  window._activePage = pageId;

  // üîï Hide promo banner
  const promo = document.getElementById("promoBanner");
  if (promo) promo.style.display = "none";

  // üîí Hide all sections safely
  const idsToHide = [
    "menuWrapper",
    "pageWrapper",
    "profilePage",
    "ordersPage",
    "offersPage",
    "myCouponsPage"
  ];

  idsToHide.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });

  // üîì Show requested page
  if (pageId === "menuPage") {
    const menu = document.getElementById("menuWrapper");
    if (menu) menu.style.display = "block";
  } else {
    const wrapper = document.getElementById("pageWrapper");
    const page = document.getElementById(pageId);

    if (wrapper) wrapper.style.display = "block";
    if (page) page.style.display = "block";
  }

  // üîî Page-specific hooks
  if (pageId === "offersPage") onOffersPageOpen?.();
  if (pageId === "myCouponsPage") onMyCouponsPageOpen?.();
  if (pageId === "ordersPage") loadMyOrdersSection?.();

  // ‚úÖ ‚≠ê FINAL FIX: Sidebar decides layout, NOT page ‚≠ê
  const sidebar = document.getElementById("leftNav");
  const main = document.getElementById("mainContent");

  if (sidebar && sidebar.classList.contains("active")) {
    main.style.marginLeft = "220px";
  } else {
    main.style.marginLeft = "0";
  }
}


function activateMenu(element) {
  document.querySelectorAll("#premiumMenu li")
    .forEach(li => li.classList.remove("active"));
  element.classList.add("active");
}

function toggleSidebar() {
  const sidebar = document.getElementById("leftNav");
  const menuBtn = document.getElementById("hamburgerBtn");
  const main = document.getElementById("mainContent");

  // Sidebar hidden ? open
  if (!sidebar.classList.contains("active")) {
    sidebar.classList.add("active");
    main.style.marginLeft = "220px";
    menuBtn.innerHTML = `
<svg width="22" height="22">
  <path d="M4 4 L20 20 M20 4 L4 20" stroke="#FFD166" stroke-width="3"/>
</svg>`;

  } 
  else {
    // close sidebar
    sidebar.classList.remove("active");
    main.style.marginLeft = "0";
    menuBtn.innerHTML = `
<svg width="24" height="24" fill="#FFD166">
  <rect y="4" width="24" height="3"></rect>
  <rect y="10" width="24" height="3"></rect>
  <rect y="16" width="24" height="3"></rect>
</svg>`;

  }
}
  
function loadUserProfile() {
  const mobile = localStorage.getItem("userMobile");

  if (!mobile) {
    alert("Session expired. Please login again.");
    return;
  }

  // ? SHOW SIMPLE LOADING TEXT
  document.getElementById("profileLoading").style.display = "block";

  // ? Netlify API replacement
  apiGet("getUserProfile", { mobile })
    .then(res => {
      document.getElementById("profileLoading").style.display = "none";

      if (!res.success) {
        alert("User not found");
        return;
      }

      fillProfileForm(res);
    })
    .catch(err => {
      document.getElementById("profileLoading").style.display = "none";
      alert("Failed: " + err.message);
    });
}
function loadUserOrders() {
  const mobile = localStorage.getItem("userMobile");
  if (!mobile) {
    alert("Session expired. Please login again.");
    return;
  }
  // ? SHOW SIMPLE LOADING TEXT
  document.getElementById("ordersLoading").style.display = "block";
  // ? Netlify API replacement
  apiGet("getUserOrders", { mobile })
    .then(res => {
      document.getElementById("ordersLoading").style.display = "none";
      if (!res.success) {
        alert("No orders found");
        return;
      }
      fillOrdersList(res.orders);
    })
    .catch(err => {
      document.getElementById("ordersLoading").style.display = "none";
      alert("Failed: " + err.message);
    });
}

function showCouponHint(msg) {
  if (!msg) return;

  const box = document.getElementById("couponHintBox");
  if (!box) {
    console.warn("couponHintBox not found in DOM");
    return;
  }

  box.innerHTML = msg;

  // üî• FORCE VISIBILITY (important)
  box.classList.remove("hidden");
  box.style.display = "block";

  // üîÅ restart blink animation cleanly
  box.classList.remove("coupon-blink");
  void box.offsetWidth; // reflow trick
  box.classList.add("coupon-blink");
}

function hideCouponHint() {
  const box = document.getElementById("couponHintBox");
  if (!box) return;

  box.classList.add("hidden");
  box.classList.remove("coupon-blink");
  box.innerHTML = "";
}

  
function loadOffers() {
  // ? SHOW SIMPLE LOADING TEXT
  document.getElementById("offersLoading").style.display = "block";
  // ? Netlify API replacement
  apiGet("getOffers", {})
    .then(res => {
      document.getElementById("offersLoading").style.display = "none";
      if (!res.success) {
        alert("No offers available");
        return;
      }
      fillOffersList(res.offers);
    })
    .catch(err => {
      document.getElementById("offersLoading").style.display = "none";
      alert("Failed: " + err.message);
    });
}

function fillProfileForm(res) {
  document.getElementById("profileLoading").style.display = "none";

  if (!res.success) {
    alert("User not found");
    return;
  }

  // Autofill
  document.getElementById("pName").value = res.name || "";
  document.getElementById("pMobile").value = res.mobile || "";
  document.getElementById("pEmail").value = res.email || "";
  document.getElementById("pAddress").value = res.address || "";
   document.getElementById("ppin").value = res.pincode || "";
  document.getElementById("pCity").value = res.city || "";
  document.getElementById("pState").value = res.state || "";
  setProfileReadonly(true);
}
function showProfilePage() {
  hideAllPages();
  document.getElementById("profilePage").style.display = "block";
  loadUserProfile();   // ? profile load karo
}

function setProfileReadonly(state) {
  document.getElementById("pName").readOnly = state;
  document.getElementById("pEmail").readOnly = state;
  document.getElementById("pAddress").readOnly = state;
  document.getElementById("ppin").readOnly = state;
  document.getElementById("pCity").readOnly = state;
  document.getElementById("pState").readOnly = state;

  // Mobile never editable
  document.getElementById("pMobile").disabled = true;
}
function enableProfileEdit() {
  setProfileReadonly(false);

  document.getElementById("editBtn").style.display = "none";
  document.getElementById("saveBtn").style.display = "inline-block";
  document.getElementById("cancelBtn").style.display = "inline-block";
}
function cancelProfileEdit() {
  loadUserProfile();   // reload original values
  document.getElementById("editBtn").style.display = "inline-block";
  document.getElementById("saveBtn").style.display = "none";
  document.getElementById("cancelBtn").style.display = "none";
}

function saveProfile() {
  const data = {
    mobile: document.getElementById("pMobile").value.trim(),
    name: document.getElementById("pName").value.trim(),
    email: document.getElementById("pEmail").value.trim(),
    address: document.getElementById("pAddress").value.trim(),
    pincode: document.getElementById("ppin").value.trim(),
    city: document.getElementById("pCity").value.trim(),
    state: document.getElementById("pState").value.trim()
  };

  if (!data.name) return alert("Name cannot be empty");
  if (!data.email) return alert("Email cannot be empty");
  if (data.pincode.length !== 6) return alert("Enter valid 6-digit pincode");

  // ? Show overlay
  document.getElementById("profileOverlay").classList.add("active");

  // Disable buttons
  document.getElementById("editBtn").disabled = true;
  document.getElementById("saveBtn").disabled = true;
  document.getElementById("cancelBtn").disabled = true;

  // ? Netlify POST request
  apiPost("updateUserProfile", data)
    .then(res => {
      document.getElementById("profileOverlay").classList.remove("active");

      // Re-enable buttons
      document.getElementById("editBtn").disabled = false;
      document.getElementById("saveBtn").disabled = false;
      document.getElementById("cancelBtn").disabled = false;

      if (res.success) {
        alert("Profile updated successfully!");
        loadUserProfile();

        document.getElementById("editBtn").style.display = "inline-block";
        document.getElementById("saveBtn").style.display = "none";
        document.getElementById("cancelBtn").style.display = "none";
      } else {
        alert(res.message);
      }
    })
    .catch(err => {
      document.getElementById("profileOverlay").classList.remove("active");
      alert("Error: " + err.message);
    });
}


</script>
<script>
let deferredPrompt;

window.addEventListener("beforeinstallprompt", (e) => {
  e.preventDefault();
  deferredPrompt = e;

  // Show button
  document.getElementById("installBtn").style.display = "block";
});

// When user clicks install button
document.getElementById("installBtn").addEventListener("click", async () => {
  if (!deferredPrompt) return;

  deferredPrompt.prompt();

  const result = await deferredPrompt.userChoice;

  if (result.outcome === "accepted") {
    alert("App installed successfully!");
  }

  deferredPrompt = null;

  // Hide button after install
  document.getElementById("installBtn").style.display = "none";
});

// Hide button if already installed
window.addEventListener("appinstalled", () => {
  document.getElementById("installBtn").style.display = "none";
});
</script>

<script>
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('./sw.js')

    .then(reg => {
      console.log('SW Registered on Netlify');

      // SAME UPDATE CHECK SYSTEM
      reg.addEventListener("updatefound", () => {
        const newWorker = reg.installing;
        newWorker.addEventListener("statechange", () => {
          if (newWorker.state === "installed" && navigator.serviceWorker.controller) {
            if (confirm("A new version of the app is available. Update now?")) {
              window.location.reload();
            }
          }
        });
      });

    })
    .catch(err => {
      console.error('SW Failed:', err);
    });
}
</script>
  
<script>
function hidePromoBannerForLoggedInUser() {
  const banner = document.getElementById("promoBanner");
  const slides = document.getElementById("promoSlides");

  if (banner) banner.style.display = "none";
  if (slides) slides.innerHTML = "";
}


async function loginUser() {
  const mobile = document.getElementById("loginMobile").value.trim();
  const password = document.getElementById("loginPassword").value.trim();

  if (!/^[0-9]{10}$/.test(mobile)) {
    alert("Enter valid 10-digit mobile.");
    return;
  }

  lockLoginForm(); // overlay ON

  apiPost("login", { mobile, password })
    .then(async res => {

      if (!res.success) {
        unlockLoginForm();
        alert(res.message || "Login failed.");
        return;
      }

      // 1Ô∏è‚É£ Save user identity
    
localStorage.setItem("userMobile", mobile);
localStorage.setItem("userEmail", res.email || "");
localStorage.setItem("userName", res.name || res.customerName || ""); // ‚úÖ ADD

      // 2Ô∏è‚É£ Save SIGNUP DISCOUNT immediately (most important)
      const sd = Number(res.signupDiscount || 0);
      localStorage.setItem("signupDiscount", sd);
      window.signupDiscount = sd;
      console.log("üî• Signup Discount Saved:", sd);

      // 3Ô∏è‚É£ Update UI email
      document.getElementById("loggedEmail").innerText = res.email || "";

      // 4Ô∏è‚É£ Merge guest cart ‚Üí backend cart
      await onUserLogin(mobile);
      hidePromoBannerForLoggedInUser();
      // 5Ô∏è‚É£ Recalculate drawer totals so discount shows instantly
      try { updateDrawerTotals(); } catch(e){ console.error(e); }

      // 6Ô∏è‚É£ Update UI panels
      document.getElementById("userInfoBox").style.display = "block";
      document.querySelector("button[onclick='openLogin()']").style.display = "none";
      document.querySelector("button[onclick='openSignup()']").style.display = "none";
      document.getElementById("signupLabelBox").style.display = "none";
      document.getElementById("logoutBtn").style.display = "inline-block";
      document.getElementById("hamburgerBtn").style.display = "block";
      document.getElementById("leftNav").style.display = "block";

      // 7Ô∏è‚É£ Close modal
      setTimeout(() => {
        closeLogin();
        unlockLoginForm();
        window.location.reload();
      }, 50);

    })
    .catch(err => {
      unlockLoginForm();
      alert("Login error: " + err.message);
    });
}


  function openMenuPageProperly(el) {
  activateMenu(el);
  hideAllPages();
  document.getElementById("menuWrapper").style.display = "block";
}


</script>
<script>
  
function hideAllPages() {
  const ids = [
    "menuWrapper",
    "profilePage",
    "ordersPage",
    "offersPage",
    "myCouponsPage"
  ];

  ids.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = "none";
  });
}

</script>
<script>

function apiPost(api, data = {}) {
  return fetch(API_BASE + "?api=" + api, {
    method: "POST",
    redirect: "follow", // ‚≠ê MUST
    body: JSON.stringify(data)
  })
  .then(async res => {
    const text = await res.text();   // üîë GAS redirect safe
    try {
      return JSON.parse(text);
    } catch (e) {
      console.error("API RAW RESPONSE:", text);
      throw new Error("Invalid JSON from backend");
    }
  });
}


function isLoggedIn() {
  return Boolean(localStorage.getItem("userMobile"));
}

  
function buildMenuCardHTML(item, idx) {
// A2A ‚Äî Ensure stable itemId (Single + Multi)
item.itemId = String(
  item.itemId ||
  item.ItemId ||
  item.id ||
  item.ID ||
  slugify(item.name)
);
  
  let priceSection = "";
  let cartSection = "";

  // ==========================
  //       SINGLE ITEM
  // ==========================
  if (item.cat2 === "Single") {

    // FINAL PRICE CALCULATION (MENU SHEET)
    const mrp  = Number(item.price);               // From menu sheet
    const disc = Number(item.discPercent || 0);
    const finalPrice = parseFloat((mrp - (mrp * disc / 100)).toFixed(2));

    priceSection = `
      <div class="variant-box">
        <div class="variant-row">
          <div class="left-side">
            <span class="unit">${item.unit || ""}</span>

            ${disc > 0 ? `
              <span style="background:#ff3e3e;color:#fff;font-size:11px;
                           padding:2px 4px;border-radius:3px;">
                ${disc}% OFF
              </span>
            ` : ""}
          </div>

          <div style="text-align:right;">
            <span class="final-price" style="font-weight:700;font-size:16px;">
               ${fmt(finalPrice)}
            </span>

            ${disc > 0 ? `
              <span class="mrp" 
                    style="text-decoration:line-through;color:#777;
                           margin-left:6px;font-size:13px;">
                 ${fmt(mrp)}
              </span>
            ` : ""}
          </div>
        </div>
      </div>
    `;

    cartSection = `
  <button class="add-btn hidden"
    data-name="${item.name}"
    data-unit="${item.unit}"
    data-price="${mrp}"
    data-disc="${disc}"
    data-item-id="${item.itemId}">
    Add
  </button>
    `;
  }

   // ==========================
  //       MULTI ITEM
  // ==========================
  if (item.cat2 === "Multi") {
    const idSafe = slugify(item.name) + "-" + idx;

    // AUTO-GENERATE variantId if missing
    item.variants = item.variants.map((v, vidx) => ({
      ...v,
      variantId: v.variantId || slugify(v.unit) || `v${vidx + 1}`
    }));

    let variantsHTML = "";

    item.variants.forEach(v => {
      // FINAL PRICE CALCULATION (CAT_ALLOCATION SHEET)
      const mrp  = Number(v.price);                  // From cat_allocation sheet
      const disc = Number(v.discPercent || 0);
      const finalPrice = parseFloat((mrp - (mrp * disc / 100)).toFixed(2));

      const boxId    = `box-${item.itemId}_${v.variantId}-${idx}`;
      const qtyTextId = `qtyText-${item.itemId}_${v.variantId}-${idx}`;

      variantsHTML += `
        <label class="variant-row">
          <div class="left-side">
            <input type="radio"
                   name="var-${idSafe}"
                   onclick="activateVariantSelector('${item.itemId}', '${v.variantId}', '${v.unit}', ${mrp}, ${disc}, ${idx})"
                   data-unit="${v.unit}"
                   data-mrp="${mrp}"
                   data-disc="${disc}"
                   data-variant-id="${v.variantId}"
                   data-item-id="${item.itemId}">

            <span class="unit">${v.unit}</span>

            ${disc > 0 ? `
              <span style="background:#ff3e3e;color:#fff;
                           font-size:11px;padding:2px 4px;
                           border-radius:3px;">
                ${disc}% OFF
              </span>
            ` : ""}
          </div>

          <div style="text-align:right;">
            <span class="final-price" 
                  style="font-weight:700;font-size:16px;">
             ${fmt(finalPrice)}
            </span>

            ${disc > 0 ? `
              <span style="text-decoration:line-through;
                           color:#777;margin-left:6px;font-size:13px;">
                ${fmt(mrp)}
              </span>
            ` : ""}
          </div>
        </label>

        <!-- HIDDEN QTY BOX FOR THIS VARIANT (CARD-SPECIFIC) -->
        <div id="${boxId}"
             class="hidden flex items-center gap-3 mt-2">

          <button class="px-2 bg-gray-300 rounded text-lg"
                  onclick="updateCart('${item.itemId}', '${v.variantId}', 'dec')">‚àí</button>

          <span class="font-semibold" id="${qtyTextId}">1</span>

          <button class="px-2 bg-gray-300 rounded text-lg"
                  onclick="updateCart('${item.itemId}', '${v.variantId}', 'add')">+</button>
        </div>
      `;
    });

    priceSection = `<div class="variant-box">${variantsHTML}</div>`;
    // Multi item ‚Üí no global ADD button
    cartSection = "";
  }


  // ==========================
  //       RETURN CARD
  // ==========================

  // üëâ NEW: Menu-level controls only for Single items
  let menuControls = "";

  if (item.cat2 === "Single") {
    menuControls = `
      <!-- ADD BUTTON (Single only) -->
      <button id="addBtn-${item.itemId}-${idx}"
        class="addBtn bg-[#ff6f00] text-white px-3 py-1 rounded font-semibold mt-2"
        onclick="addFromMenu('${item.itemId}', ${idx})">
  ADD
</button>

<div id="qtyBox-${item.itemId}-${idx}" 
     class="qtyBox hidden flex items-center justify-center gap-3 mt-2">

  <button class="px-2 py-1 bg-gray-300 rounded text-lg"
          onclick="menuMinus('${item.itemId}', ${idx})">‚àí</button>

  <span id="qtyText-${item.itemId}-${idx}" class="font-semibold">1</span>

  <button class="px-2 py-1 bg-gray-300 rounded text-lg"
          onclick="menuPlus('${item.itemId}', ${idx})">+</button>

</div>

    `;
  } else {
    // Multi item ‚Üí NO global ADD, only variant-wise qty using activateVariantSelector
    menuControls = "";
  }

  return `
    <img src="${item.image}" alt="${item.name}">
    <h4>${item.name}</h4>
    <p>${item.description || ""}</p>
    ${priceSection}
    ${cartSection}
    ${menuControls}
  `;
}





// Delegated click handler for all Add buttons (works for Single and Multi)
// ADD-TO-CART HANDLER
window._cartSavePromise = Promise.resolve();

async function saveCartToBackend(cartData = null) {
   const p = new Promise(async (resolve) => {
    // Only if logged in
    if (!isLoggedIn()) return resolve();

    const mobile = localStorage.getItem("userMobile");
    if (!mobile) return resolve();

    // ---- QUEUE SYSTEM (Race fix) ----
    if (window.cartSaveLock) {
      window.cartSaveQueued = true;
      return resolve();
    }
    window.cartSaveLock = true;

    // Ensure sessionId
    let sessionId = localStorage.getItem("sessionId");
    if (!sessionId) {
      sessionId = "SESS-" + Date.now();
      localStorage.setItem("sessionId", sessionId);
    }

    // Use passed data OR global cart
    const cartToSend = (cartData && Array.isArray(cartData)) ? cartData : cart;

    // Clean final payload
    const cleanedCart = cartToSend.map(item => ({
      name: item.name || "",
      unit: item.unit || "",
      qty: Number(item.qty || 1),
      rate: Number(item.rate || 0),
      discPercent: Number(item.discPercent || 0),
      itemId: item.itemId || "",
      variantId: item.variantId || "",
      image: item.image || ""
    }));

    try {
       blockRender = true;  
      await apiPost("saveCart", {
        mobile,
        email: localStorage.getItem("userEmail") || "",
        sessionId,
        cartItems: cleanedCart
      });

    } catch (err) {
      console.error("Cart Save Error:", err);

    } finally {
 blockRender = false;  
      window.cartSaveLock = false;

     if (window.cartSaveQueued) {
  window.cartSaveQueued = false;
  const p2 = saveCartToBackend();
  window._cartSavePromise = p2;
  await p2;
}

  // FINAL SAFE CHECK
    if (isLoggedIn()) {
        
    }
      // === STEP 4C: DISABLED BACKEND VERIFY TO PREVENT QTY ROLLBACK ===
      resolve();
    }

  });
    // üîí register this save as "latest"
  window._cartSavePromise = p;

  return p;
}



 

function getBackendCart(mobile) {
  return apiPost("getCart", { mobile })
    .then(res => {
      if (res.success && Array.isArray(res.data)) {
        return res.data;   // ‚Üê backend cart array return
      }
      return [];
    })
    .catch(err => {
      console.error("Fetch Backend Cart Error:", err);
      return [];
    });
}

function mergeCarts(localCart, backendCart) {
  let finalCart = [];

  const map = new Map();

  // Step 1: Backend items safe
  backendCart.forEach(item => {
    const key = `${item.itemId}_${item.variantId}`;
    map.set(key, { ...item });
  });

  // Step 2: Local cart merge
 localCart.forEach(localItem => {

  // ‚ùó skip if invalid IDs
  if (!localItem.itemId) return;
  if (localItem.variantId === undefined) return;

  const key = `${localItem.itemId}_${localItem.variantId}`;

    if (map.has(key)) {
      let exist = map.get(key);
      exist.qty = Number(exist.qty) + Number(localItem.qty);
      exist.total = exist.qty * exist.rate;
      map.set(key, exist);
    } else {
      map.set(key, {
        ...localItem,
        cartId: "",      
        sessionId: "",
        mobile: "",
        timestamp: ""
      });
    }
  });

  map.forEach(item => finalCart.push(item));
  return finalCart;
}
async function onUserLogin(mobile) {

  // ALWAYS load email first (IMPORTANT)
  const email = localStorage.getItem("userEmail") || "";

  // Ensure sessionId exists
  let sessionId = localStorage.getItem("sessionId");
  if (!sessionId) {
    sessionId = "SESS-" + Date.now();
    localStorage.setItem("sessionId", sessionId);
  }

  // -------------------------------
  // 1) Fetch backend cart
  // -------------------------------
  const backendRes = await apiPost("getCart", { mobile });
  const backendCartRaw = backendRes.cart || [];

  const backendCart = backendCartRaw.map(i => ({
    name: i.name || "",
    unit: i.unit || "",
    qty: Number(i.qty || 1),
    rate: Number(i.rate || 0),
    discPercent: Number(i.discPercent || 0),
    itemId: i.itemId || "",
    variantId: i.variantId || "",
    image: i.image || ""
  }));

  // -------------------------------
  // 2) Read local guest cart
  // -------------------------------
  const guestRaw = JSON.parse(localStorage.getItem("guestCart") || "[]");

  const guestCart = guestRaw.map(i => ({
    name: i.name || "",
    unit: i.unit || "",
    qty: Number(i.qty || 1),
    rate: Number(i.rate || 0),
    discPercent: Number(i.discPercent || 0),
    itemId: i.itemId || "",
    variantId: i.variantId || "",
    image: i.image || ""
  }));

  // -------------------------------
  // 3A) Merge guest + backend (ONLY ONCE)
  // -------------------------------
  let merged = mergeCarts(guestCart, backendCart);

  // -------------------------------
  // 3D) Final Normalize
  // -------------------------------
  const finalMerged = merged.map(item => {
    item.qty = Number(item.qty || 1);
    item.rate = Number(item.rate || 0);
    item.discPercent = Number(item.discPercent || 0);

    const discAmt = (item.rate * item.discPercent) / 100;
    const netRate = item.rate - discAmt;

    item.discAmt = Number(discAmt.toFixed(2));
    item.netAmt  = Number(netRate.toFixed(2));

    item.total = item.discPercent > 0
      ? Number((netRate * item.qty).toFixed(2))
      : Number((item.rate * item.qty).toFixed(2));

    return item;
  });

  // -------------------------------
  // 4) Save to backend
  // -------------------------------
  cart = finalMerged;
  window.cart = finalMerged;

  localStorage.setItem("userEmail", email);
  await saveCartToBackend(finalMerged);

  // Clear guest cart
  localStorage.removeItem("guestCart");

  // -------------------------------
  // 5) Save local mirror
  // -------------------------------
  localStorage.setItem("cart", JSON.stringify(finalMerged));

  // -------------------------------
  // 6) Render UI
  // -------------------------------
  renderCart();
  setTimeout(() => refreshUI(), 50);
}


async function someCartAction() {
  showCartOverlay("Working...");

  try {
      // 1) local storage update
      // 2) cart rebuild
      // 3) backend save (if logged in)
      // 4) renderCart()
      // 5) any recheck or merge
  }
  catch(err) {
     console.error(err);
  }
  finally {
     hideCartOverlay();   // <-- ALWAYS LAST
  }
}

function resetCheckoutFieldsDefault() {

  // SHOW only these 3 rows
  document.getElementById("mobile").parentElement.style.display = "block";
  document.getElementById("orderType").parentElement.style.display = "block";
  document.getElementById("paymentMethod").parentElement.style.display = "block";

  // HIDE Name + Email + Address (label + input together)
  document.getElementById("customerName").parentElement.style.display = "none";
  document.getElementById("email").parentElement.style.display = "none";
  document.getElementById("addressWrapper").style.display = "none";

  // Ensure fields remain editable when shown later
  document.getElementById("customerName").readOnly = false;
  document.getElementById("email").readOnly = false;
  document.getElementById("address").readOnly = false;

  // Payment MUST remain visible always
  document.getElementById("paymentMethod").style.display = "block";
}


function setupAddressUIVisibility() {
  const changeBtn = document.getElementById("changeAddressBtn");
  const dropdownContainer = document.getElementById("addressSelectContainer");
  const newAddressForm = document.getElementById("newAddressForm");

  if (!changeBtn || !dropdownContainer || !newAddressForm) return;

  if (isLoggedIn()) {
    // ONLY logged-in users see the button
    changeBtn.classList.remove("hidden");

    // Dropdown & New address form remain hidden until user clicks
    dropdownContainer.classList.add("hidden");
    newAddressForm.classList.add("hidden");
  } else {
    // Guest User ‚Üí everything OFF
    changeBtn.classList.add("hidden");
    dropdownContainer.classList.add("hidden");
    newAddressForm.classList.add("hidden");
  }
}

// run on page load
document.addEventListener("DOMContentLoaded", setupAddressUIVisibility);
 
  
function autofillMobileForLoggedIn() {
  const mobileInput = document.getElementById("mobile");
  const nameInput   = document.getElementById("customerName");
  const emailInput  = document.getElementById("email");

  if (!mobileInput) return;

  // Logged-in data
  const mobile = localStorage.getItem("userMobile");
  const name   = localStorage.getItem("userName");
  const email  = localStorage.getItem("userEmail");

  // ---------- GUEST ----------
  if (!mobile) {
    mobileInput.value = "";
    mobileInput.readOnly = false;

    if (nameInput) {
      nameInput.value = "";
      nameInput.readOnly = false;
    }
    if (emailInput) {
      emailInput.value = "";
      emailInput.readOnly = false;
    }
    return;
  }

  // ---------- LOGGED-IN ----------
  mobileInput.value = mobile;
  mobileInput.readOnly = true;

  // üî• IMPORTANT: even if name missing, keep field editable
  if (nameInput) {
    nameInput.value = name || "";
    nameInput.readOnly = !!name;   // lock only if we actually have name
  }

  if (emailInput) {
    emailInput.value = email || "";
    emailInput.readOnly = !!email; // lock only if we actually have email
  }
}



  
window.__NEW_ADDRESS_FLOW = false;

function onChangeAddressClick() {
  window.__NEW_ADDRESS_FLOW = false;

 // üîπ STATUS MESSAGE SHOW
  const status = document.getElementById("addressStatus");
  if (status) {
    status.innerText = "Fetching your saved address‚Ä¶";
     status.className = "text-sm text-red-600 font-medium";
    status.classList.remove("hidden");
  }
  const mobile = localStorage.getItem("mobile") || localStorage.getItem("userMobile");
  if (!mobile) return;

  const overlay = document.getElementById("loadingOverlay");
  if (overlay) overlay.style.display = "flex";

  const dropdownBox = document.getElementById("addressSelectContainer");
  const newFormBox = document.getElementById("newAddressForm");

  dropdownBox.classList.add("hidden");
  newFormBox.classList.add("hidden");

  const ddl = document.getElementById("savedAddressDropdown");
  ddl.innerHTML = "";
  ddl.classList.remove("hidden");

  // 1Ô∏è‚É£ Fetch Primary + MultiAdd together
  Promise.all([
    apiGet("getUserProfile", { mobile }),
    apiGet("getUserMultiAddresses", { mobile })
  ])
  .then(([userRes, multiRes]) => {

      const primary = userRes?.address
        ? {
            address: userRes.address,
            pincode: userRes.pincode || "",
            city: userRes.city || "",
            state: userRes.state || "",
            type: "primary"
          }
        : null;

      const multiList = Array.isArray(multiRes?.addresses)
        ? multiRes.addresses.map(a => ({
            address: a.address || "",
            pincode: a.pincode || "",
            city: a.city || "",
            state: a.state || "",
            type: "multi"
          }))
        : [];

      // 2Ô∏è‚É£ If nothing saved ‚Üí show new form
      // 2Ô∏è‚É£ If nothing saved ‚Üí DO NOT auto-open new address form in checkout
if (!primary && multiList.length === 0) {
  dropdownBox.classList.add("hidden");

  // just inform user
  const status = document.getElementById("addressStatus");
  if (status) {
    status.innerText = "No saved address found. Please add a new address.";
    status.className = "text-sm text-red-600 font-medium";
    status.classList.remove("hidden");
  }

  if (overlay && !window.__NEW_ADDRESS_FLOW) {
  overlay.style.display = "none";
}

  return;
}


      // 3Ô∏è‚É£ Show dropdown box
      dropdownBox.classList.remove("hidden");

      let count = 1;

      // --- Add Primary ---
      if (primary) {
        const opt = document.createElement("option");
        opt.value = JSON.stringify(primary);
        opt.textContent =
          `${count}) ${primary.address} | ${primary.pincode} | ${primary.city} | ${primary.state}`;
        ddl.appendChild(opt);
        count++;
      }

      // --- Add multi_add addresses ---
      multiList.forEach(a => {
        const opt = document.createElement("option");
        opt.value = JSON.stringify(a);
        opt.textContent =
          `${count}) ${a.address} | ${a.pincode} | ${a.city} | ${a.state}`;
        ddl.appendChild(opt);
        count++;
      });

      // 4Ô∏è‚É£ Auto-select first address
      const first = ddl.options[0];
      if (first) {
        ddl.value = first.value;
        const obj = JSON.parse(first.value);
        document.getElementById("address").value  = obj.address;
        document.getElementById("pincode").value = obj.pincode;
        document.getElementById("city").value    = obj.city;
        document.getElementById("state").value   = obj.state;
      }

      // ‚≠ê SUPER SAFE OVERLAY HIDE ‚Üí when dropdown truly visible
      const waitRender = setInterval(() => {
  const optionsReady = ddl.options.length > 0;
  const visible = !dropdownBox.classList.contains("hidden");

  if (optionsReady && visible) {
    clearInterval(waitRender);

    // ensure browser paints dropdown before hiding overlay
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
       if (overlay && !window.__NEW_ADDRESS_FLOW) {
  overlay.style.display = "none";
}
        // ‚úÖ SUCCESS MESSAGE (STEP-1C)
        const status = document.getElementById("addressStatus");
        if (status) {
          status.innerText = "Address loaded successfully";
          status.className = "text-sm text-green-600 font-medium";
          status.classList.remove("hidden");

          // auto hide after 1.5 sec
          setTimeout(() => {
            status.classList.add("hidden");
          }, 1500);
        }
      });
    });
  }

}, 50);



      // 5Ô∏è‚É£ Dropdown change handler
      ddl.onchange = () => {
        try {
          const obj = JSON.parse(ddl.value);
          document.getElementById("address").value  = obj.address;
          document.getElementById("pincode").value = obj.pincode;
          document.getElementById("city").value    = obj.city;
          document.getElementById("state").value   = obj.state;
        } catch (e) {}
      };

  })
  .catch(err => {
      console.error("Address load error:", err);
      alert("Unable to load saved addresses.");
      if (overlay) overlay.style.display = "none";
    const status = document.getElementById("addressStatus");
  if (status) status.classList.add("hidden");
  });
}



function onChangeAddressAddNew() {
window.__NEW_ADDRESS_FLOW = true;

  // 1Ô∏è‚É£ Hide checkout modal ONLY (no reset)
  const checkout = document.getElementById("checkoutModal");
  if (checkout) {
    checkout.classList.add("hidden");
    checkout.style.display = "none";
  }

  // üîë Important: keep body locked for modal flow
  document.body.style.overflow = "hidden";

  // 2Ô∏è‚É£ Open New Address modal
  const modal = document.getElementById("newAddressModal");
  if (!modal) return;

  modal.classList.remove("hidden");
  modal.classList.add("flex");
  modal.style.display = "flex";
  modal.style.zIndex = "100000";

  // 3Ô∏è‚É£ Show form INSIDE modal
  const form = document.getElementById("newAddressForm");
  if (form) {
    form.classList.remove("hidden");
    form.style.display = "block";
  }

  loadPincodeDropdown();
  console.log("‚úÖ New Address Modal opened cleanly");
}

function closeNewAddressModal() {

  const modal = document.getElementById("newAddressModal");
  if (modal) {
    modal.classList.add("hidden");
    modal.classList.remove("flex");
    modal.style.display = "none";
  }

  // Hide form safely
  const form = document.getElementById("newAddressForm");
  if (form) {
    form.classList.add("hidden");
    form.style.display = "none";
  }

  // üîÅ Restore checkout modal
  const checkout = document.getElementById("checkoutModal");
  if (checkout) {
    checkout.classList.remove("hidden");
    checkout.style.display = "flex";
  }

  // üîë KEEP body locked because checkout is open
  document.body.style.overflow = "hidden";

  console.log("‚úÖ New Address Modal closed, checkout restored");
}


function saveNewAddress() {
if (window._savingAddress) return;
window._savingAddress = true;

  const mobile =
    localStorage.getItem("mobile") ||
    localStorage.getItem("userMobile");

  if (!mobile) {
    alert("Login required.");
    window._savingAddress = false;
    return;
  }
  const btn = document.getElementById("saveNewAddressBtn");
if (btn) {
  btn.disabled = true;
  btn.innerText = "Saving...";
}


  const addr  = document.getElementById("newAddressField").value.trim();
  const pin   = document.getElementById("newPincode").value.trim();
  const city  = document.getElementById("newCity").value.trim();
  const state = document.getElementById("newState").value.trim();

  if (!addr || pin.length !== 6 || !city || !state) {
    alert("Please fill all address fields correctly.");
    window._savingAddress = false;
if (btn) {
    btn.disabled = false;
    btn.innerText = "Save Address";
}
    
    return;
  }

  apiPost("saveUserNewAddress", {
    mobile,
    address: addr,
    pincode: pin,
    city,
    state
  })
  .then(res => {
    if (!res || !res.success) {
      alert(res?.message || "Failed to save address.");
      window._savingAddress = false;

  if (btn) {
    btn.disabled = false;
    btn.innerText = "Save Address";
  }
      return;
    }
window._savingAddress = false;
if (btn) {
  btn.disabled = false;
  btn.innerText = "Save Address";
}

    // ‚úÖ Close modal
    closeNewAddressModal();

    // ‚úÖ Clear modal inputs
    document.getElementById("newAddressField").value = "";
    document.getElementById("newPincode").value = "";
    document.getElementById("newCity").value = "";
    document.getElementById("newState").value = "";

    // ‚úÖ Refresh dropdown
    onChangeAddressClick();

    // ‚úÖ Auto-select newly added address
    setTimeout(() => {
      const ddl = document.getElementById("savedAddressDropdown");
      if (ddl && ddl.options.length > 0) {
        ddl.selectedIndex = ddl.options.length - 1;
        ddl.dispatchEvent(new Event("change"));
      }
    }, 300);

  })
  .catch(err => {
    console.error(err);
   console.log("NEW MODAL SAVE FLOW RUNNING");

    console.warn("Save address fetch failed, but may be saved:", err);
window._savingAddress = false;
if (btn) {
  btn.disabled = false;
  btn.innerText = "Save Address";
}

  closeNewAddressModal();
  onChangeAddressClick();
  });
}


const originalBodyOverflow = document.body.style.overflow || "";  
// STEP 8 ‚Äî Autofill New Address Form with logged-in mobile
function autofillNewAddressMobile() {
  const mobile = localStorage.getItem("userMobile") || "";
  const field = document.getElementById("newAddressMobile");
  if (field && mobile) {
    field.value = mobile;
  }
}
  
function updateCartBadge() {

  // Always use master engine getter
  const cartArr = getCart();

  let totalQty = 0;

  cartArr.forEach(ci => {
    totalQty += Number(ci.qty || 0);
  });

  const badge = document.getElementById("cartCount");
  if (!badge) return;

  if (totalQty > 0) {
    badge.textContent = totalQty;
    badge.classList.remove("hidden");
  } else {
    badge.textContent = "";
    badge.classList.add("hidden");
  }
}


  function syncCheckoutButton() {
  const btn = document.getElementById("checkoutBtn");
  if (!btn) return;

  if (window._cartUpdating) {
    btn.disabled = true;
    btn.innerText = "Updating cart‚Ä¶";
    btn.classList.remove("bg-red-500", "hover:bg-red-600");
    btn.classList.add("bg-gray-400", "cursor-not-allowed", "opacity-60");
  } else {
    btn.disabled = false;
    btn.innerText = "Checkout";
    btn.classList.remove("bg-gray-400", "cursor-not-allowed", "opacity-60");
    btn.classList.add("bg-red-500", "hover:bg-red-600");
  }
}

async function openCheckout() {

    if (window._cartUpdating) {
    alert("Cart is still updating. Please wait‚Ä¶");
    return;
  }

  // ‚úÖ 0Ô∏è‚É£ FIRST ‚Äî close drawer cart
  closeCartDrawer();

  // üîí Lock background scroll
  document.body.style.overflow = "hidden";

  const freshCart = getCart();
  cart = freshCart;
  window.cart = freshCart;

  if (freshCart.length === 0) {
    alert("Your cart is empty!");
    document.body.style.overflow = "";
    return;
  }

  // Autofill + reset
  autofillMobileForLoggedIn();
  resetCheckoutFieldsDefault();
  document.getElementById("orderType").value = "";
hideAddressIfOrderTypeBlank();
  setupAddressUIVisibility();
  loadPrimaryAddress();

  refreshCheckout();
  document.getElementById("changeAddressBtn")?.classList.add("hidden");

  // ‚úÖ Open modal
  const modal = document.getElementById("checkoutModal");
  modal.style.display = "flex";

  // üîí FIX: Logged-in user ‚Üí hide mobile hint
  if (isLoggedIn()) {
    const hint = document.getElementById("mobileHint");
    if (hint) hint.style.display = "none";
  }

  // üîÅ Restore correct UI AFTER modal open
  setTimeout(() => {
    updateGuestFieldsVisibility();

    const orderType = document.getElementById("orderType")?.value;
    if (orderType) {
      toggleAddressField();
    }
  }, 0);


mountInvoiceIntoCheckout();
  updateCheckoutInvoice();

}




async function openCartDrawer() {

 closeCheckout();
  showCouponHintPlaceholder(); // üëà STEP-1 placeholder
  //  OPEN DRAWER INSTANTLY (NO DELAY)
  document.getElementById("cartBackdrop").classList.add("active");
  document.getElementById("cartDrawer").classList.add("active");
  document.body.style.overflow = "hidden";

  // Fetch offers in background (NO await)
  fetchOffersFromBackend().then(() => {
  try {
    updateDrawerTotals();           // totals recalc
    refreshCouponMotivationHint();  // üî• NOW hint will show
  } catch (e) {}
});

  // 1) Always get latest cart (master engine)
  let freshCart = getCart();

  // STEP 1D ‚Üí Restore missing images
  freshCart = restoreCartImages(freshCart);

  // 2) Sync global
  cart = freshCart;
  window.cart = freshCart;

  // 3) Rebuild drawer UI
  openCartPanel(freshCart);
  renderCart();

  // ----------------------------------------
  // ‚≠ê FIXED RESTORE: coupon should restore ONLY if valid
  // ----------------------------------------
  if (alreadyAppliedCouponId && (!selectedCoupon || selectedCoupon.id !== alreadyAppliedCouponId)) {

    const offers = window.liveOffers || [];
    const found = offers.find(x => x.id === alreadyAppliedCouponId);

    if (found) {
      selectedCoupon = found;
    } else {
      // coupon expired or removed ‚Üí reset
      alreadyAppliedCouponId = "";
      selectedCoupon = null;
    }
  }

  // ----------------------------------------
// ‚≠ê G4: REVALIDATE COUPON on drawer open
// ----------------------------------------
if (selectedCoupon && selectedCoupon.type === "onetime") {

    const subtotal = cart.reduce((sum, ci) => {
        const mrp = Number(ci.rate || 0);
        const disc = Number(ci.discPercent || 0);
        const qty  = Number(ci.qty || 1);
        return sum + (mrp - (mrp * disc / 100)) * qty;
    }, 0);

    if (subtotal < Number(selectedCoupon.min || 0)) {
        selectedCoupon = null;
        alreadyAppliedCouponId = "";
        showCouponError("Coupon removed because cart value changed.");
    }
}
  // 4) Update totals + badge
  try { updateDrawerTotals(); } catch(e){}
  try { updateCartBadge(); } catch(e){}
  checkAndShowMonthlyReward();
 fetchAndRenderUserCouponsForCart();
refreshMonthlySpendAndReward();

}


function closeCartDrawer() {
  const backdrop = document.getElementById("cartBackdrop");
  const drawer   = document.getElementById("cartDrawer");

  if (drawer) {
    drawer.classList.remove("active");
  }

  if (backdrop) {
    backdrop.classList.remove("active");
  }

  document.body.style.overflow = "auto";
}


window._drawerCollapsed = false;
  
function collapseDrawerCart() {
  const drawer = document.getElementById("cartDrawer");
  if (!drawer) return;

  drawer.classList.add("collapsed");
  document.body.style.overflow = "auto";

  window._drawerCollapsed = true;
}
  
function expandDrawerCart() {
  const drawer = document.getElementById("cartDrawer");
  if (!drawer) return;

  drawer.classList.remove("collapsed");
  document.body.style.overflow = "hidden";

  window._drawerCollapsed = false;
}

function updateCartHandle() {
  const handle = document.getElementById("cartHandle");
  if (!handle) return;

  handle.style.display = window._drawerCollapsed ? "flex" : "none";
}

// hook into existing functions
const _collapseDrawerCart = collapseDrawerCart;
collapseDrawerCart = function () {
  _collapseDrawerCart();
  updateCartHandle();
};

const _expandDrawerCart = expandDrawerCart;
expandDrawerCart = function () {
  _expandDrawerCart();
  updateCartHandle();
};

function isDrawerOpen() {
  const drawer = document.getElementById("cartDrawer");
  return drawer && !window._drawerCollapsed && drawer.classList.contains("active");
}

  function autoCollapseDrawerOnMenuInteraction() {
  if (isDrawerOpen()) {
    collapseDrawerCart();
  }
}

  
function toggleCartDrawer() {
  const drawer = document.getElementById("cartDrawer");
  if (drawer.classList.contains("active")) {
    closeCartDrawer();
  } else {
    openCartDrawer();
  }
   
}

  document.addEventListener("DOMContentLoaded", () => {   
  restoreFullCartUI();   
  updateCartBadge();    
});

// ===== SWIPE TO CLOSE Drawer (Zomato style) =====
let touchStartX = 0;

document.addEventListener("touchstart", function(e) {
  const drawer = document.getElementById("cartDrawer");
  if (!drawer.classList.contains("active")) return;

  touchStartX = e.touches[0].clientX;
});

document.addEventListener("touchmove", function(e) {
  const drawer = document.getElementById("cartDrawer");
  if (!drawer.classList.contains("active")) return;

  const currentX = e.touches[0].clientX;
  const diff = currentX - touchStartX;

  // Swipe right only
  if (diff > 60) {
    closeCartDrawer();
  }
});
// ===== ESC Key Close =====
document.addEventListener("keydown", function(e) {
  if (e.key === "Escape") {
    closeCartDrawer();
  }
});

function addFromMenu(itemId, idx) {
autoCollapseDrawerOnMenuInteraction();
  itemId = String(itemId);

  const addBtn  = document.getElementById(`addBtn-${itemId}-${idx}`);
  const qtyBox  = document.getElementById(`qtyBox-${itemId}-${idx}`);
  const qtyText = document.getElementById(`qtyText-${itemId}-${idx}`);

  if (addBtn) addBtn.classList.add("hidden");
  if (qtyBox) qtyBox.classList.remove("hidden");
  if (qtyText) qtyText.innerText = "1";

  try { animateQty(`qtyText-${itemId}-${idx}`); } catch(e){}

  // MASTER ENGINE (UNCHANGED)
  updateCart(itemId, "", "add");
}


function menuPlus(itemId, idx) {
autoCollapseDrawerOnMenuInteraction();
  itemId = String(itemId);

  const qtyText = document.getElementById(`qtyText-${itemId}-${idx}`);
  if (!qtyText) return;

  let q = Number(qtyText.innerText) + 1;
  qtyText.innerText = q;

  try { animateQty(`qtyText-${itemId}-${idx}`); } catch(e){}

  updateCart(itemId, "", "add");
}


function menuMinus(itemId, idx) {
autoCollapseDrawerOnMenuInteraction();
  itemId = String(itemId);

  const qtyText = document.getElementById(`qtyText-${itemId}-${idx}`);
  const qtyBox  = document.getElementById(`qtyBox-${itemId}-${idx}`);
  const addBtn  = document.getElementById(`addBtn-${itemId}-${idx}`);

  if (!qtyText) return;

  let q = Number(qtyText.innerText);

  if (q === 1) {
    qtyText.innerText = "0";
    if (qtyBox) qtyBox.classList.add("hidden");
    if (addBtn) addBtn.classList.remove("hidden");
    updateCart(itemId, "", "dec");
    return;
  }

  q--;
  qtyText.innerText = q;

  try { animateQty(`qtyText-${itemId}-${idx}`); } catch(e){}

  updateCart(itemId, "", "dec");
}



function menuMinus_multi(id) {

  const [itemId, variantId] = id.split("_");
  const qtyText = document.getElementById("qtyText-" + id);
  let q = Number(qtyText.innerText);

  // ------------------------------------------------
  // CASE A ‚Üí NORMAL DECREMENT (qty > 1)
  // ------------------------------------------------
  if (q > 1) {

    q--;
    qtyText.innerText = q;
    animateQty("qtyText-" + id);

    updateDrawerItemQty(String(itemId), String(variantId), q);

    let cartArr = isLoggedIn()
      ? JSON.parse(localStorage.getItem("cart") || "[]")
      : JSON.parse(localStorage.getItem("guestCart") || "[]");

    const item = cartArr.find(
      c => c.itemId === itemId && c.variantId === variantId
    );
    if (item) item.qty = q;

    cart = cartArr;
    window.cart = cartArr;

    if (isLoggedIn()) {
      localStorage.setItem("cart", JSON.stringify(cartArr));
      saveCartToBackend(cartArr);
    } else {
      localStorage.setItem("guestCart", JSON.stringify(cartArr));
    }

    updateCartBadge();
    refreshCartDrawer();
    updateDrawerTotals();
    return;
  }

  // ------------------------------------------------
  // CASE B ‚Üí REMOVE ITEM (qty = 1)
  // ------------------------------------------------
  if (q === 1) {

    let cartArr = isLoggedIn()
      ? JSON.parse(localStorage.getItem("cart") || "[]")
      : JSON.parse(localStorage.getItem("guestCart") || "[]");

    // Remove exact variant
    cartArr = cartArr.filter(
      c => !(c.itemId === itemId && c.variantId === variantId)
    );

    // Drawer remove ‚Äî FIXED ID format
    removeItemFromDrawer(`${itemId}_${variantId}`);

    // Save in storage
    if (isLoggedIn()) {
      localStorage.setItem("cart", JSON.stringify(cartArr));
      saveCartToBackend(cartArr);
    } else {
      localStorage.setItem("guestCart", JSON.stringify(cartArr));
    }

    cart = cartArr;
    window.cart = cartArr;

    // Hide qty box
    const box = document.getElementById("qtyBox-" + id);
    if (box) box.classList.add("hidden");

    // Reset radio
    const radio = document.querySelector(`input[data-variant-id="${variantId}"]`);
    if (radio) radio.checked = false;

    updateCartBadge();
    refreshCartDrawer();
    updateDrawerTotals();
  }
}



function cleanCartConsistency(cartArr) {

  // Remove invalid items
  cartArr = cartArr.filter(c =>
    c && c.itemId && Number(c.qty) > 0
  );

  // Remove duplicates (same item + same variant)
  const map = {};
  const cleaned = [];

  cartArr.forEach(c => {
    const key = c.itemId + "_" + (c.variantId || "single");
    if (!map[key]) {
      map[key] = true;
      cleaned.push(c);
    }
  });

  return cleaned;
}


function menuPlus_multi(id) {
  // id = "itemId_variantId"
  const [itemId, variantId] = id.split("_");

  // 1Ô∏è‚É£ UI increment
  const qtyText = document.getElementById("qtyText-" + id);
  let q = Number(qtyText.innerText);
  q++;
  qtyText.innerText = q;
  animateQty("qtyText-" + id);

  // Drawer qty update
  updateDrawerItemQty(String(itemId), String(variantId), q);

  // 2Ô∏è‚É£ Load cart
  let cartArr = isLoggedIn()
    ? JSON.parse(localStorage.getItem("cart") || "[]")
    : JSON.parse(localStorage.getItem("guestCart") || "[]");

  // 3Ô∏è‚É£ Find exact multi variant
  const item = cartArr.find(
    c => c.itemId === itemId && c.variantId === variantId
  );
  if (!item) return;

  // 4Ô∏è‚É£ Update qty
  item.qty = q;

  // Save in global state
  cart = cartArr;
  window.cart = cartArr;

  // 5Ô∏è‚É£ Save to correct storage
  if (isLoggedIn()) {
    localStorage.setItem("cart", JSON.stringify(cartArr));
    saveCartToBackend(cartArr);
  } else {
    localStorage.setItem("guestCart", JSON.stringify(cartArr));
  }

  // 6Ô∏è‚É£ UI update
  updateCartBadge();
  if (document.getElementById("cartDrawer").classList.contains("active")) {
    refreshCartDrawer();
    updateDrawerTotals();
  }
}

function loadCartOnStart() {

  let cartArr = getCart();   // master engine getter

  // STEP 1C ‚Üí image restore apply
  cartArr = restoreCartImages(cartArr);

  cart = cartArr;
  window.cart = cartArr;

  updateCartBadge();
  restoreFullCartUI();
}


  
function refreshCartDrawer() {

  // Drawer closed? ‚Üí skip
  const drawer = document.getElementById("cartDrawer");
  if (!drawer || !drawer.classList.contains("active")) return;

  // Always read latest cart
  const cartArr = getCart();

  // Rebuild drawer UI fresh
  openCartPanel(cartArr);

  // Update totals + badge
  try { updateDrawerTotals(); } catch(e){}
  try { updateCartBadge(); } catch(e){}
}

  function updateDrawerItemQty(itemId, variantId = "", newQty) {

  itemId = String(itemId);
  variantId = String(variantId);

  // Drawer closed ‚Üí skip
  const drawer = document.getElementById("cartDrawer");
  if (!drawer || !drawer.classList.contains("active")) return;

  // Row ID detect
  const rowId = variantId
    ? `drawerRow-${itemId}_${variantId}`
    : `drawerRow-${itemId}`;

  const row = document.getElementById(rowId);
  if (!row) return;

  // Update qty text
  const qtyEl = row.querySelector(".drawer-qty");
  if (qtyEl) qtyEl.textContent = newQty;

  // Recalculate total inside drawer
  const mrp = Number(row.dataset.price || 0);
  const disc = Number(row.dataset.disc || 0);

  const priceAfterDisc = mrp - (mrp * disc / 100);
  const lineTotal = (priceAfterDisc * newQty).toFixed(2);

  const totalEl = row.querySelector(".drawer-total");
  if (totalEl) totalEl.textContent = fmt(lineTotal);

}



function removeItemFromDrawer(itemId, variantId = "") {

  itemId = String(itemId);
  variantId = String(variantId);

  // Drawer closed ‚Üí ignore
  const drawer = document.getElementById("cartDrawer");
  if (!drawer || !drawer.classList.contains("active")) return;

  // Row ID
  const rowId = variantId
    ? `drawerRow-${itemId}_${variantId}`
    : `drawerRow-${itemId}`;

  const row = document.getElementById(rowId);
  if (row) row.remove();

  // Update totals + badge
  try { updateDrawerTotals(); } catch(e){}
  try { updateCartBadge(); } catch(e){}
}

async function loadCartBeforeDrawer() {

  const cartArr = getCart();   // guest => guestCart, login => cart (localStorage)

  cart = Array.isArray(cartArr) ? cartArr : [];
  window.cart = cart;

  return cart;
}



function showCartOverlay(msg = "Loading‚Ä¶") {
  const o = document.getElementById("cartOverlay");
  if (!o) return;
  o.innerText = msg;
  o.classList.remove("hidden");
}

function hideCartOverlay() {
  const o = document.getElementById("cartOverlay");
  if (!o) return;
  o.classList.add("hidden");
}


  function activateVariantSelector(itemId, variantId, unit, price, disc, idx) {
autoCollapseDrawerOnMenuInteraction();
  itemId = String(itemId);
  variantId = String(variantId);

  const boxId     = `box-${itemId}_${variantId}-${idx}`;
  const qtyTextId = `qtyText-${itemId}_${variantId}-${idx}`;

  // 1Ô∏è‚É£ Hide ALL other variant qty-boxes of this card
  document.querySelectorAll(`div[id^="box-${itemId}_"][id$="-${idx}"]`)
    .forEach(b => b.classList.add("hidden"));

  // 2Ô∏è‚É£ Show selected variant qty-box
  const targetBox = document.getElementById(boxId);
  if (targetBox) targetBox.classList.remove("hidden");

  // 3Ô∏è‚É£ Check existing cart item
  const ex = findCartItem(itemId, variantId);

  if (ex) {
    // Restore qty
    const qtyLabel = document.getElementById(qtyTextId);
    if (qtyLabel) qtyLabel.textContent = ex.qty;
    return; // IMPORTANT ‚Üí no add on re-select
  }

  // 4Ô∏è‚É£ If not in cart ‚Üí add via Master Engine
  updateCart(itemId, variantId, "add", {
    unit,
    price,
    discount: disc
  });

  // 5Ô∏è‚É£ Initialize qty = 1
  const qtyLabel = document.getElementById(qtyTextId);
  if (qtyLabel) qtyLabel.textContent = "1";
}


  
function removeAllOldMultiEvents() {
  document.querySelectorAll("input[data-variant-id]").forEach(el => {
    const clean = el.cloneNode(true); 
    el.replaceWith(clean);
  });
}
function buildCartObject(itemId, variantId, meta = {}) {

  itemId = String(itemId || "");
  variantId = String(variantId || "");

  // MENU lookups
  const menuItem = window.menuItems?.find(m =>
    String(m.itemId) === itemId
  );

  let variant = null;
  if (menuItem?.variants && variantId) {
    variant = menuItem.variants.find(v =>
      String(v.variantId) === variantId
    );
  }

  // FINAL SAFE META BUILD
  const name = meta.name || menuItem?.name || "";
  const unit = meta.unit || variant?.unit || menuItem?.unit || "";
  const price = Number(meta.price || variant?.price || menuItem?.price || 0);
  const discount = Number(meta.discount || variant?.discPercent || menuItem?.discPercent || 0);

  return {
    itemId,
    variantId,
    name,
    unit,
    price,
    discPercent: discount,
    qty: 1,
    image: menuItem?.image || "",

    // UI helpers ‚Äî optional
    rate: price,
    total: price,
  };
}

function finalizeCartUpdate(cartArr) {
  setCart(cartArr);

  try {
    updateDrawerTotals();
    refreshCouponMotivationHint();
  } catch (e) {}

  return;
}

  function updateCart(itemId, variantId = "", action, meta = {}) {
  console.log("üü° updateCart drawer called");

  // üîí START LOCK
  window._cartUpdating = true;
  renderCart();   // checkout button gray + disabled

  itemId = String(itemId);
  variantId = String(variantId);

  let cartArr = getCart();

  let existing = cartArr.find(c =>
    String(c.itemId) === itemId &&
    String(c.variantId || "") === variantId
  );

  let cartChanged = false;

  // ---------- ADD ----------
  if (action === "add") {
    if (existing) {
      existing.qty++;
    } else {
      const newObj = buildCartObject(itemId, variantId, meta);
      cartArr.push(newObj);
    }
    cartChanged = true;
  }

  // ---------- DEC ----------
  if (action === "dec") {

    // üî• FIX ‚Äî do NOT return without unlock
    if (!existing) {
      setTimeout(() => {
        window._cartUpdating = false;
        renderCart();
      }, 100);
      return;
    }

    if (existing.qty > 1) {
      existing.qty--;
      cartChanged = true;
    } else {
      cartArr = cartArr.filter(c =>
        !(String(c.itemId) === itemId &&
          String(c.variantId || "") === variantId)
      );
      cartChanged = true;
    }
  }

  // üî• SINGLE FINAL UPDATE
  if (cartChanged) {
    setCart(cartArr);

    try {
      updateDrawerTotals();
      refreshCouponMotivationHint();
      toggleClaimRewardOnCart();
    } catch (e) {}
  }

  // üîì ALWAYS UNLOCK
  setTimeout(() => {
    window._cartUpdating = false;
    renderCart();   // restore red checkout
  }, 300);
}



  
function cleanCartInvalidItems(arr) {
  return arr.filter(i =>
    i &&
    i.itemId && String(i.itemId).trim() !== "" &&
    i.name && String(i.name).trim() !== "" &&
    i.unit && String(i.unit).trim() !== "" &&
    !isNaN(i.rate) &&
    Number(i.rate) > 0
  );
}
function getUserMobile() {
  return (
    localStorage.getItem("userMobile") ||
    localStorage.getItem("mobile") ||
    ""
  );
}


function getCartSubtotal() {
  let subtotal = 0;
  cart.forEach(ci => {
    const rate = Number(ci.rate || 0);
    const disc = Number(ci.discPercent || 0);
    const qty = Number(ci.qty || 1);
    subtotal += (rate - (rate * disc / 100)) * qty;
  });
  return subtotal;
}

function getCouponMotivationMessage() {
  const cartTotal = getCartSubtotal();
  const loggedIn = isUserLoggedIn();
  const offers = window._allOffersRaw || [];

  for (const o of offers) {
    // signup coupons ignore
    if (o.type === "signup") continue;

    // onetime already used ‚Üí ignore fully
    if (o.type === "onetime" && o._usedOnce === true) continue;

    // min not reached ‚Üí candidate
    if (cartTotal < Number(o.min || 0)) {
      let msg = `Add items worth ‚Çπ${Number(o.min) - cartTotal} more to unlock this offer.`;

      // registered-only coupon + guest user
      if (
        String(o.userApplicable || "").toLowerCase() === "registered user" &&
        !loggedIn
      ) {
        msg += " Sign up / login to avail this offer.";
      }

      return msg; // üî¥ ONLY FIRST VALID MESSAGE
    }
  }

  return ""; // nothing to show
}
function isRewardAlreadyClaimed() {
  return window._rewardAlreadyClaimed === true;
}

function toggleClaimRewardOnCart(cartList) {
  const rewardBox = document.getElementById("rewardBox");
  if (!rewardBox) return;

  // default hide
  rewardBox.style.display = "none";

  if (!cartList || cartList.length === 0) return;
  if (window._rewardTextReady !== true) return;
  if (window._rewardAlreadyClaimed === true) return;

  // ‚úÖ show reward
  rewardBox.style.display = "block";

  // üîí STEP-8 PRIORITY LOCK (missing part)
  const hintBox = document.getElementById("couponHintBox");
  if (hintBox) {
    hintBox.style.display = "none";
    hintBox.innerHTML = "";
  }

  const couponsBox = document.getElementById("availableCouponsBox");
  if (couponsBox) {
    couponsBox.style.pointerEvents = "none";
    couponsBox.style.opacity = "0.5";
  }
}





function showCouponHintPlaceholder() {
  const hintBox = document.getElementById("couponHintBox");
  if (!hintBox) return;

  hintBox.innerText = "Checking best offers for you‚Ä¶";
  hintBox.style.display = "block";
   window._couponHintLocked = true;
}

window._couponHintTimer = null;
  
function refreshCouponMotivationHint() {
if (window._appliedCouponType === "reward") {
  const hintBox = document.getElementById("couponHintBox");
  if (hintBox) {
    hintBox.innerHTML = "üéÅ Reward coupon applied. Other offers are disabled.";
    hintBox.style.display = "block";
  }
  return;
}

  if (typeof window._rewardAlreadyClaimed !== "boolean") {
    window._rewardAlreadyClaimed = false;
  }
  clearTimeout(window._couponHintTimer);

  window._couponHintTimer = setTimeout(() => {
    const hintBox = document.getElementById("couponHintBox");
    if (!hintBox) return;
 
    const subtotal = Number(window._drawerTotals?.baseTotal || 0);
    const loggedIn = isUserLoggedIn();
    const allOffers = window._allOffersRaw || [];

    // ‚ùå nothing to show
    if (subtotal <= 0 || allOffers.length === 0) {
      hintBox.style.display = "none";
      return;
    }

    // ===============================
    // Guest same-range registered
    // ===============================
    let sameRangeRegistered = [];

    if (!loggedIn) {
      sameRangeRegistered = allOffers
        .filter(o => o.active === true)
        .filter(o => String(o.userApplicable || "all user").toLowerCase() === "registered user")
        .filter(o => Number(o.min || 0) <= subtotal)
        .filter(o => !(o.type === "onetime" && o._usedOnce === true));
    }

    if (!loggedIn && sameRangeRegistered.length > 0) {
      const best = sameRangeRegistered.sort((a, b) => {
        const valA = a.flat > 0 ? a.flat : (subtotal * a.discount / 100);
        const valB = b.flat > 0 ? b.flat : (subtotal * b.discount / 100);
        return valB - valA;
      })[0];

      hintBox.innerHTML =
        best.min <= subtotal
          ? `Signup now to unlock <b>${best.text}</b>`
          : `Add items worth <b>${fmt(best.min - subtotal)}</b> more to unlock <b>${best.text}</b>`;

      hintBox.style.display = "block";
      return;
    }

    // ===============================
    // Future offer
    // ===============================
    const future = allOffers
      .filter(o => o.active === true)
      .filter(o => Number(o.min || 0) > subtotal)
      .sort((a, b) => a.min - b.min)[0];

    if (!future || (future.type === "onetime" && future._usedOnce === true)) {
      hintBox.style.display = "none";
      return;
    }

    let msg = `Add items worth <b>${fmt(future.min - subtotal)}</b> more to unlock <b>${future.text}</b>`;
    const ua = String(future.userApplicable || "all user").toLowerCase();

    if (ua === "registered user" && !loggedIn) {
      msg += `<br><span class="text-sm">Login / Signup to avail this offer</span>`;
    }

     hintBox.innerHTML = msg;
    hintBox.style.display = "block";

    // üîí re-apply checkout lock AFTER coupon hint repaint
    if (window._cartUpdating) {
      lockCheckout("Updating cart‚Ä¶");
    }

  }, 150); // üîë debounce ONLY

  
}



  async function fetchOffersFromBackend() {
  try {
    window.liveOffers = [];
    window._allOffersRaw = [];

    const mobile = isUserLoggedIn() ? getUserMobile() : "";
    const cartTotal = getCartSubtotal(); // MIN is checked on backend also

    const res = await fetch(
      API_BASE + "?api=getOffers&mobile=" + mobile + "&cartTotal=" + cartTotal
    );

    const data = await res.json();

    // ‚úÖ ‚≠ê SINGLE IMPORTANT ADDITION (DO NOT REMOVE)
    window._lastOffersResponse = data;

    if (data.success && Array.isArray(data.offers)) {

      window._allOffersRaw = Array.isArray(data.allOffersRaw)
        ? data.allOffersRaw
        : [];

      window.liveOffers = data.offers;

      // ===============================
      // STEP 1b: User applicable filter
      // ===============================
      const loggedIn = isUserLoggedIn();

      window.liveOffers = window.liveOffers.filter(o => {
        // signup coupons untouched
        if (o.type === "signup") return true;

        const ua = (
          o.userApplicable ||
          o.user_applicable ||
          o.UserApplicable ||
          o.userapplicable ||
          "All user"
        ).toLowerCase();

        // All user ‚Üí always visible
        if (ua === "all user") return true;

        // Registered user ‚Üí only logged-in users
        if (ua === "registered user") {
          return loggedIn;
        }

        // safety fallback
        return true;
      });

      // ‚ùå TEMPORARILY DISABLED (HINT TRIGGER)
      
      setTimeout(() => {
        try {
          refreshCouponMotivationHint();
        } catch (e) {}
      }, 0);
      

      return window.liveOffers;
    }

  } catch (err) {
    console.error("Offer load error:", err);
  }

  window.liveOffers = [];
  return [];
}

  
function getCart() {

  // Guest user
  if (!isLoggedIn()) {
    let g = JSON.parse(localStorage.getItem("guestCart") || "[]");
    return g;
  }

  // Logged-in user
  let c = JSON.parse(localStorage.getItem("cart") || "[]");
  return c;
}


// STEP 1A ‚Üí Menu se image fetch karne ka helper
function getMenuImage(itemId, variantId) {
  itemId = String(itemId);
  variantId = String(variantId || "");

  const item = (window.menuItems || []).find(
    m => String(m.id) === itemId || String(m.itemId) === itemId
  );

  if (!item) return "";

  // agar multi variant hai aur variant image rakhi hai
  if (variantId && Array.isArray(item.variants)) {
    const v = item.variants.find(x => String(x.variantId || x.id) === variantId);
    if (v && v.image) return v.image;
  }

  return item.image || "";
}
// ---------- STEP 1B: Offers data + best-offer calculation ----------


function evaluateCouponHint() {
  const cartTotal = getCartSubtotal();
  const loggedIn = isUserLoggedIn();

  // container
  const hintBox = document.getElementById("couponHintBox");
  if (!hintBox) return;

  hintBox.style.display = "none";
  hintBox.innerHTML = "";

  // safety
  const offers = window.liveOffers || [];
  if (offers.length > 0) return; // coupons already visible ‚Üí no hint

  // ---- read ALL offers (raw, without min filter) ----
  const allOffers = window._allOffersRaw || [];
  if (!allOffers.length) return;

  // find best eligible-but-blocked offer
  for (const o of allOffers) {

    // ‚ùå never show for signup
    if (o.type === "signup") continue;

    // ‚ùå onetime already used ‚Üí NO MESSAGE
    if (o.type === "onetime" && o._usedOnce === true) continue;

    const min = Number(o.min || 0);
    const ua = (o.userApplicable || "All user").toLowerCase();

    // üü• CASE-1: cart total less than min
    if (cartTotal < min) {
      const diff = min - cartTotal;

      let msg = `Please add items worth ‚Çπ${diff} more to unlock this offer`;

      // üü• CASE-2: registered-only + guest
      if (ua === "registered user" && !loggedIn) {
        msg += `<br><span style="font-weight:600;">Signup / Login to avail this offer</span>`;
      }

      hintBox.innerHTML = "üî¥ " + msg;
      hintBox.style.display = "block";
      return;
    }
  }
}

function getBestOffer(total) {
  const offers = window.liveOffers || [];

  let best = null;
  let bestValue = 0;

  offers.forEach(o => {
    if (total >= (o.min || 0)) {
      let val = 0;
      if (o.discount) val = total * (o.discount / 100);
      if (o.flat) val = o.flat;

      if (val > bestValue) {
        bestValue = val;
        best = { ...o, value: Number(val.toFixed(2)) };
      }
    }
  });

  return best;
}
 

// STEP 2A ‚Äì Apply Coupon button (open offer list)
async function openCouponList() {

  const listBox = document.getElementById("offerList");
  const loader  = document.getElementById("offerLoadingText");

  try {
    if (!listBox || !loader) return;

    // 1Ô∏è‚É£ show loader
    listBox.style.display = "block";
    loader.style.display  = "block";

    // 2Ô∏è‚É£ fetch offers
    await fetchOffersFromBackend();
    showCouponHint(getCouponMotivationMessage());

    // 3Ô∏è‚É£ FINAL FILTER (ONLY ONE PLACE)
    const loggedIn = isUserLoggedIn();

   const apiOffers =
  (window._lastOffersResponse && window._lastOffersResponse.offers) || [];

const activeOffers = apiOffers.filter(o => {

      // ‚ùå signup coupon kabhi mat dikhao
      if (o.type === "signup") return false;

      // üîí onetime + already used
      if (o.type === "onetime" && o._usedOnce === true) return false;

      // üë§ registered user rule
      const ua = (o.userApplicable || "All user").toLowerCase();
      if (ua === "registered user" && !loggedIn) return false;

      // ‚úÖ finally active
      return o.active === true;
    });

    console.log(
      "FINAL COUPONS SHOWN:",
      activeOffers.map(o => ({ id: o.id, used: o._usedOnce }))
    );

    // 4Ô∏è‚É£ render
    listBox.innerHTML = "";
    listBox.appendChild(loader);
    loader.style.display = "none";

    if (activeOffers.length === 0) {
      listBox.innerHTML = `
        <div class="p-2 text-gray-500 text-center">
          No offers available
        </div>`;
      return;
    }

    listBox.innerHTML += activeOffers.map(o => `
      <div class="p-2 border-b cursor-pointer hover:bg-gray-100"
           onclick="applyCoupon('${o.id}')">
        <div class="font-semibold">
          <span class="font-bold">${o.id}</span> ‚Äì ${o.text}
        </div>
        <div class="text-sm text-gray-500">Min: ${fmt(o.min)}</div>
      </div>
    `).join("");

  } catch (err) {
    console.error("openCouponList ERROR:", err);
  }
}

function closeCouponList() {
  const list = document.getElementById("offerList");
  const loader = document.getElementById("offerLoadingText");

  if (list) list.style.display = "none";
  if (loader) loader.style.display = "none";
}
  
function cleanupCouponUI(loadingText, offerList) {
  if (loadingText) {
    loadingText.style.display = "none";
    loadingText.classList.remove("coupon-loading");
  }

  if (offerList) {
    offerList.style.pointerEvents = "auto";
    offerList.style.opacity = "1";
    offerList.style.visibility = "visible";

    const couponItems = offerList.querySelectorAll(
      ':scope > div:not(#offerLoadingText)'
    );
    couponItems.forEach(el => {
      el.style.display = "";
    });
  }
}



let selectedCoupon = null;        // coupon object (UI + totals)
let alreadyAppliedCouponId = "";  // coupon ID (restore + protection)

async function applyCoupon(couponId) {
  window._appliedCouponType = "normal";
window._couponLocked = false;

// ===============================
// STEP 1c: Defensive apply-time guard
// ===============================
const offer = (window.liveOffers || []).find(o => o.id === couponId);

if (offer) {
  const ua = (offer["User applicable"] || "All user").toLowerCase();

  // Guest trying to apply Registered user coupon
  if (ua === "registered user" && !isUserLoggedIn()) {
    showCouponError("Please login to use this offer.");
    return { success: false }; 
  }
}

  // üîÑ SHOW COUPON PROCESSING
  const loadingText = document.getElementById("offerLoadingText");
  const offerList = document.getElementById("offerList");
  if (loadingText) {
    loadingText.innerText = "Applying coupon";
    loadingText.classList.add("coupon-loading");
    loadingText.style.display = "block";
     loadingText.style.color = "#dc2626";       // üî¥ red
  loadingText.style.fontSize = "16px";        // bigger
  loadingText.style.fontWeight = "600";       // bold
  }
 

if (offerList) {
  offerList.style.pointerEvents = "none"; // disable clicks
  offerList.style.opacity = "1";        // visual feedback
   const couponItems = offerList.querySelectorAll(
  ':scope > div:not(#offerLoadingText)'
);

couponItems.forEach(el => {
  el.style.display = "none";
});
}

  // üîë 1Ô∏è‚É£ Fresh backend truth
  await fetchOffersFromBackend();


  const offers = window.liveOffers || [];

  // üîë 2Ô∏è‚É£ Coupon still active?
  const o = offers.find(x => x.id === couponId && x.active === true);

  if (!o) {
    showCouponError("This promotional offer is no longer available.");
    cleanupCouponUI(loadingText, offerList);
     return { success: false };
  }
// üîí ONETIME COUPON CHECK (minimal)
if (o.type === "onetime") {

 const mobile =
  localStorage.getItem("userMobile") ||
  document.getElementById("mobile")?.value ||
  "";

  // backend se check: is user ne ye coupon pehle use kiya?
  const used = await apiGet("hasUsedCoupon", {
    mobile,
    couponId
  });

  console.log("USED COUPON?", used);

  if (used && used.success === true) {
  showCouponError("This promotional offer has already been used.");
      // üßπ cleanup coupon UI
 cleanupCouponUI(loadingText, offerList);
 return { success: false };
}

}

  // calculate subtotal
  const subtotal = getCart().reduce((sum, ci) => {
    const mrp = Number(ci.rate || 0);
    const disc = Number(ci.discPercent || 0);
    const qty = Number(ci.qty || 1);
    return sum + (mrp - (mrp * disc / 100)) * qty;
  }, 0);

  // ‚ùå MINIMUM FAIL
  if (subtotal < Number(o.min || 0)) {

    showCouponError(
      `Cannot apply <b>${o.text}</b><br>
       Minimum required: ${fmt(o.min)}<br>
       Your subtotal: ${fmt(subtotal)}`
    );
cleanupCouponUI(loadingText, offerList);
 return { success: false };
  }

  // ‚≠ê VERY IMPORTANT ‚Äî Save applied coupon ID for restore
  alreadyAppliedCouponId = couponId;

  // ‚úî APPLY COUPON
  selectedCoupon = o;
  showCouponSuccess(`üéâ ${o.text} applied successfully!`);

 if (String(couponId).startsWith("RW-")) {
  window._appliedCouponType = "reward";
}
 
// üîí Lock ONLY if reward coupon (extra safety)
if (String(couponId).startsWith("RW-")) {
  window._couponLocked = true;

  const availBox = document.getElementById("availableCouponsBox");
  if (availBox) availBox.classList.add("hidden");
}


  // hide offer list
  const listBox = document.getElementById("offerList");
  if (listBox) listBox.style.display = "none";

  // show applied message
 const appliedBox = document.getElementById("bestOfferApplied");
const appliedText = document.getElementById("appliedCouponText");
const appliedSub = document.getElementById("appliedCouponSubText");

if (appliedBox && appliedText && appliedSub) {
  appliedText.innerText = o.text;
  appliedSub.innerText = `Coupon code: ${couponId}`;
  appliedBox.style.display = "flex";
}


  updateDrawerTotals();
// üßπ FINAL CLEANUP AFTER COUPON RESULT
cleanupCouponUI(loadingText, offerList);

  // close list fully
  closeCouponList();
   return { success: false };
}

function applyUserCouponFromList(couponCode, couponType = "") {
  // üîí If already locked, stop
  if (window._couponLocked === true) {
    alert("Only one coupon can be applied per order");
    return;
  }

  // üîê Mark coupon type (reward / promo / paid)
  if (couponType) {
    window._appliedCouponType = couponType;
  }

  // üîÅ Forward to existing engine
  applyCoupon(couponCode);
}


function renderAvailableUserCoupons(coupons = []) {
  const box = document.getElementById("availableCouponsBox");
  const list = document.getElementById("availableCouponsList");

  if (!box || !list) return;

    if (window._appliedCouponType === "reward" && alreadyAppliedCouponId) {
  box.classList.add("hidden");
  return;
}

  // üîí STEP-6 SAFETY: coupon already applied ‚Üí hide list
//  if (window._couponLocked === true && window._appliedCouponType === "reward") {
 // box.classList.add("hidden");
 // return;
//}

  // reset
  list.innerHTML = "";

  if (!Array.isArray(coupons) || coupons.length === 0) {
    box.classList.add("hidden");
    return;
  }

  coupons.forEach(c => {
    // üö´ skip already-applied reward coupon ONLY
if (
  c.couponType === "reward" &&
  window._appliedCouponType === "reward" &&
  alreadyAppliedCouponId === c.couponcode
) {
  return;
}

    const div = document.createElement("div");
    div.className =
      "flex justify-between items-center p-2 border rounded bg-white";

   const label =
  c.couponType === "reward"
    ? "üéÅ Reward Coupon"
    : c.couponType === "paid"
    ? "üí∞ Paid Coupon"
    : "üè∑ Coupon";


    div.innerHTML = `
      <div>
        <div class="font-semibold">${label}</div>
        <div class="text-sm text-gray-600">
          ‚Çπ${c.flat} OFF ¬∑ Code: <b>${c.couponcode}</b>
        </div>
      </div>

     <button
  class="px-3 py-1 text-sm bg-green-600 text-white rounded"
 onclick="${
  (c.couponType === 'reward' || c.couponType === 'paid')
    ? `applyRewardCoupon('${c.couponcode}', ${Number(c.flat || 0)})`
    : `applyCoupon('${c.couponcode}')`
}"

>
  Apply
</button>

    `;

    // üî• FORCE RESET ‚Äì remove visual disabled state
const btn = div.querySelector("button");
if (btn) {
  btn.classList.remove("disabled-btn");
  btn.disabled = false;
  btn.style.pointerEvents = "auto";
  btn.style.opacity = "1";
}

    list.appendChild(div);
  });

  box.classList.remove("hidden");
}

async function fetchAndRenderUserCouponsForCart() {
  try {
    const mobile =
      localStorage.getItem("userMobile") ||
      localStorage.getItem("mobile");

    // ‚ùå not logged in ‚Üí hide box
    if (!mobile) {
      renderAvailableUserCoupons([]);
      return;
    }

    const res = await fetch(
      API_BASE +
        "?api=getUserCouponsForCart&mobile=" +
        encodeURIComponent(mobile)
    );

    const data = await res.json();

    if (!data || data.success !== true) {
      renderAvailableUserCoupons([]);
      return;
    }

    renderAvailableUserCoupons(data.coupons || []);
  } catch (err) {
    console.error("Failed to load user coupons", err);
    renderAvailableUserCoupons([]);
  }
}

  
// =====================================================
// G3: Remove ONETIME coupon automatically on qty change
// =====================================================
function removeCouponIfNeeded() {
  if (!selectedCoupon) return;

  const type = (selectedCoupon.type || "").toLowerCase();

  // ONLY onetime coupon should be auto-removed
  if (type === "onetime") {

    // üîÅ RESET COUPON STATE
    selectedCoupon = null;
    alreadyAppliedCouponId = "";
    window._couponLocked = false;
    window._appliedCouponType = "";

    // üîÅ UI RESET
    const appliedBox = document.getElementById("bestOfferApplied");
    if (appliedBox) appliedBox.style.display = "none";

    // üîÅ RESTORE AVAILABLE COUPONS
    fetchAndRenderUserCouponsForCart();

    // üîÅ MESSAGE
    showCouponError(
      "Your applied coupon is no longer valid after cart change. Please apply again."
    );

    // üîÅ TOTALS + HINT
    updateDrawerTotals();
    refreshCouponMotivationHint();
  }
}
function removeAppliedCoupon() {
  // 1Ô∏è‚É£ reset coupon state
  selectedCoupon = null;
  alreadyAppliedCouponId = "";
  window._couponLocked = false;
  window._appliedCouponType = "";

  // 2Ô∏è‚É£ UI reset
  const appliedBox = document.getElementById("bestOfferApplied");
  if (appliedBox) appliedBox.style.display = "none";

  // 3Ô∏è‚É£ restore available coupons
  fetchAndRenderUserCouponsForCart();

  // 4Ô∏è‚É£ totals + hint refresh
  try { updateDrawerTotals(); } catch(e){}
  try { refreshCouponMotivationHint(); } catch(e){}
}


// üî¥ RED error message
function showCouponError(msg) {
  const box = document.getElementById("couponMessage");
  if (!box) return;

  box.style.display = "block";
  box.style.background = "#ffefef";
  box.style.color = "#b30000";
  box.style.border = "1px solid #ffcccc";
  box.innerHTML = msg;

  setTimeout(() => {
    box.style.display = "none";
  }, 4000);
}

// üü¢ GREEN success message
function showCouponSuccess(msg) {
  const box = document.getElementById("couponMessage");
  if (!box) return;

  box.style.display = "block";
  box.style.background = "#ecffec";
  box.style.color = "#006600";
  box.style.border = "1px solid #b6ffb6";
  box.innerHTML = msg;

  setTimeout(() => {
    box.style.display = "none";
  }, 4000);
}


  
// STEP 1B ‚Üí Cart items ke image ko restore karne ka helper
function restoreCartImages(cartArr) {
  if (!Array.isArray(cartArr)) return [];

  return cartArr.map(ci => {
    ci = ci || {};

    // Agar image missing hai ‚Üí getMenuImage() se fetch karo
    if (!ci.image || String(ci.image).trim() === "") {
      ci.image = getMenuImage(ci.itemId, ci.variantId) || "";
    }

    return ci;
  });
}
  
function setCart(updatedCart) {

  if (!Array.isArray(updatedCart)) updatedCart = [];
 // ‚≠ê SAFETY FIREWALL ‚Äî remove invalid/blank items
  updatedCart = cleanCartInvalidItems(updatedCart);
  // 1) Update master engine globals
  cart = updatedCart;
  window.cart = updatedCart;

  // 2) Save to correct storage
  if (!isLoggedIn()) {
    localStorage.setItem("guestCart", JSON.stringify(updatedCart));
  } else {
    localStorage.setItem("cart", JSON.stringify(updatedCart));
  }

  // 3) UI update (FAST, NO BLOCK)
  refreshUI();

  // 4) Backend SAVE (DEBOUNCED ‚Äî prevents overwrite)
  if (isLoggedIn()) {

    if (window.cartSaveTimer)
      clearTimeout(window.cartSaveTimer);

    window.cartSaveTimer = setTimeout(() => {
      saveCartToBackend(updatedCart);
    }, 400);   // slightly increased debounce = safer
  }

  return updatedCart;
}
function refreshUI() {
  try { updateCartBadge(); } catch(e){}
  try { refreshCartDrawer(); } catch(e){}
  try { renderCart(); } catch(e){}
  try { updateDrawerTotals(); } catch(e){}
  //  MOST IMPORTANT: menu cards pe qty / ADD button sync
  try { restoreFullCartUI(); } catch(e){}
}

  
function findCartItem(itemId, variantId) {
  itemId = String(itemId || "");
  variantId = String(variantId || "");

  return cart.find(ci =>
    String(ci.itemId) === itemId &&
    String(ci.variantId || "") === variantId
  ) || null;
}
  
function variantPlus(itemId, variantId, idx) {

  itemId = String(itemId);
  variantId = String(variantId);

  const qtyTextId = `qtyText-${itemId}_${variantId}-${idx}`;
  const qtyEl = document.getElementById(qtyTextId);

  if (!qtyEl) return;

  let q = Number(qtyEl.innerText) + 1;
  qtyEl.innerText = q;

  try { animateQty(qtyTextId); } catch(e){}

  // MASTER ENGINE
  updateCart(itemId, variantId, "add");
}
  
function variantMinus(itemId, variantId, idx) {

  itemId = String(itemId);
  variantId = String(variantId);

  const qtyTextId = `qtyText-${itemId}_${variantId}-${idx}`;
  const boxId     = `box-${itemId}_${variantId}-${idx}`;

  const qtyEl = document.getElementById(qtyTextId);
  const boxEl = document.getElementById(boxId);

  if (!qtyEl) return;

  let q = Number(qtyEl.innerText);

  // If qty is 1 ‚Üí delete from UI
  if (q === 1) {

    qtyEl.innerText = "0";

    if (boxEl) boxEl.classList.add("hidden");

    // Untick radio button also
    const radios = document.querySelectorAll(
      `input[data-item-id="${itemId}"][data-variant-id="${variantId}"]`
    );
    radios.forEach(r => (r.checked = false));

    // MASTER ENGINE remove
    updateCart(itemId, variantId, "dec");

    return;
  }

  // Normal decrement
  q--;
  qtyEl.innerText = q;

  try { animateQty(qtyTextId); } catch(e){}

  // MASTER ENGINE
  updateCart(itemId, variantId, "dec");
}

  function restoreFullCartUI() {

  const cartArr = getCart();
  if (!Array.isArray(cartArr)) return;

  // RESET ALL UI FIRST
  document.querySelectorAll("div[id^='box-']").forEach(b => b.classList.add("hidden"));
  document.querySelectorAll("span[id^='qtyText-']").forEach(q => q.textContent = "");
  document.querySelectorAll("input[data-variant-id][data-item-id]").forEach(r => r.checked = false);

  document.querySelectorAll("[id^='qtyBox-']").forEach(b => b.classList.add("hidden"));
  document.querySelectorAll("[id^='addBtn-']").forEach(btn => btn.classList.remove("hidden"));


  // RESTORE FROM CART
  cartArr.forEach(ci => {

    const itemId = String(ci.itemId);
    const variantId = String(ci.variantId || "");
    const qty = Number(ci.qty || 1);

// SINGLE ITEMS (FIXED)
// -------------------------
if (!variantId) {

  const boxes = document.querySelectorAll(`div[id^="qtyBox-${itemId}-"]`);
  const texts = document.querySelectorAll(`span[id^="qtyText-${itemId}-"]`);
  const btns  = document.querySelectorAll(`button[id^="addBtn-${itemId}-"]`);

  boxes.forEach(b => b.classList.remove("hidden"));
  btns.forEach(b => b.classList.add("hidden"));

  texts.forEach(t => {
    t.textContent = qty;
  });

  return;
}

    // -------------------------
    // MULTI VARIANT ITEMS
    // -------------------------

    // All boxes of this variant (all card-index versions)
    const boxes = document.querySelectorAll(`div[id^="box-${itemId}_${variantId}-"]`);

    boxes.forEach(box => {
      box.classList.remove("hidden");

      const qtyLabel = box.querySelector(`span[id^="qtyText-${itemId}_${variantId}-"]`);
      if (qtyLabel) qtyLabel.textContent = qty;
    });

    // Tick all matching radios
    const radios = document.querySelectorAll(
      `input[data-item-id="${itemId}"][data-variant-id="${variantId}"]`
    );
    radios.forEach(r => (r.checked = true));
  });
}


  
function refreshCheckout() {

  const cartArr = getCart();
  const container = document.getElementById("checkoutItemsContainer");
  if (!container) return;

  container.innerHTML = "";

  let subtotal = 0;

  cartArr.forEach(ci => {

    const itemId = String(ci.itemId);
    const variantId = String(ci.variantId || "");
    const qty = Number(ci.qty || 1);

    const rate = Number(ci.rate || 0);
    const disc = Number(ci.discPercent || 0);

    const finalPrice = rate - (rate * disc / 100);
    const lineTotal = (finalPrice * qty).toFixed(2);

    subtotal += finalPrice * qty;

    const row = `
      <div class="checkout-row flex justify-between py-2 border-b">

        <div>
          <div class="font-semibold">${ci.name}</div>
          ${ci.unit ? `<div class="text-sm text-gray-500">${ci.unit}</div>` : ""}
        </div>

        <div class="flex items-center gap-3">

          <button class="px-2 bg-gray-300 rounded"
            onclick="updateCart('${itemId}', '${variantId}', 'dec'); refreshCheckout();">‚àí</button>

          <span class="font-semibold">${qty}</span>

          <button class="px-2 bg-gray-300 rounded"
            onclick="updateCart('${itemId}', '${variantId}', 'add'); refreshCheckout();">+</button>
        </div>

        <div class="font-semibold">${fmt(lineTotal)}</div>


      </div>
    `;

    container.insertAdjacentHTML("beforeend", row);
  });

  // Subtotal
  const subtotalEl = document.getElementById("checkoutSubtotal");
  if (subtotalEl) subtotalEl.textContent = fmt(subtotal);

}


function getCartForOrder() {

  const cartArr = getCart();  // master engine getter

  // Clean + prepare final order cart
  const finalList = cartArr.map(ci => ({

    itemId: String(ci.itemId || ""),
    variantId: String(ci.variantId || ""),

    name: ci.name || "",
    unit: ci.unit || "",

    qty: Number(ci.qty || 1),

    rate: Number(ci.rate || 0),
    discPercent: Number(ci.discPercent || 0),

    image: ci.image || ""
  }));

  return finalList;
}

function refreshCheckoutCart() {

  const cartArr = getCart();   // master engine getter
  const container = document.getElementById("checkoutCartContainer");

  if (!container) return;

  container.innerHTML = "";  // Reset checkout list

  let html = "";

  cartArr.forEach(ci => {

    const itemId = String(ci.itemId);
    const variantId = String(ci.variantId || "");
    const unitLabel = ci.unit ? `(${ci.unit})` : "";

    const qty = Number(ci.qty || 1);
    const rate = Number(ci.rate || 0);
    const disc = Number(ci.discPercent || 0);

    const priceAfterDisc = rate - (rate * disc / 100);
    const lineTotal = (priceAfterDisc * qty).toFixed(2);

    html += `
      <div class="checkout-row flex justify-between items-center py-2 border-b">
        
        <div class="flex flex-col">
          <span class="font-semibold">${ci.name} ${unitLabel}</span>
        </div>

        <div class="flex items-center gap-3">
          <span class="font-semibold">${qty}</span>
        </div>

        <div class="font-semibold">${fmt(lineTotal)}</div>


      </div>
    `;
  });

  container.innerHTML = html;
}

  function resetMenuUIForLogout() {

  // Hide all multi variant qty boxes
  document.querySelectorAll("div[id^='box-']").forEach(b => {
    b.classList.add("hidden");
  });

  // Show ADD buttons again
  document.querySelectorAll("[id^='addBtn-']").forEach(btn => {
    btn.classList.remove("hidden");
  });

  // Hide qtyBox for single items
  document.querySelectorAll("[id^='qtyBox-']").forEach(box => {
    box.classList.add("hidden");
  });

  // Reset all qtyText to 0 (not empty)
  document.querySelectorAll("span[id^='qtyText-']").forEach(q => {
    q.textContent = "0";
  });

  // Untick all multi variant radios
  document
    .querySelectorAll("input[data-variant-id][data-item-id]")
    .forEach(r => (r.checked = false));
}

function updateDrawerTotals() {

  const cartArr = getCart();
  let subtotal = 0;

  // ========== 1) Base Subtotal ==========
  cartArr.forEach(ci => {
    const mrp = Number(ci.rate || 0);
    const disc = Number(ci.discPercent || 0);
    const qty  = Number(ci.qty || 1);

    const priceAfterDisc = mrp - (mrp * disc / 100);
    subtotal += priceAfterDisc * qty;
  });

  subtotal = Number(subtotal.toFixed(2));

  // ‚≠ê If cart is empty ‚Üí force all values to zero
if (cartArr.length === 0) {

    const totalEl = document.getElementById("drawerTotalAmount");
  if (totalEl) totalEl.textContent = fmt(0);

  const taxBox = document.getElementById("taxSummary");
  if (taxBox) {
    taxBox.innerHTML = `
      <div class="text-right text-gray-700 space-y-1.5">
        <div class="flex justify-between"><span>Offer Discount:</span><span>- 0</span></div>
        <div class="flex justify-between"><span>Signup Discount:</span><span>- 0</span></div>
        <div class="flex justify-between"><span>Total after discount:</span><span>0</span></div>
        <div class="flex justify-between"><span>Service Charge:</span><span>0</span></div>
        <div class="flex justify-between"><span>Total after charges:</span><span>0</span></div>
        <div class="flex justify-between"><span>CGST:</span><span>0</span></div>
        <div class="flex justify-between"><span>SGST:</span><span>0</span></div>
        <div class="flex justify-between"><span>IGST:</span><span>0</span></div>
        <div class="flex justify-between font-bold text-lg"><span>Grand Total:</span><span>0</span></div>
      </div>
    `;
  }
  window._drawerTotals = {
    baseTotal: 0,
    offerDiscount: 0,
    signupDiscount: 0,
    payableAfterDiscount: 0,
    serviceAmt: 0,
    taxableAmount: 0,
    cgstAmt: 0,
    sgstAmt: 0,
    igstAmt: 0,
    grandTotal: 0
  };
  return;
}

  // ----------------------------------------
// ‚≠ê G4: REVALIDATE COUPON on totals update
// ----------------------------------------
if (selectedCoupon && (selectedCoupon.type === "onetime" || selectedCoupon.type === "regular"))
 {

    const min = Number(selectedCoupon.min || 0);

    if (subtotal < min) {
        selectedCoupon = null;
        alreadyAppliedCouponId = "";
        showCouponError("Coupon removed due to quantity/value change.");
    }
}


  // =====================================================
  // ‚≠ê‚≠ê RESTORE COUPON ON REFRESH (MAIN FIX)
  // =====================================================
  try {
    if (!selectedCoupon && alreadyAppliedCouponId && window.liveOffers) {
      const found = window.liveOffers.find(o => o.id === alreadyAppliedCouponId);
      if (found) selectedCoupon = found;
    }
  } catch (e) {}


  // =====================================================
  // ========== 2) COUPON & OFFER LOGIC ==================
  // =====================================================
  let offerDiscount = 0;
  let appliedOfferText = "";
let rewardHint = "";
  const mode = (window.couponMode || "").toLowerCase();

  // ------------ MANUAL MODE ---------------
  if (mode === "manualcoupon") {
// ‚≠ê STEP-3B: Reward partial usage hint


if (selectedCoupon && selectedCoupon.type === "reward") {
  const rewardValue = Number(selectedCoupon.flat || 0);

  if (subtotal < rewardValue) {
    const diff = rewardValue - subtotal;
    rewardHint = `Add ‚Çπ${diff} more to use the full reward`;

  } else {
    rewardHint = `Reward coupon fully applied`;
  }
}

    if (selectedCoupon) {
      const o = selectedCoupon;

      if (subtotal >= Number(o.min || 0)) {

        if (o.discount) {
          offerDiscount = subtotal * (o.discount / 100);
        }

if (o.flat) {

  // ‚≠ê STEP-3A: CAP reward discount to cart subtotal
  if (o.type === "reward") {
    offerDiscount = Math.min(Number(o.flat), subtotal);
  } else {
    offerDiscount = Number(o.flat);
  }

}


        offerDiscount = Number(offerDiscount.toFixed(2));
        appliedOfferText = `üéÅ ${o.text} applied`;

      } else {
        selectedCoupon = null;
      }
    }
  }

  // ------------ AUTO MODE -----------------
  else {
    const best = getBestOffer(subtotal);

    if (best) {
      offerDiscount = Number(best.value || 0);
      appliedOfferText = `üéâ ${best.text} (Saved ${fmt(offerDiscount)})`;
    }
  }


  // Update Offer Message Box
  const appliedBox = document.getElementById("bestOfferApplied");
 if (appliedBox) {
  if (offerDiscount > 0) {
    appliedBox.style.display = "block";

    appliedBox.innerHTML = `
      <div>${appliedOfferText}</div>
      ${
        rewardHint
          ? `<div class="text-sm text-red-600 mt-1">${rewardHint}</div>`
          : ``
      }
    `;
  } else {
    appliedBox.style.display = "none";
  }
}



  // ========== Subtotal after offer ==========
  let payable = subtotal - offerDiscount;
  if (payable < 0) payable = 0;
  payable = Number(payable.toFixed(2));


  // =====================================================
  // ‚≠ê‚≠ê 3) SIGNUP DISCOUNT APPLY (UI SIDE)
  // =====================================================
  let signupDiscount = 0;
  try {
    const mobile = localStorage.getItem("userMobile");
    if (mobile) {
      signupDiscount = Number(window.signupDiscount);
if (isNaN(signupDiscount)) signupDiscount = 0;

    }
  } catch (e) {}

  payable = payable - signupDiscount;
  if (payable < 0) payable = 0;
  payable = Number(payable.toFixed(2));


  // =====================================================
  // ========== 4) TAX + SERVICE CHARGE ==================
  // =====================================================
  const t = restaurantTax || {};

  let serviceAmt = 0;
  if (t.servicePercent > 0) {
    serviceAmt = payable * (t.servicePercent / 100);
  }

  let taxable = payable + serviceAmt;

  let cgstAmt = taxable * ((t.cgstPercent || 0) / 100);
  let sgstAmt = taxable * ((t.sgstPercent || 0) / 100);
  let igstAmt = taxable * ((t.igstPercent || 0) / 100);

  let grandTotal = taxable + cgstAmt + sgstAmt + igstAmt;

  serviceAmt  = Number(serviceAmt.toFixed(2));
  taxable     = Number(taxable.toFixed(2));
  cgstAmt     = Number(cgstAmt.toFixed(2));
  sgstAmt     = Number(sgstAmt.toFixed(2));
  igstAmt     = Number(igstAmt.toFixed(2));
  grandTotal  = Number(grandTotal.toFixed(2));


  // ========== UPDATE UI ==========
  const totalEl = document.getElementById("drawerTotalAmount");
  if (totalEl) totalEl.textContent = fmt(subtotal);

  const taxBox = document.getElementById("taxSummary");
  if (taxBox) {
   taxBox.innerHTML = `
      <div class="text-right text-gray-700 space-y-1.5">

        <div class="flex justify-between">
        <span>Offer Discount:</span>
        <span>- ${fmt(offerDiscount)}</span></div>

        ${signupDiscount > 0 
          ? `<div class="flex justify-between"><span>Signup Discount:</span><span>- ${fmt(signupDiscount)}</span></div>`
          : ``}

        <div class="flex justify-between"><span>Total after discount:</span>
        <span>${fmt(Number((subtotal - offerDiscount - signupDiscount).toFixed(2)))}</span></div>

        <div class="flex justify-between"><span>Service Charge (${t.servicePercent}%):</span>
        <span>${fmt(serviceAmt)}</span></div>

        <div class="flex justify-between"><span>Total after charges:</span>
        <span>${fmt(Number((payable + serviceAmt).toFixed(2)))}</span></div>

    <div class="flex justify-between"><span>CGST (${t.cgstPercent}%):</span> 
    <span>${fmt(cgstAmt)}</span></div>

    <div class="flex justify-between"><span>SGST (${t.sgstPercent}%): </span>
    <span>${fmt(sgstAmt)}</span></div>

    <div class="flex justify-between"><span>IGST (${t.igstPercent}%): </span>
    <span>${fmt(igstAmt)}</span></div>

    <div class="flex justify-between font-bold text-lg"><span>Grand Total: </span>
    <span>${fmt(grandTotal)}</span></div>

      </div>
    `;

  }
window._drawerTotals = {
    baseTotal: subtotal,
    offerDiscount: offerDiscount,
    signupDiscount: signupDiscount,
    payableAfterDiscount: payable,
    serviceAmt: serviceAmt,
    taxableAmount: taxable,
    cgstAmt: cgstAmt,
    sgstAmt: sgstAmt,
    igstAmt: igstAmt,
    grandTotal: grandTotal
  };

  try { updateCartBadge(); } catch(e){}
   refreshCouponMotivationHint();

}

async function fetchSignupDiscount(mobile) {
  try {
    let res = await apiPost("checkSignupDiscount", { mobile });

    if (res.success) {
      window.signupDiscount = Number(res.amount || 0);
      updateDrawerTotals();  // UI refresh
    }
  } catch (e) {
    console.error("Signup discount fetch error:", e);
  }
}

</script>
<div id="couponAlert"
     style="display:none; position:fixed; bottom:20px; left:50%; 
            transform:translateX(-50%); background:#ffdddd; 
            color:#b30000; padding:12px 18px; border-radius:8px;
            box-shadow:0 3px 12px rgba(0,0,0,0.15);
            font-size:15px; z-index:9999;">
</div>
<script>
function showCouponAlert(msg) {
  const box = document.getElementById("couponAlert");
  if (!box) return;

  box.innerHTML = msg;
  box.style.display = "block";

  setTimeout(() => {
    box.style.display = "none";
  }, 10000); // hide after 10 seconds
}
function showCouponMessage(msg) {
  const box = document.getElementById("couponMessage");
  if (!box) return;

  box.innerHTML = msg;
  box.style.display = "block";

  // auto hide after 3 seconds
  setTimeout(() => {
    box.style.display = "none";
  }, 3000);
}
 document.querySelectorAll(".payment-btn").forEach(btn => {
    btn.addEventListener("click", () => {

      // remove active from all
      document.querySelectorAll(".payment-btn").forEach(b => {
        b.classList.remove("bg-orange-500", "text-white", "border-orange-500");
      });

      // add active to clicked
      btn.classList.add("bg-orange-500", "text-white", "border-orange-500");

      // set hidden input value (IMPORTANT)
      document.getElementById("paymentMethod").value = btn.dataset.value;
    });
  });
async function loadPincodeDropdown() {
  const ddl = document.getElementById("newPincode");
  if (!ddl) return;

  ddl.innerHTML = `<option value="">Select Pincode</option>`;

  try {
    const res = await apiGet("getCityList");

    if (!res || !res.success || !Array.isArray(res.cities)) return;

    res.cities.forEach(r => {
      const opt = document.createElement("option");
      opt.value = r.pin; // only pin as value
      opt.textContent = `${r.pin} ‚Äì ${r.city}, ${r.state}`;
      ddl.appendChild(opt);
    });

  } catch (e) {
    console.error("Pincode load failed", e);
  }
}
  
function onNewPincodeChange() {
  const pin = document.getElementById("newPincode").value.trim();
  const cityInput  = document.getElementById("newCity");
  const stateInput = document.getElementById("newState");

  // reset on partial input
  if (pin.length < 6) {
    cityInput.value = "";
    stateInput.value = "";
    cityInput.disabled = false;
    stateInput.disabled = false;
    return;
  }

  // üîí show wait inside fields
  cityInput.value = "Checking‚Ä¶";
  stateInput.value = "Please wait";
  cityInput.disabled = true;
  stateInput.disabled = true;

  apiGet("getCityStateByPincode", { pincode: pin })
    .then(res => {
      if (res && res.found) {
        cityInput.value  = res.city || "";
        stateInput.value = res.state || "";
      } else {
        // manual entry allowed
        cityInput.value = "";
        stateInput.value = "";
      }
    })
    .catch(err => {
      console.error("Pincode lookup failed", err);
      cityInput.value = "";
      stateInput.value = "";
    })
    .finally(() => {
      cityInput.disabled = false;
      stateInput.disabled = false;
    });
}
// üîÅ Reuse existing pincode lookup for checkout
function onCheckoutPincodeChange() {
  const checkoutPin   = document.getElementById("pincode");
  const checkoutCity  = document.getElementById("city");
  const checkoutState = document.getElementById("state");

  // temporarily map checkout fields to newAddress IDs
  checkoutPin.id   = "newPincode";
  checkoutCity.id  = "newCity";
  checkoutState.id = "newState";

  onNewPincodeChange(); // üîÅ existing tested logic

  // restore original IDs
  checkoutPin.id   = "pincode";
  checkoutCity.id  = "city";
  checkoutState.id = "state";
}



function updateGuestFieldsVisibility() {
  const orderType = document.getElementById("orderType")?.value;

  const nameRow = document.getElementById("customerName")?.parentElement;
  const emailRow = document.getElementById("email")?.parentElement;
  const addressRow = document.getElementById("addressWrapper");

  // pehle sab hide
  if (nameRow) nameRow.style.display = "none";
  if (emailRow) emailRow.style.display = "none";
  if (addressRow) addressRow.style.display = "none";

  if (!orderType) return;

  // Dine In / Take Away
  if (orderType === "Dine In" || orderType === "Take Away") {
    if (nameRow) nameRow.style.display = "block";
    if (emailRow) emailRow.style.display = "block";
  }

  // Home Delivery
  if (orderType === "Home Delivery") {
    if (nameRow) nameRow.style.display = "block";
    if (emailRow) emailRow.style.display = "block";
    if (addressRow) addressRow.style.display = "block";
  }
}

document.addEventListener("DOMContentLoaded", function () {

  const buttons = document.querySelectorAll(".payment-btn");

  buttons.forEach(btn => {
    btn.addEventListener("click", function () {

      // sab se active hatao
      buttons.forEach(b => b.classList.remove("active"));

      // jispe click hua usko active banao
      this.classList.add("active");

      // hidden input set (placeOrder safe)
      document.getElementById("paymentMethod").value = this.dataset.value;

    });
  });

});


function onViewCartClick() {
  showCouponHintPlaceholder(); 
   showCouponHintPlaceholder(); // üî• FIX: always fires
  const drawer = document.getElementById("cartDrawer");
  if (!drawer) return;

  // CASE 1: drawer collapsed / hidden ‚Üí just expand it
  if (drawer.classList.contains("collapsed")) {
    drawer.classList.remove("collapsed");
    document.body.style.overflow = "hidden";

    // hide arrow
    const handle = document.getElementById("cartHandle");
    if (handle) handle.style.display = "none";

    window._drawerCollapsed = false;
    return;
  }

  // CASE 2: drawer not active at all ‚Üí normal open (full logic runs)
  if (!drawer.classList.contains("active")) {
    openCartDrawer();
    return;
  }

  // CASE 3: already open & visible ‚Üí do nothing
}

  window._rewardTextReady = false;

function showRewardBox(data, alreadyClaimed) {
  window._rewardAlreadyClaimed = alreadyClaimed === true;

  const box = document.getElementById("rewardBox");
  const text = document.getElementById("rewardText");
  const btn = document.getElementById("claimRewardBtn");
  const status = document.getElementById("rewardStatus");

  // üîí default hide + reset
  window._rewardTextReady = false;
  box.classList.add("hidden");

  if (!data) return;

  // ===============================
  // ‚úÖ ALREADY CLAIMED
  // ===============================
  if (alreadyClaimed || Number(data.remainingReward) <= 0) {
    text.innerText = "üéÅ Reward already claimed for this period";

    btn.style.display = "none";

    status.classList.remove("hidden");
    status.innerText = "You can use the coupon in checkout";
  }
  // ===============================
  // ‚úÖ ELIGIBLE (NOT CLAIMED)
  // ===============================
  else {
    text.innerText =
      `üéâ You are eligible for ‚Çπ${data.remainingReward} reward (${data.slabId})`;

    btn.style.display = "inline-block";
    status.classList.add("hidden");
  }

  // ‚úÖ text READY now
  window._rewardTextReady = true;

  // ‚úÖ show box
  box.classList.remove("hidden");

  // üîÅ cart ke hisaab se final decision
  toggleClaimRewardOnCart(getCart());
}

async function onClaimRewardClick() {
  try {
    const mobile =
      localStorage.getItem("userMobile") ||
      localStorage.getItem("mobile");

    if (!mobile) {
      alert("Please login first");
      return;
    }

    const btn = document.getElementById("claimRewardBtn");
    const status = document.getElementById("rewardStatus");

    btn.disabled = true;
    btn.innerText = "Claiming...";

    const res = await fetch(
      API_BASE + "?api=claimReward&mobile=" + mobile
    );

    const data = await res.json();
    console.log("claimReward response:", data);

    // ‚ùå failed
    if (!data.success) {
      status.classList.remove("hidden");
      status.innerText = data.reason || "Unable to claim reward";
      btn.disabled = false;
      btn.innerText = "Claim Reward";
      return;
    }

    // ‚úÖ SUCCESS UI
    const couponCode = data.couponcode;
    const rewardAmount = Number(data.amount || 0);
    const expiry = data.expiry_date;

    status.classList.remove("hidden");
    status.innerHTML =
      `üéâ Coupon <b>${couponCode}</b> of ‚Çπ${rewardAmount} generated.<br>
       Valid till ${new Date(expiry).toLocaleDateString()}`;

    // üîí mark reward claimed (UI logic)
    window._rewardAlreadyClaimed = true;
    toggleClaimRewardOnCart(getCart());
    btn.innerText = "Claimed";

    // üî• IMPORTANT: RESET any old coupon-applied state
    selectedCoupon = null;
    alreadyAppliedCouponId = "";
    window._appliedCouponType = "";
    window._couponLocked = false;

    // üî• AUTO APPLY REWARD (MINIMAL)
selectedCoupon = {
  id: couponCode,
  type: "reward",
  flat: rewardAmount,
  min: 0,
  text: `Reward ‚Çπ${rewardAmount} OFF`,
  active: true
};

alreadyAppliedCouponId = couponCode;
window._appliedCouponType = "reward";
window._couponLocked = true;

    // üîÑ FULL drawer refresh (cart + coupons + reward)
   openCartDrawer();

  } catch (err) {
    console.error(err);
    alert("Something went wrong");
  }
}



async function checkMonthlyRewardStatus() {
  const mobile =
    localStorage.getItem("userMobile") ||
    localStorage.getItem("mobile");

  if (!mobile) return;

  try {
    const res = await fetch(
      API_BASE + "?api=getMonthlyRewardEligibility&mobile=" + mobile
    );
    const data = await res.json();

    if (!data || data.eligible !== true) {
      document.getElementById("rewardBox").classList.add("hidden");
      return;
    }

    showRewardBox(data, false);

  } catch (e) {
    console.error("Reward check failed", e);
  }
}

async function checkAndShowMonthlyReward() {
  try {
    const mobile =
      localStorage.getItem("userMobile") ||
      localStorage.getItem("mobile");

    if (!mobile) return;

    const res = await fetch(
      API_BASE + "?api=getMonthlyRewardEligibility&mobile=" + mobile
    );

    const data = await res.json();
    console.log("Reward eligibility:", data);

    // ‚ùå Not eligible ‚Üí nothing to show
    if (!data.eligible) return;

    // ‚úÖ Already unlocked?
    const alreadyClaimed = Number(data.remainingReward || 0) <= 0;

    // üîí Global flag (important for cart / apply)
    window._rewardAlreadyClaimed = alreadyClaimed;

    console.log("rewardAlreadyClaimed =", alreadyClaimed);

    // ‚úÖ Show reward box
    showRewardBox(data, alreadyClaimed);

  } catch (err) {
    console.error("Reward check failed", err);
  }
}

  
async function loadAvailableCoupons() {
  const box = document.getElementById("availableCouponsBox");
  const list = document.getElementById("availableCouponsList");

  if (!box || !list) return;

  const mobile =
    localStorage.getItem("userMobile") ||
    document.getElementById("mobile")?.value ||
    "";

  if (!mobile) {
    box.classList.add("hidden");
    return;
  }

  list.innerHTML = "Loading coupons‚Ä¶";
  box.classList.remove("hidden");

  try {
    const res = await apiGet("getUserCoupons", { mobile });
console.log("üü° getUserCoupons response =", res);
    if (!res || !res.success || !Array.isArray(res.coupons) || res.coupons.length === 0) {
      box.classList.add("hidden");
      return;
    }

    list.innerHTML = "";

    res.coupons.forEach(c => {
      const div = document.createElement("div");
      div.className =
        "p-2 border rounded bg-white flex justify-between items-center";

      div.innerHTML = `
        <div>
          <div class="font-semibold">${c.couponcode}</div>
          <div class="text-sm text-gray-600">
            ‚Çπ${c.flat} OFF
          </div>
        </div>
        <button class="text-sm text-green-600 font-medium"
                onclick="applyCoupon('${c.couponcode}')">
          Apply
        </button>
      `;

      list.appendChild(div);
    });

  } catch (e) {
    console.error("loadAvailableCoupons error", e);
    box.classList.add("hidden");
  }
}

function applyRewardCoupon(couponCode, rewardAmount) {

  // üõë already applied ‚Üí do nothing
  if (
    window._appliedCouponType === "reward" &&
    alreadyAppliedCouponId === couponCode
  ) {
    return;
  }

  // üîí lock coupons (reward wins)
  window._couponLocked = true;
  window._appliedCouponType = "reward";

  // ‚ùå REMOVE any previously applied coupon
  selectedCoupon = null;
  alreadyAppliedCouponId = "";

  // ‚úÖ APPLY reward coupon
  selectedCoupon = {
    id: couponCode,
    type: "reward",
    flat: Number(rewardAmount),
    min: 0,
    text: `Reward ‚Çπ${rewardAmount} OFF`
  };

  alreadyAppliedCouponId = couponCode;

  // üîÑ recalc totals
  try {
    updateDrawerTotals();
  } catch (e) {}

  // üîÅ refresh reward UI
  toggleClaimRewardOnCart(getCart());

  // üö´ DISABLE normal coupon list
  const offerList = document.getElementById("offerList");
  if (offerList) {
    offerList.style.pointerEvents = "none";
    offerList.style.opacity = "0.5";
  }

  // üî¥ SHOW RED INFO MESSAGE
  const offerLoadingText = document.getElementById("offerLoadingText");
  if (offerLoadingText) {
    offerLoadingText.innerText =
      "Reward coupon already applied. Promotional offers cannot be used together.";
    offerLoadingText.style.display = "block";
    offerLoadingText.style.color = "#dc2626";
    offerLoadingText.style.fontSize = "14px";
    offerLoadingText.style.fontWeight = "600";
  }
}


async function refreshMonthlySpendAndReward() {
  const mobile = localStorage.getItem("userMobile");
  if (!mobile) return; // üë§ guest ignore

  try {
    // 1Ô∏è‚É£ Backend monthly spend rebuild (status-based, safe)
    await fetch(API_BASE + "?api=refreshMonthlySpend");

    // 2Ô∏è‚É£ Check reward eligibility for THIS user only
    const res = await fetch(
      API_BASE + "?api=checkMonthlyReward&mobile=" + encodeURIComponent(mobile)
    );

    const data = await res.json();

    if (data.ok && data.alreadyClaimed === false) {
      // ‚ö†Ô∏è function already exists / we‚Äôll wire later
      showClaimRewardBox(data.data);
    } else {
      hideClaimRewardBox();
    }

  } catch (err) {
    console.error("‚ùå Monthly reward refresh failed:", err);
  }
}

function hideClaimRewardBox() {
  const box = document.getElementById("rewardBox");
  if (box) box.classList.add("hidden");
}


// ===============================
// PROMO BANNER ‚Äì SHOW LOGIC
// ===============================
function showPromoBannerFromSheet() {
  // ‚ùå Logged-in users ‚Üí no banner
    if (isUserLoggedIn()) {
    const banner = document.getElementById("promoBanner");
    if (banner) banner.style.display = "none";
    return;
  }
  const banner = document.getElementById("promoBanner");
  const slidesWrap = document.getElementById("promoSlides");

  if (!banner || !slidesWrap) return;

  const offers = window._promoOffers || [];
  const today = new Date();

  // reset
  slidesWrap.innerHTML = "";
  promoIndex = 0;

  // üîç Filter eligible offers
  const eligible = offers.filter(o => {

    // ACTIVE only
    if (String(o.active).toLowerCase() !== "true") return false;

    // DATE check
   const start = new Date(new Date(o.startDate).toDateString());
const end   = new Date(new Date(o.endDate).toDateString());
const today = new Date(new Date().toDateString());

if (today < start || today > end) return false;

    // ONLY fill = Y
    return String(o.fill || "").trim().toUpperCase() === "Y";
  });

  console.log("RAW FILLS:", offers.map(o => `[${o.id}] -> "${o.fill}"`));
  console.log("ELIGIBLE OFFERS:", eligible);

  // ‚ùå Nothing to show
  if (eligible.length === 0) {
    banner.style.display = "none";
    return;
  }

  // üß± Build slides
  eligible.forEach(o => {
    const slide = document.createElement("div");

   
 slide.className =
  "min-w-full rounded-2xl bg-[#fffdfb] border border-transparent";



    slide.innerHTML = `
      <div class="p-5 min-h-[180px] flex items-center gap-4">

        <!-- ICON -->
        <div class="w-16 h-16 rounded-2xl bg-orange-100
                    flex items-center justify-center
                    shadow-md flex-shrink-0">
          <div class="w-8 h-8 text-orange-600">
            ${
              String(o.type).toLowerCase() === "signup"
                ? PROMO_SVGS.signup
                : o.flat > 0
                  ? PROMO_SVGS.flat
                  : PROMO_SVGS.percent
            }
          </div>
        </div>

        <!-- TEXT -->
        <div class="flex-1">
          <div class="text-xl font-extrabold text-gray-900 leading-snug">
            ${o.text}
          </div>

          <div class="text-sm text-gray-600 mt-1">
            ${
              Number(o.min || 0) > 0
                ? `Valid on orders above ${fmt(o.min)}`
                : "Limited time offer"
            }
          </div>

          <!-- CTA -->
  <button
  onclick="${
    String(o.type).toLowerCase() === 'signup'
      ? 'openSignup()'
      : 'openLogin()'
  }"
  class="mt-4
         bg-orange-100
         text-orange-600
         px-6 py-2.5
         rounded-full
         font-semibold text-sm
         shadow-md
         hover:bg-orange-200
         transition">
  ${
    String(o.type).toLowerCase() === "signup"
      ? "Signup"
      : "Login & Save"
  }
</button>
</div>

        <!-- RIGHT IMAGE -->
        <div class="
  w-24 h-24
  sm:w-28 sm:h-28
  md:w-32 md:h-32
  lg:w-36 lg:h-36
  rounded-2xl
  overflow-hidden
  flex-shrink-0
  bg-gray-100">

          <img
            src="${o.imageUrl || ''}"
            class="w-full h-full object-cover"
            alt="Offer Image" />
        </div>

      </div>
    `;

    slidesWrap.appendChild(slide);
  });

  // ‚úÖ show banner
  banner.style.display = "block";
  startPromoSlider();
}

  let promoIndex = 0;
let promoTimer = null;

function startPromoSlider() {
  const slides = document.getElementById("promoSlides");
  const dotsBox = document.getElementById("promoDots");

  if (!slides || slides.children.length <= 1) return;
if (!dotsBox) return;  
  const total = slides.children.length;
  dotsBox.innerHTML = "";

  // üîµ build dots
  for (let i = 0; i < total; i++) {
    const dot = document.createElement("span");
    dot.className =
      "w-2.5 h-2.5 rounded-full cursor-pointer bg-white/40";
    if (i === 0) dot.classList.add("bg-white");

    dot.onclick = () => {
      promoIndex = i;
      updatePromoSlide();
      restartPromoTimer();
    };

    dotsBox.appendChild(dot);
  }

  updatePromoSlide();
  restartPromoTimer();
  
}

function updatePromoSlide() {
  const slides = document.getElementById("promoSlides");
  const dots = document.querySelectorAll("#promoDots span");

  slides.style.transform = `translateX(-${promoIndex * 100}%)`;

  dots.forEach((d, i) => {
    d.classList.toggle("bg-white", i === promoIndex);
    d.classList.toggle("bg-white/40", i !== promoIndex);
  });
}

function restartPromoTimer() {
  clearInterval(promoTimer);
  promoTimer = setInterval(() => {
    const slides = document.getElementById("promoSlides");
    if (!slides) return;

    promoIndex = (promoIndex + 1) % slides.children.length;
    updatePromoSlide();
  }, 3500);
}

document.addEventListener("DOMContentLoaded", () => {
  fetchOffersForPromoBanner().then(() => {
    showPromoBannerFromSheet();
  });
});
document.addEventListener("DOMContentLoaded", () => {
  const loginBtn  = document.getElementById("loginBtn");
  const signupBtn = document.getElementById("signupBtn");
  const logoutBtn = document.getElementById("logoutBtn");
  const userBox   = document.getElementById("userInfoBox");

  const loggedIn = isUserLoggedIn();

  if (loggedIn) {
    if (loginBtn)  loginBtn.style.display = "none";
    if (signupBtn) signupBtn.style.display = "none";
    if (logoutBtn) logoutBtn.style.display = "inline-block";
    if (userBox)   userBox.classList.remove("hidden");
  } else {
    if (loginBtn)  loginBtn.style.display = "inline-block";
    if (signupBtn) signupBtn.style.display = "inline-block";
    if (logoutBtn) logoutBtn.style.display = "none";
    if (userBox)   userBox.classList.add("hidden");
  }
});

    function mapOffersToCoupons(offers = []) {
  return offers.map(o => ({
    couponcode: o.id,              // üî• REQUIRED
    flat: Number(o.flat || 0),
    discount: Number(o.discount || 0),
    couponType:
      o.type === "reward"
        ? "reward"
        : "normal",
    min: Number(o.min || 0),
    text: o.text
  }));
}
  
function mapPrepaidPackageToOffer(pkg) {
  if (!pkg) return null;

  return {
    id: "PREPAID_" + pkg.package_id,
    type: "prepaid",
    active: true,

    text: pkg.title,        // Prepaid Saving Coupon
     topText: pkg.description || "",
    min: null,              // üîë IMPORTANT
    discount: 1,            // so "UP TO OFFER" shows

  imageUrl: pkg.imageUrl || "",

    _prepaid: true,
    slabs: pkg.slabs || []
  };
}

async function onOffersPageOpen() {
  const grid = document.getElementById("offersPosterGrid");
  if (!grid) return;

  showOffersLoading(); // üîµ SHOW OVERLAY

  try {
    // üîë FETCH BOTH
    await fetchOffersFromBackend();
    await fetchPrepaidCoupons();

    const loggedIn = isUserLoggedIn();
    const offers =
      (window._lastOffersResponse && window._lastOffersResponse.offers) || [];

    // SAME FINAL FILTER (View Offers ke jaisa)
    const activeOffers = offers.filter(o => {
      if (o.type === "signup") return false;
      if (o.type === "onetime" && o._usedOnce === true) return false;

      const ua = (o.userApplicable || "All user").toLowerCase();
      if (ua === "registered user" && !loggedIn) return false;

      return o.active === true;
    });

    // üîπ APPEND PREPAID OFFER (CONTINUITY)
    if (
      Array.isArray(window._prepaidPackages) &&
      window._prepaidPackages.length > 0
    ) {
      const prepaidOffer = mapPrepaidPackageToOffer(
        window._prepaidPackages[0]
      );
      if (prepaidOffer) activeOffers.push(prepaidOffer);
    }

    grid.innerHTML = "";

    if (activeOffers.length === 0) {
      grid.innerHTML = `<div class="text-gray-500">No offers available</div>`;
      grid.classList.remove("hidden");
      return;
    }

    const colors = ["offer-blue", "offer-orange", "offer-pink", "offer-green"];

    activeOffers.forEach((o, i) => {
      const colorClass = colors[i % colors.length];

      const div = document.createElement("div");
      div.className = `offer-poster ${colorClass}`;

      div.onclick = () => {
        if (o.type === "prepaid") {
          openPrepaidForm();
        } else {
          showPage("menuPage");
        }
      };

      div.innerHTML = `
        <div class="offer-blob ${colorClass}"></div>

        <div class="offer-content">
          <div>
          <div class="offer-top">
  ${
    o.type === "prepaid"
      ? o.topText
      : (o.discount > 0 ? "UP TO OFFER" : "FLAT OFFER")
  }
</div>


            <div class="offer-title">
              ${o.text}
            </div>

            <div class="offer-sub">
              ${
                o.type === "prepaid"
                  ? o.slabs.map(s => s.display_text).join("<br>")
                  : (o.min ? `Valid above ${fmt(o.min)}` : "Limited time offer")
              }
            </div>
          </div>

          <button class="offer-cta-btn">Shop Now</button>
        </div>

        <div class="offer-img">
          <img src="${o.imageUrl || 'images/offer-food.png'}">
        </div>
      `;

      grid.appendChild(div);
    });

    grid.classList.remove("hidden");

  } catch (err) {
    console.error("Offers page load failed", err);
  } finally {
    hideOffersLoading(); // üîµ ALWAYS HIDE
  }
}




async function fetchPrepaidCoupons() {
  try {
    console.log("üü° Fetching prepaid coupons...");

    const res = await fetch(
      API_BASE + "?api=getprepaidcoupon"
    );

    const data = await res.json();

    if (!data || data.success !== true) {
      console.warn("‚ö†Ô∏è Prepaid coupon API failed", data);
      window._prepaidPackages = [];
      return;
    }

    // üîí SAFE GLOBAL STORE
    window._prepaidPackages = data.packages || [];

    console.log(
      "‚úÖ Prepaid coupons loaded:",
      window._prepaidPackages
    );

  } catch (err) {
    console.error("‚ùå fetchPrepaidCoupons error", err);
    window._prepaidPackages = [];
  }
}

  function testPrepaidData() {
  if (!Array.isArray(window._prepaidPackages)) {
    console.warn("‚ùå Prepaid packages not loaded");
    return;
  }

  console.log("üì¶ TOTAL PACKAGES:", window._prepaidPackages.length);

  window._prepaidPackages.forEach((pkg, i) => {
    console.log(`üì¶ Package ${i + 1}:`, {
      id: pkg.package_id,
      title: pkg.title,
      slabs: pkg.slabs?.length || 0
    });

    (pkg.slabs || []).forEach(s => {
      console.log("   ‚ñ∏ Slab:", s.display_text);
    });
  });

  console.log("‚úÖ Prepaid data structure verified");
}
function showOffersLoading() {
  document.getElementById("offersLoadingOverlay")?.classList.remove("hidden");
}

function hideOffersLoading() {
  document.getElementById("offersLoadingOverlay")?.classList.add("hidden");
}


  function openPrepaidForm() {
  const el = document.getElementById("prepaidFormOverlay");
  if (!el) return;
  el.classList.remove("hidden");
}

function closePrepaidForm() {
  const el = document.getElementById("prepaidFormOverlay");
  if (!el) return;
  el.classList.add("hidden");
}
  
 <!-- Prepaid Savings Coupon Form (script) -->
function getActivePrepaidSlabs() {
  const pkgs = window._prepaidPackages || [];
  if (!pkgs.length) return [];

  // assuming single prepaid package for now
  return (pkgs[0].slabs || []).filter(
    s => String(s.active).toLowerCase() === "true"
  );
}
  
function populateSlabDropdown(selectEl) {
  const slabs = getActivePrepaidSlabs();
  if (!selectEl) return;

  selectEl.innerHTML = `<option value="">Select Slab</option>`;

  slabs.forEach(s => {
    const opt = document.createElement("option");
    opt.value = s.slab_id;
    opt.textContent = s.slab_id;
    selectEl.appendChild(opt);
  });

  disableAlreadySelectedSlabs();
}

  function disableAlreadySelectedSlabs() {
  const selected = Array.from(
    document.querySelectorAll("#prepaidSlabRows select")
  )
    .map(s => s.value)
    .filter(Boolean);

  document
    .querySelectorAll("#prepaidSlabRows select")
    .forEach(sel => {
      Array.from(sel.options).forEach(opt => {
        if (!opt.value) return;
        opt.disabled = selected.includes(opt.value) && sel.value !== opt.value;
      });
    });
}

function addPrepaidSlabRow() {
  const tbody = document.getElementById("prepaidSlabRows");
  if (!tbody) return;

  const rows = tbody.querySelectorAll("tr");
if (rows.length) {
  const lastSelect = rows[rows.length - 1].querySelector("select");
  if (lastSelect && !lastSelect.value) {
    return; // ‚ùå last row blank ‚Üí don't add new row
  }
}

  const tr = document.createElement("tr");
  tr.className = "border-t";

  tr.innerHTML = `
    <td class="p-2">
      <select class="w-full border rounded px-2 py-1"
        onchange="onPrepaidSlabChange(this)">

        <option value="">Select Slab</option>
      </select>
    </td>

    <td class="p-2 text-right text-gray-500">‚Äî</td>
    <td class="p-2 text-right text-gray-500">‚Äî</td>
    <td class="p-2 text-right text-gray-500">‚Äî</td>
    <td class="p-2 text-right text-gray-500">‚Äî</td>

    <td class="p-2 text-center">
      <input type="number"
             min="1"
             value="1"
             class="w-16 border rounded px-2 py-1 text-center" />
    </td>

    <td class="p-2 text-right text-gray-500">‚Äî</td>

    <td class="p-2 text-center">
      <button onclick="removePrepaidRow(this)" class="text-gray-400">‚úï</button>
    </td>
  `;

  tbody.appendChild(tr);

  const select = tr.querySelector("select");
  populateSlabDropdown(select);
}

  function removePrepaidRow(btn) {
  const row = btn.closest("tr");
  if (!row) return;

  row.remove();
  disableAlreadySelectedSlabs();
    recalcTotalPayable(); 
}

  function openPrepaidForm() {
  const el = document.getElementById("prepaidFormOverlay");
  if (!el) return;

  el.classList.remove("hidden");

  // populate first row slab dropdown
  const firstSelect = el.querySelector("#prepaidSlabRows select");
  if (firstSelect) {
    populateSlabDropdown(firstSelect);
  }
}
  
function getSlabById(slabId) {
  const slabs = getActivePrepaidSlabs();
  return slabs.find(s => s.slab_id === slabId) || null;
}
  
function onPrepaidSlabChange(selectEl) {
  disableAlreadySelectedSlabs();

  const row = selectEl.closest("tr");
  if (!row) return;

  const slabId = selectEl.value;
  if (!slabId) {
    resetRow(row);
    recalcTotalPayable();
    return;
  }

  const slab = getSlabById(slabId);
  if (!slab) return;

  const buyAmount = Number(slab.buy_amount || 0);
  const discType  = slab.discount_type;
  const discVal   = Number(slab.discount_value || 0);

  let discountAmt = 0;
  if (discType === "percent") {
    discountAmt = Math.round((buyAmount * discVal) / 100);
  } else {
    discountAmt = discVal;
  }

  const netRate = buyAmount - discountAmt;

  // fill columns
  row.cells[1].innerText = buyAmount;
  row.cells[2].innerText = discType === "percent" ? discVal + "%" : discVal;
  row.cells[3].innerText = discountAmt;
  row.cells[4].innerText = netRate;

  // qty change listener
  const qtyInput = row.querySelector("input[type='number']");
  qtyInput.oninput = () => recalcRow(row);

  recalcRow(row);
}
  
function recalcRow(row) {
  const netRate = Number(row.cells[4].innerText || 0);
  const qtyInput = row.querySelector("input[type='number']");
  const qty = Math.max(1, Number(qtyInput.value || 1));

  qtyInput.value = qty;

  const netAmt = netRate * qty;
  row.cells[6].innerText = netAmt;

  recalcTotalPayable();
}
  
function resetRow(row) {
  row.cells[1].innerText = "‚Äî";
  row.cells[2].innerText = "‚Äî";
  row.cells[3].innerText = "‚Äî";
  row.cells[4].innerText = "‚Äî";
  row.cells[6].innerText = "‚Äî";

  const qtyInput = row.querySelector("input[type='number']");
  qtyInput.value = 1;
}
  
function recalcTotalPayable() {
  let total = 0;

  document.querySelectorAll("#prepaidSlabRows tr").forEach(row => {
    const val = Number(row.cells[6].innerText || 0);
    total += val;
  });

  const totalBox = document.querySelector("#prepaidFormOverlay .text-lg");
  if (totalBox) {
    totalBox.innerText = "Total Payable: ‚Çπ" + total;
  }
}

  function collectPrepaidPayload() {
  const rows = document.querySelectorAll("#prepaidSlabRows tr");
  if (!rows.length) return null;

  const mobile =
    localStorage.getItem("userMobile") ||
    localStorage.getItem("mobile") ||
    "";

  if (!mobile) {
    alert("Please login to continue");
    return null;
  }

  const orderGroupId =
    "PP-" + Date.now() + "-" + Math.floor(Math.random() * 1000);

  const pkg = window._prepaidPackages[0];
  const packageId = pkg.package_id;

  let items = [];
  let totalPayable = 0;

  rows.forEach(row => {
    const tds = row.querySelectorAll("td");
    const slabId = tds[0].querySelector("select").value;
    if (!slabId) return;

    const buyAmount = Number(tds[1].innerText || 0);
    const discount = tds[2].innerText;
    const discountAmt = Number(tds[3].innerText || 0);
    const netRate = Number(tds[4].innerText || 0);
    const qty = Number(tds[5].querySelector("input").value || 1);
    const netAmt = Number(tds[6].innerText || 0);

    totalPayable += netAmt;

    items.push({
      slab_id: slabId,
      buy_amount: buyAmount,
      discount_type: discount.includes("%") ? "percent" : "flat",
      discount_value: discount.replace("%", ""),
      discount_amt: discountAmt,
      net_rate: netRate,
      qty: qty,
      net_amount: netAmt
    });
  });

  if (!items.length) {
    alert("Please select at least one slab");
    return null;
  }

  return {
    order_group_id: orderGroupId,
    mobile,
    package_id: packageId,
    total_payable: totalPayable,
    items
  };
}

 async function submitPrepaidPurchase() {
  const payload = collectPrepaidPayload();
  if (!payload) return;

  disablePrepaidProceedBtn();   // üëà STEP-D
  showPrepaidProcessing();      // already done

  try {
    const url =
      API_BASE +
      "?api=savePrepaidPurchase" +
      "&data=" +
      encodeURIComponent(JSON.stringify(payload));

    const res = await fetch(url);
    const data = await res.json();

    hidePrepaidProcessing();    // STEP-C
    enablePrepaidProceedBtn();  // üëà STEP-D (SUCCESS)

    if (!data.success) {
      alert("Failed to save prepaid order");
      return;
    }

    alert("Prepaid order saved successfully (Payment pending)");
    resetPrepaidForm();
    closePrepaidForm();

  } catch (err) {
    console.error("Prepaid save failed", err);

    hidePrepaidProcessing();
    enablePrepaidProceedBtn();  // üëà STEP-D (ERROR)
    alert("Something went wrong");
  }
}

function resetPrepaidForm() {
  const tbody = document.getElementById("prepaidSlabRows");
  if (!tbody) return;

  // üî• Remove all existing rows
  tbody.innerHTML = "";

  // üîπ Insert fresh empty row
  const tr = document.createElement("tr");
  tr.className = "border-t";

  tr.innerHTML = `
    <td class="p-2">
      <select
        class="w-full border rounded px-2 py-1"
        onchange="onPrepaidSlabChange(this)">
        <option value="">Select Slab</option>
      </select>
    </td>

    <td class="p-2 text-right text-gray-500">‚Äî</td>
    <td class="p-2 text-right text-gray-500">‚Äî</td>
    <td class="p-2 text-right text-gray-500">‚Äî</td>
    <td class="p-2 text-right text-gray-500">‚Äî</td>

    <td class="p-2 text-center">
      <input type="number"
             min="1"
             value="1"
             class="w-16 border rounded px-2 py-1 text-center" />
    </td>

    <td class="p-2 text-right text-gray-500">‚Äî</td>

    <td class="p-2 text-center text-gray-300">‚úï</td>
  `;

  tbody.appendChild(tr);

  // üîπ Populate slab dropdown
  const select = tr.querySelector("select");
  populateSlabDropdown(select);

  // üîπ Reset total payable
  const totalBox = document.querySelector("#prepaidFormOverlay .text-lg");
  if (totalBox) {
    totalBox.innerText = "Total Payable: ‚Çπ0";
  }
}

  function showPrepaidProcessing() {
  const el = document.getElementById("prepaidProcessingOverlay");
  if (el) el.classList.remove("hidden");
}
  
function hidePrepaidProcessing() {
  const el = document.getElementById("prepaidProcessingOverlay");
  if (el) el.classList.add("hidden");
}

  function disablePrepaidProceedBtn() {
  const btn = document.getElementById("prepaidProceedBtn");
  if (!btn) return;

  btn.disabled = true;
  btn.dataset.originalText = btn.innerText;
  btn.innerText = "Processing...";
  btn.classList.add("opacity-60", "cursor-not-allowed");
}

  function enablePrepaidProceedBtn() {
  const btn = document.getElementById("prepaidProceedBtn");
  if (!btn) return;

  btn.disabled = false;
  btn.innerText = btn.dataset.originalText || "Proceed to Pay";
  btn.classList.remove("opacity-60", "cursor-not-allowed");
}

async function onMyCouponsPageOpen() {
  console.log("üî• loadMyCouponsPage CALLED");

  const page = document.getElementById("myCouponsPage");
  if (!page) return;

  // üîí Hide data blocks initially (prevent flash)
  const unusedBlock = document.getElementById("unusedCouponsBlock");
  const usedBlock = document.getElementById("usedCouponsBlock");

  if (unusedBlock) unusedBlock.classList.add("hidden");
  if (usedBlock) usedBlock.classList.add("hidden");

  // üîµ SHOW overlay (page load start)
  showMyCouponsOverlay();
  console.log("üü¢ overlay shown");

  try {
    const mobile =
      localStorage.getItem("userMobile") ||
      localStorage.getItem("mobile");

    if (!mobile) {
      console.warn("‚ö†Ô∏è No logged-in mobile found");
      page.style.display = "block";
      if (unusedBlock) {
        unusedBlock.classList.remove("hidden");
        document.getElementById("unusedCouponsList").innerHTML =
          `<div class="text-sm text-gray-500">No coupons available</div>`;
      }
      return;
    }

    const res = await fetch(
      API_BASE +
        "?api=getusercouponsummary&mobile=" +
        encodeURIComponent(mobile)
    );

    const data = await res.json();

    if (!data || data.success !== true) {
      console.error("‚ùå Coupon summary API failed", data);
      return;
    }

    const allCoupons = Array.isArray(data.coupons) ? data.coupons : [];

    const unused = [];
    const used = [];

    allCoupons.forEach(c => {
      const usedFlag = String(c.used || "").toLowerCase();
      if (usedFlag === "no") unused.push(c);
      else if (usedFlag === "yes") used.push(c);
    });

    console.log("üéüÔ∏è Coupon summary loaded", {
      total: allCoupons.length,
      unused: unused.length,
      used: used.length
    });

    // üîì SHOW PAGE AFTER DATA READY
    page.style.display = "block";

    // üî• Render unused
    if (unused.length > 0 && unusedBlock) {
      unusedBlock.classList.remove("hidden");
      renderUnusedCoupons(unused);
    }

    // üî• Render used
    if (used.length > 0 && usedBlock) {
      usedBlock.classList.remove("hidden");
      renderUsedCoupons(used);
    }

    // üîπ No coupons case
    if (unused.length === 0 && used.length === 0 && unusedBlock) {
      unusedBlock.classList.remove("hidden");
      document.getElementById("unusedCouponsList").innerHTML =
        `<div class="text-sm text-gray-500">No coupons available</div>`;
    }

  } catch (err) {
    console.error("‚ùå loadMyCouponsPage error", err);

  } finally {
    hideMyCouponsOverlay();
    console.log("üîµ overlay hidden");
  }
}


  
function renderUnusedCoupons(coupons) {
  const list = document.getElementById("unusedCouponsList");
  if (!list) {
    console.warn("unusedCouponsList not found");
    return;
  }

  list.innerHTML = "";

  if (!coupons || coupons.length === 0) {
    list.innerHTML =
      `<div class="text-sm text-gray-500">No unused coupons</div>`;
    return;
  }

  coupons.forEach(c => {
    list.innerHTML += `
      <div class="coupon-card available-coupon mb-3">
        <div class="font-semibold coupon-status">
          ${c.couponType === "paid" ? "üí∞" : "üéÅ"} ${c.couponcode}
        </div>
        <div class="text-sm coupon-status">
          ‚Çπ${c.flat} OFF
        </div>
        <div class="text-xs coupon-meta">
          Valid till: ${formatDateDMY(c.expiry_date)}
        </div>
      </div>
    `;
  });
}

  function renderUsedCoupons(coupons) {
  const block = document.getElementById("usedCouponsBlock");
  const list = document.getElementById("usedCouponsList");

  if (!block || !list) {
    console.warn("usedCouponsBlock/list not found");
    return;
  }

  list.innerHTML = "";

  if (!coupons || coupons.length === 0) {
    block.classList.add("hidden");
    return;
  }

  coupons.forEach(c => {
    list.innerHTML += `
      <div class="coupon-card used-coupon mb-3">
        <div class="coupon-body">
          
          <div class="font-semibold coupon-status">
            ${c.couponType === "paid" ? "üí∞" : "üéÅ"} ${c.couponcode}
          </div>

          <div class="text-sm coupon-status">
            ‚Çπ${c.flat} OFF
          </div>

          <div class="text-xs coupon-meta">
            Used on: ${formatDateDMY(c.useddate)}
          </div>

          ${
            c.orderId
              ? `<div class="text-xs coupon-meta">Order: ${c.orderId}</div>`
              : ""
          }
        </div>
      </div>
    `;
  });

  block.classList.remove("hidden");
}


function formatDateDMY(dateStr) {
  if (!dateStr) return "-";

  const d = new Date(dateStr);
  if (isNaN(d)) return "-";

  const day = String(d.getDate()).padStart(2, "0");
  const monthNames = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
  const month = monthNames[d.getMonth()];
  const year = d.getFullYear();

  return `${day}-${month}-${year}`;
}


function showMyCouponsOverlay() {
  const o = document.getElementById("myCouponsOverlay");
  if (!o) return;

  o.classList.remove("hidden"); // ‚úÖ ONLY THIS
}

function hideMyCouponsOverlay() {
  const o = document.getElementById("myCouponsOverlay");
  if (!o) return;

  o.classList.add("hidden"); // ‚úÖ ONLY THIS
}

function testMyCouponsOverlay() {
  const o = document.getElementById("myCouponsOverlay");
  console.log("myCouponsOverlay element =", o);

  if (!o) {
    alert("‚ùå myCouponsOverlay DOM me hi nahi hai");
    return;
  }

  // force visible
  o.classList.remove("hidden");

  // safety force (sirf test ke liye)
  o.style.display = "flex";
  o.style.zIndex = "99999";

  console.log("‚úÖ overlay force shown");
}

  document.addEventListener("DOMContentLoaded", () => {
  const overlay = document.getElementById("myCouponsOverlay");
  if (overlay && overlay.parentElement !== document.body) {
    document.body.appendChild(overlay);
    console.log("‚úÖ myCouponsOverlay moved to BODY");
  }
});


async function loadMyOrdersSection() {
  const mobile =
    localStorage.getItem("userMobile") ||
    localStorage.getItem("mobile");

  const activeBox = document.getElementById("activeOrdersSection");
  const dispatchedBox = document.getElementById("dispatchedOrdersSection");
  if (!activeBox || !dispatchedBox) return;

  // üî• SHOW LOADING ON BOTH
  activeBox.innerHTML =
    "<div class='text-center text-gray-400 py-6'>Loading orders...</div>";
  dispatchedBox.innerHTML =
    "<div class='text-center text-gray-400 py-6'>Loading orders...</div>";

  if (!mobile) {
    activeBox.innerHTML =
      "<p class='text-gray-500'>Please login to view orders</p>";
    dispatchedBox.innerHTML = "";
    return;
  }

  try {
    const res = await fetch(
      API_BASE +
        "?api=getUserOrders&mobile=" +
        encodeURIComponent(mobile)
    );

    const data = await res.json();

    if (!data || data.success !== true) {
      throw new Error("Order fetch failed");
    }

    renderMyActiveOrders(data.activeOrders || []);
    renderMyDispatchedOrders(data.dispatchedOrders || []);

  } catch (err) {
    console.error("My Orders error:", err);
    activeBox.innerHTML =
      "<p class='text-red-500'>Failed to load orders</p>";
    dispatchedBox.innerHTML =
      "<p class='text-red-500'>Failed to load orders</p>";
  }
}

function renderMyActiveOrders(orders = []) {
  const box = document.getElementById("activeOrdersSection");
  if (!box) return;

  box.innerHTML = "";

  if (!orders.length) {
    box.innerHTML = `
      <div class="text-center text-gray-500 py-6">
        No active orders
      </div>`;
    return;
  }

  orders.forEach(o => {
    const div = document.createElement("div");
    div.className =
      "border rounded-lg p-3 mb-3 bg-white shadow-sm text-sm";

    div.innerHTML = `
      <!-- HEADER -->
      <div class="flex justify-between items-start">
        <div class="font-semibold text-gray-800">
          ${o.orderNumber}
        </div>

        <!-- STATUS + BUTTON -->
        <div class="text-right">
          <span class="inline-block px-2 py-0.5 rounded bg-orange-100 text-orange-600 text-xs">
            ${o.orderStatus}
          </span>

          <button
            class="mt-1 px-3 py-0.5 text-xs border border-orange-500 text-orange-600 rounded hover:bg-orange-500 hover:text-white transition"
            onclick="openInvoiceModal('${o.orderId}')">
            View Invoice
          </button>
        </div>
      </div>

      <div class="text-xs text-gray-500 mt-1">
        ${new Date(o.timestamp).toLocaleString()}
      </div>

      <div class="mt-1 text-xs">
        <b>Type:</b> ${o.orderType}
      </div>

      ${o.fullAddress ? `
        <div class="mt-1 text-xs text-gray-600">
          ${o.fullAddress}
        </div>` : ""}

      <div class="mt-2 flex justify-between items-center">
        <div class="text-xs text-gray-600">
          ${o.paymentMethod}
        </div>
        <div class="font-semibold">
          ${fmt(o.totalAmount)}
        </div>
      </div>
    `;

    box.appendChild(div);
  });
}

function renderMyDispatchedOrders(orders = []) {
  const box = document.getElementById("dispatchedOrdersSection");
  if (!box) return;

  box.innerHTML = "";

  if (!orders.length) {
    box.innerHTML = `
      <div class="text-center text-gray-500 py-6">
        No dispatched orders
      </div>`;
    return;
  }

  orders.forEach(o => {
    const div = document.createElement("div");
    div.className =
      "border rounded-lg p-3 mb-3 bg-gray-50 text-sm";

    div.innerHTML = `
      <!-- HEADER -->
      <div class="flex justify-between items-start">
        <div class="font-semibold text-gray-800">
          ${o.orderNumber}
        </div>

        <!-- STATUS + BUTTON -->
        <div class="text-right">
          <span class="inline-block px-2 py-0.5 rounded bg-green-100 text-green-700 text-xs">
            ${o.orderStatus}
          </span>

          <button
            class="mt-1 px-3 py-0.5 text-xs border border-orange-500 text-orange-600 rounded hover:bg-orange-500 hover:text-white transition"
            onclick="openInvoiceModal('${o.orderId}')">
            View Invoice
          </button>
        </div>
      </div>

      <div class="text-xs text-gray-500 mt-1">
        ${new Date(o.timestamp).toLocaleString()}
      </div>

      <div class="mt-1 text-xs">
        <b>Type:</b> ${o.orderType}
      </div>

      <div class="mt-2 flex justify-between items-center">
        <div class="text-xs text-gray-600">
          ${o.paymentMethod}
        </div>
        <div class="font-semibold">
          ${fmt(o.totalAmount)}
        </div>
      </div>
    `;

    box.appendChild(div);
  });
}


async function openInvoiceModal(orderId) {
  console.log("üßæ View Invoice clicked:", orderId);

  const modal = document.getElementById("invoiceModal");
  if (!modal) {
    console.error("invoiceModal not found");
    return;
  }

  modal.classList.remove("hidden");

  // üî¥ CLEAR OLD INVOICE DATA (CRITICAL FIX)
  document.getElementById("invoiceHeader").innerText = "Loading...";
  document.getElementById("invOrderId").innerText = "";
  document.getElementById("invInvoiceMeta").innerHTML = "";
const orderTypeBox = document.getElementById("invOrderType");
if (orderTypeBox) {
  orderTypeBox.innerHTML = "";
}

  document.getElementById("invCustomer").innerText = "";
  document.getElementById("invContact").innerText = "";
  document.getElementById("invAddress").innerText = "";
  document.getElementById("invBase").innerHTML = "";
  document.getElementById("invService").innerHTML = "";
  document.getElementById("invTax").innerHTML = "";
  document.getElementById("invCoupon").innerHTML = "";
  document.getElementById("invNet").innerText = "";
  document.getElementById("invPayment").innerText = "";
  document.querySelectorAll(".inv-tax-row").forEach(e => e.remove());

  const itemsBox = document.getElementById("invoiceItems");
  if (itemsBox) {
    itemsBox.innerHTML =
      "<div class='text-gray-400 text-sm'>Loading invoice...</div>";
  }

  try {
    const res = await fetch(
      API_BASE +
        "?api=getOrderInvoice&orderId=" +
        encodeURIComponent(orderId)
    );

    const data = await res.json();

    if (!data || data.success !== true) {
      throw new Error("API failed");
    }

    renderInvoiceFromAPI(data.invoice);

  } catch (err) {
    console.error("Invoice load error:", err);
    if (itemsBox) {
      itemsBox.innerHTML =
        "<div class='text-red-500 text-sm'>Failed to load invoice</div>";
    }
  }
}


  function closeInvoiceModal() {
  const modal = document.getElementById("invoiceModal");
  if (modal) modal.classList.add("hidden");
}

function formatInvoiceDate(dt) {
  if (!dt) return "";
  const d = new Date(dt);
  if (isNaN(d)) return dt;

  const dd = String(d.getDate()).padStart(2, "0");
  const mm = d.toLocaleString("en-GB", { month: "short" });
  const yyyy = d.getFullYear();

  return `${dd}-${mm}-${yyyy}`;
}

function renderInvoiceFromAPI(inv) {
  console.log("API INV OBJECT:", JSON.parse(JSON.stringify(inv)));

  /* ================= HEADER ================= */
  const orderDt = new Date(inv.orderDate).toLocaleString();
  document.getElementById("invoiceHeader").innerText =
    `${inv.orderNumber} ‚Ä¢ ${orderDt}`;

  const orderIdBox = document.getElementById("invOrderId");
  if (orderIdBox) {
    if (inv.orderId && String(inv.orderId).trim() !== "" && inv.orderId !== "-") {
      orderIdBox.classList.remove("hidden");
      orderIdBox.innerText = `Order ID: ${inv.orderId}`;
    } else {
      orderIdBox.classList.add("hidden");
      orderIdBox.innerText = "";
    }
  }

  const orderTypeBox = document.getElementById("invOrderType");
  if (orderTypeBox && inv.orderType) {
    orderTypeBox.classList.remove("hidden");
    orderTypeBox.innerHTML = `
      <div class="grid grid-cols-[140px_auto] gap-1 mt-1">
        <span class="font-semibold">Order Type</span>
        <span>: ${inv.orderType}</span>
      </div>`;
  }

  /* ================= CUSTOMER ================= */
  document.getElementById("invCustomer").innerHTML = `
    <div class="grid grid-cols-[140px_auto] gap-1">
      <span class="font-semibold">Name</span>
      <span>: ${inv.customerName || ""}</span>
    </div>`;

  document.getElementById("invContact").innerHTML = `
    <div class="grid grid-cols-[140px_auto] gap-1">
      <span class="font-semibold">Mobile / Email</span>
      <span>: ${inv.mobile || ""} / ${inv.email || ""}</span>
    </div>`;

  const addrBox = document.getElementById("invAddress");
  if (inv.address) {
    addrBox.classList.remove("hidden");
    addrBox.innerHTML = `
      <div class="grid grid-cols-[140px_auto] gap-1">
        <span class="font-semibold">Address</span>
        <span>: ${inv.address}</span>
      </div>`;
  } else addrBox.classList.add("hidden");

  /* ================= ITEMS ================= */
  document.getElementById("invoiceItems").innerHTML =
    (inv.items || []).map((i, idx) => {
      const qty = Number(i.qty || 0);
      const rate = Number(i.rate || 0);
      const gross = qty * rate;
      const net = Number(i.amount || gross);
      const disc = gross - net;

      return `
        <div class="border-b pb-2 mb-2">
          <div class="font-semibold">
            ${idx + 1}. ${i.name}
            <span class="text-xs text-gray-500">(${i.unit})</span>
          </div>
          <div class="text-xs text-gray-600">
            Qty ${qty} √ó ${fmt(rate)} = ${fmt(gross)}
          </div>
          ${disc > 0 ? `<div class="text-xs text-green-600">Item Discount: ‚àí${fmt(disc)}</div>` : ""}
          <div class="flex justify-between text-sm font-medium">
            <span>Item Total</span>
            <span>${fmt(net)}</span>
          </div>
        </div>`;
    }).join("");

  /* ================= ORDER TYPE CHARGES ================= */
  const orderType = inv.orderType || "";
  let serviceAmt = 0;
  let deliveryAmt = 0;

  if (orderType === "Dine In") {
    serviceAmt = Number(inv.serviceAmt || 0);
  } else if (orderType === "Home Delivery" || orderType === "Courier") {
    deliveryAmt = Number(inv.deliveryCharge || 0);
  }

  /* ================= BASE & COUPONS ================= */
  const items = Number(inv.baseTotal || 0);

  const normalCoupon = Number(inv.couponAmount || 0);
  const signup = Number(inv.signupDiscount || 0);
  const reward = Number(inv.rewardDiscount || 0);
  const paid = Number(inv.paidCouponDiscount || 0);

  // Actual selling price
  const grossValue = items - normalCoupon;

  // What customer pays before tax
  const afterAllDiscounts = grossValue - signup - reward - paid;

  // üî• FINAL GST BASE
  const gstBase = grossValue + serviceAmt + deliveryAmt;

  /* ================= GST ================= */
  const cgstRate = Number(inv.cgstPercent || 0);
  const sgstRate = Number(inv.sgstPercent || 0);
  const igstRate = Number(inv.igstPercent || 0);

  const cgst = gstBase * cgstRate / 100;
  const sgst = gstBase * sgstRate / 100;
  const igst = gstBase * igstRate / 100;
  const taxTotal = cgst + sgst + igst;

  /* ================= NET ================= */
  const netPayable =
    (afterAllDiscounts + serviceAmt + deliveryAmt) + taxTotal;

  /* ================= RENDER TOTALS ================= */
  // 1Ô∏è‚É£ Items
document.getElementById("invBase").innerHTML = `
  <div class="flex justify-between font-semibold">
    <span>Items Subtotal</span>
    <span>${fmt(items)}</span>
  </div>`;

// 2Ô∏è‚É£ Normal Coupon + Gross
const c = document.getElementById("invCoupon");
if (normalCoupon > 0) {
  c.classList.remove("hidden");
  c.innerHTML = `
    <div class="flex justify-between text-green-600">
      <span>Normal Coupon</span>
      <span>‚àí${fmt(normalCoupon)}</span>
    </div>
    <div class="flex justify-between font-semibold text-gray-900">
      <span>Gross Value</span>
      <span>${fmt(grossValue)}</span>
    </div>`;
} else {
  c.classList.add("hidden");
}

// 3Ô∏è‚É£ Service / Delivery
const deliveryBox = document.getElementById("invDelivery");
const serviceBox  = document.getElementById("invService");

if (deliveryAmt > 0) {
  deliveryBox.classList.remove("hidden");
  deliveryBox.innerHTML = `
    <div class="flex justify-between">
      <span>${inv.deliveryChargeLabel || "Delivery Charges"}</span>
      <span>${fmt(deliveryAmt)}</span>
    </div>`;
} else deliveryBox.classList.add("hidden");

if (serviceAmt > 0) {
  serviceBox.classList.remove("hidden");
  serviceBox.innerHTML = `
    <div class="flex justify-between">
      <span>Service Charges</span>
      <span>${fmt(serviceAmt)}</span>
    </div>`;
} else serviceBox.classList.add("hidden");

// 4Ô∏è‚É£ Tax block
const taxBox = document.getElementById("invTax");
taxBox.innerHTML = `
  <div class="flex justify-between font-semibold">
    <span>Taxable Amount</span>
    <span>${fmt(gstBase)}</span>
  </div>
  <div class="flex justify-between">
    <span>CGST</span>
    <span>${fmt(cgst)}</span>
  </div>
  <div class="flex justify-between">
    <span>SGST</span>
    <span>${fmt(sgst)}</span>
  </div>
  <div class="flex justify-between font-semibold">
    <span>Bill Amount</span>
    <span>${fmt(gstBase + taxTotal)}</span>
  </div>`;

// 5Ô∏è‚É£ Signup Discount (after Bill)
const signupBox = document.getElementById("invSignup");
if (signup > 0) {
  signupBox.classList.remove("hidden");
  signupBox.innerHTML = `
    <div class="flex justify-between text-green-600">
      <span>Signup Discount</span>
      <span>‚àí${fmt(signup)}</span>
    </div>`;
} else {
  signupBox.classList.add("hidden");
}

  document.getElementById("invNet").innerText = fmt(netPayable);
  document.getElementById("invPayment").innerText =
    `Payment: ${inv.paymentMethod || ""}`;

  /* ================= SNAPSHOT ================= */
  window._checkoutInvoice = {
    items: (inv.items || []).map(i => ({ ...i })),
    itemsSubtotal: items,
    serviceCharge: serviceAmt,
    deliveryCharge: deliveryAmt,
    normalCoupon,
    signupDiscount: signup,
    rewardDiscount: reward,
    paidCouponDiscount: paid,
    taxableAmount: gstBase,
    cgst, sgst, igst,
    taxTotal,
    netPayable,
    couponId: inv.couponId || "",
    paymentMethod: inv.paymentMethod || ""
  };

  console.log("üîê CHECKOUT SNAPSHOT LOCKED:", window._checkoutInvoice);
}


  function buildCheckoutPreviewInv() {
console.log("üöö ELIGIBILITY USED:", window.orderEligibility);

  // üîí SINGLE SOURCE OF TRUTH (drawer cart snapshot for amounts only)
  const s = window.cartSummary || {};
  const d = window._drawerTotals || {};

  const orderType = document.getElementById("orderType")?.value || "";
  const eligibility = window.orderEligibility || {};
  const isOrderTypeChosen = orderType && orderType !== "Select Order Type";

  /* ======================
     BASE & COUPONS
  ====================== */
const base = Number(d.baseTotal || 0);

const normalCoupon = Number(s.couponAmount || 0);
const signup = Number(s.signupDiscount || 0);
const reward = Number(s.rewardDiscount || 0);
const paid   = Number(s.paidCouponDiscount || 0);


  // Sale value after ONLY normal coupon
  const grossValue = base - normalCoupon;

  // What customer pays before tax
  const afterAllDiscounts = grossValue - signup - reward - paid;

  /* ======================
     SERVICE / DELIVERY (on GROSS VALUE)
  ====================== */
  let serviceAmt = 0;
  let deliveryAmt = 0;
  let deliveryChargeLabel = "";

  const servicePercent  = Number(window.servicePercent || 0) / 100;
  const deliveryPercent = Number(window.deliveryPercent || 0) / 100;

  if (isOrderTypeChosen) {
  if (orderType === "Dine In") {
    serviceAmt = grossValue * servicePercent;
  }
  else if (orderType === "Home Delivery" || orderType === "Courier") {
    // üî• Delivery ALWAYS from backend eligibility
   deliveryAmt = Number(window.orderEligibility?.extraCharge || 0);
  deliveryChargeLabel = window.orderEligibility?.chargeType || "Delivery Charges";
  }
}


  /* ======================
     GST RULES
  ====================== */
  const cgstRate = Number(window.cgstPercent || 0) / 100;
  const sgstRate = Number(window.sgstPercent || 0) / 100;
  const igstRate = Number(window.igstPercent || 0) / 100;

  // GST base = Gross value + Service/Delivery
  const gstBase = grossValue + serviceAmt + deliveryAmt;

  /* ======================
     TAX AMOUNTS
  ====================== */
  const cgst = gstBase * cgstRate;
  const sgst = gstBase * sgstRate;
  const igst = gstBase * igstRate;
  const taxTotal = cgst + sgst + igst;

  /* ======================
     NET PAYABLE
  ====================== */
  const netPayable =
    (afterAllDiscounts + serviceAmt + deliveryAmt) + taxTotal;

  console.log("üß™ PREVIEW DEBUG", {
    orderType,
    grossValue,
    serviceAmt,
    deliveryAmt,
    gstBase,
    afterAllDiscounts,
    netPayable
  });

  /* ======================
     RETURN PAYLOAD
  ====================== */
  return {
    // ===== HEADER =====
    orderNumber: "PREVIEW",
    orderDate: new Date(),
    orderId: "-",
    orderType,
    deliveryCharge: deliveryAmt,
    deliveryChargeLabel,

    // ===== CUSTOMER =====
    customerName: document.getElementById("customerName")?.value || "",
    mobile: document.getElementById("mobile")?.value || "",
    email: document.getElementById("email")?.value || "",
    address: document.getElementById("address")?.value || "",

    // ===== ITEMS =====
    items: s.items || [],

    // ===== TOTALS =====
    baseTotal: base,
    serviceAmt,
    taxableAmount: gstBase,
    cgstAmt: cgst,
    sgstAmt: sgst,
    igstAmt: igst,
    taxTotal,
    netPayable,
cgstPercent: window.cgstPercent,
sgstPercent: window.sgstPercent,
igstPercent: window.igstPercent,
gstOnDiscountedAmount: window.gstOnDiscountedAmount,
    
    // ===== COUPONS =====
   couponAmount: Number(s.couponAmount || 0),
normalCoupon: Number(s.couponAmount || 0),

    rewardDiscount: reward,
    paidCouponDiscount: paid,
    signupDiscount: signup,

    // ===== PAYMENT =====
    paymentMethod: document.getElementById("paymentMethod")?.value || ""
  };
}

function syncCouponFromDrawerForCheckout() {
  if (!window.cartSummary) return;
  if (!window._drawerTotals) return;

  // agar cartSummary me coupon missing hai
  if (
    (!window.cartSummary.couponAmount || window.cartSummary.couponAmount === 0) &&
    window._drawerTotals.offerDiscount > 0
  ) {
    window.cartSummary = {
      ...window.cartSummary,
      couponAmount: window._drawerTotals.offerDiscount,
      totalDiscount:
        Number(window._drawerTotals.offerDiscount || 0) +
        Number(window.cartSummary.signupDiscount || 0)
    };
  }
}

function injectCheckoutOfferDiscount(inv) {
  if (!inv || !inv.couponAmount || inv.couponAmount <= 0) return;

  const container = document.querySelector("#checkoutInvoiceContainer");
  if (!container) return;
if (container.innerText.includes("Coupon")) return;

  // already injected? ‚Üí avoid duplicate
  if (container.querySelector(".offer-discount-row")) return;

  const row = document.createElement("div");
  row.className = "offer-discount-row flex justify-between text-green-600 mt-2";

  row.innerHTML = `
    <span>Offer Discount</span>
    <span>- ${fmt(inv.couponAmount)}</span>
  `;

  // üëâ INSERT BEFORE NET PAYABLE (safe spot)
  const netPayableRow = container.querySelector(".net-payable-row");
  if (netPayableRow) {
    netPayableRow.before(row);
  } else {
    container.appendChild(row);
  }
}

  function lockCheckout(text = "Updating cart‚Ä¶") {
  const btn = document.getElementById("checkoutBtn");
  if (!btn) return;

  btn.disabled = true;
  btn.dataset.originalText = btn.innerText;
  btn.innerText = text;

  // üî• Visual lock
  btn.classList.add("opacity-40");
  btn.style.backgroundColor = "#9ca3af";   // Tailwind gray-400
  btn.style.cursor = "not-allowed";
}

  
function unlockCheckout() {
  const btn = document.getElementById("checkoutBtn");
  if (!btn) return;

  btn.disabled = false;
  btn.innerText = btn.dataset.originalText || "Checkout";

  btn.classList.remove("opacity-40");
  btn.style.backgroundColor = "";   // back to Tailwind red
  btn.style.cursor = "";
}



 async function updateCheckoutInvoice() {
   document.getElementById("checkoutInvoiceOverlay")?.classList.remove("hidden");

     if (window._cartSavePromise) {
    await window._cartSavePromise;
  }
    toggleAddressField(); 
  syncCouponFromDrawerForCheckout();
  mountInvoiceIntoCheckout();

  const inv = buildCheckoutPreviewInv();
  renderInvoiceFromAPI(inv);
document.getElementById("checkoutInvoiceOverlay")?.classList.add("hidden");

  // üîí SINGLE CONTROL POINT
  const root = document.getElementById("checkoutInvoiceContainer");

  // Service
const serviceBox = root.querySelector("#invService");
if (inv.serviceAmt > 0) {
  serviceBox.classList.remove("hidden");
} else {
  serviceBox.classList.add("hidden");
}


  // Delivery
  const deliveryBox = root.querySelector("#invDelivery");
  if (inv.deliveryCharge > 0) {
    deliveryBox.classList.remove("hidden");
  } else {
    deliveryBox.classList.add("hidden");
  }

  // ‚úÖ PAYMENT (checkout preview only)
  const payBox = root.querySelector("#invPayment");
  if (!inv.paymentMethod || inv.paymentMethod.trim() === "") {
    payBox.classList.add("hidden");
  } else {
    payBox.classList.remove("hidden");
  }

  injectCheckoutOfferDiscount(inv);
}



  
function mountInvoiceIntoCheckout() {
  const src = document.getElementById("invoiceTemplate");
  const target = document.getElementById("checkoutInvoiceContainer");

  if (!src || !target) return;

  target.innerHTML = "";
  const clone = src.cloneNode(true);
  clone.removeAttribute("id");

  target.appendChild(clone);
}


document.addEventListener("DOMContentLoaded", () => {
  const modal = document.getElementById("invoiceModal");
  if (modal && modal.parentElement !== document.body) {
    document.body.appendChild(modal);
    console.log("‚úÖ invoiceModal moved to BODY");
  }
});



document.addEventListener("input", e => {
  if (
    ["customerName", "mobile", "email", "address"].includes(e.target.id)
  ) {
    updateCheckoutInvoice();
  }
});

document.getElementById("orderType")
  ?.addEventListener("change", updateCheckoutInvoice);

document.querySelectorAll(".payment-btn").forEach(btn => {
  btn.addEventListener("click", () => {
    setTimeout(updateCheckoutInvoice, 0);
  });
});

function hideAddressIfOrderTypeBlank() {
  const orderType = document.getElementById("orderType")?.value || "";

  if (orderType !== "") return; // üõë only blank case

  const fieldIds = ["address", "pincode", "city", "state"];
  const wrapperIds = [
    "addressWrapper",
    "pincodeWrapper",
    "cityWrapper",
    "stateWrapper"
  ];

  // clear values
  fieldIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.value = "";
  });

  // hide UI
  wrapperIds.forEach(id => {
    const box = document.getElementById(id);
    if (box) box.style.display = "none";
  });
}

function captureDeliveryLocation() {
  if (!navigator.geolocation) {
    alert("GPS not supported on this device");
    return;
  }

  const row  = document.getElementById("locationStatusRow");
  const txt  = document.getElementById("locationStatusText");
  const icon = document.getElementById("locationStatusIcon");

  icon.innerText = "‚è≥";
  txt.innerText  = "Fetching location...";

  navigator.geolocation.getCurrentPosition(
    pos => {
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;

      const mobile = document.getElementById("mobile").value.trim();
      if (!mobile) {
        icon.innerText = "‚ö†Ô∏è";
        txt.innerText  = "Mobile not found";
        return;
      }

      // üîí Send ONLY lat/lng (never address)
      apiPost("saveUserLocation", {
        mobile,
        lat,
        lng
      })
      .then(res => {
        if (res && res.success) {

          // üîë authoritative flag
          window._deliveryLocationReady = true;

          // üîë SINGLE SOURCE OF TRUTH ‚Üí controls Place Order button
          updatePlaceOrderLockByLocation();

          // üó∫Ô∏è Show mini map preview
          const mapBox   = document.getElementById("mapPreviewBox");
          const mapFrame = document.getElementById("mapPreviewFrame");

          if (mapBox && mapFrame) {
            mapBox.classList.remove("hidden");
            mapFrame.src = `https://maps.google.com/maps?q=${lat},${lng}&z=16&output=embed`;
            // üîÅ Re-check full backend eligibility now that GPS is saved
setTimeout(() => {
  if (typeof canProceedPlaceOrder === "function") {
    canProceedPlaceOrder();
  }
}, 300);
}

        } else {
          icon.innerText = "‚ö†Ô∏è";
          txt.innerText  = "Failed to save location";
        }
      })
      .catch(() => {
        icon.innerText = "‚ö†Ô∏è";
        txt.innerText  = "Server error while saving";
      });
    },
    err => {
      icon.innerText = "‚ö†Ô∏è";
      txt.innerText  = "Location permission denied";
    },
    { enableHighAccuracy: true, timeout: 15000 }
  );
}

function openLocationPicker() {
  if (!navigator.geolocation) {
    alert("GPS not supported on this device");
    return;
  }

  const row  = document.getElementById("locationStatusRow");
  const txt  = document.getElementById("locationStatusText");
  const icon = document.getElementById("locationStatusIcon");

  icon.innerText = "‚è≥";
  txt.innerText  = "Updating location...";

  // reuse existing logic
  captureDeliveryLocation();
}
  
function updatePlaceOrderLockByLocation() {
  const btn = document.getElementById("placeOrderBtn");
  const orderType = document.getElementById("orderType")?.value;

  if (!btn) return;

  // Only Home Delivery depends on GPS
  if (orderType !== "Home Delivery") {
    btn.disabled = false;
    btn.classList.remove("opacity-50", "cursor-not-allowed");
    return;
  }

  // üîí If location NOT ready ‚Üí lock
  if (!window._deliveryLocationReady) {
    btn.disabled = true;
    btn.classList.add("opacity-50", "cursor-not-allowed");
    return;
  }

  // ‚úÖ Location ready ‚Üí allow order
  btn.disabled = false;
  btn.classList.remove("opacity-50", "cursor-not-allowed");
}

</script>

  <div id="cartHandle" onclick="expandDrawerCart()">
  ‚Ä∫
</div>


<!-- Offers Page Loader -->
<div id="offersLoadingOverlay"
     class="fixed inset-0 bg-white bg-opacity-80 hidden z-50 flex items-center justify-center">
  <div class="text-center">
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-orange-500 border-t-transparent mx-auto"></div>
    <div class="mt-4 text-gray-700 text-base font-semibold">
      Loading offers...
    </div>
  </div>
</div>


<!-- Prepaid Savings Coupon Form -->
<div id="prepaidFormOverlay"
     class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">

  <div class="bg-white w-[95%] max-w-3xl rounded-2xl p-6 relative">

    <!-- Close -->
    <button onclick="closePrepaidForm()"
            class="absolute top-3 right-3 text-gray-500 text-xl">
      ‚úï
    </button>

    <!-- Title -->
    <h2 class="text-xl font-bold text-gray-800">
      Prepaid Savings Coupon
    </h2>

    <!-- Subtitle -->
    <p class="text-gray-600 text-sm mt-1">
      Buy coupons & save more
    </p>

    <!-- Prepaid Coupon Purchase Table -->
    <div class="mt-6 overflow-x-auto">
      <table class="w-full border border-gray-200 rounded-lg text-sm">
        <thead class="bg-gray-100 text-gray-700">
          <tr>
            <th class="p-2 text-left">Slab ID</th>
            <th class="p-2 text-right">Value</th>
            <th class="p-2 text-right">Discount</th>
            <th class="p-2 text-right">Disc Amt</th>
            <th class="p-2 text-right">Net Rate</th>
            <th class="p-2 text-center">Qty</th>
            <th class="p-2 text-right">Net Amt</th>
            <th class="p-2 text-center"></th>
          </tr>
        </thead>

        <tbody id="prepaidSlabRows">
          <!-- Default Row -->
          <tr class="border-t">
            <td class="p-2">
              <select
                class="w-full border rounded px-2 py-1"
                onchange="onPrepaidSlabChange(this)">
                <option value="">Select Slab</option>
              </select>
            </td>

            <td class="p-2 text-right text-gray-500">‚Äî</td>
            <td class="p-2 text-right text-gray-500">‚Äî</td>
            <td class="p-2 text-right text-gray-500">‚Äî</td>
            <td class="p-2 text-right text-gray-500">‚Äî</td>

            <td class="p-2 text-center">
              <input type="number"
                     min="1"
                     value="1"
                     class="w-16 border rounded px-2 py-1 text-center" />
            </td>

            <td class="p-2 text-right text-gray-500">‚Äî</td>

            <td class="p-2 text-center text-gray-300">‚úï</td>
          </tr>
        </tbody>
      </table>

      <!-- Add Slab -->
    <button
  type="button"
  onclick="addPrepaidSlabRow()"
  class="mt-3 text-orange-600 text-sm font-semibold
         hover:bg-transparent focus:bg-transparent active:bg-transparent">
  + Add another slab
</button>

    </div>
    <!-- Total Payable -->
    <div class="mt-6 flex justify-end">
      <div class="text-lg font-bold text-gray-800">
        Total Payable: ‚Çπ0
      </div>
    </div>

    <!-- Actions -->
    <div class="mt-6 flex justify-end gap-3">
      <button
        type="button"
        onclick="closePrepaidForm()"
        class="px-4 py-2 rounded-lg border border-gray-300 text-gray-600">
        Cancel
      </button>

     <button
  id="prepaidProceedBtn"
  type="button"
  onclick="submitPrepaidPurchase()"
  class="px-5 py-2 rounded-lg bg-orange-500 text-white font-semibold">
  Proceed to Pay
</button>

    </div>

  </div>
</div>

  <!-- Prepaid Processing Overlay -->
<div id="prepaidProcessingOverlay"
     class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] flex items-center justify-center">

  <div class="bg-white rounded-xl px-6 py-5 text-center shadow-lg">
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-orange-500 border-t-transparent mx-auto"></div>
    <div class="mt-4 text-gray-700 font-semibold">
      Processing your prepaid order...
    </div>
  </div>

</div>

<!-- My Coupons Loading Overlay -->
<div id="myCouponsOverlay"
     class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] flex items-center justify-center">
  
  <div class="bg-white rounded-xl px-6 py-5 text-center shadow-lg">
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-green-500 border-t-transparent mx-auto"></div>
    <div class="mt-4 text-gray-800 font-extrabold text-lg">
      Loading coupons...
    </div>
  </div>

</div>

<!-- ========================= -->
<!-- INVOICE MODAL -->
<!-- ========================= -->

<div id="checkoutInvoiceOverlay"
     class="hidden fixed inset-0 bg-white bg-opacity-80 z-[9999] flex items-center justify-center">
  <div class="text-center">
    <div class="animate-spin rounded-full h-10 w-10 border-4 border-orange-500 border-t-transparent mx-auto"></div>
    <div class="mt-3 text-gray-700 font-semibold">
      Please wait, preparing your invoice‚Ä¶
    </div>
  </div>
</div>
<div
  id="invoiceModal"
  class="fixed inset-0 bg-black bg-opacity-50 hidden z-[9999] flex items-center justify-center">
  <div class="bg-white w-[95%] max-w-xl rounded-xl p-4 text-sm relative">
<div id="invoiceTemplate">

    <!-- CLOSE -->
    <button
      onclick="closeInvoiceModal()"
      class="absolute top-2 right-3 text-gray-400 text-xl">
      ‚úï
    </button>

    <!-- HEADER -->
    <div class="mb-3">
      <div class="font-bold text-base" id="invoiceHeader">
        Invoice
      </div>
      
      <div class="text-xs text-gray-500" id="invOrderId"></div>
      <div id="invOrderType"></div>
      <div class="text-xs text-gray-700 mt-1" id="invInvoiceMeta"></div>
    </div>

    <!-- CUSTOMER -->
    <div class="mb-3 text-xs text-gray-700">
      <div id="invCustomer"></div>
      <div id="invContact"></div>
      <div id="invAddress"></div>
    </div>

    <hr class="my-2">

    <!-- ITEMS -->
    <div class="space-y-1 mb-3" id="invoiceItems">
      <!-- items injected by JS -->
    </div>

    <hr class="my-2">

    <!-- TOTALS -->
  <div class="space-y-1 text-xs text-gray-700">
  <div id="invBase"></div>

  <!-- Coupon & Gross come immediately after Items -->
<div id="invCoupon" class="hidden"></div>
  <!-- Charges -->
  <div id="invService"></div>
  <div id="invDelivery"></div>

  <!-- Tax block (Taxable + CGST + SGST + Bill Amount) -->
  <div id="invTax"></div>

  <!-- Post-tax discounts -->
  <div id="invSignup" class="text-green-600 hidden"></div>
</div>


    <hr class="my-2">

    <!-- NET -->
    <div class="flex justify-between items-center font-bold text-base">
      <span>Net Payable</span>
      <span id="invNet"></span>
    </div>

    <div class="mt-2 text-xs text-gray-600" id="invPayment"></div>
</div>
  </div>
</div>
  
  
</body>
</html>


































